<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,interactive-widget=resizes-content" />
  <title>AEMX Visor HUD (C√°mara + Stats + √öltimos 5 mensajes)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #00c8ff;
      --glow:    #00c8ff;
      --gold:    #facc15;
      --green:   #4ade80;
      --blue:    #60a5fa;
      --purple:  #a855f7;
      --yellow:  #facc15;
      --danger:  #ff4466;
      --text:    #ffffff;
      --glass:   rgba(5,10,20,.52);
      --glass2:  rgba(5,10,20,.72);
      --stroke:  rgba(0,200,255,.30);
      --shadow:  0 0 20px rgba(0,200,255,.15);
      --safe-top:    env(safe-area-inset-top);
      --safe-right:  env(safe-area-inset-right);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left:   env(safe-area-inset-left);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:#060b14; color:var(--text); font-family:Rajdhani,system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden; }
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(var(--primary) 1px,transparent 1px),
        linear-gradient(90deg,var(--primary) 1px,transparent 1px);
      background-size:52px 52px;
      opacity:.38;
      pointer-events:none;
      z-index:0;
      animation: gridEnergy 3.5s ease-in-out infinite;
      -webkit-mask-image:
        radial-gradient(ellipse 60% 90% at 50% 50%,
          black 30%, transparent 100%),
        radial-gradient(ellipse 100% 40% at 50% 50%,
          black 40%, transparent 100%);
      -webkit-mask-composite: source-in;
      mask-image:
        radial-gradient(ellipse 60% 90% at 50% 50%,
          black 30%, transparent 100%),
        radial-gradient(ellipse 100% 40% at 50% 50%,
          black 40%, transparent 100%);
      mask-composite: intersect;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(var(--primary) 1px,transparent 1px),
        linear-gradient(90deg,var(--primary) 1px,transparent 1px);
      background-size:52px 52px;
      opacity:.12;
      pointer-events:none;
      z-index:0;
      animation: gridEnergy 3.5s ease-in-out infinite reverse;
    }

    /* Stage */
    .stage{
      position:fixed; inset:0;
      z-index:1;
      display:block;
      background:#000;
    }
    video#cam{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      transform:scaleX(-1); /* espejo por defecto; se puede cambiar */
      background:#000;
    }
    /* HUD Overlay */
    .hud{
      position:absolute; inset:0;
      pointer-events:none;
    }

    .hud::before{
      display:none;
    }
    /* Corner accent lines */
    .hud::after{
      content:"";
      position:absolute; inset:0;
      background:
        /* top-left corner */
        linear-gradient(90deg, rgba(0,200,255,.55) 0px, rgba(0,200,255,.55) 40px, transparent 40px) 0 0 / 100% 1px no-repeat,
        linear-gradient(180deg, rgba(0,200,255,.55) 0px, rgba(0,200,255,.55) 40px, transparent 40px) 0 0 / 1px 100% no-repeat,
        /* top-right corner */
        linear-gradient(90deg, transparent calc(100% - 40px), rgba(0,200,255,.55) calc(100% - 40px), rgba(0,200,255,.55) 100%) 0 0 / 100% 1px no-repeat,
        linear-gradient(180deg, rgba(0,200,255,.55) 0px, rgba(0,200,255,.55) 40px, transparent 40px) 100% 0 / 1px 100% no-repeat,
        /* bottom-left corner */
        linear-gradient(90deg, rgba(0,200,255,.55) 0px, rgba(0,200,255,.55) 40px, transparent 40px) 0 100% / 100% 1px no-repeat,
        linear-gradient(180deg, transparent calc(100% - 40px), rgba(0,200,255,.55) calc(100% - 40px), rgba(0,200,255,.55) 100%) 0 0 / 1px 100% no-repeat,
        /* bottom-right corner */
        linear-gradient(90deg, transparent calc(100% - 40px), rgba(0,200,255,.55) calc(100% - 40px)) 0 100% / 100% 1px no-repeat,
        linear-gradient(180deg, transparent calc(100% - 40px), rgba(0,200,255,.55) calc(100% - 40px)) 100% 0 / 1px 100% no-repeat,
        /* vignette */
        radial-gradient(ellipse 100% 100% at 50% 50%, transparent 50%, rgba(0,0,0,.55) 100%);
      pointer-events:none;
    }
    .scanlines{
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.03),
        rgba(255,255,255,.03) 1px,
        transparent 1px,
        transparent 4px
      );
      opacity:.22;
      pointer-events:none;
    }

    /* Top controls (clickable) */
    .topbar{
      position:absolute;
      top: calc(10px + var(--safe-top));
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      gap:4px;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
      z-index:10;
      background: rgba(5,10,20,.55);
      border: 1px solid rgba(0,200,255,.18);
      border-radius: 12px;
      padding: 4px 6px;
      backdrop-filter: blur(10px);
    }
    .chip{
      display:flex; align-items:center; gap:5px;
      padding:5px 9px;
      border-radius:8px;
      border:1px solid rgba(0,200,255,.20);
      background:rgba(0,200,255,.07);
      font-family:Orbitron,system-ui;
      font-weight:800;
      letter-spacing:1px;
      font-size:9px;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .chip:active{ transform:scale(.96); }
    .chip:hover{ background:rgba(0,200,255,.14); }
    .chip .dot{
      width:6px; height:6px; border-radius:50%;
      background:var(--danger);
      box-shadow:0 0 6px rgba(255,68,102,.65);
      flex-shrink:0;
    }
    .chip.ok .dot{ background:#4ade80; box-shadow:0 0 6px rgba(74,222,128,.65); }
    .chip.secondary{ border-color: rgba(0,255,255,.18); }
    .spacer{ display:none; }

    /* Diamonds battery (top-right) */
    .battery{
      position:absolute;
      top: calc(10px + var(--safe-top));
      right: calc(10px + var(--safe-right));
      width: 210px;
      padding:10px 14px 12px;
      border-radius:14px;
      background: transparent;
      border: none;
      backdrop-filter: none;
      box-shadow: none;
      pointer-events:none;
      z-index:5;
    }
    .battery .title{
      display:flex; justify-content:space-between; align-items:center;
      font-family:Orbitron,system-ui;
      font-weight:900;
      letter-spacing:2px;
      font-size:9px;
      text-transform:uppercase;
      color:rgba(0,200,255,.75);
      margin-bottom:4px;
    }
    .battery .value{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:13px;
      letter-spacing:1.5px;
      color:rgba(255,255,255,.80);
      text-shadow:0 0 10px rgba(0,200,255,.40);
    }
    .batteryBar{
      position:relative;
      height:14px;
      border-radius:4px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(0,200,255,.18);
      overflow:hidden;
      direction: rtl;
    }
    .batteryFill{
      position:absolute; right:0; top:0; bottom:0;
      width:0%;
      border-radius:3px;
      background: linear-gradient(270deg, #00c8ff, #60a5fa, #a855f7);
      box-shadow: 0 0 14px rgba(0,200,255,.50);
      transition: width 0.8s ease;
      overflow:hidden;
    }
    .batteryFill::before{
      content:'';
      position:absolute; top:0; bottom:0;
      width:28%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      animation: barScan 3.0s ease-in-out infinite;
      z-index:3;
      pointer-events:none;
    }
    .batteryFill::after{
      content:'';
      position:absolute; top:-10%; bottom:-10%;
      width:22%;
      background: linear-gradient(105deg, transparent, rgba(255,255,255,.20), transparent);
      animation: shimmer 5.0s ease-in-out infinite;
      z-index:4;
      pointer-events:none;
    }
    .batterySpark{
      position:absolute;
      right:-3px; top:50%;
      transform:translateY(-50%);
      width:7px; height:7px;
      border-radius:50%;
      z-index:5;
      pointer-events:none;
      animation: spark 2.0s ease-in-out infinite;
      background:#00c8ff;
      box-shadow:0 0 10px #00c8ff;
    }
    .batteryBar::after{
      content:'';
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent calc(10% - 1px),
        rgba(0,0,0,.35) calc(10% - 1px),
        rgba(0,0,0,.35) 10%
      );
      pointer-events:none;
      z-index:2;
    }
    .batteryShell,.batteryBody,.cells,.cell,.batteryTip{ display:none; }
        /* Badges cards (top-right, below battery) */
    .badges{
      position:absolute;
      top: calc(10px + var(--safe-top));
      left: 10px;
      width: 80px;
      height: 88px;
      pointer-events:none;
      z-index:5;
    }
    .cardStack{
      position:relative; width:100%; height:100%;
    }
    .badgeCard{
      position:absolute; inset:auto;
      width: 62px; height: 62px;
      border-radius:10px;
      background: rgba(5,10,20,.42);
      border: 1px solid rgba(0,200,255,.22);
      backdrop-filter: blur(12px);
      box-shadow: 0 0 14px rgba(0,200,255,.12), inset 0 1px 0 rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:3px;
      font-family:Orbitron,system-ui;
      letter-spacing:1px;
    }
    .badgeCard:nth-child(1){ top:0; left:2px; transform:rotate(-6deg) translate(-5px, 3px); opacity:.40; }
    .badgeCard:nth-child(2){ top:5px; left:10px; transform:rotate(4deg) translate(4px, -3px); opacity:.62; }
    .badgeCard:nth-child(3){ top:16px; left:2px; transform:rotate(-1.5deg); opacity:1; border-color:rgba(0,200,255,.38); }
        .badgeLabel{ font-size:8px; font-weight:900; text-transform:uppercase; color:rgba(0,200,255,.80); letter-spacing:1.5px; }
    .badgeValue{ font-size:28px; font-weight:900; color:#ffffff; text-shadow:0 0 14px rgba(0,200,255,.60); line-height:1; }

    /* Krill bars (bottom-left) */
    .krill{
      position:absolute;
      bottom: calc(10px + var(--safe-bottom));
      left: 10px;
      width: 270px;
      height: auto;
      padding:8px 0 8px 0;
      border-radius:16px;
      background: transparent;
      border: none;
      backdrop-filter: none;
      box-shadow: none;
      pointer-events:none;
    }
    .krillHeader{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px;
      padding-bottom:6px;
      border-bottom:1px solid rgba(0,200,255,.14);
    }
    .krillHeader .t{
      font-family:Orbitron,system-ui;
      font-size:10px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      color:rgba(0,200,255,.90);
    }
    .krillTitle{
      font-family:Orbitron,system-ui;
      font-size:9px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      color:rgba(0,200,255,.75);
    }
    .krillFooter{
      font-family:Orbitron,system-ui;
      font-size:9px;
      font-weight:900;
      letter-spacing:1.5px;
      text-transform:uppercase;
      color:rgba(255,255,255,.60);
      margin-top:6px;
      text-align:left;
    }
    .krillHeader .total{
      font-family:Orbitron,system-ui;
      font-size:10px;
      font-weight:900;
      letter-spacing:1px;
      color:#ffffff;
      text-shadow:0 0 10px rgba(0,200,255,.40);
    }

    /* Horizontal stacked bars */
    .bars{
      display:flex;
      flex-direction:column;
      gap:7px;
      width:100%;
    }
    .barRow{
      display:flex;
      align-items:center;
      gap:7px;
      width:100%;
    }
    .lbl{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:8px;
      letter-spacing:1px;
      text-transform:uppercase;
      width:22px;
      text-align:right;
      flex-shrink:0;
    }
    .barRow.common   .lbl{ color:rgba(74,222,128,.90); }
    .barRow.rare     .lbl{ color:rgba(96,165,250,.90); }
    .barRow.epic     .lbl{ color:rgba(168,85,247,.90); }
    .barRow.legendary .lbl{ color:rgba(250,204,21,.90); }

    .bar{
      flex:1;
      height:14px;
      border-radius:4px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      position:relative;
    }
    .barRow.common   .bar{ border-color:rgba(74,222,128,.18); }
    .barRow.rare     .bar{ border-color:rgba(96,165,250,.18); }
    .barRow.epic     .bar{ border-color:rgba(168,85,247,.18); }
    .barRow.legendary .bar{ border-color:rgba(250,204,21,.20); }

    /* segmented ticks overlay */
    .bar::after{
      content:'';
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent calc(10% - 1px),
        rgba(0,0,0,.35) calc(10% - 1px),
        rgba(0,0,0,.35) 10%
      );
      pointer-events:none;
      z-index:2;
    }
    /* scan line sweeping over fill */
    .fill::before{
      content:'';
      position:absolute; top:0; bottom:0;
      width:28%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      animation: barScan 2.8s ease-in-out infinite;
      z-index:3;
      pointer-events:none;
      border-radius:4px;
    }
    /* shimmer diagonal */
    .fill::after{
      content:'';
      position:absolute; top:-10%; bottom:-10%;
      width:22%;
      background: linear-gradient(105deg, transparent, rgba(255,255,255,.20), transparent);
      animation: shimmer 4.5s ease-in-out infinite;
      z-index:4;
      pointer-events:none;
    }
    /* spark at tip */
    .spark{
      position:absolute;
      left:-3px; top:50%;
      transform:translateY(-50%);
      width:7px; height:7px;
      border-radius:50%;
      z-index:5;
      pointer-events:none;
      animation: spark 1.8s ease-in-out infinite;
    }
    .barRow.common   .spark{ background:#4ade80; box-shadow:0 0 8px #4ade80; }
    .barRow.rare     .spark{ background:#60a5fa; box-shadow:0 0 8px #60a5fa; }
    .barRow.epic     .spark{ background:#a855f7; box-shadow:0 0 8px #a855f7; }
    .barRow.legendary .spark{ background:#facc15; box-shadow:0 0 8px #facc15; }
    .fill{
      height:100%;
      width:0%;
      min-width:3px;
      border-radius:3px;
      opacity:.85;
      transition: width 0.7s cubic-bezier(.22,.68,0,1.2);
      position:relative;
      z-index:1;
    }
    .barRow.common   .fill{ background:linear-gradient(90deg,#2a9d60,#4ade80,#6ee7a0); box-shadow:0 0 10px rgba(74,222,128,.40); }
    .barRow.rare     .fill{ background:linear-gradient(90deg,#1d6fa8,#60a5fa,#93c5fd); box-shadow:0 0 10px rgba(96,165,250,.40); }
    .barRow.epic     .fill{ background:linear-gradient(90deg,#6b21a8,#a855f7,#c084fc); box-shadow:0 0 10px rgba(168,85,247,.40); }
    .barRow.legendary .fill{ background:linear-gradient(90deg,#b45309,#facc15,#fde68a); box-shadow:0 0 10px rgba(250,204,21,.45); }

    .num{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:9px;
      color:#ffffff;
      width:28px;
      text-align:right;
      flex-shrink:0;
      opacity:.75;
    }

    /* HUD chat (bottom-right) */
    .hudChat{
      position:absolute;
      bottom: calc(10px + var(--safe-bottom));
      right: calc(10px + var(--safe-right));
      width: 300px;
      max-width: calc(100vw - 24px);
      padding:0;
      background: transparent;
      border: none;
      backdrop-filter: none;
      box-shadow: none;
      pointer-events:none;
    }
    .hudChatUser{
      display:flex; align-items:center; gap:6px;
      font-family:Orbitron,system-ui;
      font-size:9px;
      font-weight:900;
      letter-spacing:1.5px;
      text-transform:uppercase;
      color:rgba(0,200,255,.75);
      margin-bottom:6px;
      justify-content:flex-start;
    }
    .hudChatUser .lamp{
      width:7px; height:7px; border-radius:50%;
      background:var(--danger);
      box-shadow:0 0 8px rgba(255,68,102,.55);
      flex-shrink:0;
    }
    .hudChatUser .lamp.ok{
      background:#4ade80;
      box-shadow:0 0 8px rgba(74,222,128,.65);
    }

    .msg{
      display:flex;
      gap:5px;
      font-size:12px;
      line-height:1.35;
      margin:3px 0;
      opacity:.95;
      justify-content:flex-start;
      text-align:left;
      text-shadow: 0 1px 8px rgba(0,0,0,.95);
      align-items:baseline;
    }
    .msg .a{
      color:rgba(96,165,250,.65);
      font-weight:700;
      flex:0 0 auto;
      max-width:38%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-family:Orbitron,system-ui;
      font-size:9px;
    }
    .msg .sep{
      color:rgba(255,255,255,.30);
      flex-shrink:0;
    }
    .msg .t{
      color:rgba(255,255,255,.90);
      word-break:break-word;
      flex:1;
      min-width:0;
    }

    /* Mobile friendliness */
    @media (max-width: 420px){
      .battery{ width:170px; }
      .hudChat{ width: 280px; }
      .krill{ width: 240px; }
      .badges{ width: 80px; }
      .badgeCard{ width:80px; height:80px; }
    }


    .topbar.hidden{
      opacity:0;
      transform: translateX(-50%) translateY(-60px);
      pointer-events:none;
    }
    .topbar{
      transition: opacity .30s ease, transform .30s cubic-bezier(.22,.68,0,1.2);
    }
    .tapHint{
      position:absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 10px;
      background: rgba(255,255,255,.08);
      clip-path: polygon(0% 0%, 100% 0%, 82% 100%, 18% 100%);
      display:none;
      pointer-events:none;
      z-index:15;
    }
    .tapHint.show{ display:block; }
    .miniBtn{
      position:absolute;
      bottom: calc(10px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
      pointer-events:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .miniBtn button{
      border:none;
      background: rgba(5,10,20,.35);
      color:rgba(232,255,246,.80);
      padding: 8px 18px 10px;
      font-family: Orbitron, system-ui;
      font-weight:900;
      letter-spacing:2px;
      font-size:10px;
      text-transform:uppercase;
      cursor:pointer;
      backdrop-filter: blur(8px);
      outline: 1px solid rgba(0,200,255,.18);
      outline-offset: -1px;
    }
    /* HUD = left button: trapezoid wider at bottom, clipped top-right */
    .miniBtn button:first-child{
      clip-path: polygon(12px 0%, 100% 0%, 100% 100%, 0% 100%);
    }
    /* FULL = right button: trapezoid wider at bottom, clipped top-left */
    .miniBtn button:last-child{
      clip-path: polygon(0% 0%, calc(100% - 12px) 0%, 100% 100%, 0% 100%);
    }
    .miniBtn button:active{ opacity:.7; }

    /* Safe overlay for ‚Äúrotate device‚Äù */
    .rotateHint{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      text-align:center;
      padding:24px;
      background:rgba(6,11,20,.88);
      z-index:999;
      pointer-events:none;
      font-family:Orbitron,system-ui;
      letter-spacing:2px;
      text-transform:uppercase;
      color:#fff;
    }
    .rotateHint .box{
      max-width:520px;
      border:1px solid rgba(0,255,136,.25);
      border-radius:18px;
      padding:20px 18px;
      background:rgba(5,10,20,.45);
      box-shadow:0 0 22px rgba(0,255,136,.15);
    }
    .rotateHint .big{ font-size:14px; font-weight:900; margin-bottom:10px; }
    .rotateHint .small{ font-family:Rajdhani,system-ui; font-size:14px; letter-spacing:0; text-transform:none; opacity:.85; }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes hudGridPulse {
      0%, 100% { opacity: .75; }
      50%       { opacity: 1; }
    }
    @keyframes batteryGlitch {
      0%   { transform: scaleX(1);      filter: brightness(1); opacity:1; }
      20%  { transform: scaleX(1.04) translateX(3px); filter: brightness(2.2) hue-rotate(40deg); opacity:.7; }
      40%  { transform: scaleX(0.97) translateX(-2px); filter: brightness(1.6); opacity:.9; }
      60%  { transform: scaleX(1.02) translateX(1px); filter: brightness(2) hue-rotate(-25deg); opacity:.8; }
      100% { transform: scaleX(1);      filter: brightness(1); opacity:1; }
    }
    @keyframes badgeGlitch {
      0%   { transform: rotate(-1.5deg) translateX(0);   filter: brightness(1); }
      25%  { transform: rotate(-1.5deg) translateX(5px);  filter: brightness(2.5) hue-rotate(30deg); }
      50%  { transform: rotate(-1.5deg) translateX(-4px); filter: brightness(1.8) hue-rotate(-20deg); }
      75%  { transform: rotate(-1.5deg) translateX(2px);  filter: brightness(2); }
      100% { transform: rotate(-1.5deg) translateX(0);   filter: brightness(1); }
    }
    @keyframes barGlitch {
      0%   { transform: translateX(0)   scaleY(1);    filter: brightness(1); }
      20%  { transform: translateX(4px) scaleY(1.15); filter: brightness(1.8) hue-rotate(30deg); }
      35%  { transform: translateX(-3px) scaleY(0.9); filter: brightness(2.2) hue-rotate(-20deg); }
      50%  { transform: translateX(2px) scaleY(1.1);  filter: brightness(1.5); }
      100% { transform: translateX(0)   scaleY(1);    filter: brightness(1); }
    }
    @keyframes numGlitch {
      0%   { transform: translateX(0);  opacity:1;   filter: none; }
      25%  { transform: translateX(3px); opacity:.6; filter: blur(1px) brightness(2); }
      50%  { transform: translateX(-2px); opacity:1; filter: brightness(1.8) hue-rotate(20deg); }
      100% { transform: translateX(0);  opacity:1;   filter: none; }
    }
    @keyframes gridEnergy {
      0%, 100% { opacity: .38; filter: brightness(1) hue-rotate(0deg); }
      33%       { opacity: .55; filter: brightness(1.4) hue-rotate(15deg); }
      66%       { opacity: .30; filter: brightness(0.8) hue-rotate(-10deg); }
    }
    @keyframes barGlow {
      0%, 100% { opacity: .95; filter: brightness(1); }
      50%       { opacity: 1;   filter: brightness(1.25); }
    }
    /* 1. Scan line sweeping left to right */
    @keyframes barScan {
      0%   { left: -30%; opacity: .7; }
      100% { left: 110%; opacity: .0; }
    }
    /* 2. Particle spark at tip */
    @keyframes spark {
      0%         { opacity: 0; transform: scale(0.4); }
      20%, 60%   { opacity: 1; transform: scale(1.2); }
      100%       { opacity: 0; transform: scale(0.6) translateY(-4px); }
    }
    /* 4. Shimmer diagonal */
    @keyframes shimmer {
      0%   { left: -60%; }
      100% { left: 130%; }
    }
    /* 3. Fill from zero on load */
    @keyframes fillIn {
      from { width: 0% !important; }
    }
    @keyframes batteryPulse {
      0%, 100% { box-shadow: 0 0 10px rgba(0,200,255,.40); }
      50%       { box-shadow: 0 0 22px rgba(0,200,255,.85); }
    }
    @keyframes batteryLow {
      0%, 100% { box-shadow: 0 0 10px rgba(255,68,102,.40); }
      50%       { box-shadow: 0 0 22px rgba(255,68,102,.90); }
    }
    @keyframes badgeFloat {
      0%, 100% { transform: rotate(-1.5deg) translateY(0px); }
      50%       { transform: rotate(-1.5deg) translateY(-4px); }
    }
    @keyframes badgeBorderPulse {
      0%, 100% { border-color: rgba(0,200,255,.38); box-shadow: 0 0 14px rgba(0,200,255,.12); }
      50%       { border-color: rgba(0,200,255,.75); box-shadow: 0 0 20px rgba(0,200,255,.35); }
    }
    @keyframes scanPulse {
      0%, 100% { opacity: .22; }
      50%       { opacity: .32; }
    }

    /* Apply animations */
    .fill{
      animation: barGlow 2.8s ease-in-out infinite, fillIn 1.2s ease-out 1;
    }
    .barRow.legendary .fill{ animation: barGlow 2.2s ease-in-out infinite, fillIn 1.2s ease-out 1; }
    .barRow.legendary .fill::before{ animation-duration: 2.4s; animation-delay: 0s; }
    .barRow.legendary .fill::after { animation-duration: 4.0s; animation-delay: 0s; }
    .barRow.epic      .fill{ animation: barGlow 3.0s ease-in-out infinite, fillIn 1.4s ease-out 1; }
    .barRow.epic      .fill::before{ animation-duration: 3.1s; animation-delay: .4s; }
    .barRow.epic      .fill::after { animation-duration: 5.0s; animation-delay: .5s; }
    .barRow.rare      .fill{ animation: barGlow 2.6s ease-in-out infinite, fillIn 1.6s ease-out 1; }
    .barRow.rare      .fill::before{ animation-duration: 2.7s; animation-delay: .7s; }
    .barRow.rare      .fill::after { animation-duration: 4.5s; animation-delay: .3s; }
    .barRow.common    .fill{ animation: barGlow 3.2s ease-in-out infinite, fillIn 1.8s ease-out 1; }
    .barRow.common    .fill::before{ animation-duration: 3.3s; animation-delay: .9s; }
    .barRow.common    .fill::after { animation-duration: 5.5s; animation-delay: .8s; }

    /* ‚îÄ‚îÄ LOGIN OVERLAY ‚îÄ‚îÄ */
    .loginOverlay{
      position:fixed; inset:0;
      z-index:500;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(6,11,20,.82);
      backdrop-filter: blur(6px);
      pointer-events:auto;
    }
    .loginOverlay.hidden{ display:none; }
    .loginBox{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      padding: 32px 28px 28px;
      border-radius:20px;
      background: rgba(5,10,20,.88);
      border: 1px solid rgba(0,200,255,.35);
      box-shadow: 0 0 40px rgba(0,200,255,.18), inset 0 1px 0 rgba(255,255,255,.06);
      max-width:320px;
      width:90%;
      text-align:center;
    }
    .loginTitle{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:22px;
      letter-spacing:4px;
      color:#00c8ff;
      text-shadow:0 0 20px rgba(0,200,255,.60);
      text-transform:uppercase;
    }
    .loginSub{
      font-family:Rajdhani,system-ui;
      font-size:14px;
      color:rgba(255,255,255,.70);
      letter-spacing:1px;
      line-height:1.4;
    }
    .loginBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding:13px 22px;
      border-radius:12px;
      border: 1px solid rgba(0,200,255,.40);
      background: rgba(0,200,255,.10);
      color:#fff;
      font-family:Orbitron,system-ui;
      font-weight:700;
      font-size:11px;
      letter-spacing:1.5px;
      text-transform:uppercase;
      cursor:pointer;
      transition: all .2s ease;
      width:100%;
    }
    .loginBtn:hover{
      background: rgba(0,200,255,.22);
      border-color: rgba(0,200,255,.75);
      box-shadow: 0 0 20px rgba(0,200,255,.30);
    }
    .loginBtn:active{ transform:scale(.97); }
    .loginBtn:disabled{ opacity:.5; cursor:not-allowed; }
    .loginHint{
      font-family:Rajdhani,system-ui;
      font-size:12px;
      color:rgba(255,80,100,.85);
      min-height:16px;
      letter-spacing:.5px;
    }
    .loginSkip{
      background:none;
      border:none;
      color:rgba(255,255,255,.35);
      font-family:Rajdhani,system-ui;
      font-size:12px;
      letter-spacing:1px;
      cursor:pointer;
      text-decoration:underline;
      padding:4px 8px;
      transition: color .2s;
      display:none;
    }
    .loginSkip:hover{ color:rgba(255,255,255,.70); }
    @media (hover: hover) and (pointer: fine){
      .loginSkip{ display:block; }
    }

    .batteryFill{
      animation: batteryPulse 2.4s ease-in-out infinite;
    }
    .batteryFill.low{
      animation: batteryLow 1.0s ease-in-out infinite;
    }

    .badgeCard:nth-child(3){
      animation: badgeFloat 3.5s ease-in-out infinite, badgeBorderPulse 3.5s ease-in-out infinite;
    }
    .scanlines{
      animation: scanPulse 4s ease-in-out infinite;
    }

    /* ‚îÄ‚îÄ QR SCANNER OVERLAY ‚îÄ‚îÄ */
    .qrOverlay{
      position:fixed; inset:0;
      z-index:200;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(6,11,20,.72);
      backdrop-filter: blur(4px);
      pointer-events:auto;
    }
    .qrOverlay.hidden{ display:none; }
    .qrBox{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .qrFrame{
      position:relative;
      width: min(72vw, 300px);
      height: min(72vw, 300px);
      border-radius:12px;
      overflow:hidden;
      background:#000;
    }
    #qrVideo{
      width:100%; height:100%;
      object-fit:cover;
    }
    .qrCorner{
      position:absolute;
      width:28px; height:28px;
      border-color:#00c8ff;
      border-style:solid;
      pointer-events:none;
    }
    .qrCorner.tl{ top:8px; left:8px; border-width:3px 0 0 3px; border-radius:4px 0 0 0; }
    .qrCorner.tr{ top:8px; right:8px; border-width:3px 3px 0 0; border-radius:0 4px 0 0; }
    .qrCorner.bl{ bottom:8px; left:8px; border-width:0 0 3px 3px; border-radius:0 0 0 4px; }
    .qrCorner.br{ bottom:8px; right:8px; border-width:0 3px 3px 0; border-radius:0 0 4px 0; }
    .qrScanLine{
      position:absolute; left:12px; right:12px; height:2px;
      background: linear-gradient(90deg, transparent, #00c8ff, transparent);
      box-shadow: 0 0 8px #00c8ff;
      animation: qrScan 2s ease-in-out infinite;
    }
    @keyframes qrScan{
      0%{ top:12px; opacity:.5; }
      50%{ opacity:1; }
      100%{ top:calc(100% - 14px); opacity:.5; }
    }
    .qrStatus{
      font-family:Orbitron,system-ui;
      font-size:10px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      color:rgba(0,200,255,.85);
      text-align:center;
    }
    .qrClose{
      padding:7px 22px;
      border-radius:8px;
      border:1px solid rgba(0,200,255,.30);
      background:rgba(0,200,255,.08);
      color:#fff;
      font-family:Orbitron,system-ui;
      font-weight:800;
      font-size:9px;
      letter-spacing:2px;
      text-transform:uppercase;
      cursor:pointer;
    }
    .qrClose:hover{ background:rgba(0,200,255,.18); }

        .chip.qrChip{ border-color:rgba(250,204,21,.30); background:rgba(250,204,21,.07); }
    .chip.qrChip .dot{ background:#facc15; box-shadow:0 0 6px rgba(250,204,21,.65); }
    .chip.qrChip.active{ background:rgba(250,204,21,.18); border-color:rgba(250,204,21,.60); }
  </style>
</head>

<body>
  <div class="stage">
    <video id="cam" autoplay playsinline muted></video>

    <div class="hud">
      <div class="scanlines"></div>
      <svg id="hudGrid" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:screen;opacity:0.85;" preserveAspectRatio="none"></svg>

      <!-- clickable controls -->
      <div class="topbar">
        <div class="chip" id="btnStart">
          <span class="dot" id="camDot"></span>
          <span id="camLabel">C√ÅMARA: OFF</span>
        </div>

        <div class="chip secondary" id="btnFlip">
          ‚áÑ ESPEJO
        </div>
        <div class="chip secondary" id="btnCamSwitch">
          ‚óâ FRONTAL
        </div>
        <div class="spacer"></div>

        <div class="chip" id="btnReloadStats" title="Refrescar stats desde localStorage">
          ‚Üª STATS
        </div>

      </div>

      <!-- Diamonds battery -->
      <div class="battery" aria-label="Diamantes">
        <div class="batteryBar">
          <div class="batteryFill" id="batteryFill"></div><div class="batterySpark" id="batterySpark"></div>
        </div>
        <div class="title" style="margin-top:4px;">
          <span>‚ö° BATER√çA</span>
          <span class="value" id="diamondsVal">0</span>
        </div>
        <!-- keep old cells hidden for JS compat -->
        <div style="display:none"><div class="cells" id="diamondCells"></div></div>
      </div>

      <!-- Badges cards -->
      <div class="badges" aria-label="Insignias">
        <div class="cardStack">
          <div class="badgeCard">
            <span class="badgeValue" id="badgesValGhost1">0</span>
          </div>
          <div class="badgeCard">
            <span class="badgeValue" id="badgesValGhost2">0</span>
          </div>
          <div class="badgeCard">
            <span class="badgeLabel">INSIGNIAS</span>
            <span class="badgeValue" id="badgesVal">0</span>
          </div>
        </div>
      </div>

      <!-- Krill bars -->
      <div class="krill" aria-label="Parcela por rareza">
        <div class="bars">
          <div class="barRow legendary">
            <div class="num" id="numLegendary">0</div>
            <div class="bar"><div class="fill" id="fillLegendary"></div><div class="spark"></div></div>
          </div>
          <div class="barRow epic">
            <div class="num" id="numEpic">0</div>
            <div class="bar"><div class="fill" id="fillEpic"></div><div class="spark"></div></div>
          </div>
          <div class="barRow rare">
            <div class="num" id="numRare">0</div>
            <div class="bar"><div class="fill" id="fillRare"></div><div class="spark"></div></div>
          </div>
          <div class="barRow common">
            <div class="num" id="numCommon">0</div>
            <div class="bar"><div class="fill" id="fillCommon"></div><div class="spark"></div></div>
          </div>
        </div>
        <div class="krillFooter"><span class="krillTitle">STATS</span> &nbsp;¬∑&nbsp; TOTAL: <span id="totalParcels">0</span></div>
      </div>

      <!-- Last 5 chat messages -->
      <div class="hudChat" aria-label="√öltimos 5 mensajes">
        <div class="hudChatUser">
          <span class="lamp" id="chatLamp"></span>
          <span id="chatState">‚Äî</span>
        </div>
        <div id="chatLines">
          <div class="msg"><span class="a">‚Äî</span><span class="t">Conecta Firebase para ver actividad.</span></div>
        </div>
      </div>
    </div>

    
    <div class="miniBtn">
      <button id="btnUI">HUD</button>
      <button id="btnFS">FULL</button>
    </div>
    <div class="tapHint" id="tapHint"></div>

    <!-- QR button: always visible, fixed bottom-right -->
    <div id="btnQR" style="
      position:fixed;
      bottom: calc(18px + env(safe-area-inset-bottom));
      right: calc(16px + env(safe-area-inset-right));
      z-index: 25;
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:6px;
      padding:10px 16px;
      border-radius:12px;
      border:1px solid rgba(250,204,21,.45);
      background:rgba(5,10,20,.72);
      color:#facc15;
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:11px;
      letter-spacing:2px;
      cursor:pointer;
      backdrop-filter:blur(10px);
      box-shadow:0 0 14px rgba(250,204,21,.20);
      user-select:none;
    ">
      <span style="width:7px;height:7px;border-radius:50%;background:#facc15;box-shadow:0 0 6px #facc15;flex-shrink:0;display:inline-block;"></span>
      QR
    </div>

    <div class="rotateHint" id="rotateHint">
      <div class="box">
        <div class="big">GIRA EL TEL√âFONO A HORIZONTAL</div>
        <div class="small">Tip: en iPhone, Safari es medio terco‚Ä¶ pero con FULL + girar, queda üëå</div>
      </div>
    </div>

    <!-- QR SCANNER OVERLAY -->
    <div class="qrOverlay hidden" id="qrOverlay">
      <div class="qrBox">
        <div class="qrFrame">
          <video id="qrVideo" autoplay playsinline muted></video>
          <div class="qrCorner tl"></div>
          <div class="qrCorner tr"></div>
          <div class="qrCorner bl"></div>
          <div class="qrCorner br"></div>
          <div class="qrScanLine"></div>
        </div>
        <div class="qrStatus" id="qrStatus">APUNTA AL C√ìDIGO QR</div>
        <button class="qrClose" id="btnQRClose">CERRAR</button>
      </div>
    </div>

    <!-- AR CANVAS (transparent, over camera) -->
    <canvas id="arCanvas" style="position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:50;display:none;"></canvas>
    <!-- AR CLOSE BUTTON -->
    <button id="btnARClose" style="display:none;position:fixed;z-index:60;width:44px;height:44px;border-radius:50%;border:1.5px solid rgba(255,255,255,.40);background:rgba(5,10,20,.70);color:#fff;font-size:20px;cursor:pointer;backdrop-filter:blur(8px);pointer-events:auto;align-items:center;justify-content:center;line-height:1;">‚úï</button>

    <!-- THREE.JS (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AEMX AR PARCEL SYSTEM ‚Äî anchored on QR in camera feed
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const RARITY_MAP = {
      'AEMX-COMMON':    'common',
      'AEMX-RARE':      'rare',
      'AEMX-EPIC':      'epic',
      'AEMX-LEGENDARY': 'legendary',
    };

    // ‚îÄ‚îÄ AR canvas & Three.js renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const arCanvas = document.getElementById('arCanvas');
    const btnARClose = document.getElementById('btnARClose');

    const renderer = new THREE.WebGLRenderer({ canvas: arCanvas, antialias: true, alpha: true });
    renderer.setClearColor(0x000000, 0); // fully transparent background
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    const scene = new THREE.Scene();
    // NO scene.background ‚Üí transparent

    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
    camera.position.set(4.5, 4.5, 4.5);
    camera.lookAt(0, 0.5, 0);

    // Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.60));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.1);
    dirLight.position.set(5, 8, 5);
    scene.add(dirLight);
    scene.add(Object.assign(new THREE.DirectionalLight(0x6699ff, 0.25), { position: new THREE.Vector3(-4,2,-4) }));

    let parcelGroup = null;
    let arRafId = null;

    // ‚îÄ‚îÄ Colors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const C = {
      grassLight:0x5aaf3a, grassDark:0x3d8a27, grassTile:0x4d9c30,
      borderCommon:0x9ca3af, borderRare:0x60a5fa, borderEpic:0xa855f7, borderLegendary:0xf59e0b,
      trunk:0x7c4a1e, trunkDark:0x5a3412,
      pineGreen1:0x2d7a3a, pineGreen2:0x1e5c2a,
      leafGreen1:0x3a9e2a, leafGreen2:0x2d8020, leafGreen3:0x4ab830,
      rockGray:0x6b7280, rockDark:0x4b5563,
      flowerYellow:0xfbbf24, weedGreen:0x166534, weedDark:0x14532d,
    };
    const mat = (color, opts={}) => new THREE.MeshLambertMaterial({ color, flatShading:true, ...opts });

    // ‚îÄ‚îÄ Grass base ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildBase(borderColor){
      const g = new THREE.Group();
      const geo = new THREE.BoxGeometry(4, 0.18, 4, 4, 1, 4);
      const pos = geo.attributes.position;
      for(let i=0; i<pos.count; i++){
        if(Math.abs(pos.getY(i) - 0.09) < 0.01) pos.setY(i, pos.getY(i)+(Math.random()-.5)*.06);
      }
      geo.computeVertexNormals();
      const colors=[], col=new THREE.Color();
      for(let i=0;i<pos.count;i++){
        const t=Math.random();
        col.setHex(t>.5?C.grassLight:t>.25?C.grassTile:C.grassDark);
        colors.push(col.r,col.g,col.b);
      }
      geo.setAttribute('color', new THREE.BufferAttribute(new Float32Array(colors),3));
      g.add(Object.assign(new THREE.Mesh(geo, new THREE.MeshLambertMaterial({vertexColors:true,flatShading:true})), {receiveShadow:true}));
      const border = new THREE.Mesh(new THREE.BoxGeometry(4.22,0.12,4.22), mat(borderColor));
      border.position.y=-0.04; g.add(border);
      [{x:0,z:2.06,sx:4.22,sz:.11},{x:0,z:-2.06,sx:4.22,sz:.11},{x:2.06,z:0,sx:.11,sz:4.22},{x:-2.06,z:0,sx:.11,sz:4.22}]
        .forEach(s=>{ const m=new THREE.Mesh(new THREE.BoxGeometry(s.sx,.14,s.sz),mat(borderColor)); m.position.set(s.x,.05,s.z); g.add(m); });
      return g;
    }

    function buildCommon(){ return buildBase(C.borderCommon); }

    function buildRare(){
      const g=buildBase(C.borderRare);
      [{x:-.6,z:-.4,h:.9,l:.12},{x:-.3,z:-.2,h:1.1,l:-.08},{x:-.7,z:-.1,h:.75,l:.15},{x:-.45,z:.25,h:1.0,l:.05},{x:-.2,z:.1,h:.65,l:-.12}]
        .forEach(r=>{
          const reed=new THREE.Mesh(new THREE.CylinderGeometry(.025,.04,r.h,5),mat(Math.random()>.5?C.weedGreen:C.weedDark));
          reed.position.set(r.x,r.h/2+.09,r.z); reed.rotation.z=r.l; g.add(reed);
          const tip=new THREE.Mesh(new THREE.ConeGeometry(.06,.18,4),mat(C.weedGreen));
          tip.position.set(r.x,r.h+.15,r.z); g.add(tip);
        });
      return g;
    }

    function buildEpic(){
      const g=buildBase(C.borderEpic);
      const trunk=new THREE.Mesh(new THREE.CylinderGeometry(.1,.15,.55,6),mat(C.trunk));
      trunk.position.set(.2,.36,.1); g.add(trunk);
      [{y:.64,r:.75,h:1.1},{y:1.35,r:.55,h:.9},{y:1.95,r:.35,h:.75},{y:2.45,r:.18,h:.55}]
        .forEach((l,i)=>{
          const c=new THREE.Mesh(new THREE.ConeGeometry(l.r,l.h,7+i),mat(i%2===0?C.pineGreen1:C.pineGreen2));
          c.position.set(.2,l.y,.1); g.add(c);
        });
      return g;
    }

    function buildLegendary(){
      const g=buildBase(C.borderLegendary);
      const trunk=new THREE.Mesh(new THREE.CylinderGeometry(.13,.2,1.1,6),mat(C.trunk));
      trunk.position.set(-.1,.64,-.1); g.add(trunk);
      const br=new THREE.Mesh(new THREE.CylinderGeometry(.07,.10,.7,5),mat(C.trunkDark));
      br.position.set(.22,1.05,-.1); br.rotation.z=-.6; g.add(br);
      [{x:-.1,y:2.1,z:-.1,s:.9,c:C.leafGreen1},{x:.55,y:1.75,z:.1,s:.65,c:C.leafGreen2},
       {x:-.65,y:1.85,z:.15,s:.60,c:C.leafGreen3},{x:.1,y:2.65,z:.2,s:.55,c:C.leafGreen1},
       {x:-.3,y:2.35,z:-.55,s:.50,c:C.leafGreen2},{x:.4,y:2.3,z:-.3,s:.45,c:C.leafGreen3}]
        .forEach(l=>{ const m=new THREE.Mesh(new THREE.IcosahedronGeometry(l.s,0),mat(l.c)); m.position.set(l.x,l.y,l.z); m.rotation.y=Math.random()*Math.PI; g.add(m); });
      const rock=new THREE.Mesh(new THREE.DodecahedronGeometry(.28,0),mat(C.rockGray));
      rock.position.set(.9,.18,-.5); rock.rotation.y=1.2; rock.scale.set(1,.65,.9); g.add(rock);
      const rock2=new THREE.Mesh(new THREE.DodecahedronGeometry(.18,0),mat(C.rockDark));
      rock2.position.set(1.15,.12,-.2); rock2.scale.set(.9,.55,1); g.add(rock2);
      [{x:.7,z:.5},{x:.5,z:.8},{x:1.0,z:.65},{x:.3,z:.9}].forEach(fp=>{
        const stem=new THREE.Mesh(new THREE.CylinderGeometry(.015,.02,.22,4),mat(C.weedGreen));
        stem.position.set(fp.x,.2,fp.z); g.add(stem);
        const petal=new THREE.Mesh(new THREE.ConeGeometry(.07,.06,5),mat(C.flowerYellow));
        petal.position.set(fp.x,.33,fp.z); g.add(petal);
      });
      return g;
    }

    function loadParcel(rarity){
      if(parcelGroup){ scene.remove(parcelGroup); parcelGroup=null; }
      const builders = { common:buildCommon, rare:buildRare, epic:buildEpic, legendary:buildLegendary };
      if(builders[rarity]){ parcelGroup=builders[rarity](); scene.add(parcelGroup); }
    }

    // ‚îÄ‚îÄ AR state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let arActive = false;
    let arTarget = { x:0, y:0, size:200 }; // screen position of QR center
    let arSmooth = { x:0, y:0, size:200 }; // smoothed
    let qrLostFrames = 0;
    const QR_LOST_THRESHOLD = 20; // frames before hiding

    function resizeAR(){
      const W = window.innerWidth, H = window.innerHeight;
      arCanvas.width = W * Math.min(window.devicePixelRatio, 2);
      arCanvas.height = H * Math.min(window.devicePixelRatio, 2);
      arCanvas.style.width = W + 'px';
      arCanvas.style.height = H + 'px';
      renderer.setSize(W, H);
      camera.aspect = 1;
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resizeAR);
    resizeAR();

    function arRenderLoop(){
      if(!arActive){ arRafId=null; return; }
      arRafId = requestAnimationFrame(arRenderLoop);

      // Smooth position
      const lerpK = 0.18;
      arSmooth.x += (arTarget.x - arSmooth.x) * lerpK;
      arSmooth.y += (arTarget.y - arSmooth.y) * lerpK;
      arSmooth.size += (arTarget.size - arSmooth.size) * lerpK;

      const W = window.innerWidth, H = window.innerHeight;
      const dpr = Math.min(window.devicePixelRatio, 2);

      // Render 3D to offscreen then blit at QR position
      // Use scissor/viewport trick: render into a square centered on QR
      const renderSize = Math.round(arSmooth.size * 2.2); // model slightly bigger than QR
      const cx = Math.round(arSmooth.x); // screen center X
      const cy = Math.round(arSmooth.y); // screen center Y

      // WebGL viewport: bottom-left origin, Y flipped
      const vpX = Math.round((cx - renderSize/2) * dpr);
      const vpY = Math.round((H - cy - renderSize/2) * dpr);
      const vpW = Math.round(renderSize * dpr);
      const vpH = Math.round(renderSize * dpr);

      renderer.setScissorTest(true);
      renderer.setScissor(vpX, vpY, vpW, vpH);
      renderer.setViewport(vpX, vpY, vpW, vpH);

      camera.aspect = 1;
      camera.updateProjectionMatrix();

      renderer.clear(true, true, true);
      renderer.render(scene, camera);
      renderer.setScissorTest(false);
    }

    // ‚îÄ‚îÄ Show/hide AR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showAR(rarity){
      loadParcel(rarity);
      arCanvas.style.display = 'block';
      btnARClose.style.display = 'flex';
      // Position close button top-right
      btnARClose.style.top = 'calc(14px + env(safe-area-inset-top))';
      btnARClose.style.right = 'calc(14px + env(safe-area-inset-right))';
      arActive = true;
      qrLostFrames = 0;
      if(!arRafId) arRenderLoop();
    }

    function hideAR(){
      arActive = false;
      arCanvas.style.display = 'none';
      btnARClose.style.display = 'none';
      if(parcelGroup){ scene.remove(parcelGroup); parcelGroup=null; }
    }

    btnARClose.addEventListener('click', ()=>{ hideAR(); closeQR(); });

    // ‚îÄ‚îÄ QR Scanner with AR anchor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let qrStream = null;
    let qrScanning = false;
    let qrDetector = null;
    let qrLoopTimer = null;
    let detectedRarity = null;
    const qrOverlay = document.getElementById('qrOverlay');
    const qrVideo   = document.getElementById('qrVideo');
    const qrStatus  = document.getElementById('qrStatus');
    const btnQR     = document.getElementById('btnQR');

    const hasBarcodeDetector = ('BarcodeDetector' in window);
    if(hasBarcodeDetector){
      try{ qrDetector = new BarcodeDetector({ formats:['qr_code'] }); }catch(e){ qrDetector=null; }
    }

    // Manual fallback
    if(!qrDetector){
      const qrBox = document.querySelector('.qrBox');
      const inp = document.createElement('input');
      inp.type='text'; inp.placeholder='AEMX-COMMON / RARE / EPIC / LEGENDARY';
      inp.style.cssText='background:rgba(5,10,20,.85);border:1px solid rgba(0,200,255,.35);color:#fff;padding:8px 12px;border-radius:8px;width:100%;font-family:Orbitron,system-ui;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;outline:none;text-align:center;margin-top:8px;';
      const btn = document.createElement('button');
      btn.textContent='CONFIRMAR';
      btn.style.cssText='margin-top:6px;padding:7px 22px;border-radius:8px;border:1px solid rgba(0,200,255,.30);background:rgba(0,200,255,.10);color:#fff;font-family:Orbitron,system-ui;font-weight:800;font-size:9px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;width:100%;';
      const confirm = ()=>{
        const code=inp.value.trim().toUpperCase();
        const rarity=RARITY_MAP[code];
        if(rarity){
          // Position in center screen when manual
          arTarget = { x: window.innerWidth/2, y: window.innerHeight/2, size: Math.min(window.innerWidth,window.innerHeight)*0.35 };
          arSmooth = { ...arTarget };
          closeQR();
          showAR(rarity);
        } else {
          qrStatus.textContent='‚ö† C√ìDIGO NO V√ÅLIDO';
        }
      };
      btn.addEventListener('click', confirm);
      inp.addEventListener('keydown', e=>{ if(e.key==='Enter') confirm(); });
      qrBox.appendChild(inp); qrBox.appendChild(btn);
    }

    async function openQR(){
      qrOverlay.classList.remove('hidden');
      btnQR.style.background='rgba(250,204,21,.25)'; btnQR.style.borderColor='rgba(250,204,21,.80)';
      if(!qrDetector){
        document.querySelector('.qrFrame').style.display='none';
        qrStatus.textContent='INGRESA EL C√ìDIGO MANUALMENTE';
        return;
      }
      qrStatus.textContent='INICIANDO C√ÅMARA‚Ä¶';
      try{
        // Use the MAIN camera stream if already running
        const mainCam = document.getElementById('cam');
        if(mainCam && mainCam.srcObject){
          qrStream = mainCam.srcObject;
          qrVideo.srcObject = qrStream;
          qrVideo.play().catch(()=>{});
        } else {
          qrStream = await navigator.mediaDevices.getUserMedia({
            video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} },
            audio:false
          });
          qrVideo.srcObject = qrStream;
          await qrVideo.play();
        }
        qrScanning = true;
        qrStatus.textContent='APUNTA AL C√ìDIGO QR';
        scanLoop();
      }catch(e){
        qrStatus.textContent='ERROR DE C√ÅMARA';
      }
    }

    function closeQR(){
      qrScanning = false;
      if(qrLoopTimer){ clearTimeout(qrLoopTimer); qrLoopTimer=null; }
      // Don't stop stream ‚Äî we might need it for AR tracking
      qrVideo.srcObject = null;
      qrStream = null;
      qrOverlay.classList.add('hidden');
      btnQR.style.background='rgba(5,10,20,.72)'; btnQR.style.borderColor='rgba(250,204,21,.45)';
    }

    async function scanLoop(){
      if(!qrScanning || !qrDetector) return;
      try{
        const barcodes = await qrDetector.detect(qrVideo);
        if(barcodes.length > 0){
          const barcode = barcodes[0];
          const code = barcode.rawValue.trim().toUpperCase();
          const rarity = RARITY_MAP[code];
          if(rarity){
            // Get QR bounding box in the qrVideo element's coordinate space
            // then map to screen coordinates
            const vw = qrVideo.videoWidth || qrVideo.offsetWidth;
            const vh = qrVideo.videoHeight || qrVideo.offsetHeight;
            const rect = qrVideo.getBoundingClientRect();

            // Corner points from BarcodeDetector
            const pts = barcode.cornerPoints;
            const cx_vid = (pts[0].x + pts[1].x + pts[2].x + pts[3].x) / 4;
            const cy_vid = (pts[0].y + pts[1].y + pts[2].y + pts[3].y) / 4;

            // QR size in video pixels
            const qrW = Math.hypot(pts[1].x-pts[0].x, pts[1].y-pts[0].y);
            const qrH = Math.hypot(pts[3].x-pts[0].x, pts[3].y-pts[0].y);
            const qrSize_vid = (qrW + qrH) / 2;

            // Scale to screen (video element might be scaled/cropped)
            const scaleX = rect.width / vw;
            const scaleY = rect.height / vh;
            const scale = Math.min(scaleX, scaleY); // object-fit:cover uses max actually
            // For cover: scale = max, and centered
            const coverScale = Math.max(scaleX, scaleY);
            const offsetX = (rect.width  - vw * coverScale) / 2;
            const offsetY = (rect.height - vh * coverScale) / 2;

            const screen_cx = rect.left + offsetX + cx_vid * coverScale;
            const screen_cy = rect.top  + offsetY + cy_vid * coverScale;
            const screen_size = qrSize_vid * coverScale;

            arTarget = { x: screen_cx, y: screen_cy, size: screen_size };

            if(!arActive){
              arSmooth = { ...arTarget };
              detectedRarity = rarity;
              qrStatus.textContent = '‚úì ' + code;
              // Switch: close overlay, start AR on MAIN camera
              // Reuse main camera for AR tracking
              closeQR();
              showAR(rarity);
              // Start AR tracking loop using main camera
              startARTracking(rarity);
              return;
            }
          } else {
            qrStatus.textContent = 'QR NO RECONOCIDO';
          }
        }
      }catch(e){}
      if(qrScanning) qrLoopTimer = setTimeout(scanLoop, 150);
    }

    // ‚îÄ‚îÄ AR tracking: keep detecting QR on main camera ‚îÄ‚îÄ‚îÄ‚îÄ
    let arTrackTimer = null;
    let arTrackDetector = null;

    async function startARTracking(rarity){
      if(arTrackDetector) return;
      try{ arTrackDetector = new BarcodeDetector({ formats:['qr_code'] }); }catch(e){ return; }

      const mainCam = document.getElementById('cam');
      if(!mainCam) return;

      async function trackLoop(){
        if(!arActive){ arTrackDetector=null; return; }
        try{
          const barcodes = await arTrackDetector.detect(mainCam);
          if(barcodes.length > 0){
            const barcode = barcodes[0];
            const vw = mainCam.videoWidth || mainCam.offsetWidth;
            const vh = mainCam.videoHeight || mainCam.offsetHeight;
            const rect = mainCam.getBoundingClientRect();

            const pts = barcode.cornerPoints;
            const cx_vid = (pts[0].x+pts[1].x+pts[2].x+pts[3].x)/4;
            const cy_vid = (pts[0].y+pts[1].y+pts[2].y+pts[3].y)/4;
            const qrW = Math.hypot(pts[1].x-pts[0].x, pts[1].y-pts[0].y);
            const qrH = Math.hypot(pts[3].x-pts[0].x, pts[3].y-pts[0].y);
            const qrSize_vid = (qrW+qrH)/2;

            const coverScale = Math.max(rect.width/vw, rect.height/vh);
            const offsetX = (rect.width  - vw*coverScale)/2;
            const offsetY = (rect.height - vh*coverScale)/2;

            arTarget.x = rect.left + offsetX + cx_vid*coverScale;
            arTarget.y = rect.top  + offsetY + cy_vid*coverScale;
            arTarget.size = qrSize_vid * coverScale;
            qrLostFrames = 0;
          } else {
            qrLostFrames++;
            if(qrLostFrames > QR_LOST_THRESHOLD){
              // QR lost ‚Äî keep last position (don't hide, just freeze)
            }
          }
        }catch(e){}
        if(arActive) arTrackTimer = setTimeout(trackLoop, 100);
        else arTrackDetector = null;
      }
      trackLoop();
    }

    // ‚îÄ‚îÄ Button listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('btnQRClose').addEventListener('click', closeQR);
    btnQR.addEventListener('click', ()=>{
      if(qrOverlay.classList.contains('hidden')) openQR();
      else closeQR();
    });
    </script>

    <!-- LOGIN OVERLAY -->
    <div class="loginOverlay" id="loginOverlay">
      <div class="loginBox">
        <div class="loginTitle">AEMX HUD</div>
        <div class="loginSub">Inicia sesi√≥n para ver el chat en vivo</div>
        <button class="loginBtn" id="btnLogin">
          <svg width="18" height="18" viewBox="0 0 48 48" style="display:inline-block;vertical-align:middle;margin-right:8px;"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
          Iniciar con Google
        </button>
        <div class="loginHint" id="loginHint"></div>
        <button class="loginSkip" id="btnSkipLogin">Omitir (solo pruebas)</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, ref, query, limitToLast, orderByChild, onValue } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, browserLocalPersistence, setPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 1) Stats source (GamerTag localStorage)
    // SAVE_KEY identificado en tu index: 'atlas-earth-calc-data'
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SAVE_KEY = 'atlas-earth-calc-data';

    function toInt(x){
      const n = Number(String(x ?? '').replace(/[^\d.-]/g,''));
      return Number.isFinite(n) ? Math.max(0, Math.floor(n)) : 0;
    }

    function readStats(){
      // 1) Preferir JSON del SAVE_KEY
      let d = null;
      try{
        const raw = localStorage.getItem(SAVE_KEY);
        if(raw) d = JSON.parse(raw);
      }catch(e){ d = null; }

      // 2) Fallback: leer claves sueltas si existieran
      const fallback = (k) => {
        try { return localStorage.getItem(k); } catch(e){ return null; }
      };

      const common     = toInt(d?.common     ?? fallback('common'));
      const rare       = toInt(d?.rare       ?? fallback('rare'));
      const epic       = toInt(d?.epic       ?? fallback('epic'));
      const legendary  = toInt(d?.legendary  ?? fallback('legendary'));
      const badges     = toInt(d?.badges     ?? fallback('badges'));
      const diamonds   = toInt(d?.diamonds   ?? fallback('diamonds'));
      const atlasbucks = toInt(d?.atlasbucks ?? fallback('atlasbucks'));

      return { common, rare, epic, legendary, badges, diamonds, atlasbucks };
    }

    function renderStats(s){
      // numbers
      document.getElementById('numCommon').textContent = s.common;
      document.getElementById('numRare').textContent = s.rare;
      document.getElementById('numEpic').textContent = s.epic;
      document.getElementById('numLegendary').textContent = s.legendary;

      const total = Math.max(0, s.common + s.rare + s.epic + s.legendary);
      document.getElementById('totalParcels').textContent = total;
      // 100% = next hundred above commons (e.g. 1450 ‚Üí 1500)
      const refMax = s.common > 0 ? Math.ceil(s.common / 100) * 100 : 100;
      const pct = (v) => Math.min(100, Math.round((v / refMax) * 100));
      document.getElementById('fillCommon').style.width = pct(s.common) + '%';
      document.getElementById('fillRare').style.width = pct(s.rare) + '%';
      document.getElementById('fillEpic').style.width = pct(s.epic) + '%';
      document.getElementById('fillLegendary').style.width = pct(s.legendary) + '%';

      // badges cards
      document.getElementById('badgesVal').textContent = s.badges;
      document.getElementById('badgesValGhost1').textContent = s.badges;
      document.getElementById('badgesValGhost2').textContent = s.badges;

      // diamonds battery (0..9999)
      const d = Math.min(9999, s.diamonds);
      document.getElementById('diamondsVal').textContent = d.toLocaleString('es-MX');

      // New battery bar
      const battFill = document.getElementById('batteryFill');
      const battSpark = document.getElementById('batterySpark');
      if(battFill){
        const pctBatt = Math.round((d / 9999) * 100);
        battFill.style.width = pctBatt + '%';
        battFill.classList.toggle('low', pctBatt < 20);
        if(battSpark) battSpark.style.right = (100 - pctBatt) + '%';
      }
    }

    function refreshStats(){
      renderStats(readStats());
    }

    // update on load + on storage changes
    refreshStats();
    window.addEventListener('storage', (e) => {
      if(e.key === SAVE_KEY || ['common','rare','epic','legendary','badges','diamonds','atlasbucks'].includes(e.key)) {
        refreshStats();
      }
    });
    // also poll (mobile Safari sometimes doesn‚Äôt dispatch storage reliably across tabs)
    setInterval(refreshStats, 1200);

    document.getElementById('btnReloadStats').addEventListener('click', refreshStats);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 2) Camera
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const camVideo = document.getElementById('cam');
    const btnStart = document.getElementById('btnStart');
    const camDot = document.getElementById('camDot');
    const camLabel = document.getElementById('camLabel');
    const btnFlip = document.getElementById('btnFlip');
    const btnFullscreen = document.getElementById('btnFullscreen');
    const rotateHint = document.getElementById('rotateHint');

    const btnUI = document.getElementById('btnUI');
    const btnFS = document.getElementById('btnFS');
    const topbar = document.querySelector('.topbar');
    const tapHint = document.getElementById('tapHint');

    let uiHidden = true;
    let uiTimer = null;

    function showUI(temp=true){
      uiHidden = false;
      topbar.classList.remove('hidden');
      tapHint.classList.remove('show');
      if(uiTimer) clearTimeout(uiTimer);
      if(temp){
        uiTimer = setTimeout(() => hideUI(), 2600);
      }
    }
    function hideUI(){
      uiHidden = true;
      topbar.classList.add('hidden');
      tapHint.classList.add('show');
    }

    // start hidden (requested)
    hideUI();

    // Tap anywhere to show controls briefly
    const reveal = (e) => {
      if(e && (e.target?.closest?.('.topbar') || e.target?.closest?.('.miniBtn'))) return;
      showUI(true);
    };
    document.addEventListener('pointerdown', reveal, {passive:true});
    document.addEventListener('touchstart', reveal, {passive:true});
    document.addEventListener('click', reveal);

    btnUI.addEventListener('click', () => {
      if(uiHidden) showUI(false);
      else hideUI();
    });

    async function toggleFullscreen(){
      try{
        if(!document.fullscreenElement){
          await document.documentElement.requestFullscreen?.();
          await requestLandscapeLock();
        }else{
          await document.exitFullscreen?.();
        }
      }catch(e){}
      syncFSLabel();
      checkOrientationHint();
    }

    function syncFSLabel(){
      const on = !!document.fullscreenElement;
      btnFS.textContent = on ? 'SALIR' : 'FULL';
      // keep original chip label if visible
      try{ document.getElementById('btnFullscreen').textContent = on ? '‚õ∂ SALIR' : '‚õ∂ FULL'; }catch(e){}
    }

    btnFS.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', syncFSLabel);
    syncFSLabel();


    let camStream = null;
    let mirrored = true;
    let facingMode = 'environment';

    function setCamState(on){
      camDot.classList.toggle('ok', on);
      btnStart.classList.toggle('ok', on);
      camLabel.textContent = on ? 'C√ÅMARA: ON' : 'C√ÅMARA: OFF';
    }

    async function startCamera(){
      if(camStream) return;
      try{
        camStream = await navigator.mediaDevices.getUserMedia({
          audio:false,
          video:{
            facingMode:{ ideal: facingMode },
            width:{ ideal:1280 },
            height:{ ideal:720 }
          }
        });
        camVideo.srcObject = camStream;
        setCamState(true);
      }catch(e){
        console.error('getUserMedia error:', e);
        alert('No se pudo abrir la c√°mara. Revisa permisos del navegador.');
        setCamState(false);
      }
    }

    function stopCamera(){
      if(!camStream) return;
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
      camVideo.srcObject = null;
      setCamState(false);
    }

    btnStart.addEventListener('click', async () => {
      if(camStream) stopCamera();
      else await startCamera();
    });

    btnFlip.addEventListener('click', () => {
      mirrored = !mirrored;
      camVideo.style.transform = mirrored ? 'scaleX(-1)' : 'scaleX(1)';
    });

    const btnCamSwitch = document.getElementById('btnCamSwitch');
    btnCamSwitch.addEventListener('click', async () => {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      btnCamSwitch.textContent = facingMode === 'environment' ? '‚óâ FRONTAL' : '‚óâ TRASERA';
      // Auto-mirror front camera, unmirror back
      mirrored = facingMode === 'user';
      camVideo.style.transform = mirrored ? 'scaleX(-1)' : 'scaleX(1)';
      if(camStream){
        stopCamera();
        await startCamera();
      }
    });

    async function requestLandscapeLock(){
      try{
        if(screen.orientation && screen.orientation.lock){
          await screen.orientation.lock('landscape');
        }
      }catch(e){
        // iOS Safari: no soporta lock (ignorar)
      }
    }

    if(btnFullscreen) btnFullscreen.addEventListener('click', async () => {
      if (typeof toggleFullscreen === 'function') {
        await toggleFullscreen();
        return;
      }
      try{ await document.documentElement.requestFullscreen?.(); }catch(e){}
      await requestLandscapeLock();
      checkOrientationHint();
    });

    function checkOrientationHint(){
      // show hint if portrait (best-effort)
      const isPortrait = window.matchMedia && window.matchMedia("(orientation: portrait)").matches;
      rotateHint.style.display = isPortrait ? 'flex' : 'none';
    }
    window.addEventListener('resize', checkOrientationHint);
    window.addEventListener('orientationchange', checkOrientationHint);
    checkOrientationHint();

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 3) Firebase: last 5 messages (read-only HUD)
    // Config copiada del chat-firebase.html
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const firebaseConfig = {
      apiKey: "AIzaSyB-xx2PlBjvnHe0K7Bf1MspVqUlfjky0mk",
      authDomain: "aemx-chat.firebaseapp.com",
      databaseURL: "https://aemx-chat-default-rtdb.firebaseio.com",
      projectId: "aemx-chat",
      storageBucket: "aemx-chat.appspot.com",
      messagingSenderId: "267113002594",
      appId: "1:267113002594:web:4099e7537d950f5753433b",
      measurementId: "G-K84EVPE46R"
    };

    const chatLamp = document.getElementById('chatLamp');
    const chatState = document.getElementById('chatState');
    const chatLines = document.getElementById('chatLines');

    function setChatState(on, label){
      chatLamp.classList.toggle('ok', on);
      chatState.textContent = label || (on ? 'LIVE' : '‚Äî');
    }

    function safeStr(x, max=140){
      const s = String(x ?? '').replace(/\s+/g,' ').trim();
      if(!s) return '';
      return s.length > max ? s.slice(0, max-1) + '‚Ä¶' : s;
    }

    function renderChat(list){
      chatLines.innerHTML = '';
      if(!list.length){
        chatLines.innerHTML = '<div class="msg"><span class="a">‚Äî</span><span class="t">Sin mensajes recientes.</span></div>';
        return;
      }
      for(const m of list){
        const row = document.createElement('div');
        row.className = 'msg';

        const a = document.createElement('span');
        a.className = 'a';
        a.textContent = safeStr(m.username || m.user || m.author || m.name || 'AEMX', 18);

        const sep = document.createElement('span');
        sep.className = 'sep';
        sep.textContent = '¬∑';

        const t = document.createElement('span');
        t.className = 't';
        t.textContent = safeStr(m.text || m.message || m.msg || m.mensaje || '', 100) || '‚Ä¶';

        row.appendChild(a);
        row.appendChild(sep);
        row.appendChild(t);
        chatLines.appendChild(row);
      }
    }

    try{
      const app = initializeApp(firebaseConfig, 'hud-app');
      const db  = getDatabase(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      // ‚îÄ‚îÄ Login overlay logic ‚îÄ‚îÄ
      const loginOverlay = document.getElementById('loginOverlay');
      const btnLogin     = document.getElementById('btnLogin');
      const loginHint    = document.getElementById('loginHint');

      function showLoginOverlay(){
        loginOverlay.classList.remove('hidden');
        setChatState(false, 'SIN SESI√ìN');
        renderChat([]);
      }
      function hideLoginOverlay(){
        loginOverlay.classList.add('hidden');
      }

      document.getElementById('btnSkipLogin').addEventListener('click', () => {
        hideLoginOverlay();
        setChatState(false, 'SIN SESI√ìN');
        renderChat([{ username: 'AEMX', text: 'Chat no disponible sin sesi√≥n.' }]);
      });

      btnLogin.addEventListener('click', async () => {
        btnLogin.disabled = true;
        btnLogin.textContent = 'CONECTANDO‚Ä¶';
        loginHint.textContent = '';
        try{
          await setPersistence(auth, browserLocalPersistence);
          await signInWithPopup(auth, provider);
          // onAuthStateChanged will handle the rest
        }catch(e){
          console.error('Login error:', e);
          loginHint.textContent = e.code === 'auth/popup-blocked'
            ? 'Popup bloqueado ‚Äî permite popups en este sitio.'
            : 'Error al iniciar sesi√≥n. Intenta de nuevo.';
          btnLogin.disabled = false;
          btnLogin.innerHTML = `<svg width="18" height="18" viewBox="0 0 48 48" style="display:inline-block;vertical-align:middle;margin-right:8px;"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>Iniciar con Google`;
        }
      });

      // Helper to attach Realtime DB listener
      const attachListener = () => {
        const q = query(ref(db, 'messages'), orderByChild('timestamp'), limitToLast(5));
        onValue(q, (snap) => {
          const arr = [];
          if(snap.exists()){
            snap.forEach(child => {
              const val = child.val();
              // Normalize timestamp: serverTimestamp() may arrive as object or null briefly
              if(val && (val.username || val.user) && (val.text || val.message || val.msg)){
                const ts = typeof val.timestamp === 'number' ? val.timestamp : Date.now();
                arr.push({ ...val, timestamp: ts });
              }
            });
            arr.sort((a,b) => a.timestamp - b.timestamp);
          }
          renderChat(arr);
          const _uname = (window._hudUsername || '').toUpperCase() || 'LIVE';
          setChatState(true, _uname);
        }, (err) => {
          console.error('HUD chat onValue error:', err);
          setChatState(false, 'DENIED');
          renderChat([]);
        });
      };

      // Activar persistencia y esperar estado de auth
      setPersistence(auth, browserLocalPersistence).catch(console.warn);

      onAuthStateChanged(auth, (user) => {
        if(user){
          hideLoginOverlay();
          // Show first name in chat status
          const firstName = (localStorage.getItem('atlas-username') || user.displayName || 'USER').split(' ')[0].toUpperCase();
          window._hudUsername = firstName;
          setChatState(true, firstName);
          attachListener();
        } else {
          showLoginOverlay();
        }
      });

    }catch(e){
      console.error('Firebase init error:', e);
      setChatState(false, 'ERR');
    }

    // ‚îÄ‚îÄ Curved HUD grid + scanline + glitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const NS = 'http://www.w3.org/2000/svg';

    function buildCurvedGrid(){
      const svg = document.getElementById('hudGrid');
      if(!svg) return;
      const W = window.innerWidth;
      const H = window.innerHeight;
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      svg.innerHTML = '';

      const cols = 14;
      const rows = 10;
      const curve = 0.10;

      const fade = (t) => Math.min(1, Math.min(t, 1-t) * 6);

      // Grid group
      const gridGroup = document.createElementNS(NS, 'g');
      gridGroup.id = 'gridLines';

      for(let i = 0; i <= cols; i++){
        const t = i / cols;
        const x = t * W;
        const bulgeX = (x - W*0.5) * curve;
        const op = (fade(t) * 0.9).toFixed(3);
        const p = document.createElementNS(NS,'path');
        p.setAttribute('d', `M ${x} 0 C ${x-bulgeX} ${H*0.25}, ${x-bulgeX} ${H*0.75}, ${x} ${H}`);
        p.setAttribute('stroke', `rgba(0,200,255,${op})`);
        p.setAttribute('stroke-width','0.7');
        p.setAttribute('fill','none');
        gridGroup.appendChild(p);
      }
      for(let j = 0; j <= rows; j++){
        const t = j / rows;
        const y = t * H;
        const bulgeY = (y - H*0.5) * curve;
        const op = (fade(t) * 0.9).toFixed(3);
        const p = document.createElementNS(NS,'path');
        p.setAttribute('d', `M 0 ${y} C ${W*0.25} ${y-bulgeY}, ${W*0.75} ${y-bulgeY}, ${W} ${y}`);
        p.setAttribute('stroke', `rgba(0,200,255,${op})`);
        p.setAttribute('stroke-width','0.7');
        p.setAttribute('fill','none');
        gridGroup.appendChild(p);
      }
      svg.appendChild(gridGroup);

      // ‚îÄ‚îÄ Scanline (gradient trail: opaque top ‚Üí transparent bottom) ‚îÄ‚îÄ
      const defs = document.createElementNS(NS,'defs');
      const grad = document.createElementNS(NS,'linearGradient');
      grad.id = 'scanGrad';
      grad.setAttribute('x1','0'); grad.setAttribute('y1','0');
      grad.setAttribute('x2','0'); grad.setAttribute('y2','1');
      const s1 = document.createElementNS(NS,'stop');
      s1.setAttribute('offset','0%');   s1.setAttribute('stop-color','rgba(0,200,255,0)');
      const s2 = document.createElementNS(NS,'stop');
      s2.setAttribute('offset','60%');  s2.setAttribute('stop-color','rgba(0,200,255,0.08)');
      const s3 = document.createElementNS(NS,'stop');
      s3.setAttribute('offset','100%'); s3.setAttribute('stop-color','rgba(0,200,255,0.28)');
      grad.appendChild(s1); grad.appendChild(s2); grad.appendChild(s3);
      defs.appendChild(grad);
      svg.appendChild(defs);

      const scanline = document.createElementNS(NS,'rect');
      scanline.id = 'hudScanline';
      scanline.setAttribute('x','0');
      scanline.setAttribute('y','0');
      scanline.setAttribute('width', W);
      scanline.setAttribute('height','80');
      scanline.setAttribute('fill','url(#scanGrad)');
      svg.appendChild(scanline);

      // ‚îÄ‚îÄ Glitch rects (2 hidden bands) ‚îÄ‚îÄ
      for(let g=0;g<2;g++){
        const gr = document.createElementNS(NS,'rect');
        gr.classList.add('glitchBand');
        gr.setAttribute('x','0');
        gr.setAttribute('y','-20');
        gr.setAttribute('width', W);
        gr.setAttribute('height','6');
        gr.setAttribute('fill','rgba(0,200,255,0.12)');
        gr.setAttribute('opacity','0');
        svg.appendChild(gr);
      }
    }

    buildCurvedGrid();
    window.addEventListener('resize', buildCurvedGrid);

    // Subtle grid pulse
    const hudGridEl = document.getElementById('hudGrid');
    if(hudGridEl){
      hudGridEl.animate(
        [{opacity:0.75},{opacity:1},{opacity:0.75}],
        {duration:4000, iterations:Infinity, easing:'ease-in-out'}
      );
    }

    // ‚îÄ‚îÄ Scanline animation (always re-queries element so survives rebuilds) ‚îÄ‚îÄ
    let _scanY = -80;
    function scanlineLoop(){
      const line = document.querySelector('#hudScanline');
      if(line){
        const H = window.innerHeight;
        _scanY += 1.8;
        if(_scanY > H) _scanY = -80;
        line.setAttribute('y', _scanY);
      }
      requestAnimationFrame(scanlineLoop);
    }
    scanlineLoop();

    // ‚îÄ‚îÄ Glitch animation ‚îÄ‚îÄ
    function triggerGlitch(){
      const svg = document.getElementById('hudGrid');
      if(!svg) return;
      const H = window.innerHeight;
      const W = window.innerWidth;
      const bands = svg.querySelectorAll('.glitchBand');
      bands.forEach(band => {
        const y = Math.random() * H;
        const h = 4 + Math.random() * 14;
        const offsetX = (Math.random() - 0.5) * 18;
        band.setAttribute('y', y);
        band.setAttribute('height', h);
        band.setAttribute('x', offsetX);
        band.setAttribute('opacity','1');
        // Also shift a random section of the grid briefly
        const gridLines = svg.querySelector('#gridLines');
        if(gridLines){
          const sliceY = y;
          const sliceH = h;
          gridLines.setAttribute('transform',`translate(${offsetX * 0.4},0)`);
          setTimeout(()=>{
            gridLines.setAttribute('transform','translate(0,0)');
          }, 80);
        }
        setTimeout(()=>{ band.setAttribute('opacity','0'); }, 120);
      });
      // Random interval: 2.5s to 7s
      setTimeout(triggerGlitch, 2500 + Math.random() * 4500);
    }
    setTimeout(triggerGlitch, 1500 + Math.random() * 2000);

    // ‚îÄ‚îÄ Battery glitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function triggerBatteryGlitch(){
      const el = document.getElementById('batteryFill');
      if(!el) return;
      const dur = 200 + Math.random() * 150;
      el.style.animation = `batteryGlitch ${dur}ms steps(4,end) 1`;
      const val = document.getElementById('diamondsVal');
      if(val){ val.style.filter='brightness(2) hue-rotate(20deg)'; }
      setTimeout(() => {
        el.style.animation = '';
        if(val) val.style.filter = '';
      }, dur + 50);
      setTimeout(triggerBatteryGlitch, 3000 + Math.random() * 5000);
    }
    setTimeout(triggerBatteryGlitch, 2500 + Math.random() * 2000);

    // ‚îÄ‚îÄ Badge glitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function triggerBadgeGlitch(){
      const card = document.querySelector('.badgeCard:nth-child(3)');
      const val  = document.getElementById('badgesVal');
      if(!card) return;
      const dur = 180 + Math.random() * 120;
      card.style.animation = `badgeGlitch ${dur}ms steps(4,end) 1`;
      if(val){ val.style.filter='brightness(2.5) hue-rotate(40deg)'; val.style.transform='translateX(3px)'; }
      setTimeout(() => {
        card.style.animation = '';
        if(val){ val.style.filter=''; val.style.transform=''; }
      }, dur + 50);
      setTimeout(triggerBadgeGlitch, 2500 + Math.random() * 5000);
    }
    setTimeout(triggerBadgeGlitch, 3500 + Math.random() * 2000);

    // ‚îÄ‚îÄ Bar stats glitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const BAR_IDS = ['fillCommon','fillRare','fillEpic','fillLegendary'];
    const NUM_IDS = ['numCommon','numRare','numEpic','numLegendary'];

    function triggerBarGlitch(){
      // Pick 1-2 random bars to glitch
      const count = Math.random() < 0.4 ? 2 : 1;
      const shuffled = [...BAR_IDS].sort(()=>Math.random()-.5).slice(0, count);
      shuffled.forEach(id => {
        const el = document.getElementById(id);
        const num = document.getElementById(id.replace('fill','num'));
        if(!el) return;
        const dur = 180 + Math.random() * 120;
        el.style.animation = `barGlitch ${dur}ms steps(3,end) 1`;
        if(num) num.style.animation = `numGlitch ${dur}ms steps(3,end) 1`;
        setTimeout(() => {
          el.style.animation = '';
          if(num) num.style.animation = '';
        }, dur + 50);
      });
      // Next glitch: 1.5s to 5s
      setTimeout(triggerBarGlitch, 1500 + Math.random() * 3500);
    }
    setTimeout(triggerBarGlitch, 2000 + Math.random() * 2000);
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Auto-start camera if permission already granted
    if(navigator.permissions){
      navigator.permissions.query({ name: 'camera' }).then(result => {
        if(result.state === 'granted'){
          startCamera();
        } else {
          setCamState(false);
        }
      }).catch(() => setCamState(false));
    } else {
      setCamState(false);
    }
  </script>
</body>
</html>
