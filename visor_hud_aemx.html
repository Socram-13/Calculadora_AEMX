<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,interactive-widget=resizes-content" />
  <title>AEMX Visor HUD (C√°mara + Stats + √öltimos 5 mensajes)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #00c8ff;
      --glow:    #00c8ff;
      --gold:    #facc15;
      --green:   #4ade80;
      --blue:    #60a5fa;
      --purple:  #a855f7;
      --yellow:  #facc15;
      --danger:  #ff4466;
      --text:    #ffffff;
      --glass:   rgba(5,10,20,.52);
      --glass2:  rgba(5,10,20,.72);
      --stroke:  rgba(0,200,255,.30);
      --shadow:  0 0 20px rgba(0,200,255,.15);
      --safe-top:    env(safe-area-inset-top);
      --safe-right:  env(safe-area-inset-right);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left:   env(safe-area-inset-left);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:#060b14; color:var(--text); font-family:Rajdhani,system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden; }
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(var(--primary) 1px,transparent 1px),
        linear-gradient(90deg,var(--primary) 1px,transparent 1px);
      background-size:52px 52px;
      opacity:.18;
      pointer-events:none;
      z-index:0;
      -webkit-mask-image: radial-gradient(
        ellipse 72% 100% at 50% 50%,
        rgba(0,0,0,1)   38%,
        rgba(0,0,0,0.7) 58%,
        rgba(0,0,0,0.2) 76%,
        rgba(0,0,0,0)   100%
      );
      mask-image: radial-gradient(
        ellipse 72% 100% at 50% 50%,
        rgba(0,0,0,1)   38%,
        rgba(0,0,0,0.7) 58%,
        rgba(0,0,0,0.2) 76%,
        rgba(0,0,0,0)   100%
      );
    }

    /* Stage */
    .stage{
      position:fixed; inset:0;
      z-index:1;
      display:block;
      background:#000;
    }
    video#cam{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      transform:scaleX(-1); /* espejo por defecto; se puede cambiar */
      background:#000;
    }
    /* HUD Overlay */
    .hud{
      position:absolute; inset:0;
      pointer-events:none;
    }

    .hud::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 38px 38px;
      opacity:.25;
      mix-blend-mode:screen;
      pointer-events:none;
    }
    .scanlines{
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.03),
        rgba(255,255,255,.03) 1px,
        transparent 1px,
        transparent 4px
      );
      opacity:.22;
      pointer-events:none;
    }

    /* Top controls (clickable) */
    .topbar{
      position:absolute;
      top: calc(10px + var(--safe-top));
      left: calc(10px + var(--safe-left));
      right: calc(10px + var(--safe-right));
      display:flex;
      gap:10px;
      align-items:center;
      pointer-events:auto;
      z-index:10;
    }
    .chip{
      display:flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid rgba(0,200,255,.28);
      background:rgba(5,10,20,.70);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      font-family:Orbitron,system-ui;
      font-weight:800;
      letter-spacing:1px;
      font-size:11px;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .chip:active{ transform:scale(.98); }
    .chip .dot{
      width:8px; height:8px; border-radius:50%;
      background:var(--danger);
      box-shadow:0 0 10px rgba(255,68,102,.65);
    }
    .chip.ok .dot{ background:var(--primary); box-shadow:0 0 10px rgba(0,255,136,.65); }
    .chip.secondary{ border-color: rgba(0,255,255,.25); }
    .spacer{ flex:1; }

    /* Diamonds battery (top-right) */
    .battery{
      position:absolute;
      top: calc(10px + var(--safe-top));
      right: calc(10px + var(--safe-right));
      width: 210px;
      padding:10px 14px 12px;
      border-radius:14px;
      background: transparent;
      border: none;
      backdrop-filter: none;
      box-shadow: none;
      pointer-events:none;
      z-index:5;
    }
    .battery .title{
      display:flex; justify-content:space-between; align-items:center;
      font-family:Orbitron,system-ui;
      font-weight:900;
      letter-spacing:2px;
      font-size:9px;
      text-transform:uppercase;
      color:rgba(0,200,255,.75);
      margin-bottom:4px;
    }
    .battery .value{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:13px;
      letter-spacing:1.5px;
      color:rgba(255,255,255,.80);
      text-shadow:0 0 10px rgba(0,200,255,.40);
    }
    .batteryBar{
      position:relative;
      height:14px;
      border-radius:4px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(0,200,255,.18);
      overflow:hidden;
      direction: rtl;
    }
    .batteryFill{
      position:absolute; right:0; top:0; bottom:0;
      width:0%;
      border-radius:3px;
      background: linear-gradient(270deg, #00c8ff, #60a5fa, #a855f7);
      box-shadow: 0 0 14px rgba(0,200,255,.50);
      transition: width 0.8s ease;
      overflow:hidden;
    }
    .batteryFill::before{
      content:'';
      position:absolute; top:0; bottom:0;
      width:28%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      animation: barScan 3.0s ease-in-out infinite;
      z-index:3;
      pointer-events:none;
    }
    .batteryFill::after{
      content:'';
      position:absolute; top:-10%; bottom:-10%;
      width:22%;
      background: linear-gradient(105deg, transparent, rgba(255,255,255,.20), transparent);
      animation: shimmer 5.0s ease-in-out infinite;
      z-index:4;
      pointer-events:none;
    }
    .batterySpark{
      position:absolute;
      right:-3px; top:50%;
      transform:translateY(-50%);
      width:7px; height:7px;
      border-radius:50%;
      z-index:5;
      pointer-events:none;
      animation: spark 2.0s ease-in-out infinite;
      background:#00c8ff;
      box-shadow:0 0 10px #00c8ff;
    }
    .batteryBar::after{
      content:'';
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent calc(10% - 1px),
        rgba(0,0,0,.35) calc(10% - 1px),
        rgba(0,0,0,.35) 10%
      );
      pointer-events:none;
      z-index:2;
    }
    .batteryShell,.batteryBody,.cells,.cell,.batteryTip{ display:none; }
        /* Badges cards (top-right, below battery) */
    .badges{
      position:absolute;
      top: calc(10px + var(--safe-top));
      left: calc(10px + var(--safe-left));
      width: 80px;
      height: 88px;
      pointer-events:none;
      z-index:5;
    }
    .cardStack{
      position:relative; width:100%; height:100%;
    }
    .badgeCard{
      position:absolute; inset:auto;
      width: 62px; height: 62px;
      border-radius:10px;
      background: rgba(5,10,20,.42);
      border: 1px solid rgba(0,200,255,.22);
      backdrop-filter: blur(12px);
      box-shadow: 0 0 14px rgba(0,200,255,.12), inset 0 1px 0 rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:3px;
      font-family:Orbitron,system-ui;
      letter-spacing:1px;
    }
    .badgeCard:nth-child(1){ top:0; left:2px; transform:rotate(-6deg) translate(-5px, 3px); opacity:.40; }
    .badgeCard:nth-child(2){ top:5px; left:10px; transform:rotate(4deg) translate(4px, -3px); opacity:.62; }
    .badgeCard:nth-child(3){ top:16px; left:2px; transform:rotate(-1.5deg); opacity:1; border-color:rgba(0,200,255,.38); }
        .badgeLabel{ font-size:8px; font-weight:900; text-transform:uppercase; color:rgba(0,200,255,.80); letter-spacing:1.5px; }
    .badgeValue{ font-size:28px; font-weight:900; color:#ffffff; text-shadow:0 0 14px rgba(0,200,255,.60); line-height:1; }

    /* Krill bars (bottom-left) */
    .krill{
      position:absolute;
      bottom: calc(10px + var(--safe-bottom));
      left: calc(10px + var(--safe-left));
      width: 270px;
      height: auto;
      padding:12px 14px 12px;
      border-radius:16px;
      background: transparent;
      border: none;
      backdrop-filter: none;
      box-shadow: none;
      pointer-events:none;
    }
    .krillHeader{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px;
      padding-bottom:6px;
      border-bottom:1px solid rgba(0,200,255,.14);
    }
    .krillHeader .t{
      font-family:Orbitron,system-ui;
      font-size:10px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      color:rgba(0,200,255,.90);
    }
    .krillTitle{
      font-family:Orbitron,system-ui;
      font-size:9px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      color:rgba(0,200,255,.75);
    }
    .krillFooter{
      font-family:Orbitron,system-ui;
      font-size:9px;
      font-weight:900;
      letter-spacing:1.5px;
      text-transform:uppercase;
      color:rgba(255,255,255,.60);
      margin-top:6px;
      text-align:left;
    }
    .krillHeader .total{
      font-family:Orbitron,system-ui;
      font-size:10px;
      font-weight:900;
      letter-spacing:1px;
      color:#ffffff;
      text-shadow:0 0 10px rgba(0,200,255,.40);
    }

    /* Horizontal stacked bars */
    .bars{
      display:flex;
      flex-direction:column;
      gap:7px;
      width:100%;
    }
    .barRow{
      display:flex;
      align-items:center;
      gap:7px;
      width:100%;
    }
    .lbl{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:8px;
      letter-spacing:1px;
      text-transform:uppercase;
      width:22px;
      text-align:right;
      flex-shrink:0;
    }
    .barRow.common   .lbl{ color:rgba(74,222,128,.90); }
    .barRow.rare     .lbl{ color:rgba(96,165,250,.90); }
    .barRow.epic     .lbl{ color:rgba(168,85,247,.90); }
    .barRow.legendary .lbl{ color:rgba(250,204,21,.90); }

    .bar{
      flex:1;
      height:14px;
      border-radius:4px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      position:relative;
    }
    .barRow.common   .bar{ border-color:rgba(74,222,128,.18); }
    .barRow.rare     .bar{ border-color:rgba(96,165,250,.18); }
    .barRow.epic     .bar{ border-color:rgba(168,85,247,.18); }
    .barRow.legendary .bar{ border-color:rgba(250,204,21,.20); }

    /* segmented ticks overlay */
    .bar::after{
      content:'';
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent calc(10% - 1px),
        rgba(0,0,0,.35) calc(10% - 1px),
        rgba(0,0,0,.35) 10%
      );
      pointer-events:none;
      z-index:2;
    }
    /* scan line sweeping over fill */
    .fill::before{
      content:'';
      position:absolute; top:0; bottom:0;
      width:28%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      animation: barScan 2.8s ease-in-out infinite;
      z-index:3;
      pointer-events:none;
      border-radius:4px;
    }
    /* shimmer diagonal */
    .fill::after{
      content:'';
      position:absolute; top:-10%; bottom:-10%;
      width:22%;
      background: linear-gradient(105deg, transparent, rgba(255,255,255,.20), transparent);
      animation: shimmer 4.5s ease-in-out infinite;
      z-index:4;
      pointer-events:none;
    }
    /* spark at tip */
    .spark{
      position:absolute;
      left:-3px; top:50%;
      transform:translateY(-50%);
      width:7px; height:7px;
      border-radius:50%;
      z-index:5;
      pointer-events:none;
      animation: spark 1.8s ease-in-out infinite;
    }
    .barRow.common   .spark{ background:#4ade80; box-shadow:0 0 8px #4ade80; }
    .barRow.rare     .spark{ background:#60a5fa; box-shadow:0 0 8px #60a5fa; }
    .barRow.epic     .spark{ background:#a855f7; box-shadow:0 0 8px #a855f7; }
    .barRow.legendary .spark{ background:#facc15; box-shadow:0 0 8px #facc15; }
    .fill{
      height:100%;
      width:0%;
      min-width:3px;
      border-radius:3px;
      opacity:.95;
      transition: width 0.7s cubic-bezier(.22,.68,0,1.2);
      position:relative;
      z-index:1;
    }
    .barRow.common   .fill{ background:linear-gradient(90deg,#2a9d60,#4ade80,#6ee7a0); box-shadow:0 0 10px rgba(74,222,128,.40); }
    .barRow.rare     .fill{ background:linear-gradient(90deg,#1d6fa8,#60a5fa,#93c5fd); box-shadow:0 0 10px rgba(96,165,250,.40); }
    .barRow.epic     .fill{ background:linear-gradient(90deg,#6b21a8,#a855f7,#c084fc); box-shadow:0 0 10px rgba(168,85,247,.40); }
    .barRow.legendary .fill{ background:linear-gradient(90deg,#b45309,#facc15,#fde68a); box-shadow:0 0 10px rgba(250,204,21,.45); }

    .num{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:9px;
      color:#ffffff;
      width:28px;
      text-align:right;
      flex-shrink:0;
      opacity:.85;
    }

    /* HUD chat (bottom-right) */
    .hudChat{
      position:absolute;
      bottom: calc(10px + var(--safe-bottom));
      right: calc(10px + var(--safe-right));
      width: 320px;
      max-width: calc(100vw - 24px);
      padding:10px 14px 12px;
      border-radius:16px;
      background: var(--glass2);
      border:1px solid rgba(0,200,255,.25);
      backdrop-filter: blur(14px);
      box-shadow: 0 0 22px rgba(0,200,255,.14), inset 0 1px 0 rgba(255,255,255,.05);
      pointer-events:none;
    }
    .hudChatTitle{
      display:flex; align-items:center; justify-content:space-between;
      font-family:Orbitron,system-ui;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:9px;
      color:rgba(255,255,255,.85);
      margin-bottom:8px;
    }
    .hudChatTitle .status{
      display:flex; align-items:center; gap:6px;
      font-family:Orbitron,system-ui;
      font-size:9px;
      letter-spacing:1px;
      color:rgba(255,255,255,.70);
    }
    .hudChatTitle .lamp{
      width:8px; height:8px; border-radius:50%;
      background:var(--danger);
      box-shadow:0 0 10px rgba(255,68,102,.45);
    }
    .hudChatTitle .lamp.ok{
      background:var(--primary);
      box-shadow:0 0 10px rgba(0,255,136,.45);
    }

    .msg{
      display:flex;
      gap:6px;
      font-size:12px;
      line-height:1.2;
      margin:4px 0;
      opacity:.92;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .msg .a{
      color:#4ade80;
      font-weight:700;
      flex:0 0 auto;
      max-width:38%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .msg .t{
      color:rgba(255,255,255,.88);
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Mobile friendliness */
    @media (max-width: 420px){
      .battery{ width:170px; }
      .hudChat{ width: 280px; }
      .krill{ width: 240px; }
      .badges{ width: 80px; }
      .badgeCard{ width:80px; height:80px; }
    }


    .topbar.hidden{
      opacity:0;
      transform: translateY(-10px);
      pointer-events:none;
    }
    .topbar{
      transition: opacity .25s ease, transform .25s ease;
    }
    .tapHint{
      position:absolute;
      top: calc(14px + var(--safe-top));
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-family: Orbitron, system-ui;
      font-weight:900;
      font-size:9px;
      letter-spacing:2px;
      text-transform:uppercase;
      color: rgba(255,255,255,.65);
      background: rgba(5,10,20,.45);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 7px 14px;
      backdrop-filter: blur(8px);
      display:none;
      pointer-events:none;
      z-index:15;
    }
    .tapHint.show{ display:block; }
    .miniBtn{
      position:absolute;
      bottom: calc(10px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
      pointer-events:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .miniBtn button{
      border:1px solid rgba(0,200,255,.30);
      background: rgba(5,10,20,.70);
      color:#e8fff6;
      border-radius: 14px;
      padding: 10px 14px;
      font-family: Orbitron, system-ui;
      font-weight:900;
      letter-spacing:2px;
      font-size:10px;
      text-transform:uppercase;
      cursor:pointer;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 18px rgba(0,255,136,.10);
    }
    .miniBtn button:active{ transform: scale(.98); }

    /* Safe overlay for ‚Äúrotate device‚Äù */
    .rotateHint{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      text-align:center;
      padding:24px;
      background:rgba(6,11,20,.88);
      z-index:999;
      pointer-events:none;
      font-family:Orbitron,system-ui;
      letter-spacing:2px;
      text-transform:uppercase;
      color:#fff;
    }
    .rotateHint .box{
      max-width:520px;
      border:1px solid rgba(0,255,136,.25);
      border-radius:18px;
      padding:20px 18px;
      background:rgba(5,10,20,.45);
      box-shadow:0 0 22px rgba(0,255,136,.15);
    }
    .rotateHint .big{ font-size:14px; font-weight:900; margin-bottom:10px; }
    .rotateHint .small{ font-family:Rajdhani,system-ui; font-size:14px; letter-spacing:0; text-transform:none; opacity:.85; }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes barGlow {
      0%, 100% { opacity: .95; filter: brightness(1); }
      50%       { opacity: 1;   filter: brightness(1.25); }
    }
    /* 1. Scan line sweeping left to right */
    @keyframes barScan {
      0%   { left: -30%; opacity: .7; }
      100% { left: 110%; opacity: .0; }
    }
    /* 2. Particle spark at tip */
    @keyframes spark {
      0%         { opacity: 0; transform: scale(0.4); }
      20%, 60%   { opacity: 1; transform: scale(1.2); }
      100%       { opacity: 0; transform: scale(0.6) translateY(-4px); }
    }
    /* 4. Shimmer diagonal */
    @keyframes shimmer {
      0%   { left: -60%; }
      100% { left: 130%; }
    }
    /* 3. Fill from zero on load */
    @keyframes fillIn {
      from { width: 0% !important; }
    }
    @keyframes batteryPulse {
      0%, 100% { box-shadow: 0 0 10px rgba(0,200,255,.40); }
      50%       { box-shadow: 0 0 22px rgba(0,200,255,.85); }
    }
    @keyframes batteryLow {
      0%, 100% { box-shadow: 0 0 10px rgba(255,68,102,.40); }
      50%       { box-shadow: 0 0 22px rgba(255,68,102,.90); }
    }
    @keyframes badgeFloat {
      0%, 100% { transform: rotate(-1.5deg) translateY(0px); }
      50%       { transform: rotate(-1.5deg) translateY(-4px); }
    }
    @keyframes badgeBorderPulse {
      0%, 100% { border-color: rgba(0,200,255,.38); box-shadow: 0 0 14px rgba(0,200,255,.12); }
      50%       { border-color: rgba(0,200,255,.75); box-shadow: 0 0 20px rgba(0,200,255,.35); }
    }
    @keyframes scanPulse {
      0%, 100% { opacity: .22; }
      50%       { opacity: .32; }
    }

    /* Apply animations */
    .fill{
      animation: barGlow 2.8s ease-in-out infinite, fillIn 1.2s ease-out 1;
    }
    .barRow.legendary .fill{ animation: barGlow 2.2s ease-in-out infinite, fillIn 1.2s ease-out 1; }
    .barRow.legendary .fill::before{ animation-duration: 2.4s; animation-delay: 0s; }
    .barRow.legendary .fill::after { animation-duration: 4.0s; animation-delay: 0s; }
    .barRow.epic      .fill{ animation: barGlow 3.0s ease-in-out infinite, fillIn 1.4s ease-out 1; }
    .barRow.epic      .fill::before{ animation-duration: 3.1s; animation-delay: .4s; }
    .barRow.epic      .fill::after { animation-duration: 5.0s; animation-delay: .5s; }
    .barRow.rare      .fill{ animation: barGlow 2.6s ease-in-out infinite, fillIn 1.6s ease-out 1; }
    .barRow.rare      .fill::before{ animation-duration: 2.7s; animation-delay: .7s; }
    .barRow.rare      .fill::after { animation-duration: 4.5s; animation-delay: .3s; }
    .barRow.common    .fill{ animation: barGlow 3.2s ease-in-out infinite, fillIn 1.8s ease-out 1; }
    .barRow.common    .fill::before{ animation-duration: 3.3s; animation-delay: .9s; }
    .barRow.common    .fill::after { animation-duration: 5.5s; animation-delay: .8s; }

    .batteryFill{
      animation: batteryPulse 2.4s ease-in-out infinite;
    }
    .batteryFill.low{
      animation: batteryLow 1.0s ease-in-out infinite;
    }

    .badgeCard:nth-child(3){
      animation: badgeFloat 3.5s ease-in-out infinite, badgeBorderPulse 3.5s ease-in-out infinite;
    }
    .scanlines{
      animation: scanPulse 4s ease-in-out infinite;
    }
  </style>
</head>

<body>
  <div class="stage">
    <video id="cam" autoplay playsinline muted></video>

    <div class="hud">
      <div class="scanlines"></div>

      <!-- clickable controls -->
      <div class="topbar">
        <div class="chip" id="btnStart">
          <span class="dot" id="camDot"></span>
          <span id="camLabel">C√ÅMARA: OFF</span>
        </div>

        <div class="chip secondary" id="btnFlip">
          ‚áÑ ESPEJO
        </div>
        <div class="spacer"></div>

        <div class="chip" id="btnReloadStats" title="Refrescar stats desde localStorage">
          ‚Üª STATS
        </div>
      </div>

      <!-- Diamonds battery -->
      <div class="battery" aria-label="Diamantes">
        <div class="batteryBar">
          <div class="batteryFill" id="batteryFill"></div><div class="batterySpark" id="batterySpark"></div>
        </div>
        <div class="title" style="margin-top:4px;">
          <span>‚ö° BATER√çA</span>
          <span class="value" id="diamondsVal">0</span>
        </div>
        <!-- keep old cells hidden for JS compat -->
        <div style="display:none"><div class="cells" id="diamondCells"></div></div>
      </div>

      <!-- Badges cards -->
      <div class="badges" aria-label="Insignias">
        <div class="cardStack">
          <div class="badgeCard">
            <span class="badgeValue" id="badgesValGhost1">0</span>
          </div>
          <div class="badgeCard">
            <span class="badgeValue" id="badgesValGhost2">0</span>
          </div>
          <div class="badgeCard">
            <span class="badgeLabel">INSIGNIAS</span>
            <span class="badgeValue" id="badgesVal">0</span>
          </div>
        </div>
      </div>

      <!-- Krill bars -->
      <div class="krill" aria-label="Parcela por rareza">
        <div class="bars">
          <div class="barRow legendary">
            <div class="num" id="numLegendary">0</div>
            <div class="bar"><div class="fill" id="fillLegendary"></div><div class="spark"></div></div>
          </div>
          <div class="barRow epic">
            <div class="num" id="numEpic">0</div>
            <div class="bar"><div class="fill" id="fillEpic"></div><div class="spark"></div></div>
          </div>
          <div class="barRow rare">
            <div class="num" id="numRare">0</div>
            <div class="bar"><div class="fill" id="fillRare"></div><div class="spark"></div></div>
          </div>
          <div class="barRow common">
            <div class="num" id="numCommon">0</div>
            <div class="bar"><div class="fill" id="fillCommon"></div><div class="spark"></div></div>
          </div>
        </div>
        <div class="krillFooter"><span class="krillTitle">STATS</span> &nbsp;¬∑&nbsp; TOTAL: <span id="totalParcels">0</span></div>
      </div>

      <!-- Last 5 chat messages -->
      <div class="hudChat" aria-label="√öltimos 5 mensajes">
        <div class="hudChatTitle">
          <span>üí¨ CHAT AEMX (√öLTIMOS 5)</span>
          <span class="status"><span class="lamp" id="chatLamp"></span><span id="chatState">OFF</span></span>
        </div>
        <div id="chatLines">
          <div class="msg"><span class="a">‚Äî</span><span class="t">Conecta la c√°mara y Firebase para ver actividad.</span></div>
        </div>
      </div>
    </div>

    
    <div class="miniBtn">
      <button id="btnUI">HUD</button>
      <button id="btnFS">FULL</button>
    </div>
    <div class="tapHint" id="tapHint">TOCA PARA MOSTRAR CONTROLES</div>

    <div class="rotateHint" id="rotateHint">
      <div class="box">
        <div class="big">GIRA EL TEL√âFONO A HORIZONTAL</div>
        <div class="small">Tip: en iPhone, Safari es medio terco‚Ä¶ pero con FULL + girar, queda üëå</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, ref, query, limitToLast, orderByChild, onValue } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 1) Stats source (GamerTag localStorage)
    // SAVE_KEY identificado en tu index: 'atlas-earth-calc-data'
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SAVE_KEY = 'atlas-earth-calc-data';

    function toInt(x){
      const n = Number(String(x ?? '').replace(/[^\d.-]/g,''));
      return Number.isFinite(n) ? Math.max(0, Math.floor(n)) : 0;
    }

    function readStats(){
      // 1) Preferir JSON del SAVE_KEY
      let d = null;
      try{
        const raw = localStorage.getItem(SAVE_KEY);
        if(raw) d = JSON.parse(raw);
      }catch(e){ d = null; }

      // 2) Fallback: leer claves sueltas si existieran
      const fallback = (k) => {
        try { return localStorage.getItem(k); } catch(e){ return null; }
      };

      const common     = toInt(d?.common     ?? fallback('common'));
      const rare       = toInt(d?.rare       ?? fallback('rare'));
      const epic       = toInt(d?.epic       ?? fallback('epic'));
      const legendary  = toInt(d?.legendary  ?? fallback('legendary'));
      const badges     = toInt(d?.badges     ?? fallback('badges'));
      const diamonds   = toInt(d?.diamonds   ?? fallback('diamonds'));
      const atlasbucks = toInt(d?.atlasbucks ?? fallback('atlasbucks'));

      return { common, rare, epic, legendary, badges, diamonds, atlasbucks };
    }

    function renderStats(s){
      // numbers
      document.getElementById('numCommon').textContent = s.common;
      document.getElementById('numRare').textContent = s.rare;
      document.getElementById('numEpic').textContent = s.epic;
      document.getElementById('numLegendary').textContent = s.legendary;

      const total = Math.max(0, s.common + s.rare + s.epic + s.legendary);
      document.getElementById('totalParcels').textContent = total;
      // 100% = next hundred above commons (e.g. 1450 ‚Üí 1500)
      const refMax = s.common > 0 ? Math.ceil(s.common / 100) * 100 : 100;
      const pct = (v) => Math.min(100, Math.round((v / refMax) * 100));
      document.getElementById('fillCommon').style.width = pct(s.common) + '%';
      document.getElementById('fillRare').style.width = pct(s.rare) + '%';
      document.getElementById('fillEpic').style.width = pct(s.epic) + '%';
      document.getElementById('fillLegendary').style.width = pct(s.legendary) + '%';

      // badges cards
      document.getElementById('badgesVal').textContent = s.badges;
      document.getElementById('badgesValGhost1').textContent = s.badges;
      document.getElementById('badgesValGhost2').textContent = s.badges;

      // diamonds battery (0..9999)
      const d = Math.min(9999, s.diamonds);
      document.getElementById('diamondsVal').textContent = d.toLocaleString('es-MX');

      // New battery bar
      const battFill = document.getElementById('batteryFill');
      const battSpark = document.getElementById('batterySpark');
      if(battFill){
        const pctBatt = Math.round((d / 9999) * 100);
        battFill.style.width = pctBatt + '%';
        battFill.classList.toggle('low', pctBatt < 20);
        if(battSpark) battSpark.style.right = (100 - pctBatt) + '%';
      }
    }

    function refreshStats(){
      renderStats(readStats());
    }

    // update on load + on storage changes
    refreshStats();
    window.addEventListener('storage', (e) => {
      if(e.key === SAVE_KEY || ['common','rare','epic','legendary','badges','diamonds','atlasbucks'].includes(e.key)) {
        refreshStats();
      }
    });
    // also poll (mobile Safari sometimes doesn‚Äôt dispatch storage reliably across tabs)
    setInterval(refreshStats, 1200);

    document.getElementById('btnReloadStats').addEventListener('click', refreshStats);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 2) Camera
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const camVideo = document.getElementById('cam');
    const btnStart = document.getElementById('btnStart');
    const camDot = document.getElementById('camDot');
    const camLabel = document.getElementById('camLabel');
    const btnFlip = document.getElementById('btnFlip');
    const btnFullscreen = document.getElementById('btnFullscreen');
    const rotateHint = document.getElementById('rotateHint');

    const btnUI = document.getElementById('btnUI');
    const btnFS = document.getElementById('btnFS');
    const topbar = document.querySelector('.topbar');
    const tapHint = document.getElementById('tapHint');

    let uiHidden = true;
    let uiTimer = null;

    function showUI(temp=true){
      uiHidden = false;
      topbar.classList.remove('hidden');
      tapHint.classList.remove('show');
      if(uiTimer) clearTimeout(uiTimer);
      if(temp){
        uiTimer = setTimeout(() => hideUI(), 2600);
      }
    }
    function hideUI(){
      uiHidden = true;
      topbar.classList.add('hidden');
      tapHint.classList.add('show');
    }

    // start hidden (requested)
    hideUI();

    // Tap anywhere to show controls briefly
    const reveal = (e) => {
      if(e && (e.target?.closest?.('.topbar') || e.target?.closest?.('.miniBtn'))) return;
      showUI(true);
    };
    document.addEventListener('pointerdown', reveal, {passive:true});
    document.addEventListener('touchstart', reveal, {passive:true});
    document.addEventListener('click', reveal);

    btnUI.addEventListener('click', () => {
      if(uiHidden) showUI(false);
      else hideUI();
    });

    async function toggleFullscreen(){
      try{
        if(!document.fullscreenElement){
          await document.documentElement.requestFullscreen?.();
          await requestLandscapeLock();
        }else{
          await document.exitFullscreen?.();
        }
      }catch(e){}
      syncFSLabel();
      checkOrientationHint();
    }

    function syncFSLabel(){
      const on = !!document.fullscreenElement;
      btnFS.textContent = on ? 'SALIR' : 'FULL';
      // keep original chip label if visible
      try{ document.getElementById('btnFullscreen').textContent = on ? '‚õ∂ SALIR' : '‚õ∂ FULL'; }catch(e){}
    }

    btnFS.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', syncFSLabel);
    syncFSLabel();


    let camStream = null;
    let mirrored = true;

    function setCamState(on){
      camDot.classList.toggle('ok', on);
      btnStart.classList.toggle('ok', on);
      camLabel.textContent = on ? 'C√ÅMARA: ON' : 'C√ÅMARA: OFF';
    }

    async function startCamera(){
      if(camStream) return;
      try{
        camStream = await navigator.mediaDevices.getUserMedia({
          audio:false,
          video:{
            facingMode:{ ideal:'environment' },
            width:{ ideal:1280 },
            height:{ ideal:720 }
          }
        });
        camVideo.srcObject = camStream;
        setCamState(true);
      }catch(e){
        console.error('getUserMedia error:', e);
        alert('No se pudo abrir la c√°mara. Revisa permisos del navegador.');
        setCamState(false);
      }
    }

    function stopCamera(){
      if(!camStream) return;
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
      camVideo.srcObject = null;
      setCamState(false);
    }

    btnStart.addEventListener('click', async () => {
      if(camStream) stopCamera();
      else await startCamera();
    });

    btnFlip.addEventListener('click', () => {
      mirrored = !mirrored;
      camVideo.style.transform = mirrored ? 'scaleX(-1)' : 'scaleX(1)';
    });

    async function requestLandscapeLock(){
      try{
        if(screen.orientation && screen.orientation.lock){
          await screen.orientation.lock('landscape');
        }
      }catch(e){
        // iOS Safari: no soporta lock (ignorar)
      }
    }

    btnFullscreen.addEventListener('click', async () => {
      if (typeof toggleFullscreen === 'function') {
        await toggleFullscreen();
        return;
      }
      try{ await document.documentElement.requestFullscreen?.(); }catch(e){}
      await requestLandscapeLock();
      checkOrientationHint();
    });

    function checkOrientationHint(){
      // show hint if portrait (best-effort)
      const isPortrait = window.matchMedia && window.matchMedia("(orientation: portrait)").matches;
      rotateHint.style.display = isPortrait ? 'flex' : 'none';
    }
    window.addEventListener('resize', checkOrientationHint);
    window.addEventListener('orientationchange', checkOrientationHint);
    checkOrientationHint();

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 3) Firebase: last 5 messages (read-only HUD)
    // Config copiada del chat-firebase.html
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const firebaseConfig = {
      apiKey: "AIzaSyB-xx2PlBjvnHe0K7Bf1MspVqUlfjky0mk",
      authDomain: "aemx-chat.firebaseapp.com",
      databaseURL: "https://aemx-chat-default-rtdb.firebaseio.com",
      projectId: "aemx-chat",
      storageBucket: "aemx-chat.appspot.com",
      messagingSenderId: "267113002594",
      appId: "1:267113002594:web:4099e7537d950f5753433b",
      measurementId: "G-K84EVPE46R"
    };

    const chatLamp = document.getElementById('chatLamp');
    const chatState = document.getElementById('chatState');
    const chatLines = document.getElementById('chatLines');

    function setChatState(on, label){
      chatLamp.classList.toggle('ok', on);
      chatState.textContent = label || (on ? 'ON' : 'OFF');
    }

    function safeStr(x, max=140){
      const s = String(x ?? '').replace(/\s+/g,' ').trim();
      if(!s) return '';
      return s.length > max ? s.slice(0, max-1) + '‚Ä¶' : s;
    }

    function renderChat(list){
      chatLines.innerHTML = '';
      if(!list.length){
        chatLines.innerHTML = '<div class="msg"><span class="a">‚Äî</span><span class="t">Sin mensajes recientes.</span></div>';
        return;
      }
      for(const m of list){
        const row = document.createElement('div');
        row.className = 'msg';

        const a = document.createElement('span');
        a.className = 'a';
        a.textContent = safeStr(m.username || m.user || m.author || m.name || 'AEMX', 22);

        const t = document.createElement('span');
        t.className = 't';
        t.textContent = safeStr(m.text || m.message || m.msg || m.mensaje || '', 120) || '‚Ä¶';

        row.appendChild(a);
        row.appendChild(t);
        chatLines.appendChild(row);
      }
    }

    try{
      const app = initializeApp(firebaseConfig, 'hud-app');
      const db  = getDatabase(app);
      const auth = getAuth(app);

      // Helper to attach listener once we have auth (or at least tried)
      const attachListener = () => {
        const q = query(ref(db, 'messages'), orderByChild('timestamp'), limitToLast(5));

        onValue(q, (snap) => {
          const arr = [];
          if(snap.exists()){
            snap.forEach(child => arr.push(child.val()));
            arr.sort((a,b) => {
              const ta = typeof a.timestamp === 'number' ? a.timestamp : 0;
              const tb = typeof b.timestamp === 'number' ? b.timestamp : 0;
              return ta - tb;
            });
          }
          renderChat(arr);
          setChatState(true, 'LIVE');
        }, (err) => {
          console.error('HUD chat onValue error:', err);
          setChatState(false, 'DENIED');
          renderChat([]);
        });
      };

      // Reutiliza la sesi√≥n Google activa del index.html (misma app Firebase)
      onAuthStateChanged(auth, (user) => {
        if(user){
          attachListener();
        } else {
          setChatState(false, 'SIN SESI√ìN');
          renderChat([]);
        }
      });

    }catch(e){
      console.error('Firebase init error:', e);
      setChatState(false, 'ERR');
    }

    // Start camera automatically? -> NO (avoid instant permission prompt)
    setCamState(false);
  </script>
</body>
</html>
