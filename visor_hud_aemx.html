<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,interactive-widget=resizes-content" />
  <title>AEMX Visor HUD (C√°mara + Stats + √öltimos 5 mensajes)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #00c8ff;
      --glow:    #00c8ff;
      --gold:    #facc15;
      --green:   #4ade80;
      --blue:    #60a5fa;
      --purple:  #a855f7;
      --yellow:  #facc15;
      --danger:  #ff4466;
      --text:    #ffffff;
      --glass:   rgba(5,10,20,.52);
      --glass2:  rgba(5,10,20,.72);
      --stroke:  rgba(0,200,255,.30);
      --shadow:  0 0 20px rgba(0,200,255,.15);
      --safe-top:    env(safe-area-inset-top);
      --safe-right:  env(safe-area-inset-right);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left:   env(safe-area-inset-left);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:#060b14; color:var(--text); font-family:Rajdhani,system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden; }
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(var(--primary) 1px,transparent 1px),
        linear-gradient(90deg,var(--primary) 1px,transparent 1px);
      background-size:52px 52px;
      opacity:.38;
      pointer-events:none;
      z-index:0;
      animation: gridEnergy 3.5s ease-in-out infinite;
      -webkit-mask-image:
        radial-gradient(ellipse 60% 90% at 50% 50%,
          black 30%, transparent 100%),
        radial-gradient(ellipse 100% 40% at 50% 50%,
          black 40%, transparent 100%);
      -webkit-mask-composite: source-in;
      mask-image:
        radial-gradient(ellipse 60% 90% at 50% 50%,
          black 30%, transparent 100%),
        radial-gradient(ellipse 100% 40% at 50% 50%,
          black 40%, transparent 100%);
      mask-composite: intersect;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(var(--primary) 1px,transparent 1px),
        linear-gradient(90deg,var(--primary) 1px,transparent 1px);
      background-size:52px 52px;
      opacity:.12;
      pointer-events:none;
      z-index:0;
      animation: gridEnergy 3.5s ease-in-out infinite reverse;
    }

    /* Stage */
    .stage{
      position:fixed; inset:0;
      z-index:1;
      display:block;
      background:#000;
    }
    video#cam{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      transform:scaleX(1); /* sin espejo por defecto */
      background:#000;
    }
    /* HUD Overlay */
    .hud{
      position:absolute; inset:0;
      pointer-events:none;
    }

    .hud::before{
      display:none;
    }
    /* Corner accent lines */
    .hud::after{
      content:"";
      position:absolute; inset:0;
      background:
        /* top-left corner */
        linear-gradient(90deg, rgba(0,200,255,.55) 0px, rgba(0,200,255,.55) 40px, transparent 40px) 0 0 / 100% 1px no-repeat,
        linear-gradient(180deg, rgba(0,200,255,.55) 0px, rgba(0,200,255,.55) 40px, transparent 40px) 0 0 / 1px 100% no-repeat,
        /* top-right corner */
        linear-gradient(90deg, transparent calc(100% - 40px), rgba(0,200,255,.55) calc(100% - 40px), rgba(0,200,255,.55) 100%) 0 0 / 100% 1px no-repeat,
        linear-gradient(180deg, rgba(0,200,255,.55) 0px, rgba(0,200,255,.55) 40px, transparent 40px) 100% 0 / 1px 100% no-repeat,
        /* bottom-left corner */
        linear-gradient(90deg, rgba(0,200,255,.55) 0px, rgba(0,200,255,.55) 40px, transparent 40px) 0 100% / 100% 1px no-repeat,
        linear-gradient(180deg, transparent calc(100% - 40px), rgba(0,200,255,.55) calc(100% - 40px), rgba(0,200,255,.55) 100%) 0 0 / 1px 100% no-repeat,
        /* bottom-right corner */
        linear-gradient(90deg, transparent calc(100% - 40px), rgba(0,200,255,.55) calc(100% - 40px)) 0 100% / 100% 1px no-repeat,
        linear-gradient(180deg, transparent calc(100% - 40px), rgba(0,200,255,.55) calc(100% - 40px)) 100% 0 / 1px 100% no-repeat,
        /* vignette */
        radial-gradient(ellipse 100% 100% at 50% 50%, transparent 50%, rgba(0,0,0,.55) 100%);
      pointer-events:none;
    }
    .scanlines{
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.03),
        rgba(255,255,255,.03) 1px,
        transparent 1px,
        transparent 4px
      );
      opacity:.22;
      pointer-events:none;
    }

    /* Top controls (clickable) */
    .topbar{
      position:absolute;
      top: calc(10px + var(--safe-top));
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      gap:4px;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
      z-index:10;
      background: rgba(5,10,20,.55);
      border: 1px solid rgba(0,200,255,.18);
      border-radius: 12px;
      padding: 4px 6px;
      backdrop-filter: blur(10px);
    }
    .chip{
      display:flex; align-items:center; gap:5px;
      padding:5px 9px;
      border-radius:8px;
      border:1px solid rgba(0,200,255,.20);
      background:rgba(0,200,255,.07);
      font-family:Orbitron,system-ui;
      font-weight:800;
      letter-spacing:1px;
      font-size:9px;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .chip:active{ transform:scale(.96); }
    .chip:hover{ background:rgba(0,200,255,.14); }
    .chip .dot{
      width:6px; height:6px; border-radius:50%;
      background:var(--danger);
      box-shadow:0 0 6px rgba(255,68,102,.65);
      flex-shrink:0;
    }
    .chip.ok .dot{ background:#4ade80; box-shadow:0 0 6px rgba(74,222,128,.65); }
    .chip.secondary{ border-color: rgba(0,255,255,.18); }
    .spacer{ display:none; }

    /* Diamonds battery (top-right) ‚Äî forma de bater√≠a */
    .battery{
      position:absolute;
      top: calc(10px + var(--safe-top));
      right: calc(10px + var(--safe-right));
      width: 210px;
      padding:8px 14px 10px;
      border-radius:0;
      background: transparent;
      border: none;
      backdrop-filter: none;
      box-shadow: none;
      pointer-events:none;
      z-index:5;
    }
    .battery .title{
      display:flex; justify-content:space-between; align-items:center;
      font-family:Orbitron,system-ui;
      font-weight:900;
      letter-spacing:2px;
      font-size:9px;
      text-transform:uppercase;
      color:rgba(0,200,255,.80);
      margin-bottom:7px;
    }
    .battery .value{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:13px;
      letter-spacing:2px;
      color:#fff;
      text-shadow: 0 0 10px rgba(0,200,255,.60);
    }
    /* Contenedor con forma de bater√≠a: cuerpo + tip */
    .batteryBar{
      position:relative;
      display:flex;
      align-items:center;
      height:22px;
    }
    /* Cuerpo principal */
    .batteryBar::before{
      content:'';
      position:absolute;
      left:0; top:0; bottom:0;
      right:8px;
      border-radius:5px 3px 3px 5px;
      background: rgba(0,0,0,.50);
      border: 1.5px solid rgba(255,255,255,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.07);
    }
    /* Tip (polo positivo) */
    .batteryBar::after{
      content:'';
      position:absolute;
      right:0; top:50%;
      transform:translateY(-50%);
      width:6px; height:10px;
      border-radius:0 3px 3px 0;
      background: rgba(255,255,255,.18);
      border: 1.5px solid rgba(255,255,255,.18);
      border-left:none;
    }
    .batteryFill{
      position:absolute;
      left:2px; top:2px; bottom:2px;
      right:10px; /* respeta el tip */
      border-radius:3px 2px 2px 3px;
      width:0%; /* se sobreescribe con JS como % del espacio disponible */
      background: linear-gradient(90deg, #4ade80, #4ade80);
      box-shadow: 0 0 14px rgba(74,222,128,.65);
      transition: width 0.8s cubic-bezier(.22,.68,0,1.2), background 0.8s ease, box-shadow 0.8s ease;
      overflow:hidden;
      /* width se controla desde JS como porcentaje del contenedor interno */
    }
    .batteryFill::before{
      content:'';
      position:absolute; top:0; bottom:0;
      width:35%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      animation: barScan 2.6s ease-in-out infinite;
      z-index:3;
      pointer-events:none;
    }
    .batteryFill::after{
      content:'';
      position:absolute; left:0; right:0; top:0; height:40%;
      background: rgba(255,255,255,.15);
      border-radius:3px 2px 0 0;
      z-index:4;
      pointer-events:none;
    }
    .batterySpark{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:8px; height:8px;
      border-radius:50%;
      z-index:6;
      pointer-events:none;
      animation: spark 1.8s ease-in-out infinite;
      background: #fff;
      box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
    }
        /* Badges cards (top-right, below battery) */
    .badges{
      position:absolute;
      top: calc(10px + var(--safe-top));
      left: 10px;
      width: 80px;
      height: 88px;
      pointer-events:none;
      z-index:5;
    }
    .cardStack{
      position:relative; width:100%; height:100%;
    }
    .badgeCard{
      position:absolute; inset:auto;
      width: 62px; height: 62px;
      border-radius:10px;
      background: rgba(5,10,20,.42);
      border: 1px solid rgba(0,200,255,.22);
      backdrop-filter: blur(12px);
      box-shadow: 0 0 14px rgba(0,200,255,.12), inset 0 1px 0 rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:3px;
      font-family:Orbitron,system-ui;
      letter-spacing:1px;
    }
    .badgeCard:nth-child(1){ top:0; left:2px; transform:rotate(-6deg) translate(-5px, 3px); opacity:.40; }
    .badgeCard:nth-child(2){ top:5px; left:10px; transform:rotate(4deg) translate(4px, -3px); opacity:.62; }
    .badgeCard:nth-child(3){ top:16px; left:2px; transform:rotate(-1.5deg); opacity:1; border-color:rgba(0,200,255,.38); }
        .badgeLabel{ font-size:8px; font-weight:900; text-transform:uppercase; color:rgba(0,200,255,.80); letter-spacing:1.5px; }
    .badgeValue{ font-size:28px; font-weight:900; color:#ffffff; text-shadow:0 0 14px rgba(0,200,255,.60); line-height:1; }

    /* Krill bars (bottom-left) */
    .krill{
      position:absolute;
      bottom: calc(10px + var(--safe-bottom));
      left: 10px;
      width: 270px;
      height: auto;
      padding:8px 0 8px 0;
      border-radius:16px;
      background: transparent;
      border: none;
      backdrop-filter: none;
      box-shadow: none;
      pointer-events:none;
    }
    .krillHeader{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px;
      padding-bottom:6px;
      border-bottom:1px solid rgba(0,200,255,.14);
    }
    .krillHeader .t{
      font-family:Orbitron,system-ui;
      font-size:10px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      color:rgba(0,200,255,.90);
    }
    .krillTitle{
      font-family:Orbitron,system-ui;
      font-size:9px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      color:rgba(0,200,255,.75);
    }
    .krillFooter{
      font-family:Orbitron,system-ui;
      font-size:9px;
      font-weight:900;
      letter-spacing:1.5px;
      text-transform:uppercase;
      color:rgba(255,255,255,.60);
      margin-top:6px;
      text-align:left;
    }
    .krillHeader .total{
      font-family:Orbitron,system-ui;
      font-size:10px;
      font-weight:900;
      letter-spacing:1px;
      color:#ffffff;
      text-shadow:0 0 10px rgba(0,200,255,.40);
    }

    /* Horizontal stacked bars */
    .bars{
      display:flex;
      flex-direction:column;
      gap:7px;
      width:100%;
    }
    .barRow{
      display:flex;
      align-items:center;
      gap:7px;
      width:100%;
    }
    .lbl{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:8px;
      letter-spacing:1px;
      text-transform:uppercase;
      width:22px;
      text-align:right;
      flex-shrink:0;
    }
    .barRow.common   .lbl{ color:rgba(74,222,128,.90); }
    .barRow.rare     .lbl{ color:rgba(96,165,250,.90); }
    .barRow.epic     .lbl{ color:rgba(168,85,247,.90); }
    .barRow.legendary .lbl{ color:rgba(250,204,21,.90); }

    .bar{
      flex:1;
      height:14px;
      border-radius:4px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      position:relative;
    }
    .barRow.common   .bar{ border-color:rgba(74,222,128,.18); }
    .barRow.rare     .bar{ border-color:rgba(96,165,250,.18); }
    .barRow.epic     .bar{ border-color:rgba(168,85,247,.18); }
    .barRow.legendary .bar{ border-color:rgba(250,204,21,.20); }

    /* segmented ticks overlay */
    .bar::after{
      content:'';
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent calc(10% - 1px),
        rgba(0,0,0,.35) calc(10% - 1px),
        rgba(0,0,0,.35) 10%
      );
      pointer-events:none;
      z-index:2;
    }
    /* scan line sweeping over fill */
    .fill::before{
      content:'';
      position:absolute; top:0; bottom:0;
      width:28%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      animation: barScan 2.8s ease-in-out infinite;
      z-index:3;
      pointer-events:none;
      border-radius:4px;
    }
    /* shimmer diagonal */
    .fill::after{
      content:'';
      position:absolute; top:-10%; bottom:-10%;
      width:22%;
      background: linear-gradient(105deg, transparent, rgba(255,255,255,.20), transparent);
      animation: shimmer 4.5s ease-in-out infinite;
      z-index:4;
      pointer-events:none;
    }
    /* spark at tip */
    .spark{
      position:absolute;
      left:-3px; top:50%;
      transform:translateY(-50%);
      width:7px; height:7px;
      border-radius:50%;
      z-index:5;
      pointer-events:none;
      animation: spark 1.8s ease-in-out infinite;
    }
    .barRow.common   .spark{ background:#4ade80; box-shadow:0 0 8px #4ade80; }
    .barRow.rare     .spark{ background:#60a5fa; box-shadow:0 0 8px #60a5fa; }
    .barRow.epic     .spark{ background:#a855f7; box-shadow:0 0 8px #a855f7; }
    .barRow.legendary .spark{ background:#facc15; box-shadow:0 0 8px #facc15; }
    .fill{
      height:100%;
      width:0%;
      min-width:3px;
      border-radius:3px;
      opacity:.85;
      transition: width 0.7s cubic-bezier(.22,.68,0,1.2);
      position:relative;
      z-index:1;
    }
    .barRow.common   .fill{ background:linear-gradient(90deg,#2a9d60,#4ade80,#6ee7a0); box-shadow:0 0 10px rgba(74,222,128,.40); }
    .barRow.rare     .fill{ background:linear-gradient(90deg,#1d6fa8,#60a5fa,#93c5fd); box-shadow:0 0 10px rgba(96,165,250,.40); }
    .barRow.epic     .fill{ background:linear-gradient(90deg,#6b21a8,#a855f7,#c084fc); box-shadow:0 0 10px rgba(168,85,247,.40); }
    .barRow.legendary .fill{ background:linear-gradient(90deg,#b45309,#facc15,#fde68a); box-shadow:0 0 10px rgba(250,204,21,.45); }

    .num{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:9px;
      color:#ffffff;
      width:28px;
      text-align:right;
      flex-shrink:0;
      opacity:.75;
    }

    /* HUD chat (bottom-right) */
    .hudChat{
      position:absolute;
      bottom: calc(10px + var(--safe-bottom));
      right: calc(10px + var(--safe-right));
      width: 300px;
      max-width: calc(100vw - 24px);
      padding:0;
      background: transparent;
      border: none;
      backdrop-filter: none;
      box-shadow: none;
      pointer-events:none;
    }
    .hudChatUser{
      display:flex; align-items:center; gap:6px;
      font-family:Orbitron,system-ui;
      font-size:9px;
      font-weight:900;
      letter-spacing:1.5px;
      text-transform:uppercase;
      color:rgba(0,200,255,.75);
      margin-bottom:6px;
      justify-content:flex-start;
    }
    .hudChatUser .lamp{
      width:7px; height:7px; border-radius:50%;
      background:var(--danger);
      box-shadow:0 0 8px rgba(255,68,102,.55);
      flex-shrink:0;
    }
    .hudChatUser .lamp.ok{
      background:#4ade80;
      box-shadow:0 0 8px rgba(74,222,128,.65);
    }

    .msg{
      display:flex;
      gap:5px;
      font-size:12px;
      line-height:1.35;
      margin:3px 0;
      opacity:.95;
      justify-content:flex-start;
      text-align:left;
      text-shadow: 0 1px 8px rgba(0,0,0,.95);
      align-items:baseline;
    }
    .msg .a{
      color:rgba(96,165,250,.65);
      font-weight:700;
      flex:0 0 auto;
      max-width:38%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-family:Orbitron,system-ui;
      font-size:9px;
    }
    .msg .sep{
      color:rgba(255,255,255,.30);
      flex-shrink:0;
    }
    .msg .t{
      color:rgba(255,255,255,.90);
      word-break:break-word;
      flex:1;
      min-width:0;
    }

    /* Mobile friendliness */
    @media (max-width: 420px){
      .battery{ width:170px; }
      .hudChat{ width: 280px; }
      .krill{ width: 240px; }
      .badges{ width: 80px; }
      .badgeCard{ width:80px; height:80px; }
    }



    /* Bot√≥n salir */
    #btnExit{
      position:absolute;
      top: calc(10px + var(--safe-top) + 74px);
      right: calc(10px + var(--safe-right));
      z-index:20;
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:6px;
      padding: 9px 16px 11px;
      border-radius:10px;
      border: 1px solid rgba(255,68,102,.35);
      background: rgba(5,10,20,.55);
      color: rgba(255,100,120,.90);
      font-family: Orbitron, system-ui;
      font-weight:900;
      letter-spacing:2px;
      font-size:10px;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      backdrop-filter:blur(10px);
      box-shadow: 0 0 14px rgba(255,68,102,.15);
      transition: box-shadow .2s ease, border-color .2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    #btnExit:hover{ border-color:rgba(255,68,102,.65); box-shadow: 0 0 22px rgba(255,68,102,.35); }
    #btnExit:active{ transform:scale(.96); }
    #btnExit .exitDot{
      width:6px; height:6px; border-radius:50%;
      background:rgba(255,68,102,.80);
      box-shadow:0 0 7px rgba(255,68,102,.70);
      flex-shrink:0;
    }

    .topbar.hidden{
      opacity:0;
      transform: translateX(-50%) translateY(-60px);
      pointer-events:none;
    }
    .topbar{
      transition: opacity .30s ease, transform .30s cubic-bezier(.22,.68,0,1.2);
    }
    .tapHint{
      position:absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 10px;
      background: rgba(255,255,255,.08);
      clip-path: polygon(0% 0%, 100% 0%, 82% 100%, 18% 100%);
      display:none;
      pointer-events:none;
      z-index:15;
    }
    .tapHint.show{ display:block; }
    .miniBtn{
      position:absolute;
      bottom: calc(10px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
      pointer-events:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .miniBtn button{
      border:none;
      background: rgba(5,10,20,.35);
      color:rgba(232,255,246,.80);
      padding: 8px 18px 10px;
      font-family: Orbitron, system-ui;
      font-weight:900;
      letter-spacing:2px;
      font-size:10px;
      text-transform:uppercase;
      cursor:pointer;
      backdrop-filter: blur(8px);
      outline: 1px solid rgba(0,200,255,.18);
      outline-offset: -1px;
    }
    /* first button: clipped top-right */
    .miniBtn button:first-child{
      clip-path: polygon(12px 0%, 100% 0%, 100% 100%, 0% 100%);
    }
    /* last button: clipped top-left */
    .miniBtn button:last-child{
      clip-path: polygon(0% 0%, calc(100% - 12px) 0%, 100% 100%, 0% 100%);
    }
    /* REC button active state */
    @keyframes recPulse{ 0%,100%{opacity:1} 50%{opacity:.5} }
    .miniBtn button:active{ opacity:.7; }

    /* Safe overlay for ‚Äúrotate device‚Äù */
    .rotateHint{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      text-align:center;
      padding:24px;
      background:rgba(6,11,20,.88);
      z-index:999;
      pointer-events:none;
      font-family:Orbitron,system-ui;
      letter-spacing:2px;
      text-transform:uppercase;
      color:#fff;
    }
    .rotateHint .box{
      max-width:520px;
      border:1px solid rgba(0,255,136,.25);
      border-radius:18px;
      padding:20px 18px;
      background:rgba(5,10,20,.45);
      box-shadow:0 0 22px rgba(0,255,136,.15);
    }
    .rotateHint .big{ font-size:14px; font-weight:900; margin-bottom:10px; }
    .rotateHint .small{ font-family:Rajdhani,system-ui; font-size:14px; letter-spacing:0; text-transform:none; opacity:.85; }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes hudGridPulse {
      0%, 100% { opacity: .75; }
      50%       { opacity: 1; }
    }
    @keyframes batteryGlitch {
      0%   { transform: scaleX(1);      filter: brightness(1); opacity:1; }
      20%  { transform: scaleX(1.04) translateX(3px); filter: brightness(2.2) hue-rotate(40deg); opacity:.7; }
      40%  { transform: scaleX(0.97) translateX(-2px); filter: brightness(1.6); opacity:.9; }
      60%  { transform: scaleX(1.02) translateX(1px); filter: brightness(2) hue-rotate(-25deg); opacity:.8; }
      100% { transform: scaleX(1);      filter: brightness(1); opacity:1; }
    }
    @keyframes badgeGlitch {
      0%   { transform: rotate(-1.5deg) translateX(0);   filter: brightness(1); }
      25%  { transform: rotate(-1.5deg) translateX(5px);  filter: brightness(2.5) hue-rotate(30deg); }
      50%  { transform: rotate(-1.5deg) translateX(-4px); filter: brightness(1.8) hue-rotate(-20deg); }
      75%  { transform: rotate(-1.5deg) translateX(2px);  filter: brightness(2); }
      100% { transform: rotate(-1.5deg) translateX(0);   filter: brightness(1); }
    }
    @keyframes barGlitch {
      0%   { transform: translateX(0)   scaleY(1);    filter: brightness(1); }
      20%  { transform: translateX(4px) scaleY(1.15); filter: brightness(1.8) hue-rotate(30deg); }
      35%  { transform: translateX(-3px) scaleY(0.9); filter: brightness(2.2) hue-rotate(-20deg); }
      50%  { transform: translateX(2px) scaleY(1.1);  filter: brightness(1.5); }
      100% { transform: translateX(0)   scaleY(1);    filter: brightness(1); }
    }
    @keyframes numGlitch {
      0%   { transform: translateX(0);  opacity:1;   filter: none; }
      25%  { transform: translateX(3px); opacity:.6; filter: blur(1px) brightness(2); }
      50%  { transform: translateX(-2px); opacity:1; filter: brightness(1.8) hue-rotate(20deg); }
      100% { transform: translateX(0);  opacity:1;   filter: none; }
    }
    @keyframes gridEnergy {
      0%, 100% { opacity: .38; filter: brightness(1) hue-rotate(0deg); }
      33%       { opacity: .55; filter: brightness(1.4) hue-rotate(15deg); }
      66%       { opacity: .30; filter: brightness(0.8) hue-rotate(-10deg); }
    }
    @keyframes barGlow {
      0%, 100% { opacity: .95; filter: brightness(1); }
      50%       { opacity: 1;   filter: brightness(1.25); }
    }
    /* 1. Scan line sweeping left to right */
    @keyframes barScan {
      0%   { left: -30%; opacity: .7; }
      100% { left: 110%; opacity: .0; }
    }
    /* 2. Particle spark at tip */
    @keyframes spark {
      0%         { opacity: 0; transform: scale(0.4); }
      20%, 60%   { opacity: 1; transform: scale(1.2); }
      100%       { opacity: 0; transform: scale(0.6) translateY(-4px); }
    }
    /* 4. Shimmer diagonal */
    @keyframes shimmer {
      0%   { left: -60%; }
      100% { left: 130%; }
    }
    /* 3. Fill from zero on load */
    @keyframes fillIn {
      from { width: 0% !important; }
    }
    @keyframes batteryPulse {
      0%, 100% { box-shadow: 0 0 10px rgba(0,200,255,.40); }
      50%       { box-shadow: 0 0 22px rgba(0,200,255,.85); }
    }
    @keyframes batteryLow {
      0%, 100% { box-shadow: 0 0 10px rgba(255,68,102,.40); }
      50%       { box-shadow: 0 0 22px rgba(255,68,102,.90); }
    }
    @keyframes badgeFloat {
      0%, 100% { transform: rotate(-1.5deg) translateY(0px); }
      50%       { transform: rotate(-1.5deg) translateY(-4px); }
    }
    @keyframes badgeBorderPulse {
      0%, 100% { border-color: rgba(0,200,255,.38); box-shadow: 0 0 14px rgba(0,200,255,.12); }
      50%       { border-color: rgba(0,200,255,.75); box-shadow: 0 0 20px rgba(0,200,255,.35); }
    }
    @keyframes scanPulse {
      0%, 100% { opacity: .22; }
      50%       { opacity: .32; }
    }

    /* Apply animations */
    .fill{
      animation: barGlow 2.8s ease-in-out infinite, fillIn 1.2s ease-out 1;
    }
    .barRow.legendary .fill{ animation: barGlow 2.2s ease-in-out infinite, fillIn 1.2s ease-out 1; }
    .barRow.legendary .fill::before{ animation-duration: 2.4s; animation-delay: 0s; }
    .barRow.legendary .fill::after { animation-duration: 4.0s; animation-delay: 0s; }
    .barRow.epic      .fill{ animation: barGlow 3.0s ease-in-out infinite, fillIn 1.4s ease-out 1; }
    .barRow.epic      .fill::before{ animation-duration: 3.1s; animation-delay: .4s; }
    .barRow.epic      .fill::after { animation-duration: 5.0s; animation-delay: .5s; }
    .barRow.rare      .fill{ animation: barGlow 2.6s ease-in-out infinite, fillIn 1.6s ease-out 1; }
    .barRow.rare      .fill::before{ animation-duration: 2.7s; animation-delay: .7s; }
    .barRow.rare      .fill::after { animation-duration: 4.5s; animation-delay: .3s; }
    .barRow.common    .fill{ animation: barGlow 3.2s ease-in-out infinite, fillIn 1.8s ease-out 1; }
    .barRow.common    .fill::before{ animation-duration: 3.3s; animation-delay: .9s; }
    .barRow.common    .fill::after { animation-duration: 5.5s; animation-delay: .8s; }

    /* ‚îÄ‚îÄ LOGIN OVERLAY ‚îÄ‚îÄ */
    .loginOverlay{
      position:fixed; inset:0;
      z-index:500;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(6,11,20,.82);
      backdrop-filter: blur(6px);
      pointer-events:auto;
    }
    .loginOverlay.hidden{ display:none; }
    .loginBox{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      padding: 32px 28px 28px;
      border-radius:20px;
      background: rgba(5,10,20,.88);
      border: 1px solid rgba(0,200,255,.35);
      box-shadow: 0 0 40px rgba(0,200,255,.18), inset 0 1px 0 rgba(255,255,255,.06);
      max-width:320px;
      width:90%;
      text-align:center;
    }
    .loginTitle{
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:22px;
      letter-spacing:4px;
      color:#00c8ff;
      text-shadow:0 0 20px rgba(0,200,255,.60);
      text-transform:uppercase;
    }
    .loginSub{
      font-family:Rajdhani,system-ui;
      font-size:14px;
      color:rgba(255,255,255,.70);
      letter-spacing:1px;
      line-height:1.4;
    }
    .loginBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding:13px 22px;
      border-radius:12px;
      border: 1px solid rgba(0,200,255,.40);
      background: rgba(0,200,255,.10);
      color:#fff;
      font-family:Orbitron,system-ui;
      font-weight:700;
      font-size:11px;
      letter-spacing:1.5px;
      text-transform:uppercase;
      cursor:pointer;
      transition: all .2s ease;
      width:100%;
    }
    .loginBtn:hover{
      background: rgba(0,200,255,.22);
      border-color: rgba(0,200,255,.75);
      box-shadow: 0 0 20px rgba(0,200,255,.30);
    }
    .loginBtn:active{ transform:scale(.97); }
    .loginBtn:disabled{ opacity:.5; cursor:not-allowed; }
    .loginHint{
      font-family:Rajdhani,system-ui;
      font-size:12px;
      color:rgba(255,80,100,.85);
      min-height:16px;
      letter-spacing:.5px;
    }
    .loginSkip{
      background:none;
      border:none;
      color:rgba(255,255,255,.35);
      font-family:Rajdhani,system-ui;
      font-size:12px;
      letter-spacing:1px;
      cursor:pointer;
      text-decoration:underline;
      padding:4px 8px;
      transition: color .2s;
      display:none;
    }
    .loginSkip:hover{ color:rgba(255,255,255,.70); }
    @media (hover: hover) and (pointer: fine){
      .loginSkip{ display:block; }
    }

    .batteryFill{
      animation: batteryPulse 2.4s ease-in-out infinite;
    }
    .batteryFill.low{
      animation: batteryLow 1.0s ease-in-out infinite;
    }

    .badgeCard:nth-child(3){
      animation: badgeFloat 3.5s ease-in-out infinite, badgeBorderPulse 3.5s ease-in-out infinite;
    }
    .scanlines{
      animation: scanPulse 4s ease-in-out infinite;
    }

    /* ‚îÄ‚îÄ QR SCANNER OVERLAY ‚îÄ‚îÄ */
    .qrOverlay{
      position:fixed; inset:0;
      z-index:200;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(6,11,20,.72);
      backdrop-filter: blur(4px);
      pointer-events:auto;
    }
    .qrOverlay.hidden{ display:none; }
    .qrBox{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .qrFrame{
      position:relative;
      width: min(72vw, 300px);
      height: min(72vw, 300px);
      border-radius:12px;
      overflow:hidden;
      background:#000;
    }
    #qrVideo{
      width:100%; height:100%;
      object-fit:cover;
    }
    .qrCorner{
      position:absolute;
      width:28px; height:28px;
      border-color:#00c8ff;
      border-style:solid;
      pointer-events:none;
    }
    .qrCorner.tl{ top:8px; left:8px; border-width:3px 0 0 3px; border-radius:4px 0 0 0; }
    .qrCorner.tr{ top:8px; right:8px; border-width:3px 3px 0 0; border-radius:0 4px 0 0; }
    .qrCorner.bl{ bottom:8px; left:8px; border-width:0 0 3px 3px; border-radius:0 0 0 4px; }
    .qrCorner.br{ bottom:8px; right:8px; border-width:0 3px 3px 0; border-radius:0 0 4px 0; }
    .qrScanLine{
      position:absolute; left:12px; right:12px; height:2px;
      background: linear-gradient(90deg, transparent, #00c8ff, transparent);
      box-shadow: 0 0 8px #00c8ff;
      animation: qrScan 2s ease-in-out infinite;
    }
    @keyframes qrScan{
      0%{ top:12px; opacity:.5; }
      50%{ opacity:1; }
      100%{ top:calc(100% - 14px); opacity:.5; }
    }
    .qrStatus{
      font-family:Orbitron,system-ui;
      font-size:10px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      color:rgba(0,200,255,.85);
      text-align:center;
    }
    .qrClose{
      padding:7px 22px;
      border-radius:8px;
      border:1px solid rgba(0,200,255,.30);
      background:rgba(0,200,255,.08);
      color:#fff;
      font-family:Orbitron,system-ui;
      font-weight:800;
      font-size:9px;
      letter-spacing:2px;
      text-transform:uppercase;
      cursor:pointer;
    }
    .qrClose:hover{ background:rgba(0,200,255,.18); }

        .chip.qrChip{ border-color:rgba(250,204,21,.30); background:rgba(250,204,21,.07); }
    .chip.qrChip .dot{ background:#facc15; box-shadow:0 0 6px rgba(250,204,21,.65); }
    .chip.qrChip.active{ background:rgba(250,204,21,.18); border-color:rgba(250,204,21,.60); }



    /* Hand tracking canvas */
    #handCanvas{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:55; }

    /* ‚îÄ‚îÄ BOOT OVERLAY ‚îÄ‚îÄ */
    #bootOverlay{
      position:fixed; inset:0; z-index:9999;
      background:#000;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; gap:16px;
      pointer-events:all;
    }
    #bootOverlay.hidden{ display:none; }

    #bootLine{
      width:60%; height:2px;
      background: linear-gradient(90deg, transparent, #00c8ff, transparent);
      box-shadow: 0 0 14px #00c8ff, 0 0 28px rgba(0,200,255,.50);
      border-radius:2px;
      animation: bootPulse 1.2s ease-in-out infinite;
    }
    #bootMsg{
      font-family:Orbitron,system-ui;
      font-size:10px;
      font-weight:900;
      letter-spacing:3px;
      text-transform:uppercase;
      color:rgba(0,200,255,.70);
    }
    @keyframes bootPulse{
      0%,100%{ opacity:.5; transform:scaleX(.85); }
      50%{ opacity:1; transform:scaleX(1); }
    }

    /* Las dos compuertas */
    #gateTop, #gateBottom{
      position:fixed; left:0; right:0; z-index:9998;
      background:#000;
      transition: transform 0.7s cubic-bezier(.77,0,.18,1);
    }
    #gateTop{    top:0;    height:50vh; transform:translateY(0); }
    #gateBottom{ bottom:0; height:50vh; transform:translateY(0); }
    #gateTop.open    { transform:translateY(-100%); }
    #gateBottom.open { transform:translateY(100%); }

    /* ‚îÄ‚îÄ PARCEL MENU ‚îÄ‚îÄ */
    .parcelMenu{
      position:fixed;
      bottom: calc(62px + env(safe-area-inset-bottom));
      left: 10px;
      z-index: 30;
      display:flex;
      flex-direction:column;
      gap:6px;
      pointer-events:auto;
      transform: translateY(20px);
      opacity:0;
      transition: opacity .25s ease, transform .25s cubic-bezier(.22,.68,0,1.2);
    }
    .parcelMenu.open{ opacity:1; transform:translateY(0); }
    .parcelMenu.closed{ pointer-events:none; }
    .pmBtn{
      display:flex; align-items:center; gap:8px;
      padding:8px 14px;
      border-radius:10px;
      border:1px solid var(--pc);
      background:rgba(5,10,20,.80);
      color:var(--pc);
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      cursor:pointer;
      backdrop-filter:blur(10px);
      box-shadow:0 0 12px rgba(0,0,0,.4);
      user-select:none;
      white-space:nowrap;
    }
    .pmBtn:active{ opacity:.7; transform:scale(.96); }
    .pmBtn .pmDot{
      width:8px; height:8px; border-radius:50%;
      background:var(--pc);
      box-shadow:0 0 6px var(--pc);
      flex-shrink:0;
    }
    /* Toggle button ‚Äî invisible tap area over stats */
    #btnParcelToggle{
      position:fixed;
      bottom: calc(10px + env(safe-area-inset-bottom));
      left: 10px;
      z-index:30;
      pointer-events:auto;
      width: 270px;
      height: 120px;
      background: transparent;
      border: none;
      cursor: pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    #btnParcelToggle.open{ background:transparent; }

    /* ‚îÄ‚îÄ DRAGGABLE PARCEL INSTANCES ‚îÄ‚îÄ */
    .parcelInstance{
      position:absolute;
      z-index:0;
      cursor:grab;
      touch-action:none;
      user-select:none;
    }
    .parcelInstance.dragging{ cursor:grabbing; z-index:0; }
    .parcelInstance canvas{
      display:block;
      border-radius:12px;
      background:transparent !important;
      pointer-events:none;
    }
    /* ‚îÄ‚îÄ Parcel drop & bounce animations ‚îÄ‚îÄ */
    @keyframes parcelDrop {
      0%   { transform: translateY(-120vh) scaleY(1.08); opacity:0; }
      60%  { transform: translateY(0)      scaleY(0.92); opacity:1; }
      75%  { transform: translateY(-18px)  scaleY(1.04); }
      88%  { transform: translateY(0)      scaleY(0.97); }
      96%  { transform: translateY(-6px)   scaleY(1.02); }
      100% { transform: translateY(0)      scaleY(1);    }
    }
    @keyframes parcelSettle {
      0%   { transform: translateY(0)     scaleY(1);    }
      25%  { transform: translateY(-14px) scaleY(1.04); }
      50%  { transform: translateY(0)     scaleY(0.96); }
      70%  { transform: translateY(-5px)  scaleY(1.02); }
      100% { transform: translateY(0)     scaleY(1);    }
    }
    .parcelInstance.dropping {
      animation: parcelDrop 0.7s cubic-bezier(.22,.68,0,1.1) forwards;
    }
    .parcelInstance.settling {
      animation: parcelSettle 0.45s cubic-bezier(.22,.68,0,1.2) forwards;
    }

    .parcelInstance .pClose{
      position:absolute;
      top:-10px; right:-10px;
      width:28px; height:28px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.35);
      background:rgba(5,10,20,.80);
      color:#fff;
      font-size:13px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      backdrop-filter:blur(6px);
      pointer-events:auto;
      z-index:1;
      line-height:1;
    }
  </style>
</head>

<body>
  <div class="stage">
    <video id="cam" autoplay playsinline muted></video>
    <canvas id="handCanvas" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:55;"></canvas>

    <div class="hud">
      <div class="scanlines"></div>
      <svg id="hudGrid" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:screen;opacity:0.85;" preserveAspectRatio="none"></svg>

      <!-- clickable controls -->
      <div class="topbar">
        <div class="chip" id="btnStart">
          <span class="dot" id="camDot"></span>
          <span id="camLabel">C√ÅMARA: OFF</span>
        </div>

        <div class="chip secondary" id="btnFlip">
          ‚áÑ ESPEJO
        </div>
        <div class="chip secondary" id="btnCamSwitch">
          ‚óâ FRONTAL
        </div>
        <div class="spacer"></div>

        <div class="chip" id="btnReloadStats" title="Refrescar stats desde localStorage">
          ‚Üª STATS
        </div>

      </div>

      <!-- Diamonds battery -->
      <div class="battery" aria-label="Diamantes">
        <div class="batteryBar">
          <div class="batteryFill" id="batteryFill"></div><div class="batterySpark" id="batterySpark"></div>
        </div>
        <div class="title" style="margin-top:4px;">
          <span>‚ö° BATER√çA</span>
          <span class="value" id="diamondsVal">0</span>
        </div>
        <!-- keep old cells hidden for JS compat -->
        <div style="display:none"><div class="cells" id="diamondCells"></div></div>
      </div>

      <!-- Badges cards -->
      <div class="badges" aria-label="Insignias">
        <div class="cardStack">
          <div class="badgeCard">
            <span class="badgeValue" id="badgesValGhost1">0</span>
          </div>
          <div class="badgeCard">
            <span class="badgeValue" id="badgesValGhost2">0</span>
          </div>
          <div class="badgeCard">
            <span class="badgeLabel">INSIGNIAS</span>
            <span class="badgeValue" id="badgesVal">0</span>
          </div>
        </div>
      </div>

      <!-- Krill bars -->
      <div class="krill" aria-label="Parcela por rareza">
        <div class="bars">
          <div class="barRow legendary">
            <div class="num" id="numLegendary">0</div>
            <div class="bar"><div class="fill" id="fillLegendary"></div><div class="spark"></div></div>
          </div>
          <div class="barRow epic">
            <div class="num" id="numEpic">0</div>
            <div class="bar"><div class="fill" id="fillEpic"></div><div class="spark"></div></div>
          </div>
          <div class="barRow rare">
            <div class="num" id="numRare">0</div>
            <div class="bar"><div class="fill" id="fillRare"></div><div class="spark"></div></div>
          </div>
          <div class="barRow common">
            <div class="num" id="numCommon">0</div>
            <div class="bar"><div class="fill" id="fillCommon"></div><div class="spark"></div></div>
          </div>
        </div>
        <div class="krillFooter"><span class="krillTitle">STATS</span> &nbsp;¬∑&nbsp; TOTAL: <span id="totalParcels">0</span></div>
      </div>

      <!-- Last 5 chat messages -->
      <div class="hudChat" aria-label="√öltimos 5 mensajes">
        <div class="hudChatUser">
          <span class="lamp" id="chatLamp"></span>
          <span id="chatState">‚Äî</span>
        </div>
        <div id="chatLines">
          <div class="msg"><span class="a">‚Äî</span><span class="t">Conecta Firebase para ver actividad.</span></div>
        </div>
      </div>
    </div>

    
    <div class="miniBtn">
      <button id="btnUI">HUD</button>
      <button id="btnFS">FULL</button>
      </div>
    <div class="tapHint" id="tapHint"></div>
    <button id="btnExit"><span class="exitDot"></span>SALIR</button>
    <!-- Invisible tap area center-top: reveals camera+QR controls -->
    <div id="topbarTapArea" style="
      position:fixed;
      top:0; left:50%;
      transform:translateX(-50%);
      width:220px; height:54px;
      z-index:25;
      pointer-events:auto;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    "></div>

    <!-- QR button: always visible, fixed bottom-right -->
    <div id="btnQR" style="
      position:fixed;
      top: calc(10px + env(safe-area-inset-top) + 96px);
      left: 10px;
      z-index: 25;
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:10px;
      border:1px solid rgba(250,204,21,.45);
      background:rgba(5,10,20,.72);
      color:#facc15;
      font-family:Orbitron,system-ui;
      font-weight:900;
      font-size:10px;
      letter-spacing:2px;
      cursor:pointer;
      backdrop-filter:blur(10px);
      box-shadow:0 0 14px rgba(250,204,21,.20);
      user-select:none;
      transform: translateX(-120%);
      transition: transform .3s cubic-bezier(.22,.68,0,1.2);
    ">
      <span style="width:7px;height:7px;border-radius:50%;background:#facc15;box-shadow:0 0 6px #facc15;flex-shrink:0;display:inline-block;"></span>
      QR
    </div>

    <div class="rotateHint" id="rotateHint">
      <div class="box">
        <div class="big">GIRA EL TEL√âFONO A HORIZONTAL</div>
        <div class="small">Tip: en iPhone, Safari es medio terco‚Ä¶ pero con FULL + girar, queda üëå</div>
      </div>
    </div>


    <!-- PARCEL TOGGLE BUTTON (invisible tap area over stats) -->
    <div id="btnParcelToggle"></div>

    <!-- PARCEL MENU (emergent, above stats) -->
    <div class="parcelMenu closed" id="parcelMenu">
      <div class="pmBtn" data-rarity="legendary" style="--pc:#f59e0b">
        <span class="pmDot"></span>LEGENDARY
      </div>
      <div class="pmBtn" data-rarity="epic" style="--pc:#a855f7">
        <span class="pmDot"></span>EPIC
      </div>
      <div class="pmBtn" data-rarity="rare" style="--pc:#60a5fa">
        <span class="pmDot"></span>RARE
      </div>
      <div class="pmBtn" data-rarity="common" style="--pc:#9ca3af">
        <span class="pmDot"></span>COMMON
      </div>
    </div>

    <!-- QR SCANNER OVERLAY -->
    <div class="qrOverlay hidden" id="qrOverlay">
      <div class="qrBox">
        <div class="qrFrame">
          <video id="qrVideo" autoplay playsinline muted></video>
          <div class="qrCorner tl"></div>
          <div class="qrCorner tr"></div>
          <div class="qrCorner bl"></div>
          <div class="qrCorner br"></div>
          <div class="qrScanLine"></div>
        </div>
        <div class="qrStatus" id="qrStatus">APUNTA AL C√ìDIGO QR</div>
        <button class="qrClose" id="btnQRClose">CERRAR</button>
      </div>
    </div>

    <!-- AR CANVAS (transparent, over camera) -->
    <canvas id="arCanvas" style="position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:50;display:none;"></canvas>
    <!-- AR CLOSE BUTTON -->
    <button id="btnARClose" style="display:none;position:fixed;z-index:60;width:44px;height:44px;border-radius:50%;border:1.5px solid rgba(255,255,255,.40);background:rgba(5,10,20,.70);color:#fff;font-size:20px;cursor:pointer;backdrop-filter:blur(8px);pointer-events:auto;align-items:center;justify-content:center;line-height:1;">‚úï</button>

    <!-- THREE.JS (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- TF.js se carga din√°micamente despu√©s del boot para no bloquear la p√°gina -->
    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AEMX ‚Äî Multi-parcel draggable AR system
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const RARITY_MAP = {
      'AEMX-COMMON':    'common',
      'AEMX-RARE':      'rare',
      'AEMX-EPIC':      'epic',
      'AEMX-LEGENDARY': 'legendary',
    };

    // ‚îÄ‚îÄ Colors & material helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const C = {
      grassLight:0x5aaf3a, grassDark:0x3d8a27, grassTile:0x4d9c30,
      borderCommon:0x9ca3af, borderRare:0x60a5fa, borderEpic:0xa855f7, borderLegendary:0xf59e0b,
      trunk:0x7c4a1e, trunkDark:0x5a3412,
      pineGreen1:0x2d7a3a, pineGreen2:0x1e5c2a,
      leafGreen1:0x3a9e2a, leafGreen2:0x2d8020, leafGreen3:0x4ab830,
      rockGray:0x6b7280, rockDark:0x4b5563,
      flowerYellow:0xfbbf24, weedGreen:0x166534, weedDark:0x14532d,
    };
    const mat = (color) => new THREE.MeshLambertMaterial({ color, flatShading:true });

    function buildBase(bc){
      const g = new THREE.Group();
      // Shadow blob underneath the parcel
      const shadowGeo = new THREE.PlaneGeometry(5.5, 5.5);
      const shadowMat = new THREE.MeshBasicMaterial({
        color: 0x000000,
        transparent: true,
        opacity: 0.38,
        depthWrite: false,
      });
      const shadow = new THREE.Mesh(shadowGeo, shadowMat);
      shadow.rotation.x = -Math.PI / 2;
      shadow.position.y = -0.12;
      g.add(shadow);
      const geo = new THREE.BoxGeometry(4,.18,4,4,1,4);
      const pos = geo.attributes.position;
      for(let i=0;i<pos.count;i++) if(Math.abs(pos.getY(i)-.09)<.01) pos.setY(i,pos.getY(i)+(Math.random()-.5)*.06);
      geo.computeVertexNormals();
      const cols=[], col=new THREE.Color();
      for(let i=0;i<pos.count;i++){ const t=Math.random(); col.setHex(t>.5?C.grassLight:t>.25?C.grassTile:C.grassDark); cols.push(col.r,col.g,col.b); }
      geo.setAttribute('color',new THREE.BufferAttribute(new Float32Array(cols),3));
      g.add(new THREE.Mesh(geo, new THREE.MeshLambertMaterial({vertexColors:true,flatShading:true})));
      const bm = new THREE.Mesh(new THREE.BoxGeometry(4.22,.12,4.22),mat(bc));
      bm.position.y=-.04; g.add(bm);
      [{x:0,z:2.06,sx:4.22,sz:.11},{x:0,z:-2.06,sx:4.22,sz:.11},{x:2.06,z:0,sx:.11,sz:4.22},{x:-2.06,z:0,sx:.11,sz:4.22}]
        .forEach(s=>{ const m=new THREE.Mesh(new THREE.BoxGeometry(s.sx,.14,s.sz),mat(bc)); m.position.set(s.x,.05,s.z); g.add(m); });
      // Drop shadow ‚Äî ellipse below base
      const shd = new THREE.Mesh(
        new THREE.CircleGeometry(3.0, 32),
        new THREE.MeshBasicMaterial({ color:0x000000, transparent:true, opacity:0.38, depthWrite:false })
      );
      shd.rotation.x = -Math.PI/2;
      shd.position.y = -0.12;
      shd.scale.set(1, 0.5, 1);
      g.add(shd);
      return g;
    }
    function buildCommon(){ return buildBase(C.borderCommon); }
    function buildRare(){
      const g=buildBase(C.borderRare);
      [{x:-.6,z:-.4,h:.9,l:.12},{x:-.3,z:-.2,h:1.1,l:-.08},{x:-.7,z:-.1,h:.75,l:.15},{x:-.45,z:.25,h:1.0,l:.05},{x:-.2,z:.1,h:.65,l:-.12}]
        .forEach(r=>{ const rm=new THREE.Mesh(new THREE.CylinderGeometry(.025,.04,r.h,5),mat(Math.random()>.5?C.weedGreen:C.weedDark)); rm.position.set(r.x,r.h/2+.09,r.z); rm.rotation.z=r.l; g.add(rm); const tip=new THREE.Mesh(new THREE.ConeGeometry(.06,.18,4),mat(C.weedGreen)); tip.position.set(r.x,r.h+.15,r.z); g.add(tip); });
      return g;
    }
    function buildEpic(){
      const g=buildBase(C.borderEpic);
      const tr=new THREE.Mesh(new THREE.CylinderGeometry(.1,.15,.55,6),mat(C.trunk)); tr.position.set(.2,.36,.1); g.add(tr);
      [{y:.64,r:.75,h:1.1},{y:1.35,r:.55,h:.9},{y:1.95,r:.35,h:.75},{y:2.45,r:.18,h:.55}]
        .forEach((l,i)=>{ const c=new THREE.Mesh(new THREE.ConeGeometry(l.r,l.h,7+i),mat(i%2===0?C.pineGreen1:C.pineGreen2)); c.position.set(.2,l.y,.1); g.add(c); });
      return g;
    }
    function buildLegendary(){
      const g=buildBase(C.borderLegendary);
      const tr=new THREE.Mesh(new THREE.CylinderGeometry(.13,.2,1.1,6),mat(C.trunk)); tr.position.set(-.1,.64,-.1); g.add(tr);
      const br=new THREE.Mesh(new THREE.CylinderGeometry(.07,.10,.7,5),mat(C.trunkDark)); br.position.set(.22,1.05,-.1); br.rotation.z=-.6; g.add(br);
      [{x:-.1,y:2.1,z:-.1,s:.9,c:C.leafGreen1},{x:.55,y:1.75,z:.1,s:.65,c:C.leafGreen2},{x:-.65,y:1.85,z:.15,s:.60,c:C.leafGreen3},{x:.1,y:2.65,z:.2,s:.55,c:C.leafGreen1},{x:-.3,y:2.35,z:-.55,s:.50,c:C.leafGreen2},{x:.4,y:2.3,z:-.3,s:.45,c:C.leafGreen3}]
        .forEach(l=>{ const m=new THREE.Mesh(new THREE.IcosahedronGeometry(l.s,0),mat(l.c)); m.position.set(l.x,l.y,l.z); m.rotation.y=Math.random()*Math.PI; g.add(m); });
      const rk=new THREE.Mesh(new THREE.DodecahedronGeometry(.28,0),mat(C.rockGray)); rk.position.set(.9,.18,-.5); rk.rotation.y=1.2; rk.scale.set(1,.65,.9); g.add(rk);
      const rk2=new THREE.Mesh(new THREE.DodecahedronGeometry(.18,0),mat(C.rockDark)); rk2.position.set(1.15,.12,-.2); rk2.scale.set(.9,.55,1); g.add(rk2);
      [{x:.7,z:.5},{x:.5,z:.8},{x:1.0,z:.65},{x:.3,z:.9}].forEach(fp=>{ const st=new THREE.Mesh(new THREE.CylinderGeometry(.015,.02,.22,4),mat(C.weedGreen)); st.position.set(fp.x,.2,fp.z); g.add(st); const pt=new THREE.Mesh(new THREE.ConeGeometry(.07,.06,5),mat(C.flowerYellow)); pt.position.set(fp.x,.33,fp.z); g.add(pt); });
      return g;
    }

    // ‚îÄ‚îÄ Per-parcel renderer factory ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Each parcel gets its own canvas + renderer + scene
    const PARCEL_SIZE = 180; // px, base size
    let parcelInstances = []; // array of active instances

    function createParcelInstance(rarity, opts={}){
      // Wrapper div (draggable)
      const wrap = document.createElement('div');
      wrap.className = 'parcelInstance';
      const W = window.innerWidth, H = window.innerHeight;
      // Floor = 62% down the screen
      const floorY = H * 0.62 - PARCEL_SIZE/2;
      const cx = opts.left !== undefined ? opts.left : W/2 - PARCEL_SIZE/2 + (Math.random()-.5)*80;
      const cy = opts.top  !== undefined ? opts.top  : floorY;
      wrap.style.left = cx + 'px';
      wrap.style.top  = cy + 'px';
      wrap.style.width  = PARCEL_SIZE + 'px';
      wrap.style.height = PARCEL_SIZE + 'px';

      // Canvas
      const canvas = document.createElement('canvas');
      canvas.width  = PARCEL_SIZE * Math.min(window.devicePixelRatio,2);
      canvas.height = PARCEL_SIZE * Math.min(window.devicePixelRatio,2);
      canvas.style.width  = PARCEL_SIZE + 'px';
      canvas.style.height = PARCEL_SIZE + 'px';
      wrap.appendChild(canvas);

      // Close button
      const closeBtn = document.createElement('div');
      closeBtn.className = 'pClose';
      closeBtn.textContent = '‚úï';
      wrap.appendChild(closeBtn);

      const _hud = document.querySelector('.stage .hud');
      _hud ? _hud.parentNode.insertBefore(wrap, _hud) : document.querySelector('.stage').appendChild(wrap);

      // Drop animation only for newly placed parcels, not restored ones
      if(opts.left === undefined && opts.top === undefined){
        wrap.classList.add('dropping');
        wrap.addEventListener('animationend', () => wrap.classList.remove('dropping'), { once:true });
      }

      // Three.js per-instance
      const rend = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
      rend.setClearColor(0,0);
      rend.setPixelRatio(Math.min(window.devicePixelRatio,2));
      rend.setSize(PARCEL_SIZE, PARCEL_SIZE);

      const sc = new THREE.Scene();
      sc.add(new THREE.AmbientLight(0xffffff,.60));
      const dl = new THREE.DirectionalLight(0xffffff,1.1); dl.position.set(5,8,5); sc.add(dl);
      const fl = new THREE.DirectionalLight(0x6699ff,.25); fl.position.set(-4,2,-4); sc.add(fl);

      const cam = new THREE.PerspectiveCamera(42,1,.1,100);
      cam.position.set(4.5,4.5,4.5);
      cam.lookAt(0,.5,0);

      const builders = {common:buildCommon,rare:buildRare,epic:buildEpic,legendary:buildLegendary};
      const group = builders[rarity]();
      sc.add(group);

      // Render loop for this instance
      let rafId = null;
      let _hovering = false;
      let _hoverColor = '';
      let _hoverPoint = null;
      let _velX = 0, _velY = 0;
      const IMPULSE   = 6.0;
      const FRICTION  = 0.99;

      function renderLoop(){
        rafId = requestAnimationFrame(renderLoop);

        // Aplicar impulso cuando hay hover ‚Äî direcci√≥n seg√∫n posici√≥n de la mano vs centro parcela
        if(_hovering && _hoverPoint){
          const rect = wrap.getBoundingClientRect();
          const cx = rect.left + rect.width  / 2;
          const cy = rect.top  + rect.height / 2;
          const dx = _hoverPoint.x - cx;
          const dy = _hoverPoint.y - cy;
          const dist = Math.hypot(dx, dy) || 1;
          // Izquierda (verde) = repele, Derecha (naranja) = atrae
          const attract = _hoverColor === '#fb923c' ? 1 : -1;
          _velX += (dx / dist) * IMPULSE * attract;
          _velY += (dy / dist) * IMPULSE * attract;
          _velX = Math.max(-35, Math.min(35, _velX));
          _velY = Math.max(-35, Math.min(35, _velY));
        }

        // Fricci√≥n din√°mica: mano derecha frena m√°s r√°pido
        const activeFriction = (_hovering && _hoverColor === '#fb923c') ? 0.80 : FRICTION;

        // Inercia X con rebote
        if(Math.abs(_velX) > 0.1){
          posLeft += _velX;
          _velX *= activeFriction;
          const maxX = window.innerWidth - PARCEL_SIZE;
          if(posLeft < 0)    { posLeft = 0;    _velX =  Math.abs(_velX) * 0.75; }
          if(posLeft > maxX) { posLeft = maxX; _velX = -Math.abs(_velX) * 0.75; }
          wrap.style.left = posLeft + 'px';
        } else { _velX = 0; }

        // Inercia Y con rebote
        if(Math.abs(_velY) > 0.1){
          posTop += _velY;
          _velY *= activeFriction;
          const maxY = window.innerHeight - PARCEL_SIZE;
          if(posTop < 0)    { posTop = 0;    _velY =  Math.abs(_velY) * 0.75; }
          if(posTop > maxY) { posTop = maxY; _velY = -Math.abs(_velY) * 0.75; }
          wrap.style.top = posTop + 'px';
        } else { _velY = 0; }

        if(Math.abs(_velX) > 0.1 || Math.abs(_velY) > 0.1) updateZIndices();

        rend.render(sc, cam);
      }
      renderLoop();

      // Instance object
      const instance = { wrap, canvas, rend, sc, cam, group, rafId, rarity, _scale:1, _theta:Math.PI/4, _phi:Math.PI/4,
        setHover(on, color, point){
          _hovering = on;
          _hoverColor = color;
          _hoverPoint = point || null;
          if(on){
            wrap.style.filter = `drop-shadow(0 0 18px ${color}) drop-shadow(0 0 36px ${color})`;
            wrap.style.transition = 'filter .2s ease';
          } else {
            wrap.style.filter = '';
          }
        }
      };
      parcelInstances.push(instance);
      updateZIndices();

      // ‚îÄ‚îÄ Close button: hidden, shows on touch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      closeBtn.style.opacity = '0';
      closeBtn.style.transition = 'opacity .2s ease';
      let closeBtnTimer = null;
      function showCloseBtn(){
        closeBtn.style.opacity = '1';
        if(closeBtnTimer) clearTimeout(closeBtnTimer);
        closeBtnTimer = setTimeout(()=>{ closeBtn.style.opacity='0'; }, 2000);
      }
      closeBtn.addEventListener('pointerdown', e=>{
        e.stopPropagation();
        destroyInstance(instance);
      });

      // ‚îÄ‚îÄ Interaction state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let currentScale = opts.scale || 1.0;
      let posLeft = opts.left !== undefined ? opts.left : (parseFloat(wrap.style.left) || 0);
      let posTop  = opts.top  !== undefined ? opts.top  : (parseFloat(wrap.style.top)  || 0);
      if(opts.left !== undefined){ wrap.style.left = posLeft + 'px'; }
      if(opts.top  !== undefined){ wrap.style.top  = posTop  + 'px'; }

      // 3D orbit state (camera orbits around model center)
      let orbitTheta = opts.orbitTheta !== undefined ? opts.orbitTheta : Math.PI/4;
      let orbitPhi   = opts.orbitPhi   !== undefined ? opts.orbitPhi   : Math.PI/3;
      const ORBIT_R  = 7.5;         // camera distance
      const ORBIT_TARGET = new THREE.Vector3(0, 0.5, 0);

      function updateCamera(){
        cam.position.x = ORBIT_TARGET.x + ORBIT_R * Math.sin(orbitPhi) * Math.sin(orbitTheta);
        cam.position.y = ORBIT_TARGET.y + ORBIT_R * Math.cos(orbitPhi);
        cam.position.z = ORBIT_TARGET.z + ORBIT_R * Math.sin(orbitPhi) * Math.cos(orbitTheta);
        cam.lookAt(ORBIT_TARGET);
      }
      updateCamera();

      // Active pointers map
      const pointers = new Map();
      let lastPinchDist = null;
      let rotStartX = 0, rotStartY = 0;
      let rotStartTheta = orbitTheta, rotStartPhi = orbitPhi;
      let dragStartX = 0, dragStartY = 0;
      let dragOrigLeft = 0, dragOrigTop = 0;
      let mode = 'idle'; // 'rotate' | 'pinch' | 'drag'
      // drag threshold: small move = rotate, larger = drag
      let totalMove = 0;

      function getPinchDist(a,b){ return Math.hypot(b.x-a.x, b.y-a.y); }

      wrap.addEventListener('pointerdown', e=>{
        if(e.target === closeBtn){ e.stopPropagation(); return; }
        pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
        wrap.setPointerCapture(e.pointerId);
        showCloseBtn();

        if(pointers.size === 1){
          mode = 'rotate';
          rotStartX = e.clientX; rotStartY = e.clientY;
          rotStartTheta = orbitTheta; rotStartPhi = orbitPhi;
          dragStartX = e.clientX; dragStartY = e.clientY;
          dragOrigLeft = parseFloat(wrap.style.left) || 0;
          dragOrigTop  = parseFloat(wrap.style.top)  || 0;
          totalMove = 0;
        } else if(pointers.size === 2){
          mode = 'pinch';
          const pts = [...pointers.values()];
          lastPinchDist = getPinchDist(pts[0], pts[1]);
        }
        e.preventDefault();
      }, {passive:false});

      wrap.addEventListener('pointermove', e=>{
        if(!pointers.has(e.pointerId)) return;
        const prev = pointers.get(e.pointerId);
        pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

        if(mode === 'rotate' && pointers.size === 1){
          const dx = e.clientX - rotStartX;
          const dy = e.clientY - rotStartY;
          totalMove += Math.abs(e.clientX - prev.x) + Math.abs(e.clientY - prev.y);

          // Rotate model via orbit camera
          const sensitivity = 0.008;
          orbitTheta = rotStartTheta - dx * sensitivity;
          orbitPhi   = Math.max(0.1, Math.min(Math.PI - 0.1, rotStartPhi - dy * sensitivity));
          updateCamera();
          instance._theta = orbitTheta;
          instance._phi   = orbitPhi;

        } else if(mode === 'pinch' && pointers.size === 2){
          const pts = [...pointers.values()];
          const dist = getPinchDist(pts[0], pts[1]);
          if(lastPinchDist !== null){
            currentScale = Math.max(0.3, Math.min(4, currentScale * (dist / lastPinchDist)));
            wrap.style.transformOrigin = 'center center';
            wrap.style.transform = `scale(${currentScale})`;
            instance._scale = currentScale;
            saveParcelState();
          }
          lastPinchDist = dist;

          // Move parcel with two-finger drag (center point)
          const cx = (pts[0].x + pts[1].x) / 2;
          const cy = (pts[0].y + pts[1].y) / 2;
          // (optional: could track center movement too)
        }
        e.preventDefault();
      }, {passive:false});

      function onPointerUp(e){
        if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null; }
        if(mode === 'rotate' && pointers.size === 1 && totalMove < 8){
          // tap ‚Äî already showed close btn above
        }
        // Snap + settle on drag release
        if(mode === 'drag' && pointers.size <= 1){
          snapToNeighbor(instance);
          updateZIndices();
          wrap.classList.add('settling');
          wrap.addEventListener('animationend', () => wrap.classList.remove('settling'), { once:true });
          saveParcelState();
        }
        pointers.delete(e.pointerId);
        if(pointers.size === 0){
          mode = 'idle';
          lastPinchDist = null;
          wrap.classList.remove('dragging');
        } else if(pointers.size === 1){
          mode = 'rotate';
          const remaining = [...pointers.values()][0];
          rotStartX = remaining.x; rotStartY = remaining.y;
          rotStartTheta = orbitTheta; rotStartPhi = orbitPhi;
          lastPinchDist = null;
        }
      }
      wrap.addEventListener('pointerup',    onPointerUp);
      wrap.addEventListener('pointercancel',onPointerUp);

      // Long-press to drag (300ms hold without moving)
      let longPressTimer = null;
      wrap.addEventListener('pointerdown', e=>{
        if(e.target===closeBtn) return;
        longPressTimer = setTimeout(()=>{
          mode = 'drag';
          wrap.classList.add('dragging');
          dragStartX = e.clientX; dragStartY = e.clientY;
          dragOrigLeft = parseFloat(wrap.style.left)||0;
          dragOrigTop  = parseFloat(wrap.style.top)||0;
        }, 300);
      }, {passive:true});
      wrap.addEventListener('pointermove', e=>{
        if(longPressTimer && pointers.size === 1){
          const dx = Math.abs(e.clientX - dragStartX);
          const dy = Math.abs(e.clientY - dragStartY);
          if(dx > 8 || dy > 8) { clearTimeout(longPressTimer); longPressTimer=null; }
        }
        if(mode === 'drag' && pointers.size === 1){
          const dx = e.clientX - dragStartX;
          const dy = e.clientY - dragStartY;
          posLeft = dragOrigLeft + dx;
          posTop  = dragOrigTop  + dy;
          wrap.style.left = posLeft + 'px';
          wrap.style.top  = posTop  + 'px';
          updateZIndices();
        }
      }, {passive:true});
      return instance;
    }

    // ‚îÄ‚îÄ Snap to neighbor corner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // ‚îÄ‚îÄ Snap to neighbor ‚Äî base corner to base corner ‚îÄ‚îÄ‚îÄ‚îÄ
    const SNAP_DIST  = 120; // px threshold to trigger snap
    const BASE_OFFSET = 125; // px between div origins so bases touch edge-to-edge

    // Z-index din√°mico: la parcela m√°s abajo en pantalla (top + height) va al frente
    function updateZIndices(){
      if(parcelInstances.length === 0) return;
      // Ordenar por posici√≥n Y + mitad del tama√±o (centro visual)
      const sorted = [...parcelInstances].sort((a, b) => {
        const ay = parseFloat(a.wrap.style.top  || 0) + PARCEL_SIZE * 0.5;
        const by = parseFloat(b.wrap.style.top  || 0) + PARCEL_SIZE * 0.5;
        return ay - by; // m√°s arriba = z-index menor
      });
      sorted.forEach((inst, i) => {
        inst.wrap.style.zIndex = 10 + i;
      });
    }

    function snapToNeighbor(inst){
      const left = parseFloat(inst.wrap.style.left) || 0;
      const top  = parseFloat(inst.wrap.style.top)  || 0;

      let bestDist = SNAP_DIST;
      let snapLeft = null, snapTop = null;

      parcelInstances.forEach(other => {
        if(other === inst) return;
        const oLeft = parseFloat(other.wrap.style.left) || 0;
        const oTop  = parseFloat(other.wrap.style.top)  || 0;

        // 4 adjacent positions where bases touch corner to corner
        const candidates = [
          { l: oLeft + BASE_OFFSET, t: oTop              }, // right
          { l: oLeft - BASE_OFFSET, t: oTop              }, // left
          { l: oLeft,               t: oTop + BASE_OFFSET }, // below
          { l: oLeft,               t: oTop - BASE_OFFSET }, // above
        ];

        candidates.forEach(({ l, t }) => {
          const dist = Math.sqrt((left - l) ** 2 + (top - t) ** 2);
          if(dist < bestDist){
            bestDist = dist;
            snapLeft = l;
            snapTop  = t;
          }
        });
      });

      if(snapLeft !== null){
        inst.wrap.style.transition = 'left .18s cubic-bezier(.22,.68,0,1.2), top .18s cubic-bezier(.22,.68,0,1.2)';
        inst.wrap.style.left = snapLeft + 'px';
        inst.wrap.style.top  = snapTop  + 'px';
        setTimeout(() => { inst.wrap.style.transition = ''; }, 200);
      }
    }

    function destroyInstance(inst){
      inst.rafId && cancelAnimationFrame(inst.rafId);
      inst.rend.dispose();
      inst.wrap.remove();
      parcelInstances = parcelInstances.filter(i=>i!==inst);
      saveParcelState();
    }

    // ‚îÄ‚îÄ localStorage persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PARCELS_KEY = 'aemx-parcelas-v1';

    function saveParcelState(){
      try{
        const data = parcelInstances.map(inst => ({
          rarity:      inst.rarity,
          left:        parseFloat(inst.wrap.style.left)  || 0,
          top:         parseFloat(inst.wrap.style.top)   || 0,
          scale:       inst._scale  || 1,
          orbitTheta:  inst._theta  || Math.PI/4,
          orbitPhi:    inst._phi    || Math.PI/4,
        }));
        localStorage.setItem(PARCELS_KEY, JSON.stringify(data));
      }catch(e){}
    }

    function loadParcelState(){
      try{
        const raw = localStorage.getItem(PARCELS_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        data.forEach(d=>{
          const inst = createParcelInstance(d.rarity, {
            left: d.left, top: d.top,
            scale: d.scale, orbitTheta: d.orbitTheta, orbitPhi: d.orbitPhi
          });
        });
      }catch(e){}
    }

    // ‚îÄ‚îÄ Parcel menu toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const parcelMenu   = document.getElementById('parcelMenu');
    const btnParcelToggle = document.getElementById('btnParcelToggle');
    let menuOpen = false;

    btnParcelToggle.addEventListener('click', ()=>{
      menuOpen = !menuOpen;
      parcelMenu.classList.toggle('open', menuOpen);
      parcelMenu.classList.toggle('closed', !menuOpen);
      btnParcelToggle.classList.toggle('open', menuOpen);
      // no text to update
    });

    // Invisible topbar tap area ‚Üí show camera/QR controls
    const topbarTapArea = document.getElementById('topbarTapArea');
    if(topbarTapArea){
      topbarTapArea.addEventListener('click', ()=> showUI(true));
    }

    document.querySelectorAll('.pmBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const rarity = btn.dataset.rarity;
        createParcelInstance(rarity);
        // Close menu after placing
        menuOpen = false;
        parcelMenu.classList.remove('open');
        parcelMenu.classList.add('closed');
        btnParcelToggle.classList.remove('open');
      });
    });

    // ‚îÄ‚îÄ QR Scanner ‚Üí also spawns a draggable parcel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let qrStream = null;
    let qrScanning = false;
    let qrDetector = null;
    let qrLoopTimer = null;
    const qrOverlay = document.getElementById('qrOverlay');
    const qrVideo   = document.getElementById('qrVideo');
    const qrStatus  = document.getElementById('qrStatus');
    const btnQR     = document.getElementById('btnQR');

    const hasBarcodeDetector = ('BarcodeDetector' in window);
    if(hasBarcodeDetector){
      try{ qrDetector = new BarcodeDetector({ formats:['qr_code'] }); }catch(e){ qrDetector=null; }
    }

    if(!qrDetector){
      const qrBox = document.querySelector('.qrBox');
      const inp = document.createElement('input');
      inp.type='text'; inp.placeholder='AEMX-COMMON / RARE / EPIC / LEGENDARY';
      inp.style.cssText='background:rgba(5,10,20,.85);border:1px solid rgba(0,200,255,.35);color:#fff;padding:8px 12px;border-radius:8px;width:100%;font-family:Orbitron,system-ui;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;outline:none;text-align:center;margin-top:8px;';
      const btn2 = document.createElement('button');
      btn2.textContent='CONFIRMAR';
      btn2.style.cssText='margin-top:6px;padding:7px 22px;border-radius:8px;border:1px solid rgba(0,200,255,.30);background:rgba(0,200,255,.10);color:#fff;font-family:Orbitron,system-ui;font-weight:800;font-size:9px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;width:100%;';
      const confirm=()=>{
        const code=inp.value.trim().toUpperCase();
        const rarity=RARITY_MAP[code];
        if(rarity){ closeQR(); createParcelInstance(rarity); }
        else qrStatus.textContent='‚ö† C√ìDIGO NO V√ÅLIDO';
      };
      btn2.addEventListener('click',confirm);
      inp.addEventListener('keydown',e=>{ if(e.key==='Enter') confirm(); });
      qrBox.appendChild(inp); qrBox.appendChild(btn2);
    }

    async function openQR(){
      qrOverlay.classList.remove('hidden');
      btnQR.style.background='rgba(250,204,21,.25)';
      btnQR.style.borderColor='rgba(250,204,21,.80)';
      if(!qrDetector){
        document.querySelector('.qrFrame').style.display='none';
        qrStatus.textContent='INGRESA EL C√ìDIGO MANUALMENTE';
        return;
      }
      qrStatus.textContent='INICIANDO C√ÅMARA‚Ä¶';
      try{
        qrStream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} },
          audio:false
        });
        qrVideo.srcObject = qrStream;
        await qrVideo.play();
        qrScanning = true;
        qrStatus.textContent='APUNTA AL C√ìDIGO QR';
        scanLoop();
      }catch(e){
        qrStatus.textContent='ERROR DE C√ÅMARA';
      }
    }

    function closeQR(){
      qrScanning=false;
      if(qrLoopTimer){ clearTimeout(qrLoopTimer); qrLoopTimer=null; }
      if(qrStream){ qrStream.getTracks().forEach(t=>t.stop()); qrStream=null; }
      qrVideo.srcObject=null;
      qrOverlay.classList.add('hidden');
      btnQR.style.background='rgba(5,10,20,.72)';
      btnQR.style.borderColor='rgba(250,204,21,.45)';
    }

    async function scanLoop(){
      if(!qrScanning||!qrDetector) return;
      try{
        const barcodes = await qrDetector.detect(qrVideo);
        if(barcodes.length>0){
          const code=barcodes[0].rawValue.trim().toUpperCase();
          const rarity=RARITY_MAP[code];
          if(rarity){
            qrStatus.textContent='‚úì '+code;
            closeQR();
            createParcelInstance(rarity);
            return;
          } else {
            qrStatus.textContent='QR NO RECONOCIDO';
          }
        }
      }catch(e){}
      if(qrScanning) qrLoopTimer=setTimeout(scanLoop,150);
    }

    document.getElementById('btnQRClose').addEventListener('click', closeQR);
    btnQR.addEventListener('click', ()=>{
      if(qrOverlay.classList.contains('hidden')) openQR();
      else closeQR();
    });

    // Remove old single AR canvas (no longer needed)
    const oldAR = document.getElementById('arCanvas');
    if(oldAR) oldAR.remove();
    const oldARClose = document.getElementById('btnARClose');
    if(oldARClose) oldARClose.remove();

    // ‚îÄ‚îÄ Restore saved parcelas on load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    loadParcelState();

    // ‚îÄ‚îÄ Gyroscope: shift parcelas slightly when device moves ‚îÄ‚îÄ
    let gyroEnabled = false;
    let lastBeta = null, lastGamma = null;
    const GYRO_SENSITIVITY = 3.5;

    function onDeviceOrientation(e){
      if(lastBeta === null){ lastBeta = e.beta; lastGamma = e.gamma; return; }

      // Detectar orientaci√≥n: en landscape beta y gamma se intercambian
      const isLandscape = window.innerWidth > window.innerHeight;
      let dx, dy;
      if(isLandscape){
        // En horizontal: gamma mueve X, beta mueve Y
        dx = (e.beta  - lastBeta)  * GYRO_SENSITIVITY;
        dy = (e.gamma - lastGamma) * GYRO_SENSITIVITY * -1;
      } else {
        // En vertical: gamma mueve X, beta mueve Y (invertido para efecto AR)
        dx = (e.gamma - lastGamma) * GYRO_SENSITIVITY;
        dy = (e.beta  - lastBeta)  * GYRO_SENSITIVITY * -1;
      }
      lastBeta  = e.beta;
      lastGamma = e.gamma;

      parcelInstances.forEach(inst=>{
        const left = parseFloat(inst.wrap.style.left) || 0;
        const top  = parseFloat(inst.wrap.style.top)  || 0;
        inst.wrap.style.left = (left - dx) + 'px';
        inst.wrap.style.top  = (top  - dy) + 'px';
      });
    }

    function enableGyro(){
      if(typeof DeviceOrientationEvent !== 'undefined' &&
         typeof DeviceOrientationEvent.requestPermission === 'function'){
        // iOS 13+ requiere gesto del usuario para pedir permiso
        DeviceOrientationEvent.requestPermission().then(state=>{
          if(state === 'granted'){
            window.addEventListener('deviceorientation', onDeviceOrientation);
            gyroEnabled = true;
          }
        }).catch(()=>{});
      } else {
        window.addEventListener('deviceorientation', onDeviceOrientation);
        gyroEnabled = true;
      }
    }

    // Activar al cargar (Android) o al primer tap en iOS
    let gyroInitialized = false;
    function tryEnableGyro(){
      if(gyroInitialized) return;
      gyroInitialized = true;
      enableGyro();
    }
    // Android: activar directo
    tryEnableGyro();
    // iOS: necesita gesto ‚Äî activar en primer tap
    document.addEventListener('pointerdown', tryEnableGyro, { once:true });

    </script>


    <!-- BOOT OVERLAY -->
    <div id="bootOverlay">
      <div id="bootLine"></div>
      <div id="bootMsg">Verificando orientaci√≥n‚Ä¶</div>
    </div>
    <div id="gateTop"></div>
    <div id="gateBottom"></div>

    <!-- LOGIN OVERLAY -->
    <div class="loginOverlay hidden" id="loginOverlay">
      <div class="loginBox">
        <div class="loginTitle">AEMX HUD</div>
        <div class="loginSub">Inicia sesi√≥n para ver el chat en vivo</div>
        <button class="loginBtn" id="btnLogin">
          <svg width="18" height="18" viewBox="0 0 48 48" style="display:inline-block;vertical-align:middle;margin-right:8px;"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
          Iniciar con Google
        </button>
        <div class="loginHint" id="loginHint"></div>
        <button class="loginSkip" id="btnSkipLogin">Omitir (solo pruebas)</button>
      </div>
    </div>
  </div>

  <script>

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 1) Stats source (GamerTag localStorage)
    // SAVE_KEY identificado en tu index: 'atlas-earth-calc-data'
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SAVE_KEY = 'atlas-earth-calc-data';

    function toInt(x){
      const n = Number(String(x ?? '').replace(/[^\d.-]/g,''));
      return Number.isFinite(n) ? Math.max(0, Math.floor(n)) : 0;
    }

    function readStats(){
      // 1) Preferir JSON del SAVE_KEY
      let d = null;
      try{
        const raw = localStorage.getItem(SAVE_KEY);
        if(raw) d = JSON.parse(raw);
      }catch(e){ d = null; }

      // 2) Fallback: leer claves sueltas si existieran
      const fallback = (k) => {
        try { return localStorage.getItem(k); } catch(e){ return null; }
      };

      const common     = toInt(d?.common     ?? fallback('common'));
      const rare       = toInt(d?.rare       ?? fallback('rare'));
      const epic       = toInt(d?.epic       ?? fallback('epic'));
      const legendary  = toInt(d?.legendary  ?? fallback('legendary'));
      const badges     = toInt(d?.badges     ?? fallback('badges'));
      const diamonds   = toInt(d?.diamonds   ?? fallback('diamonds'));
      const atlasbucks = toInt(d?.atlasbucks ?? fallback('atlasbucks'));

      return { common, rare, epic, legendary, badges, diamonds, atlasbucks };
    }

    function renderStats(s){
      // numbers
      document.getElementById('numCommon').textContent = s.common;
      document.getElementById('numRare').textContent = s.rare;
      document.getElementById('numEpic').textContent = s.epic;
      document.getElementById('numLegendary').textContent = s.legendary;

      const total = Math.max(0, s.common + s.rare + s.epic + s.legendary);
      document.getElementById('totalParcels').textContent = total;
      // 100% = next hundred above commons (e.g. 1450 ‚Üí 1500)
      const refMax = s.common > 0 ? Math.ceil(s.common / 100) * 100 : 100;
      const pct = (v) => Math.min(100, Math.round((v / refMax) * 100));
      document.getElementById('fillCommon').style.width = pct(s.common) + '%';
      document.getElementById('fillRare').style.width = pct(s.rare) + '%';
      document.getElementById('fillEpic').style.width = pct(s.epic) + '%';
      document.getElementById('fillLegendary').style.width = pct(s.legendary) + '%';

      // badges cards
      document.getElementById('badgesVal').textContent = s.badges;
      document.getElementById('badgesValGhost1').textContent = s.badges;
      document.getElementById('badgesValGhost2').textContent = s.badges;

      // diamonds battery (0..9999)
      const d = Math.min(9999, s.diamonds);
      const pctDisplay = Math.round((d / 9999) * 100);
      document.getElementById('diamondsVal').textContent = pctDisplay + '%';

      // Battery shape ‚Äî color verde‚Üíazul‚Üíamarillo‚Üínaranja‚Üírojo
      const battFill = document.getElementById('batteryFill');
      const battSpark = document.getElementById('batterySpark');
      if(battFill){
        const pctBatt = Math.round((d / 9999) * 100);

        // El fill vive dentro del cuerpo (left:2px right:10px), as√≠ que width = pct%
        battFill.style.width = pctBatt + '%';

        // Color seg√∫n nivel
        let color1, color2, glowColor;
        if(pctBatt >= 75){
          color1='#16a34a'; color2='#4ade80'; glowColor='rgba(74,222,128,.70)';
        } else if(pctBatt >= 50){
          color1='#0369a1'; color2='#38bdf8'; glowColor='rgba(56,189,248,.70)';
        } else if(pctBatt >= 30){
          color1='#a16207'; color2='#facc15'; glowColor='rgba(250,204,21,.70)';
        } else if(pctBatt >= 15){
          color1='#c2410c'; color2='#fb923c'; glowColor='rgba(251,146,60,.70)';
        } else {
          color1='#9f1239'; color2='#ff4466'; glowColor='rgba(255,68,102,.70)';
        }
        battFill.style.background = `linear-gradient(90deg, ${color1}, ${color2})`;
        battFill.style.boxShadow = `0 0 14px ${glowColor}`;
        if(battSpark){
          battSpark.style.left = pctBatt + '%';
          battSpark.style.color = color2;
          battSpark.style.background = color2;
          battSpark.style.boxShadow = `0 0 10px ${glowColor}, 0 0 20px ${glowColor}`;
        }
      }
    }

    function refreshStats(){
      renderStats(readStats());
    }

    // update on load + on storage changes
    refreshStats();
    window.addEventListener('storage', (e) => {
      if(e.key === SAVE_KEY || ['common','rare','epic','legendary','badges','diamonds','atlasbucks'].includes(e.key)) {
        refreshStats();
      }
    });
    // also poll (mobile Safari sometimes doesn‚Äôt dispatch storage reliably across tabs)
    setInterval(refreshStats, 1200);

    document.getElementById('btnReloadStats').addEventListener('click', refreshStats);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 2) Camera
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const camVideo = document.getElementById('cam');
    const btnStart = document.getElementById('btnStart');
    const camDot = document.getElementById('camDot');
    const camLabel = document.getElementById('camLabel');
    const btnFlip = document.getElementById('btnFlip');
    const btnFullscreen = document.getElementById('btnFullscreen');
    const rotateHint = document.getElementById('rotateHint');

    const btnUI = document.getElementById('btnUI');
    const btnFS = document.getElementById('btnFS');
    const topbar = document.querySelector('.topbar');
    const tapHint = document.getElementById('tapHint');

    let uiHidden = true;
    let uiTimer = null;

    function showUI(temp=true){
      uiHidden = false;
      topbar.classList.remove('hidden');
      tapHint.classList.remove('show');
      if(topbarTapArea) topbarTapArea.style.pointerEvents = 'none';
      const _btnQR = document.getElementById('btnQR');
      if(_btnQR) _btnQR.style.transform = 'translateX(0)';
      if(uiTimer) clearTimeout(uiTimer);
      if(temp){
        uiTimer = setTimeout(() => hideUI(), 2600);
      }
    }
    function hideUI(){
      uiHidden = true;
      topbar.classList.add('hidden');
      tapHint.classList.add('show');
      if(topbarTapArea) topbarTapArea.style.pointerEvents = 'auto';
      const _btnQR = document.getElementById('btnQR');
      if(_btnQR) _btnQR.style.transform = 'translateX(-120%)';
    }

    // start hidden (requested)
    hideUI();

    // Tap anywhere to show controls briefly
    const reveal = (e) => {
      if(e && (e.target?.closest?.('.topbar') || e.target?.closest?.('.miniBtn'))) return;
      showUI(true);
    };
    // reveal only via topbar tap area (btnParcelToggle area) ‚Äî removed global listeners

    btnUI.addEventListener('click', () => {
      if(uiHidden) showUI(false);
      else hideUI();
    });

    async function toggleFullscreen(){
      try{
        if(!document.fullscreenElement){
          await document.documentElement.requestFullscreen?.();
          await requestLandscapeLock();
        }else{
          await document.exitFullscreen?.();
        }
      }catch(e){}
      syncFSLabel();
      checkOrientationHint();
    }

    function syncFSLabel(){
      const on = !!document.fullscreenElement;
      btnFS.textContent = on ? 'SALIR' : 'FULL';
      // keep original chip label if visible
      try{ document.getElementById('btnFullscreen').textContent = on ? '‚õ∂ SALIR' : '‚õ∂ FULL'; }catch(e){}
    }

    btnFS.addEventListener('click', toggleFullscreen);

    document.getElementById('btnExit').addEventListener('click', () => { if(window.opener) window.close(); else history.back(); });
    document.addEventListener('fullscreenchange', syncFSLabel);
    syncFSLabel();


    let camStream = null;
    let mirrored = false;
    let facingMode = 'environment';

    function setCamState(on){
      camDot.classList.toggle('ok', on);
      btnStart.classList.toggle('ok', on);
      camLabel.textContent = on ? 'C√ÅMARA: ON' : 'C√ÅMARA: OFF';
    }

    async function startCamera(){
      if(camStream) return;
      try{
        camStream = await navigator.mediaDevices.getUserMedia({
          audio:false,
          video:{
            facingMode:{ ideal: facingMode },
            width:{ ideal:1280 },
            height:{ ideal:720 }
          }
        });
        camVideo.srcObject = camStream;
        setCamState(true);
      }catch(e){
        console.error('getUserMedia error:', e);
        alert('No se pudo abrir la c√°mara. Revisa permisos del navegador.');
        setCamState(false);
      }
    }

    function stopCamera(){
      if(!camStream) return;
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
      camVideo.srcObject = null;
      setCamState(false);
    }

    btnStart.addEventListener('click', async () => {
      if(camStream) stopCamera();
      else await startCamera();
    });

    btnFlip.addEventListener('click', () => {
      mirrored = !mirrored;
      camVideo.style.transform = mirrored ? 'scaleX(-1)' : 'scaleX(1)';
    });

    const btnCamSwitch = document.getElementById('btnCamSwitch');
    btnCamSwitch.addEventListener('click', async () => {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      btnCamSwitch.textContent = facingMode === 'environment' ? '‚óâ FRONTAL' : '‚óâ TRASERA';
      // Auto-mirror front camera, unmirror back
      mirrored = facingMode === 'user';
      camVideo.style.transform = mirrored ? 'scaleX(-1)' : 'scaleX(1)';
      if(camStream){
        stopCamera();
        await startCamera();
      }
    });

    async function requestLandscapeLock(){
      try{
        if(screen.orientation && screen.orientation.lock){
          await screen.orientation.lock('landscape');
        }
      }catch(e){
        // iOS Safari: no soporta lock (ignorar)
      }
    }

    if(btnFullscreen) btnFullscreen.addEventListener('click', async () => {
      if (typeof toggleFullscreen === 'function') {
        await toggleFullscreen();
        return;
      }
      try{ await document.documentElement.requestFullscreen?.(); }catch(e){}
      await requestLandscapeLock();
      checkOrientationHint();
    });

    function checkOrientationHint(){
      // show hint if portrait (best-effort)
      const isPortrait = window.matchMedia && window.matchMedia("(orientation: portrait)").matches;
      rotateHint.style.display = isPortrait ? 'flex' : 'none';
    }
    window.addEventListener('resize', checkOrientationHint);
    window.addEventListener('orientationchange', checkOrientationHint);
    checkOrientationHint();

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 3) Firebase: last 5 messages (read-only HUD)
    // Cargado din√°micamente para no bloquear c√°mara/botones
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Funciones de chat accesibles globalmente
    const chatLampEl  = document.getElementById('chatLamp');
    const chatStateEl = document.getElementById('chatState');
    const chatLinesEl = document.getElementById('chatLines');

    function setChatState(on, label){
      if(chatLampEl)  chatLampEl.classList.toggle('ok', on);
      if(chatStateEl) chatStateEl.textContent = label || (on ? 'LIVE' : '‚Äî');
    }
    function safeStr(x, max=140){
      const s = String(x ?? '').replace(/\s+/g,' ').trim();
      if(!s) return '';
      return s.length > max ? s.slice(0, max-1) + '‚Ä¶' : s;
    }
    function renderChat(list){
      if(!chatLinesEl) return;
      chatLinesEl.innerHTML = '';
      if(!list.length){
        chatLinesEl.innerHTML = '<div class="msg"><span class="a">‚Äî</span><span class="t">Sin mensajes recientes.</span></div>';
        return;
      }
      for(const m of list){
        const row = document.createElement('div');
        row.className = 'msg';
        const a = document.createElement('span'); a.className = 'a';
        a.textContent = safeStr(m.username || m.user || m.author || m.name || 'AEMX', 18);
        const sep = document.createElement('span'); sep.className = 'sep'; sep.textContent = '¬∑';
        const t = document.createElement('span'); t.className = 't';
        t.textContent = safeStr(m.text || m.message || m.msg || m.mensaje || '', 100) || '‚Ä¶';
        row.appendChild(a); row.appendChild(sep); row.appendChild(t);
        chatLinesEl.appendChild(row);
      }
    }

    // btnSkipLogin funciona siempre, independiente de Firebase
    document.getElementById('btnSkipLogin').addEventListener('click', () => {
      document.getElementById('loginOverlay').classList.add('hidden');
      setChatState(false, 'SIN SESI√ìN');
      renderChat([{ username: 'AEMX', text: 'Chat no disponible sin sesi√≥n.' }]);
    });

    (async () => {
      let initializeApp, getDatabase, ref, query, limitToLast, orderByChild, onValue, get,
          getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, browserLocalPersistence, setPersistence;
      try {
        ({ initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'));
        ({ getDatabase, ref, query, limitToLast, orderByChild, onValue, get } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js'));
        ({ getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, browserLocalPersistence, setPersistence } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js'));
      } catch(importErr) {
        console.warn('Firebase no disponible:', importErr);
        setChatState(false, 'ERR');
        return;
      }

    const firebaseConfig = {
      apiKey: "AIzaSyB-xx2PlBjvnHe0K7Bf1MspVqUlfjky0mk",
      authDomain: "aemx-chat.firebaseapp.com",
      databaseURL: "https://aemx-chat-default-rtdb.firebaseio.com",
      projectId: "aemx-chat",
      storageBucket: "aemx-chat.appspot.com",
      messagingSenderId: "267113002594",
      appId: "1:267113002594:web:4099e7537d950f5753433b",
      measurementId: "G-K84EVPE46R"
    };

    // setChatState, safeStr, renderChat definidos globalmente arriba

    try{
      const app = initializeApp(firebaseConfig, 'hud-app');
      const db  = getDatabase(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      // ‚îÄ‚îÄ Login overlay logic ‚îÄ‚îÄ
      const loginOverlay = document.getElementById('loginOverlay');
      const btnLogin     = document.getElementById('btnLogin');
      const loginHint    = document.getElementById('loginHint');

      function showLoginOverlay(){
        loginOverlay.classList.remove('hidden');
        setChatState(false, 'SIN SESI√ìN');
        renderChat([]);
      }
      function hideLoginOverlay(){
        loginOverlay.classList.add('hidden');
      }

      btnLogin.addEventListener('click', async () => {
        btnLogin.disabled = true;
        btnLogin.textContent = 'CONECTANDO‚Ä¶';
        loginHint.textContent = '';
        try{
          await setPersistence(auth, browserLocalPersistence);
          await signInWithPopup(auth, provider);
          // onAuthStateChanged will handle the rest
        }catch(e){
          console.error('Login error:', e);
          loginHint.textContent = e.code === 'auth/popup-blocked'
            ? 'Popup bloqueado ‚Äî permite popups en este sitio.'
            : 'Error al iniciar sesi√≥n. Intenta de nuevo.';
          btnLogin.disabled = false;
          btnLogin.innerHTML = `<svg width="18" height="18" viewBox="0 0 48 48" style="display:inline-block;vertical-align:middle;margin-right:8px;"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>Iniciar con Google`;
        }
      });

      // Helper to attach Realtime DB listener
      const attachListener = () => {
        const q = query(ref(db, 'messages'), orderByChild('timestamp'), limitToLast(5));
        onValue(q, (snap) => {
          const arr = [];
          if(snap.exists()){
            snap.forEach(child => {
              const val = child.val();
              // Normalize timestamp: serverTimestamp() may arrive as object or null briefly
              if(val && (val.username || val.user) && (val.text || val.message || val.msg)){
                const ts = typeof val.timestamp === 'number' ? val.timestamp : Date.now();
                arr.push({ ...val, timestamp: ts });
              }
            });
            arr.sort((a,b) => a.timestamp - b.timestamp);
          }
          renderChat(arr);
          const _uname = (window._hudUsername || '').toUpperCase() || 'LIVE';
          setChatState(true, _uname);
        }, (err) => {
          console.error('HUD chat onValue error:', err);
          setChatState(false, 'DENIED');
          renderChat([]);
        });
      };

      // Activar persistencia y esperar estado de auth
      setPersistence(auth, browserLocalPersistence).catch(console.warn);

      onAuthStateChanged(auth, async (user) => {
        if(user){
          hideLoginOverlay();
          // Leer username desde Firebase (fuente de verdad)
          try {
            const snap = await get(ref(db, `users/${user.uid}/username`));
            const fbUsername = snap.exists() ? snap.val() : null;
            const firstName = (fbUsername || localStorage.getItem('atlas-username') || user.displayName || 'USER').split(' ')[0].toUpperCase();
            window._hudUsername = firstName;
            setChatState(true, firstName);
          } catch(e) {
            // Fallback a localStorage si falla la lectura
            const firstName = (localStorage.getItem('atlas-username') || user.displayName || 'USER').split(' ')[0].toUpperCase();
            window._hudUsername = firstName;
            setChatState(true, firstName);
          }
          attachListener();
        } else {
          showLoginOverlay();
        }
      });

    }catch(e){
      console.error('Firebase init error:', e);
      setChatState(false, 'ERR');
    }
    })(); // fin async IIFE Firebase

    // ‚îÄ‚îÄ Curved HUD grid + scanline + glitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const NS = 'http://www.w3.org/2000/svg';

    function buildCurvedGrid(){
      const svg = document.getElementById('hudGrid');
      if(!svg) return;
      const W = window.innerWidth;
      const H = window.innerHeight;
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      svg.innerHTML = '';

      const cols = 14;
      const rows = 10;
      const curve = 0.10;

      const fade = (t) => Math.min(1, Math.min(t, 1-t) * 6);

      // Grid group
      const gridGroup = document.createElementNS(NS, 'g');
      gridGroup.id = 'gridLines';

      for(let i = 0; i <= cols; i++){
        const t = i / cols;
        const x = t * W;
        const bulgeX = (x - W*0.5) * curve;
        const op = (fade(t) * 0.9).toFixed(3);
        const p = document.createElementNS(NS,'path');
        p.setAttribute('d', `M ${x} 0 C ${x-bulgeX} ${H*0.25}, ${x-bulgeX} ${H*0.75}, ${x} ${H}`);
        p.setAttribute('stroke', `rgba(0,200,255,${op})`);
        p.setAttribute('stroke-width','0.7');
        p.setAttribute('fill','none');
        gridGroup.appendChild(p);
      }
      for(let j = 0; j <= rows; j++){
        const t = j / rows;
        const y = t * H;
        const bulgeY = (y - H*0.5) * curve;
        const op = (fade(t) * 0.9).toFixed(3);
        const p = document.createElementNS(NS,'path');
        p.setAttribute('d', `M 0 ${y} C ${W*0.25} ${y-bulgeY}, ${W*0.75} ${y-bulgeY}, ${W} ${y}`);
        p.setAttribute('stroke', `rgba(0,200,255,${op})`);
        p.setAttribute('stroke-width','0.7');
        p.setAttribute('fill','none');
        gridGroup.appendChild(p);
      }
      svg.appendChild(gridGroup);

      // ‚îÄ‚îÄ Scanline (gradient trail: opaque top ‚Üí transparent bottom) ‚îÄ‚îÄ
      const defs = document.createElementNS(NS,'defs');
      const grad = document.createElementNS(NS,'linearGradient');
      grad.id = 'scanGrad';
      grad.setAttribute('x1','0'); grad.setAttribute('y1','0');
      grad.setAttribute('x2','0'); grad.setAttribute('y2','1');
      const s1 = document.createElementNS(NS,'stop');
      s1.setAttribute('offset','0%');   s1.setAttribute('stop-color','rgba(0,200,255,0)');
      const s2 = document.createElementNS(NS,'stop');
      s2.setAttribute('offset','60%');  s2.setAttribute('stop-color','rgba(0,200,255,0.08)');
      const s3 = document.createElementNS(NS,'stop');
      s3.setAttribute('offset','100%'); s3.setAttribute('stop-color','rgba(0,200,255,0.28)');
      grad.appendChild(s1); grad.appendChild(s2); grad.appendChild(s3);
      defs.appendChild(grad);
      svg.appendChild(defs);

      const scanline = document.createElementNS(NS,'rect');
      scanline.id = 'hudScanline';
      scanline.setAttribute('x','0');
      scanline.setAttribute('y','0');
      scanline.setAttribute('width', W);
      scanline.setAttribute('height','80');
      scanline.setAttribute('fill','url(#scanGrad)');
      svg.appendChild(scanline);

      // ‚îÄ‚îÄ Glitch rects (2 hidden bands) ‚îÄ‚îÄ
      for(let g=0;g<2;g++){
        const gr = document.createElementNS(NS,'rect');
        gr.classList.add('glitchBand');
        gr.setAttribute('x','0');
        gr.setAttribute('y','-20');
        gr.setAttribute('width', W);
        gr.setAttribute('height','6');
        gr.setAttribute('fill','rgba(0,200,255,0.12)');
        gr.setAttribute('opacity','0');
        svg.appendChild(gr);
      }
    }

    buildCurvedGrid();
    window.addEventListener('resize', buildCurvedGrid);

    // Subtle grid pulse
    const hudGridEl = document.getElementById('hudGrid');
    if(hudGridEl){
      hudGridEl.animate(
        [{opacity:0.75},{opacity:1},{opacity:0.75}],
        {duration:4000, iterations:Infinity, easing:'ease-in-out'}
      );
    }

    // ‚îÄ‚îÄ Scanline animation (always re-queries element so survives rebuilds) ‚îÄ‚îÄ
    let _scanY = -80;
    function scanlineLoop(){
      const line = document.querySelector('#hudScanline');
      if(line){
        const H = window.innerHeight;
        _scanY += 1.8;
        if(_scanY > H) _scanY = -80;
        line.setAttribute('y', _scanY);
      }
      requestAnimationFrame(scanlineLoop);
    }
    scanlineLoop();

    // ‚îÄ‚îÄ Glitch animation ‚îÄ‚îÄ
    function triggerGlitch(){
      const svg = document.getElementById('hudGrid');
      if(!svg) return;
      const H = window.innerHeight;
      const W = window.innerWidth;
      const bands = svg.querySelectorAll('.glitchBand');
      bands.forEach(band => {
        const y = Math.random() * H;
        const h = 4 + Math.random() * 14;
        const offsetX = (Math.random() - 0.5) * 18;
        band.setAttribute('y', y);
        band.setAttribute('height', h);
        band.setAttribute('x', offsetX);
        band.setAttribute('opacity','1');
        // Also shift a random section of the grid briefly
        const gridLines = svg.querySelector('#gridLines');
        if(gridLines){
          const sliceY = y;
          const sliceH = h;
          gridLines.setAttribute('transform',`translate(${offsetX * 0.4},0)`);
          setTimeout(()=>{
            gridLines.setAttribute('transform','translate(0,0)');
          }, 80);
        }
        setTimeout(()=>{ band.setAttribute('opacity','0'); }, 120);
      });
      // Random interval: 2.5s to 7s
      setTimeout(triggerGlitch, 2500 + Math.random() * 4500);
    }
    setTimeout(triggerGlitch, 1500 + Math.random() * 2000);

    // ‚îÄ‚îÄ Battery glitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function triggerBatteryGlitch(){
      const el = document.getElementById('batteryFill');
      if(!el) return;
      const dur = 200 + Math.random() * 150;
      el.style.animation = `batteryGlitch ${dur}ms steps(4,end) 1`;
      const val = document.getElementById('diamondsVal');
      if(val){ val.style.filter='brightness(2) hue-rotate(20deg)'; }
      setTimeout(() => {
        el.style.animation = '';
        if(val) val.style.filter = '';
      }, dur + 50);
      setTimeout(triggerBatteryGlitch, 3000 + Math.random() * 5000);
    }
    setTimeout(triggerBatteryGlitch, 2500 + Math.random() * 2000);

    // ‚îÄ‚îÄ Badge glitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function triggerBadgeGlitch(){
      const card = document.querySelector('.badgeCard:nth-child(3)');
      const val  = document.getElementById('badgesVal');
      if(!card) return;
      const dur = 180 + Math.random() * 120;
      card.style.animation = `badgeGlitch ${dur}ms steps(4,end) 1`;
      if(val){ val.style.filter='brightness(2.5) hue-rotate(40deg)'; val.style.transform='translateX(3px)'; }
      setTimeout(() => {
        card.style.animation = '';
        if(val){ val.style.filter=''; val.style.transform=''; }
      }, dur + 50);
      setTimeout(triggerBadgeGlitch, 2500 + Math.random() * 5000);
    }
    setTimeout(triggerBadgeGlitch, 3500 + Math.random() * 2000);

    // ‚îÄ‚îÄ Bar stats glitch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const BAR_IDS = ['fillCommon','fillRare','fillEpic','fillLegendary'];
    const NUM_IDS = ['numCommon','numRare','numEpic','numLegendary'];

    function triggerBarGlitch(){
      // Pick 1-2 random bars to glitch
      const count = Math.random() < 0.4 ? 2 : 1;
      const shuffled = [...BAR_IDS].sort(()=>Math.random()-.5).slice(0, count);
      shuffled.forEach(id => {
        const el = document.getElementById(id);
        const num = document.getElementById(id.replace('fill','num'));
        if(!el) return;
        const dur = 180 + Math.random() * 120;
        el.style.animation = `barGlitch ${dur}ms steps(3,end) 1`;
        if(num) num.style.animation = `numGlitch ${dur}ms steps(3,end) 1`;
        setTimeout(() => {
          el.style.animation = '';
          if(num) num.style.animation = '';
        }, dur + 50);
      });
      // Next glitch: 1.5s to 5s
      setTimeout(triggerBarGlitch, 1500 + Math.random() * 3500);
    }
    setTimeout(triggerBarGlitch, 2000 + Math.random() * 2000);
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // ‚îÄ‚îÄ BOOT SEQUENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const bootOverlay  = document.getElementById('bootOverlay');
    const bootMsg      = document.getElementById('bootMsg');
    const gateTop      = document.getElementById('gateTop');
    const gateBottom   = document.getElementById('gateBottom');
    let   bootDone     = false;

    function openGates(){
      if(bootDone) return;
      bootDone = true;
      bootOverlay.classList.add('hidden');
      setTimeout(() => {
        gateTop.classList.add('open');
        gateBottom.classList.add('open');
        // Eliminar compuertas del DOM cuando termina la animaci√≥n
        setTimeout(() => { gateTop.remove(); gateBottom.remove(); }, 800);
      }, 50);
    }

    async function bootSequence(){
      // Paso 1: esperar orientaci√≥n landscape
      const isLandscape = () => window.innerWidth > window.innerHeight;
      if(!isLandscape()){
        bootMsg.textContent = 'Gira el dispositivo‚Ä¶';
        await new Promise(resolve => {
          const check = () => {
            if(isLandscape()){ window.removeEventListener('resize', check); resolve(); }
          };
          window.addEventListener('resize', check);
        });
      }

      // Paso 2: iniciar c√°mara en segundo plano
      bootMsg.textContent = 'Iniciando c√°mara‚Ä¶';
      await startCamera();

      // Paso 3: esperar que el video tenga datos reales
      if(camVideo.readyState < 2){
        await new Promise(resolve => {
          camVideo.addEventListener('canplay', resolve, { once:true });
          setTimeout(resolve, 4000); // timeout de seguridad
        });
      }

      // Paso 4: esperar 3 segundos con c√°mara activa
      bootMsg.textContent = 'Iniciando HUD‚Ä¶';
      await new Promise(r => setTimeout(r, 3000));

      // Paso 5: abrir compuertas
      openGates();
    }
    bootSequence();

    // ‚îÄ‚îÄ Hand Pose Detection (TF.js v4 + hand-pose-detection v2) ‚îÄ‚îÄ
    (function initHandTracking(){
      const handCanvas = document.getElementById('handCanvas');
      const ctx        = handCanvas.getContext('2d');
      const camEl      = document.getElementById('cam');

      // 21 keypoints, conexiones est√°ndar MediaPipe
      const CONNECTIONS = [
        [0,1],[1,2],[2,3],[3,4],
        [0,5],[5,6],[6,7],[7,8],
        [0,9],[9,10],[10,11],[11,12],
        [0,13],[13,14],[14,15],[15,16],
        [0,17],[17,18],[18,19],[19,20],
        [5,9],[9,13],[13,17]
      ];
      const COLORS = { Left:'#4ade80', Right:'#fb923c' };

      function resizeCanvas(){
        handCanvas.width  = window.innerWidth;
        handCanvas.height = window.innerHeight;
        handCanvas.style.width  = window.innerWidth  + 'px';
        handCanvas.style.height = window.innerHeight + 'px';
      }
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      // MediaPipe Hands da coords normalizadas [0-1]
      function toScreen(lm){
        const W = window.innerWidth, H = window.innerHeight;
        const isMirrored = camEl.style.transform === 'scaleX(-1)';
        return {
          x: (isMirrored ? 1 - lm.x : lm.x) * W,
          y: lm.y * H
        };
      }

      function drawHand(keypoints, handedness){
        // handedness puede llegar como string o como array de scores
        const label = typeof handedness === 'string' ? handedness : (handedness?.[0]?.label || 'Left');
        const color = COLORS[label] || '#00c8ff';

        // Filtrar keypoints inv√°lidos
        const valid = keypoints.map(kp => {
          if(!kp || isNaN(kp.x) || isNaN(kp.y)) return null;
          return toScreen(kp);
        });

        ctx.strokeStyle = color;
        ctx.lineWidth   = 3;
        ctx.shadowColor = color;
        ctx.shadowBlur  = 14;
        ctx.lineCap     = 'round';
        ctx.lineJoin    = 'round';

        CONNECTIONS.forEach(([a, b]) => {
          const pa = valid[a], pb = valid[b];
          if(!pa || !pb) return;
          ctx.beginPath();
          ctx.moveTo(pa.x, pa.y);
          ctx.lineTo(pb.x, pb.y);
          ctx.stroke();
        });

        valid.forEach((p, i) => {
          if(!p) return;
          const r = i === 0 ? 10 : (i % 4 === 0 ? 7 : 5);
          ctx.beginPath();
          ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
          ctx.fillStyle   = '#ffffff';
          ctx.shadowColor = color;
          ctx.shadowBlur  = 18;
          ctx.fill();
          ctx.beginPath();
          ctx.arc(p.x, p.y, r + 2, 0, Math.PI * 2);
          ctx.strokeStyle = color;
          ctx.lineWidth   = 2;
          ctx.stroke();
        });
      }

      function processHover(keypoints, handedness){
        const color = COLORS[handedness] || '#00c8ff';
        const W = window.innerWidth, H = window.innerHeight;
        const vW = camEl.videoWidth || W, vH = camEl.videoHeight || H;
        const isMirrored = camEl.style.transform === 'scaleX(-1)';
        [8, 0].forEach(idx => {
          const kp = keypoints[idx];
          if(!kp) return;
          const fx = (isMirrored ? 1 - kp.x/vW : kp.x/vW) * W;
          const fy = (kp.y / vH) * H;
          if(typeof parcelInstances !== 'undefined'){
            parcelInstances.forEach(inst => {
              const rect = inst.wrap.getBoundingClientRect();
              const hit  = fx >= rect.left && fx <= rect.right && fy >= rect.top && fy <= rect.bottom;
              if(hit) inst.setHover(true, color, {x:fx, y:fy});
            });
          }
        });
      }


      // Log visible en pantalla para debug
      function dbg(msg){
        console.log('[HandTracking]', msg);
        let el = document.getElementById('_htdbg');
        if(!el){
          el = document.createElement('div');
          el.id = '_htdbg';
          el.style.cssText = 'position:fixed;top:60px;left:10px;z-index:9999;color:#0f0;font-size:11px;font-family:monospace;pointer-events:none;text-shadow:0 0 4px #000;max-width:90vw;';
          document.body.appendChild(el);
        }
        el.innerHTML += msg + '<br>';
      }

      async function startHandTracking(){
        try {
          dbg('Iniciando MediaPipe Hands...');
          const hands = new Hands({
            locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/${f}`
          });
          hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5,
            selfieMode: false
          });
          hands.onResults(results => {
            ctx.clearRect(0, 0, handCanvas.width, handCanvas.height);
            if(typeof parcelInstances !== 'undefined') parcelInstances.forEach(i => i.setHover(false,''));
            if(!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;
            dbg(`Manos: ${results.multiHandLandmarks.length}`);
            results.multiHandLandmarks.forEach((landmarks, i) => {
              const label = results.multiHandedness[i]?.label || 'Left';
              drawHand(landmarks, label);
              processHover(landmarks, label);
            });
          });

          // Inicializar con un frame vac√≠o para forzar carga de WASM
          dbg('Inicializando modelo (puede tardar)...');
          await hands.initialize();
          dbg('Modelo listo ‚úì');

          let sending = false;
          let logged = false;
          let sendLogged = false;
          async function loop(){
            if(!logged){
              dbg(`cam: readyState=${camEl.readyState} vW=${camEl.videoWidth} vH=${camEl.videoHeight}`);
              logged = true;
            }
            if(!sending && camEl.readyState >= 2 && camEl.videoWidth > 0){
              sending = true;
              try {
                await hands.send({ image: camEl });
                if(!sendLogged){ dbg('send() OK'); sendLogged=true; }
              } catch(e){ dbg('send ERR:'+e.message); }
              sending = false;
            }
            requestAnimationFrame(loop);
          }
          loop();
        } catch(e){ dbg('ERROR: ' + e.message); }
      }

      function loadScript(src){
        return new Promise((res, rej) => {
          const s = document.createElement('script');
          s.src = src; s.async = true;
          s.onload = res;
          s.onerror = () => rej(new Error('Fallo: ' + src.split('/').pop()));
          document.head.appendChild(s);
        });
      }

      async function loadAndStart(){
        try {
          dbg('Cargando MediaPipe...');
          await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/hands.min.js');
          dbg('Scripts OK ‚úì');
          startHandTracking();
        } catch(e){ dbg('Script ERR: ' + e.message); }
      }

      function waitForBoot(){
        const boot = document.getElementById('bootOverlay');
        const hidden = !boot || boot.classList.contains('hidden') || getComputedStyle(boot).display === 'none';
        if(hidden){ loadAndStart(); }
        else { setTimeout(waitForBoot, 500); }
      }
      waitForBoot();
    })();
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  </script>
</body>
</html>
