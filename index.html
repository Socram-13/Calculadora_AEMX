<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/png" href="imagen_1.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü™™ Atlas Earth AEMX - GAMERTAG V2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #060b14;
    --panel: #0b1626;
    --panel2: #0f1e35;
    --border: #1a3a5c;
    --glow: #00c8ff;
    --glow2: #00ff9d;
    --gold: #ffd700;
    --epic: #c084fc;
    --rare: #60a5fa;
    --common: #4ade80;
    --legendary: #facc15;
    --text: #cce4ff;
    --text2: #6b8ab0;
    --accent: #00c8ff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    min-height: 100vh;
  }

  html {
    overflow-x: hidden;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,200,255,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,200,255,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    z-index: 0;
    animation: gridMove 20s linear infinite;
  }

  @keyframes gridMove {
    0% { transform: translateY(0); }
    100% { transform: translateY(40px); }
  }

  body::after {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(0,200,255,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(0,255,157,0.04) 0%, transparent 50%);
    z-index: 0;
    pointer-events: none;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 12px 16px 40px;
  }

  header {
    padding: 12px 0 12px;
  }

  .header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    background: linear-gradient(135deg, #0b1f3a 0%, #060f1e 100%);
    border: 3px solid var(--border);
    border-radius: 14px;
    padding: 10px 16px;
    position: relative;
    overflow: hidden;
  }

  .header-bar::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 6px;
    background: linear-gradient(90deg, #00c8ff, #4ade80, #facc15, #c084fc, #00c8ff);
    background-size: 200% 100%;
    animation: rainbowSlide 6s linear infinite;
  }

  @keyframes rainbowSlide {
    0% { background-position: 0% 0; }
    100% { background-position: 200% 0; }
  }

  /* Left: AEMX logo placeholder */
  .header-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
  }

  .aemx-logo-img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    border-radius: 0;
    filter: drop-shadow(0 0 10px rgba(0,200,255,0.3));
  }

  .header-left-label {
    font-family: 'Orbitron', monospace;
    font-size: 7px;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
  }

  /* Center: Title block */
  .header-center {
    flex: 1;
    text-align: center;
  }

  .header-title {
    font-family: 'Orbitron', monospace;
    font-size: clamp(18px, 4vw, 34px);
    font-weight: 900;
    line-height: 1.1;
    letter-spacing: 2px;
  }

  .header-title .atlas { color: #facc15; }
  .header-title .earth { color: #facc15; }
  .header-title .mexico { color: #7EC8E3; }
  .header-title .mexico .i { color: #ef4444; }

  .header-subtitle {
    font-family: 'Orbitron', monospace;
    font-size: clamp(16px, 3vw, 24px);
    font-weight: 700;
    color: #fff;
    letter-spacing: 3px;
    margin-top: 4px;
  }

  .header-tagline {
    font-size: 11px;
    color: var(--text2);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 6px;
  }

  /* Right: Atlas Earth logo */
  .header-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
  }

  .atlas-logo-img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    filter: drop-shadow(0 0 10px rgba(0,200,255,0.3));
  }

  .header-right-label {
    font-family: 'Orbitron', monospace;
    font-size: 7px;
    letter-spacing: 2px;
    color: var(--glow);
    text-transform: uppercase;
  }

  @media (max-width: 480px) {
    .container { padding: 8px 8px 100px; }
    .header-bar { padding: 10px 10px; gap: 6px; }
    .aemx-logo-img, .atlas-logo-img { width: 44px; height: 44px; }
    .header-tagline { display: none; }
    .profile-section {
      flex-direction: column;
      align-items: center;
      padding: 12px 10px;
      gap: 10px;
    }
    .profile-avatar, .profile-avatar-placeholder { width: 90px; height: 90px; }
    .profile-info { width: 100%; text-align: center; }
    .profile-name-input { min-width: 0; width: 100%; font-size: 18px; text-align: center; }
    .donut-wrap { width: 90px; height: 90px; overflow: hidden; }
    .donut-wrap svg { width: 100% !important; height: 100% !important; }
    .card { padding: 10px; }
    .card-title { font-size: 11px; letter-spacing: 2px; }
    .parcel-row { gap: 6px; }
    .parcel-pct { font-size: 13px; min-width: 38px; }
    .counter-btn { width: 28px; height: 28px; font-size: 16px; }
    .counter-val { font-size: 18px; min-width: 36px; }
    .breakdown-label, .breakdown-value { font-size: 11px; }

    /* Results card m√≥vil */
    .results-card { padding: 12px 8px; }
    .results-title { font-size: 11px; letter-spacing: 2px; margin-bottom: 10px; }
    .results-table { font-size: 12px; }
    .results-table th {
      font-size: 8px;
      letter-spacing: 1px;
      padding: 6px 6px;
    }
    .results-table td {
      font-size: 12px;
      padding: 8px 6px;
    }
    .rt-period { font-size: 9px; letter-spacing: 1px; gap: 5px; }
    .rt-period .dot { width: 5px; height: 5px; }
    .rt-base { font-size: 11px; }
    .rt-boost { font-size: 12px; }
    .rt-boost.highlight { font-size: 14px; }
    .boost-badge { font-size: 10px; padding: 3px 8px; margin-left: 4px; }
    .breakdown-row { font-size: 11px; flex-wrap: wrap; gap: 2px; }
    .tier-info { flex-wrap: wrap; gap: 6px; padding: 8px; }
    .tier-label { font-size: 11px; }
    .tier-value { font-size: 11px; }

    /* Botones inferiores: reducir tama√±o para caber en una fila */
  }

  /* Main grid */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
  }

  @media (max-width: 600px) {
    .grid { grid-template-columns: 1fr; }
  }

  .card {
    background: var(--panel);
    border: 3px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s, transform 0.2s;
  }

  .card:hover {
    border-color: var(--glow);
    transform: translateY(-2px);
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .card:hover::before { opacity: 1; }

  .card-title {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Parcel inputs */
  .parcel-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .parcel-icon {
    width: 36px; height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .parcel-label {
    flex: 1;
    font-size: 14px;
    font-weight: 600;
  }

  .parcel-rate {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text2);
    white-space: nowrap;
  }

  input[type="number"] {
    width: 80px;
    background: #060b14;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: white;
    font-family: 'Share Tech Mono', monospace;
    font-size: 16px;
    padding: 8px 10px;
    text-align: center;
    transition: border-color 0.2s, box-shadow 0.2s;
    appearance: textfield;
    -moz-appearance: textfield;
  }

  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
  }

  input[type="number"]:focus {
    outline: none;
    border-color: var(--glow);
    box-shadow: 0 0 0 2px rgba(0,200,255,0.15);
  }

  /* Colors per rarity */
  .common .parcel-icon { background: rgba(148,163,184,0.1); border: 1px solid rgba(148,163,184,0.3); color: var(--common); }
  .common .parcel-label { color: var(--common); }
  .rare .parcel-icon { background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3); color: var(--rare); }
  .rare .parcel-label { color: var(--rare); }
  .epic .parcel-icon { background: rgba(192,132,252,0.1); border: 1px solid rgba(192,132,252,0.3); color: var(--epic); }
  .epic .parcel-label { color: var(--epic); }
  .legendary .parcel-icon { background: rgba(255,140,66,0.1); border: 1px solid rgba(255,140,66,0.3); color: var(--legendary); }
  .legendary .parcel-label { color: var(--legendary); }

  /* Boosters card */
  .booster-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .booster-icon {
    font-size: 22px;
    width: 36px;
    text-align: center;
    flex-shrink: 0;
  }

  .booster-info { flex: 1; }
  .booster-name { font-size: 14px; font-weight: 600; }
  .booster-desc { font-size: 11px; color: var(--text2); margin-top: 2px; }

  /* Results */
  .results-card {
    background: linear-gradient(135deg, #0a1f38 0%, #060f1e 100%);
    border: 3px solid var(--glow);
    border-radius: 12px;
    padding: 18px;
    margin-top: 16px;
    box-shadow: 0 0 40px rgba(0,200,255,0.08), inset 0 0 40px rgba(0,200,255,0.03);
    overflow-x: hidden;
    width: 100%;
    box-sizing: border-box;
  }

  .results-title {
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 5px;
    color: var(--glow);
    text-transform: uppercase;
    text-align: center;
    margin-bottom: 14px;
  }

  /* Results table */
  .results-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 24px;
    font-family: 'Share Tech Mono', monospace;
    table-layout: fixed;
    word-break: break-word;
  }

  .results-table thead tr {
    border-bottom: 1px solid var(--border);
  }

  .results-table th {
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--text2);
    text-transform: uppercase;
    padding: 8px 14px;
    text-align: left;
  }

  .results-table th:last-child,
  .results-table td:last-child { text-align: right; }

  .results-table td {
    padding: 10px 14px;
    font-size: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    vertical-align: middle;
  }

  .results-table tbody tr {
    transition: background 0.15s;
  }

  .results-table tbody tr:hover {
    background: rgba(0,200,255,0.04);
  }

  .results-table tbody tr:last-child td { border-bottom: none; }

  .rt-period {
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .rt-period .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--glow);
    flex-shrink: 0;
    box-shadow: 0 0 4px var(--glow);
  }

  .rt-base {
    color: var(--text2);
    font-size: 13px;
  }

  .rt-boost {
    color: var(--glow2);
    font-size: 15px;
    font-weight: 700;
    text-shadow: 0 0 12px rgba(0,255,157,0.3);
  }

  .rt-boost.highlight {
    color: var(--glow2);
    font-size: 18px;
    text-shadow: 0 0 20px rgba(0,255,157,0.5);
  }

  /* Breakdown */
  .breakdown {
    border-top: 1px solid var(--border);
    padding-top: 12px;
    margin-top: 4px;
  }

  .breakdown-title {
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--text2);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .breakdown-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
  }

  .donut-arrow {
    font-size: 26px;
    font-weight: 700;
    margin-right: 3px;
    line-height: 1;
  }
  .donut-arrow.up   { color: #4ade80; }
  .donut-arrow.down { color: #ef4444; }

  .rarity-arrow {
    font-size: 11px;
    font-weight: 700;
    margin-right: 2px;
    line-height: 1;
  }
  .rarity-arrow.up   { color: #4ade80; }
  .rarity-arrow.down { color: #ef4444; }

  .breakdown-label { color: var(--text2); }
  .breakdown-value {
    font-family: 'Share Tech Mono', monospace;
    color: var(--text);
  }

  .breakdown-value.highlight { color: var(--glow); font-weight: 700; }

  /* Badge boost display */
  .boost-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(255,215,0,0.1);
    border: 1px solid rgba(255,215,0,0.3);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 12px;
    font-weight: 600;
    color: var(--gold);
    margin-left: 8px;
  }

  /* Parcel tier display */
  .tier-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 16px;
    padding: 12px;
    background: rgba(0,200,255,0.04);
    border-radius: 8px;
    border: 1px dashed rgba(0,200,255,0.2);
  }

  .tier-label { font-size: 12px; color: var(--text2); }
  .tier-value {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    font-weight: 700;
    color: var(--glow);
  }

  /* Divider line */
  .divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
    margin: 4px 0 8px;
  }

  /* Full-width card */
  .full-card { grid-column: 1 / -1; }

  /* Total parcels display */
  .total-parcels {
    text-align: center;
    margin-bottom: 8px;
    padding: 8px;
    background: rgba(255,255,255,0.02);
    border-radius: 8px;
  }

  .total-parcels .num {
    font-family: 'Orbitron', monospace;
    font-size: 28px;
    font-weight: 900;
    color: white;
  }

  .total-parcels .lbl {
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--text2);
    text-transform: uppercase;
  }

  /* Slider-like counter buttons */
  .counter {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .counter-btn {
    width: 28px; height: 28px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--glow);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s, border-color 0.15s;
    flex-shrink: 0;
    line-height: 1;
  }

  .counter-btn:hover {
    background: rgba(0,200,255,0.1);
    border-color: var(--glow);
  }

  /* Animate on change */
  @keyframes pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .pop { animation: pop 0.2s ease; }

  /* Glow pulse on result */
  @keyframes glowPulse {
    0%, 100% { box-shadow: 0 0 40px rgba(0,200,255,0.08); }
    50% { box-shadow: 0 0 60px rgba(0,200,255,0.16); }
  }

  .results-card { animation: glowPulse 4s ease-in-out infinite; }

  /* Diamond value */
  .diamond-row .booster-name { color: #a5f3fc; }

  /* Info tooltip */
  .info {
    font-size: 10px;
    color: var(--text2);
    background: rgba(0,200,255,0.05);
    border: 1px solid rgba(0,200,255,0.1);
    border-radius: 4px;
    padding: 2px 6px;
    margin-left: 4px;
  }

  /* ‚îÄ‚îÄ Coins counter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .coins-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    margin-top: 28px;
    padding: 14px 20px;
    background: linear-gradient(135deg, #1a1200 0%, #0d0b00 100%);
    border: 2px solid rgba(255, 215, 0, 0.35);
    border-radius: 14px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }

  .coins-bar::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, #ffd700, transparent);
    opacity: 0.7;
  }

  .coins-icon {
    font-size: 28px;
    filter: drop-shadow(0 0 8px rgba(255,215,0,0.8));
    animation: coinFloat 3s ease-in-out infinite;
    flex-shrink: 0;
  }

  @keyframes coinFloat {
    0%, 100% { transform: translateY(0) rotate(-5deg); }
    50%       { transform: translateY(-4px) rotate(5deg); }
  }

  .coins-info { text-align: left; }

  .coins-label {
    font-family: 'Orbitron', monospace;
    font-size: 8px;
    letter-spacing: 3px;
    color: rgba(255,215,0,0.6);
    text-transform: uppercase;
    margin-bottom: 2px;
  }

  .coins-value {
    font-family: 'Orbitron', monospace;
    font-size: 28px;
    font-weight: 900;
    color: #ffd700;
    text-shadow: 0 0 20px rgba(255,215,0,0.6);
    line-height: 1;
    transition: transform 0.3s;
  }

  .coins-value.pop-coin {
    animation: coinPop 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97);
  }

  @keyframes coinPop {
    0%   { transform: scale(1); }
    30%  { transform: scale(1.4); color: #fff; }
    60%  { transform: scale(0.9); }
    100% { transform: scale(1); }
  }

  .coins-sub {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: rgba(255,215,0,0.45);
    margin-top: 2px;
    letter-spacing: 1px;
  }

  .coins-status {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    text-align: center;
    flex: 1;
  }

  .coins-status .earned {
    color: #4ade80;
    text-shadow: 0 0 10px rgba(74,222,128,0.5);
    animation: fadeInUp 0.4s ease;
  }

  .coins-status .waiting {
    color: rgba(255,215,0,0.4);
    letter-spacing: 1px;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* Toast de coin ganado */
  .coin-toast {
    position: fixed;
    top: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: linear-gradient(135deg, #1a1200, #2a1e00);
    border: 2px solid #ffd700;
    border-radius: 50px;
    padding: 10px 24px;
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    font-weight: 700;
    color: #ffd700;
    letter-spacing: 2px;
    box-shadow: 0 0 30px rgba(255,215,0,0.4);
    z-index: 99999;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events: none;
    white-space: nowrap;
  }

  .coin-toast.show {
    transform: translateX(-50%) translateY(0);
  }
  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

  /* Save button */
  .save-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 12px;
    position: relative;
  }

  .btn-save {
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #000;
    background: linear-gradient(135deg, #00c8ff, #4ade80);
    border: none;
    border-radius: 8px;
    padding: 9px 20px;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.15s, box-shadow 0.2s;
    box-shadow: 0 0 20px rgba(0,200,255,0.35);
  }

  .btn-save:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 0 30px rgba(0,200,255,0.5);
  }

  .btn-save:active { transform: scale(0.97); }

  .save-status {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--glow2);
    opacity: 0;
    transition: opacity 0.4s;
    display: flex;
    align-items: center;
    gap: 6px;
    position: absolute;
    bottom: -24px;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
  }

  .save-status.visible { opacity: 1; }


  

  

  

  

  

  

  

  

  

  

  

  .btn-copy-link {
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    color: #000;
    background: var(--glow2);
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
    flex-shrink: 0;
    transition: opacity 0.2s;
  }

  .btn-copy-link:hover { opacity: 0.85; }

  /* Profile section */
  .profile-section {
    display: flex;
    align-items: center;
    gap: 12px;
    background: linear-gradient(135deg, #0b1f3a 0%, #060f1e 100%);
    border: 3px solid var(--border);
    border-radius: 14px;
    padding: 10px 16px 10px 16px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
    min-width: 0;
  }

  .profile-section::before {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
  }

  .ppd-circle {
    position: absolute;
    bottom: 10px;
    left: 12px;
    width: 42px;
    height: 42px;
    background: var(--glow);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 17px;
    font-weight: 700;
    color: var(--glow);
    box-shadow: 0 0 8px rgba(0,200,255,0.5);
    z-index: 4;
    line-height: 1.1;
    text-align: center;
    cursor: default;
  }

  .profile-avatar-wrapper {
    position: relative;
    flex-shrink: 0;
    cursor: pointer;
    width: 142px;
    height: 142px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .profile-avatar-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: conic-gradient(var(--avatar-border-color, #00c8ff), transparent 40%, var(--avatar-border-color, #00c8ff));
    animation: spinBorder 2.5s linear infinite;
    z-index: 0;
  }

  .profile-avatar-wrapper::after {
    content: '';
    position: absolute;
    inset: 20px;
    border-radius: 50%;
    background: var(--bg);
    z-index: 1;
  }

  @keyframes spinBorder {
    0%   { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .profile-avatar {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    object-fit: cover;
    border: none;
    box-shadow: 0 0 16px rgba(0,200,255,0.35);
    display: block;
    background: #0f1e35;
    position: relative;
    z-index: 2;
  }

  .profile-avatar-placeholder {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    border: 2px dashed var(--border);
    background: #0b1626;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    gap: 4px;
    position: relative;
    z-index: 3;
  }

  .profile-avatar-placeholder:hover {
    border-color: var(--glow);
    background: rgba(0,200,255,0.05);
  }

  .profile-avatar-placeholder .upload-icon {
    font-size: 22px;
    opacity: 0.6;
  }

  .profile-avatar-placeholder .upload-label {
    font-size: 8px;
    letter-spacing: 1px;
    color: var(--text2);
    text-transform: uppercase;
    text-align: center;
    line-height: 1.3;
  }

  .profile-avatar-color {
    position: absolute;
    bottom: 2px;
    left: 2px;
    width: 32px;
    height: 32px;
    background: var(--glow);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 0 8px rgba(0,200,255,0.5);
    z-index: 3;
  }

  .profile-avatar-edit {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 32px;
    height: 32px;
    background: var(--glow);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #000;
    cursor: pointer;
    box-shadow: 0 0 8px rgba(0,200,255,0.5);
    display: none;
    z-index: 3;
  }

  .profile-info {
    flex: 1;
  }

  .profile-name-label {
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--text2);
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .profile-name-input {
    font-family: 'Orbitron', monospace;
    font-size: clamp(16px, 3vw, 24px);
    font-weight: 900;
    color: #fff;
    background: transparent;
    border: none;
    border-bottom: 2px solid var(--border);
    outline: none;
    width: auto;
    min-width: min(280px, 100%);
    max-width: 100%;
    padding: 4px 2px;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: border-color 0.2s;
    caret-color: var(--glow);
  }

  .profile-name-input:focus {
    border-bottom-color: var(--glow);
  }

  .profile-name-input::placeholder {
    color: var(--text2);
    opacity: 0.5;
    font-size: 14px;
    letter-spacing: 1px;
  }

  .profile-hint {
    font-size: 10px;
    color: var(--text2);
    margin-top: 6px;
    letter-spacing: 1px;
  }

  #avatar-input { display: none; }

  /* Explorer compass badge inline next to name */
  .explorer-badge-inline {
    font-size: 22px;
    flex-shrink: 0;
    filter: drop-shadow(0 0 6px rgba(250,204,21,0.7));
    animation: glowCompass 2s ease-in-out infinite;
  }

  @keyframes glowCompass {
    0%, 100% { filter: drop-shadow(0 0 4px rgba(250,204,21,0.5)); }
    50%       { filter: drop-shadow(0 0 12px rgba(250,204,21,1)); }
  }


  /* Explorer club */
  .explorer-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 8px 12px;
    background: rgba(250,204,21,0.05);
    border: 1px solid rgba(250,204,21,0.2);
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
  }

  .explorer-row:hover {
    background: rgba(250,204,21,0.1);
    border-color: rgba(250,204,21,0.4);
  }

  .explorer-checkbox {
    width: 22px; height: 22px;
    border-radius: 6px;
    border: 2px solid rgba(250,204,21,0.5);
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.2s, border-color 0.2s;
    font-size: 14px;
    color: #000;
  }

  .explorer-checkbox.checked {
    background: #facc15;
    border-color: #facc15;
    box-shadow: 0 0 10px rgba(250,204,21,0.4);
  }

  .explorer-info { flex: 1; }
  .explorer-name {
    font-size: 14px;
    font-weight: 700;
    color: #facc15;
  }
  .explorer-desc {
    font-size: 11px;
    color: var(--text2);
    margin-top: 2px;
  }

  .explorer-result {
    text-align: center;
  }

  .explorer-days {
    font-family: 'Orbitron', monospace;
    font-size: 20px;
    font-weight: 900;
    color: #facc15;
    text-shadow: 0 0 12px rgba(250,204,21,0.5);
    line-height: 1;
  }

  .explorer-days-label {
    font-size: 9px;
    color: var(--text2);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  /* Time to $1 section */
  .dollar-box {
    margin-top: 8px;
    background: linear-gradient(135deg, rgba(250,204,21,0.06) 0%, rgba(250,204,21,0.02) 100%);
    border: 1px solid rgba(250,204,21,0.25);
    border-radius: 10px;
    padding: 10px 8px;
  }

  .dollar-box-title {
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    letter-spacing: 4px;
    color: #facc15;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dollar-box-title::before {
    content: '‚óà';
    color: #facc15;
  }

  .dollar-time {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 0;
    flex-wrap: wrap;
  }

  .dollar-unit {
    text-align: center;
    padding: 0 8px;
    border-right: 1px solid rgba(250,204,21,0.15);
    flex: 1;
  }

  .dollar-unit:last-child { border-right: none; }

  .dollar-num {
    font-family: 'Orbitron', monospace;
    font-size: clamp(16px, 3vw, 24px);
    font-weight: 900;
    color: #facc15;
    text-shadow: 0 0 16px rgba(250,204,21,0.5);
    line-height: 1;
  }

  .dollar-lbl {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
    margin-top: 4px;
  }

  .dollar-note {
    text-align: center;
    font-size: 11px;
    color: var(--text2);
    margin-top: 14px;
    letter-spacing: 1px;
  }

  .dollar-note span {
    color: #facc15;
    font-weight: 700;
  }

  .parcel-pct {
    font-family: 'Share Tech Mono', monospace;
    font-size: 15px;
    color: var(--text2);
    min-width: 44px;
    text-align: left;
    flex-shrink: 0;
    transition: color 0.3s;
    opacity: 0.4;
  }
  .common .parcel-pct.active  { color: #4ade80; opacity: 1; font-weight: 700; }
  .rare .parcel-pct.active    { color: #60a5fa; opacity: 1; font-weight: 700; }
  .epic .parcel-pct.active    { color: #c084fc; opacity: 1; font-weight: 700; }
  .legendary .parcel-pct.active { color: #facc15; opacity: 1; font-weight: 700; }

  /* Donut chart */
  .profile-chart {
    flex-shrink: 0;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
  }

  .donut-legend {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .dl-item {
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0.35;
    transition: opacity 0.3s;
  }

  .dl-item.has-data { opacity: 1; }

  .dl-dot {
    width: 7px; height: 7px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .dl-letter {
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    font-weight: 900;
    letter-spacing: 1px;
    width: 10px;
  }

  .dl-pct {
    font-family: 'Share Tech Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    min-width: 48px;
  }

  .donut-wrap {
    position: relative;
    width: 130px;
    height: 130px;
    flex-shrink: 0;
    overflow: hidden;
  }

  .donut-wrap svg {
    transform: rotate(-90deg);
  }

  @keyframes segSpinFwd {
    from { transform: rotate(0deg); }
    to   { transform: rotate(-360deg); }
  }
  @keyframes segSpinRev {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }

  .donut-center {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Orbitron', monospace;
    font-size: 22px;
    font-weight: 900;
    color: var(--glow);
    text-shadow:
      2px 2px 0px #0a0a14,
      3px 3px 0px rgba(0,0,0,0.6);
    text-align: center;
    line-height: 1.2;
  }

  .donut-center span, #donut-center {
    border-radius: 8px;
    padding: 2px 8px;
  }



  .donut-crel {
    display: flex;
    gap: 6px;
    font-family: 'Orbitron', monospace;
    font-size: 16px;
    font-weight: 900;
    letter-spacing: 3px;
  }

  /* ‚îÄ‚îÄ Estilos de impresi√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  @media print {
    @page { margin: 0; size: auto; }
    body { background: #060b14 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    
    #visit-wrapper { display: none !important; }
    .container > p { display: none !important; }
    * { animation: none !important; transition: none !important; }
  }

  /* ===== CHAT WIDGET ===== */
  #chat-fab {
    position: fixed;
    bottom: 28px;
    right: 28px;
    z-index: 9998;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00ff88, #00ffff);
    border: none;
    cursor: pointer;
    box-shadow: 0 0 20px rgba(0,255,136,0.6), 0 4px 15px rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  #chat-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 0 35px rgba(0,255,136,0.9), 0 6px 20px rgba(0,0,0,0.5);
  }
  #chat-fab:active { transform: scale(0.95); }
  #chat-fab svg { width: 28px; height: 28px; fill: #0a0e1a; }
  #chat-fab.open svg.icon-chat { display: none; }
  #chat-fab.open svg.icon-close { display: block !important; }
  #chat-fab::before {
    content: 'CHAT';
    position: absolute;
    right: 70px;
    background: #0f1419;
    border: 1px solid #00ff88;
    color: #00ff88;
    font-family: 'Orbitron', sans-serif;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2px;
    padding: 6px 10px;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    box-shadow: 0 0 10px rgba(0,255,136,0.3);
  }
  #chat-fab:hover::before { opacity: 1; }
  #chat-fab.open::before { content: 'CERRAR'; }

  #chat-iframe-container {
    position: fixed;
    bottom: 100px;
    right: 28px;
    z-index: 9997;
    width: 380px;
    height: min(600px, calc(100dvh - 120px));
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid #00ff88;
    box-shadow: 0 0 40px rgba(0,255,136,0.4), 0 20px 60px rgba(0,0,0,0.6);
    transform: scale(0.85) translateY(20px);
    transform-origin: bottom right;
    opacity: 0;
    pointer-events: none;
    transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1), opacity 0.25s ease;
  }
  #chat-iframe-container.open {
    transform: scale(1) translateY(0);
    opacity: 1;
    pointer-events: all;
  }
  #chat-iframe-container iframe { width: 100%; height: 100%; border: none; display: block; }

  #chat-widget-bar {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 36px;
    background: linear-gradient(90deg, rgba(0,255,136,0.15), rgba(0,255,255,0.1));
    border-bottom: 1px solid rgba(0,255,136,0.4);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
    z-index: 1;
    pointer-events: none;
  }
  #chat-widget-bar span {
    font-family: 'Orbitron', sans-serif;
    font-size: 9px;
    font-weight: 700;
    color: #00ff88;
    letter-spacing: 2px;
    text-shadow: 0 0 8px #00ff88;
  }
  #chat-widget-bar .dots { display: flex; gap: 5px; }
  #chat-widget-bar .dot { width: 8px; height: 8px; border-radius: 50%; }
  #chat-widget-bar .dot:nth-child(1) { background: #ff5f57; }
  #chat-widget-bar .dot:nth-child(2) { background: #ffbd2e; }
  #chat-widget-bar .dot:nth-child(3) { background: #00ff88; box-shadow: 0 0 6px #00ff88; }

  @media (max-width: 480px) {
    #chat-widget-bar { display: none; }
    #chat-iframe-container {
      right: 0;
      bottom: 0;
      left: 0;
      top: auto;
      width: 100%;
      height: 75dvh;
      border-radius: 20px 20px 0 0;
      transform-origin: bottom center;
      border-left: none;
      border-right: none;
      border-bottom: none;
    }
    #chat-fab { bottom: 20px; right: 20px; }
  }
  /* ===== FIN CHAT WIDGET ===== */
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ===== FIREBASE SDK ===== -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged }
      from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getDatabase, ref, set, get, update, onValue }
      from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB-xx2PlBjvnHe0K7Bf1MspVqUlfjky0mk",
      authDomain: "aemx-chat.firebaseapp.com",
      databaseURL: "https://aemx-chat-default-rtdb.firebaseio.com",
      projectId: "aemx-chat",
      storageBucket: "aemx-chat.appspot.com",
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // ‚îÄ‚îÄ Exponer al scope global para que el resto del c√≥digo los use ‚îÄ‚îÄ
    window._fbAuth     = auth;
    window._fbDb       = db;
    window._fbRef      = ref;
    window._fbSet      = set;
    window._fbGet      = get;
    window._fbOnValue  = onValue;
    window._fbSignIn   = () => signInWithPopup(auth, provider);
    window._fbSignOut  = () => signOut(auth);

    // ‚îÄ‚îÄ Escuchar cambios de sesi√≥n ‚îÄ‚îÄ
    onAuthStateChanged(auth, (user) => {
      if (user) {
        window._fbUser = user;
        renderAuthUI(user);
        // Esperar a que todos los scripts est√©n listos antes de sincronizar
        setTimeout(() => syncFromFirebase(user.uid), 300);
      } else {
        window._fbUser = null;
        renderAuthUI(null);
      }
    });

    // ‚îÄ‚îÄ Renderizar bot√≥n seg√∫n estado ‚îÄ‚îÄ
    function renderAuthUI(user) {
      const btn = document.getElementById('google-auth-btn');
      const info = document.getElementById('google-user-info');
      if (!btn) return;
      if (user) {
        btn.textContent = 'Cerrar sesi√≥n';
        btn.title = `Sesi√≥n: ${user.displayName}`;
        if (info) {
          info.innerHTML = `<img src="${user.photoURL}" style="width:22px;height:22px;border-radius:50%;vertical-align:middle;margin-right:6px;">${user.displayName.split(' ')[0]}`;
          info.style.display = 'flex';
        }
      } else {
        btn.textContent = 'üîë Iniciar con Google';
        btn.title = '';
        if (info) info.style.display = 'none';
      }
    }

    // ‚îÄ‚îÄ Cargar datos desde Firebase ‚îÄ‚îÄ
    async function syncFromFirebase(uid) {
      try {
        const snap = await get(ref(db, `users/${uid}`));
        if (!snap.exists()) {
          // No hay datos en Firebase ‚Äî guardar lo que haya en local
          if (window._fbSaveAll) setTimeout(window._fbSaveAll, 500);
          return;
        }
        const d = snap.val();

        // Perfil
        if (d.username) { document.getElementById('username').value = d.username; if(window.adjustBadge) window.adjustBadge(); }
        if (d.avatar) {
          const img = document.getElementById('avatar-img');
          const ph  = document.getElementById('avatar-placeholder');
          const eb  = document.getElementById('avatar-edit');
          img.src = d.avatar; img.style.display='block';
          if(ph) ph.style.display='none';
          if(eb) eb.style.display='none';
          localStorage.setItem('atlas-avatar', d.avatar);
        }
        if (d.borderColor) {
          localStorage.setItem('atlas-avatar-border', d.borderColor);
          document.getElementById('avatar-border-color').value = d.borderColor;
          const prev = document.getElementById('color-preview');
          if(prev) prev.style.background = d.borderColor;
          // applyThemeColor puede no estar lista a√∫n (m√≥dulo corre antes que los scripts del body)
          const applyBorder = (color) => {
            if (window.applyThemeColor) {
              window.applyThemeColor(color);
            } else {
              let tries = 0;
              const interval = setInterval(() => {
                tries++;
                if (window.applyThemeColor) {
                  window.applyThemeColor(color);
                  clearInterval(interval);
                } else if (tries > 30) {
                  clearInterval(interval);
                }
              }, 100);
            }
          };
          applyBorder(d.borderColor);
        }
        if (d.startDate) { document.getElementById('start-date').value = d.startDate; }
        if (d.country) {
          userCountry = d.country; window.userCountry = d.country;
          const spanMx = document.querySelector('.mexico');
          if (spanMx) { spanMx.textContent = d.country.toUpperCase(); spanMx.style.color = '#7EC8E3'; }
          const elLoc = document.getElementById('user-location');
          if (elLoc) elLoc.textContent = (d.city || d.country).toUpperCase();
        }

        // Calculadora
        ['common','rare','epic','legendary','badges','diamonds','atlasbucks'].forEach(k => {
          if (d[k] !== undefined) { document.getElementById(k).value = d[k]; }
        });

        if(window.calc) window.calc();

        // Sincronizaci√≥n completa ‚Äî resubir a Firebase para mantener fresco
        setTimeout(() => { if(window._fbSaveAll) window._fbSaveAll(); }, 800);
      } catch(e) { console.warn('Firebase sync error:', e); }
    }

    // ‚îÄ‚îÄ Guardar todos los datos en Firebase ‚îÄ‚îÄ
    window._fbSaveAll = async function() {
      const user = window._fbUser;
      if (!user) return;
      const data = {
        username:    document.getElementById('username')?.value    || '',
        avatar:      localStorage.getItem('atlas-avatar')          || '',
        borderColor: localStorage.getItem('atlas-avatar-border')   || '',
        startDate:   document.getElementById('start-date')?.value  || '',
        common:      document.getElementById('common')?.value      || 0,
        rare:        document.getElementById('rare')?.value        || 0,
        epic:        document.getElementById('epic')?.value        || 0,
        legendary:   document.getElementById('legendary')?.value   || 0,
        badges:      document.getElementById('badges')?.value      || 0,
        diamonds:    document.getElementById('diamonds')?.value    || 0,
        atlasbucks:  document.getElementById('atlasbucks')?.value  || 0,
      };
      try {
        const snap = await get(ref(db, `users/${user.uid}`));
        if (snap.exists()) {
          const prev = snap.val();
          if (prev.country)        data.country        = prev.country;
          else if (window.userCountry) data.country    = window.userCountry;
          if (prev.city)           data.city           = prev.city;
          if (prev.countryHistory) data.countryHistory = prev.countryHistory;
          // Preservar campos gestionados por el admin (siempre, aunque sean false)
          data.clanMember        = prev.clanMember        === true;
          data.bannedChat        = prev.bannedChat        === true;
          data.bannedLeaderboard = prev.bannedLeaderboard === true;
          data.role              = prev.role              || '';
          // Preservar coins y fecha (nunca sobreescribir con set)
          data.coins             = prev.coins             || 0;
          data.lastCoinDate      = prev.lastCoinDate      || null;
          // Solo actualizar updatedAt si cambiaron las parcelas
          const parcelasChanged =
            String(data.common)    !== String(prev.common    || 0) ||
            String(data.rare)      !== String(prev.rare      || 0) ||
            String(data.epic)      !== String(prev.epic      || 0) ||
            String(data.legendary) !== String(prev.legendary || 0);
          data.updatedAt = parcelasChanged ? Date.now() : (prev.updatedAt || null);
        } else {
          data.updatedAt = Date.now();
          if (window.userCountry) data.country = window.userCountry;
          // Usuario nuevo: campos admin en false por defecto
          data.clanMember        = false;
          data.bannedChat        = false;
          data.bannedLeaderboard = false;
          data.role              = '';
        }
        await set(ref(db, `users/${user.uid}`), data);
      } catch(e) { console.warn('Firebase save error:', e); }
    };

    window._fbSaveCity = async function(cityText) {
      const user = window._fbUser;
      if (!user || !cityText) return;
      try {
        await update(ref(db, `users/${user.uid}`), { city: cityText });
      } catch(e) { console.warn('Firebase city error:', e); }
    };

    window._fbSaveCountry = async function(newCountry) {
      const user = window._fbUser;
      if (!user || !newCountry) return;
      try {
        const snap = await get(ref(db, `users/${user.uid}/country`));
        const prev = snap.exists() ? snap.val() : null;
        if (prev === newCountry) return;
        const updates = { country: newCountry };
        if (prev) {
          const histSnap = await get(ref(db, `users/${user.uid}/countryHistory`));
          const history  = histSnap.exists() ? histSnap.val() : [];
          history.push({ from: prev, to: newCountry, date: Date.now() });
          updates.countryHistory = history;
        }
        await update(ref(db, `users/${user.uid}`), updates);
      } catch(e) { console.warn('Firebase country error:', e); }
    };

    // ‚îÄ‚îÄ Autoguardar cada vez que el usuario cambia un input ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', () => {
      ['common','rare','epic','legendary','badges','diamonds','atlasbucks','start-date','username'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', () => { if(window._fbUser) window._fbSaveAll(); });
      });
    });
  </script>
  <!-- ===== FIN FIREBASE SDK ===== -->
</head>
<body>
<div class="container">
  <header>
    <div class="header-bar">
      <!-- Left: AEMX logo -->
      <div class="header-left">
        <img src="imagen_2.png" alt="AEMX" class="aemx-logo-img">
        <div class="header-left-label">Comunidad</div>
      </div>

      <!-- Center: Title -->
      <div class="header-center">
        <div class="header-title">
          <span class="atlas">ATLAS </span><span class="earth">EARTH </span><span class="mexico">M√âXICO</span>
        </div>
        <div class="header-subtitle">GAMERTAG</div>
        <div class="header-tagline">Calcula tus ganancias pasivas</div>
      </div>

      <!-- Right: Atlas Earth logo -->
      <div class="header-right">
        <img src="imagen_3.png" alt="Atlas Earth M√©xico" class="atlas-logo-img">
        <div class="header-right-label">Atlas Earth AEMX</div>
      </div>
    </div>
  </header>

  <!-- Profile section -->
  <div class="profile-section">
    <!-- Input file nativo como label para m√°xima compatibilidad -->
    <label for="avatar-input" style="display:none;" id="avatar-label"></label>
    <input type="file" id="avatar-input" accept="image/*" onchange="loadAvatar(event)" style="display:none;">
    <input type="color" id="avatar-border-color" value="#00c8ff" oninput="changeAvatarBorder(this.value)" style="display:none;">
    <div class="profile-avatar-wrapper" id="avatar-wrapper" onmouseenter="showAvatarButtons()" onmouseleave="hideAvatarButtons()">
      <div class="profile-avatar-placeholder" id="avatar-placeholder">
        <span class="upload-icon">üë§</span>
        <span class="upload-label">Foto de<br>perfil</span>
      </div>
      <img id="avatar-img" class="profile-avatar" src="" alt="avatar" style="display:none;">
      <div class="profile-avatar-edit" id="avatar-edit">‚úé</div>
      <div class="profile-avatar-color" id="avatar-color-btn">üé®</div>
    </div>
    <div class="profile-info">
      <div class="profile-name-label">Nombre de usuario</div>
      <div style="display:flex;align-items:center;gap:0;flex-wrap:nowrap;">
        <input
          type="text"
          id="username"
          class="profile-name-input"
          placeholder="Tu nombre aqu√≠"
          maxlength="35"
          oninput="this.value=this.value.toUpperCase(); saveUsername(); adjustBadge();"
          style="width:auto;min-width:60px;flex:0 1 auto;text-transform:uppercase;"
        >
        <div class="explorer-badge-inline" id="explorer-badge" style="display:none;margin-left:8px;flex-shrink:0;">üß≠</div>
      </div>
      <div class="profile-hint">Toca el avatar para cambiar foto</div>
      <!-- color-preview oculto para mantener funcionalidad -->
      <span id="color-preview" style="display:none;"></span>
      <!-- Fecha de inicio -->
      <div style="margin-top:6px;display:flex;align-items:center;justify-content:center;gap:4px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text2);letter-spacing:1px;">
        <span style="opacity:0.5;">JUGANDO DESDE¬∑</span>
        <input
          type="date"
          id="start-date"
          onchange="saveStartDate()"
          style="
            font-family:'Share Tech Mono',monospace;
            font-size:11px;
            color:var(--text2);
            letter-spacing:1px;
            background:transparent;
            border:none;
            outline:none;
            padding:0;
            cursor:pointer;
            color-scheme:dark;
            width:auto;
          "
        >
      </div>
      <!-- color picker movido arriba -->
      <!-- Fecha y hora en tiempo real -->
      <div style="margin-top:8px;">
        <div style="display:inline-flex;justify-content:center;align-items:center;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text2);letter-spacing:1px;">
          <span id="cl-year">‚Äî</span><span>¬∑</span><span id="cl-month">‚Äî</span><span>¬∑</span><span id="cl-day">‚Äî</span><span style="margin:0 5px;opacity:0.4;">|</span><span id="cl-hour">‚Äî</span><span>:</span><span id="cl-min">‚Äî</span><span>:</span><span id="cl-sec" style="color:var(--glow);">‚Äî</span><span style="margin:0 5px;opacity:0.4;">¬∑</span><span style="font-family:'Orbitron',monospace;font-size:11px;font-weight:700;color:var(--text2);text-shadow:none;">SOL <span id="aemx-sol">‚Äî</span> MX</span>
        </div>
      </div>
      <!-- Ubicaci√≥n por IP -->
      <div style="margin-top:6px;">
        <div style="display:inline-flex;align-items:center;gap:6px;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text2);letter-spacing:1px;">
          <span style="color:var(--glow);font-size:11px;">üìç</span>
          <span id="user-location" style="color:#fff;font-weight:700;text-transform:uppercase;">‚Äî</span>
        </div>
      </div>

    </div>

    <!-- C√≠rculo parcelas por d√≠a -->
    <div class="ppd-circle" id="ppd-circle">‚Äî</div>

    <!-- Donut chart -->
    <div class="profile-chart">
      <!-- % leyenda izquierda -->
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="font-family:'Share Tech Mono',monospace;font-size:22px;font-weight:700;color:#4ade80;" id="donut-pct-c"><span class="donut-arrow" id="donut-arrow-c"></span>0%</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:22px;font-weight:700;color:#60a5fa;" id="donut-pct-r"><span class="donut-arrow" id="donut-arrow-r"></span>0%</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:22px;font-weight:700;color:#c084fc;" id="donut-pct-e"><span class="donut-arrow" id="donut-arrow-e"></span>0%</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:22px;font-weight:700;color:#facc15;" id="donut-pct-l"><span class="donut-arrow" id="donut-arrow-l"></span>0%</div>
      </div>
      <!-- Donut + CREL label -->
      <div style="display:flex;flex-direction:column;align-items:center;gap:5px;">
        <div class="donut-wrap">
          <svg width="100%" height="100%" viewBox="-10 -10 120 120" id="donut-svg">
            <circle id="donut-bg-circle" cx="50" cy="50" r="28" fill="none" stroke="#1a3a5c" stroke-width="30"/>
          </svg>
          <div class="donut-center" id="donut-center">‚Äî</div>
        </div>
        <div class="donut-crel">
          <span style="color:#4ade80">C.</span>
          <span style="color:#60a5fa">R.</span>
          <span style="color:#c084fc">E.</span>
          <span style="color:#facc15">L.</span>
        </div>
      </div>
    </div>


  </div>

  <div class="grid">
    <!-- Parcelas -->
    <div class="card">
      <div class="card-title">
        <span class="dot" style="background:#94a3b8;box-shadow:0 0 6px #94a3b8"></span>
        Parcelas
      </div>

      <div class="parcel-row common">
        <div class="parcel-pct" id="pct-common">0%</div>
        <div class="parcel-icon"><span style="display:inline-block;width:18px;height:18px;background:#4ade80;border-radius:3px;box-shadow:0 0 8px rgba(74,222,128,0.6);"></span></div>
        <div style="flex:1">
          <div class="parcel-label">Comunes</div>
          <div class="parcel-rate">$0.0000000011/seg</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('common',-1)">‚àí</button>
          <input type="number" id="common" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('common',1)">+</button>
        </div>
        <div class="parcel-pct" id="pct-common"></div>
      </div>

      <div class="parcel-row rare">
        <div class="parcel-pct" id="pct-rare">0%</div>
        <div class="parcel-icon"><span style="display:inline-block;width:18px;height:18px;background:#60a5fa;border-radius:3px;box-shadow:0 0 8px rgba(96,165,250,0.6);"></span></div>
        <div style="flex:1">
          <div class="parcel-label">Raras</div>
          <div class="parcel-rate">$0.0000000016/seg</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('rare',-1)">‚àí</button>
          <input type="number" id="rare" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('rare',1)">+</button>
        </div>
        <div class="parcel-pct" id="pct-rare"></div>
      </div>

      <div class="parcel-row epic">
        <div class="parcel-pct" id="pct-epic">0%</div>
        <div class="parcel-icon"><span style="display:inline-block;width:18px;height:18px;background:#c084fc;border-radius:3px;box-shadow:0 0 8px rgba(192,132,252,0.6);"></span></div>
        <div style="flex:1">
          <div class="parcel-label">√âpicas</div>
          <div class="parcel-rate">$0.0000000022/seg</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('epic',-1)">‚àí</button>
          <input type="number" id="epic" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('epic',1)">+</button>
        </div>
        <div class="parcel-pct" id="pct-epic"></div>
      </div>

      <div class="parcel-row legendary">
        <div class="parcel-pct" id="pct-legendary">0%</div>
        <div class="parcel-icon"><span style="display:inline-block;width:18px;height:18px;background:#facc15;border-radius:3px;box-shadow:0 0 8px rgba(250,204,21,0.6);"></span></div>
        <div style="flex:1">
          <div class="parcel-label">Legendarias</div>
          <div class="parcel-rate">$0.0000000044/seg</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('legendary',-1)">‚àí</button>
          <input type="number" id="legendary" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('legendary',1)">+</button>
        </div>
        <div class="parcel-pct" id="pct-legendary"></div>
      </div>

      <div class="total-parcels">
        <div class="num" id="total-parcels">0</div>
        <div class="lbl">Parcelas totales</div>
      </div>

      <!-- Time to $1 compact -->
      <div class="dollar-box">
        <div class="dollar-box-title">Tiempo para ganar $1.00 USD</div>
        <div class="dollar-time">
          <div class="dollar-unit">
            <div class="dollar-num" id="t1-days">‚Äî</div>
            <div class="dollar-lbl">D√≠as</div>
          </div>
          <div class="dollar-unit">
            <div class="dollar-num" id="t1-hours">‚Äî</div>
            <div class="dollar-lbl">Horas</div>
          </div>
          <div class="dollar-unit">
            <div class="dollar-num" id="t1-mins">‚Äî</div>
            <div class="dollar-lbl">Min</div>
          </div>
          <div class="dollar-unit">
            <div class="dollar-num" id="t1-secs">‚Äî</div>
            <div class="dollar-lbl">Seg</div>
          </div>
        </div>
      </div>

      <!-- Parcelas por d√≠a -->
      <div style="margin-top:14px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border-radius:10px;padding:10px 16px;">
        <div style="font-family:'Orbitron',monospace;font-size:10px;letter-spacing:2px;color:var(--text2);text-transform:uppercase;">Parcelas por d√≠a</div>
        <div style="display:flex;align-items:baseline;gap:5px;">
          <span id="ppd-card" style="font-family:'Share Tech Mono',monospace;font-size:22px;font-weight:700;color:#94a3b8;">‚Äî</span>
          <span style="font-size:10px;color:var(--text2);">parc/d√≠a</span>
        </div>
      </div>

    </div>

    <!-- Boosters -->
    <div class="card">
      <div class="card-title">
        <span class="dot" style="background:#ffd700;box-shadow:0 0 6px #ffd700"></span>
        Potenciadores
      </div>

      <div class="booster-row">
        <div class="booster-icon">üèÖ</div>
        <div class="booster-info">
          <div class="booster-name">Insignias <span id="b-badge-pct" class="boost-badge" style="display:none;">+0%</span></div>

        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('badges',-1)">‚àí</button>
          <input type="number" id="badges" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('badges',1)">+</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="booster-row">
        <div class="booster-icon">üíé</div>
        <div class="booster-info">
          <div class="booster-name" style="color:#a5f3fc">Diamantes</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('diamonds',-1)">‚àí</button>
          <input type="number" id="diamonds" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('diamonds',1)">+</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="booster-row">
        <div class="booster-icon">üíµ</div>
        <div class="booster-info">
          <div class="booster-name" style="color:#86efac">Atlas Bucks (AB)</div>

        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('atlasbucks',-100)">‚àí</button>
          <input type="number" id="atlasbucks" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('atlasbucks',100)">+</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Explorer Club -->
      <div class="explorer-row" onclick="toggleExplorer()">
        <div class="explorer-checkbox" id="explorer-check">‚úì</div>
        <div class="explorer-info">
          <div class="explorer-name">üß≠ Club de Explorador</div>
          <div class="explorer-desc" id="explorer-desc">Activo: diamantes √∑ 7 giros de ruleta</div>
        </div>
        <div class="explorer-result">
          <div class="explorer-days" id="explorer-days">0</div>
          <div class="explorer-days-label">d√≠as ruleta</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="booster-row">
        <div class="booster-icon">üì∫</div>
        <div class="booster-info">
          <div class="booster-name"> Boost (M√©xico)</div>
          <div class="booster-desc">Calculado autom√°ticamente por parcelas</div>
        </div>
        <div style="text-align:center;">
          <div id="adboost-display" style="font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:var(--glow);text-shadow:0 0 20px rgba(0,200,255,0.5);line-height:1;">20√ó</div>
          <div id="adboost-range" style="font-size:10px;color:var(--text2);letter-spacing:1px;margin-top:2px;">1‚Äì50 parcelas</div>
        </div>
      </div>


      <!-- Parcelas comprables -->
      <div class="tier-info" id="tier-info" style="flex-direction:column;gap:6px;text-align:center;">
        <div style="font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:var(--text2);text-transform:uppercase;">Parcelas que puedes comprar</div>
        <div style="display:flex;align-items:baseline;justify-content:center;gap:8px;">
          <span id="parcels-buyable" style="font-family:'Orbitron',monospace;font-size:30px;font-weight:900;color:var(--glow2);text-shadow:0 0 20px rgba(0,255,157,0.4);">0</span>
          <span style="font-size:12px;color:var(--text2);">parcelas</span>
        </div>
        <div style="font-size:11px;color:var(--text2);">con tus <span id="ab-total-display" style="color:var(--gold);">0 AB</span> ¬∑ 100 AB por parcela</div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="results-card">
    <div class="results-title">‚óà Resultados de Renta ‚óà</div>

    <table class="results-table">
      <thead>
        <tr>
          <th>Per√≠odo</th>
          <th>Sin Boost</th>
          <th>Con Boost</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por Segundo</div></td>
          <td class="rt-base" id="r-sec-base">$0.000000000000</td>
          <td class="rt-boost" id="r-sec">$0.000000000000</td>
        </tr>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por Minuto</div></td>
          <td class="rt-base" id="r-min-base">$0.0000000000</td>
          <td class="rt-boost" id="r-min">$0.0000000000</td>
        </tr>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por Hora</div></td>
          <td class="rt-base" id="r-hour-base">$0.00000000</td>
          <td class="rt-boost" id="r-hour">$0.00000000</td>
        </tr>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por D√≠a</div></td>
          <td class="rt-base" id="r-day-base">$0.000000</td>
          <td class="rt-boost" id="r-day">$0.000000</td>
        </tr>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por Semana</div></td>
          <td class="rt-base" id="r-week-base">$0.0000</td>
          <td class="rt-boost" id="r-week">$0.0000</td>
        </tr>
        <tr style="background:rgba(0,255,157,0.03);">
          <td><div class="rt-period" style="color:var(--glow2)"><span class="dot" style="background:var(--glow2);box-shadow:0 0 4px var(--glow2)"></span>Renta Mensual</div></td>
          <td class="rt-base" id="r-month-base">$0.0000</td>
          <td class="rt-boost highlight" id="r-month">$0.0000</td>
        </tr>
        <tr style="background:rgba(251,191,36,0.04);border-top:1px solid rgba(251,191,36,0.15);">
          <td>
            <div class="rt-period" style="color:#fbbf24"><span class="dot" style="background:#fbbf24;box-shadow:0 0 4px #fbbf24"></span>SRB 50√ó</div>
            <div style="font-size:10px;color:#92400e;font-family:'Share Tech Mono',monospace;margin-top:3px;padding-left:14px;">32h ¬∑ 50√ó boost</div>
          </td>
          <td class="rt-base" id="r-single-event-base">$0.0000</td>
          <td class="rt-boost" id="r-single-event" style="color:#fbbf24;text-shadow:0 0 16px rgba(251,191,36,0.5);">$0.0000</td>
        </tr>
        <tr style="background:rgba(251,191,36,0.07);border-top:1px solid rgba(251,191,36,0.2);">
          <td>
            <div class="rt-period" style="color:#fbbf24"><span class="dot" style="background:#fbbf24;box-shadow:0 0 6px #fbbf24"></span>Renta Total Mes</div>
            <div style="font-size:10px;color:#92400e;font-family:'Share Tech Mono',monospace;margin-top:3px;padding-left:14px;">2√ó SRB ¬∑ 32h ¬∑ 50√ó boost</div>
          </td>
          <td class="rt-base" id="r-event-base">$0.0000</td>
          <td class="rt-boost" id="r-event" style="color:#fbbf24;text-shadow:0 0 20px rgba(251,191,36,0.6);font-size:18px;">$0.0000</td>
        </tr>
        <tr style="background:rgba(0,200,255,0.03);">
          <td><div class="rt-period" style="color:var(--glow)"><span class="dot" style="background:var(--glow);box-shadow:0 0 4px var(--glow)"></span>Por A√±o</div></td>
          <td class="rt-base" id="r-year-base">$0.00</td>
          <td class="rt-boost highlight" id="r-year" style="color:#00ff9d;text-shadow:0 0 20px rgba(0,255,157,0.6);font-size:16px;font-weight:900;letter-spacing:1px;">$0.00</td>
        </tr>
      </tbody>
    </table>

    <div class="breakdown">
      <div class="breakdown-title">‚óà Desglose Detallado</div>

      <div class="breakdown-row">
        <span class="breakdown-label">Renta base (sin boosts)</span>
        <span class="breakdown-value" id="b-base">$0.00/mes</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-label">Boost de insignias </span>
        <span class="breakdown-value" id="b-badge">+$0.00/mes</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-label">Boost de anuncios ‚Äî <span id="b-ad-x">20√ó</span> (M√©xico)</span>
        <span class="breakdown-value" id="b-ad">+$0.00/mes</span>
      </div>
      <div class="breakdown-row breakdown-separator" style="border-top:1px solid var(--border);padding-top:10px;margin-top:6px">
        <span class="breakdown-label" style="font-weight:700;color:var(--text)">Total mensual estimado</span>
        <span class="breakdown-value highlight" id="b-total">$0.00</span>
      </div>
      <div class="breakdown-row" style="margin-top:4px;">
        <span class="breakdown-label" style="font-weight:700;color:var(--glow)">üí´ Total anual estimado</span>
        <span class="breakdown-value" style="color:var(--glow);font-size:15px;font-weight:700;text-shadow:0 0 12px rgba(0,200,255,0.4);" id="b-year">$0.00</span>
      </div>


      <!-- Evento 50x -->
      <div style="margin-top:16px;padding:14px;background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.25);border-radius:10px;">
        <div style="font-family:'Orbitron',monospace;font-size:9px;letter-spacing:3px;color:#fbbf24;text-transform:uppercase;margin-bottom:12px;">üöÄ SRB 50√ó</div>
        <div class="breakdown-row" style="margin-bottom:6px;">
          <span class="breakdown-label">Renta 1 evento (32h ¬∑ 50√ó)</span>
          <span class="breakdown-value" id="b-single-event" style="color:#fbbf24;">$0.0000</span>
        </div>
        <div class="breakdown-row" style="margin-bottom:6px;">
          <span class="breakdown-label">Horas normales del mes <span style="font-size:10px;color:var(--text2)">(‚âà672h ‚àí 64h evento)</span></span>
          <span class="breakdown-value" id="b-event-normal-hours">608 h</span>
        </div>
        <div class="breakdown-row" style="margin-bottom:6px;">
          <span class="breakdown-label">Renta en horas normales</span>
          <span class="breakdown-value" id="b-event-normal">$0.0000</span>
        </div>
        <div class="breakdown-row" style="margin-bottom:6px;">
          <span class="breakdown-label">Renta en 2 eventos (64h ¬∑ 50√ó)</span>
          <span class="breakdown-value" id="b-event-income" style="color:#fbbf24;">$0.0000</span>
        </div>
        <div class="breakdown-row breakdown-separator" style="border-top:1px solid rgba(251,191,36,0.2);padding-top:10px;margin-top:4px;">
          <span class="breakdown-label" style="font-weight:700;color:#fef3c7;">Renta Total Mes</span>
          <span class="breakdown-value" style="color:#fbbf24;font-size:16px;font-weight:700;text-shadow:0 0 12px rgba(251,191,36,0.4);" id="b-event-total">$0.0000</span>
        </div>

      </div>
    </div>


  </div>


  <!-- ===== COINS COUNTER ===== -->
  <div class="coins-bar" id="coins-bar" style="margin-top:16px;margin-bottom:0;">
    <div class="coins-icon">ü™ô</div>
    <div class="coins-info">
      <div class="coins-label">AEMX Coins</div>
      <div class="coins-value" id="coins-display">‚Äî</div>
      <div class="coins-sub">Total acumulado</div>
    </div>
    <div class="coins-status" id="coins-status">
      <span class="waiting" id="coins-status-text">Inicia sesi√≥n para ganar coins</span>
    </div>
  </div>
  <!-- ===== FIN COINS COUNTER ===== -->

  <!-- Save bar + Auth bar alineados -->
  <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:12px;flex-wrap:wrap;">
    <button class="btn-save" onclick="shareData()" id="btn-share-data">üíæ &nbsp;Guardar</button>
    <div id="google-auth-bar" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <span id="google-user-info" style="display:none;align-items:center;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--glow);letter-spacing:1px;"></span>
      <button id="google-auth-btn" onclick="handleGoogleAuth()"
        style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;padding:7px 16px;border-radius:8px;cursor:pointer;background:linear-gradient(135deg,#1a3a5c,#0b1626);border:1px solid var(--glow);color:var(--glow);transition:all 0.2s;white-space:nowrap;"
        onmouseover="this.style.background='var(--glow)';this.style.color='#060b14'"
        onmouseout="this.style.background='linear-gradient(135deg,#1a3a5c,#0b1626)';this.style.color='var(--glow)'">
        üîë Iniciar con Google
      </button>
    </div>
    <div class="save-status" id="save-status">‚úî Datos guardados</div>
  </div>
</div>

  <script>
    function handleGoogleAuth() {
      const s    = document.getElementById('save-status');
      const btn  = document.getElementById('google-auth-btn');
      const info = document.getElementById('google-user-info');
      if (!window._fbSignOut || !window._fbSignIn) return;
      if (window._fbUser) {
        if (btn) { btn.disabled = true; btn.textContent = 'Cerrando...'; }
        window._fbSignOut()
          .then(() => {
            window._fbUser = null;
            if (btn) { btn.disabled = false; btn.textContent = 'üîë Iniciar con Google'; btn.title = ''; }
            if (info) info.style.display = 'none';
            if (s) { s.textContent = 'üëã Sesi√≥n cerrada'; s.classList.add('visible'); setTimeout(() => s.classList.remove('visible'), 2500); }
          })
          .catch(err => { console.warn(err); if (btn) { btn.disabled = false; btn.textContent = 'Cerrar sesi√≥n'; } });
      } else {
        window._fbSignIn()
          .then(() => {
            if (s) { s.textContent = '‚úî Sesi√≥n iniciada'; s.classList.add('visible'); setTimeout(() => s.classList.remove('visible'), 2500); }
            // Cargar coins al iniciar sesi√≥n
            if (window._fbUser && window._coinsLoad) window._coinsLoad(window._fbUser.uid);
          })
          .catch(err => console.warn('Sign-in error:', err));
      }
    }

    // Parchamos saveData para tambi√©n guardar en Firebase
    document.addEventListener('DOMContentLoaded', function() {
      // Autoguardado en Firebase al cambiar inputs de calculadora
      ['common','rare','epic','legendary','badges','diamonds','atlasbucks'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => { if(window._fbUser && window._fbSaveAll) setTimeout(window._fbSaveAll, 800); });
      });
    });

    // ‚îÄ‚îÄ Sistema de Coins ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Muestra los coins del usuario en el contador
    window._coinsUpdateDisplay = function(coins) {
      const el = document.getElementById('coins-display');
      if (el) {
        el.textContent = coins !== undefined && coins !== null ? coins : '0';
        el.classList.remove('pop-coin');
        void el.offsetWidth; // reflow para reiniciar animaci√≥n
        el.classList.add('pop-coin');
        setTimeout(() => el.classList.remove('pop-coin'), 500);
      }
    };

    // Muestra el toast de "+1 coin"
    function showCoinToast(total) {
      const toast = document.getElementById('coin-toast');
      if (!toast) return;
      toast.textContent = `ü™ô +1 COIN GANADO ¬∑ TOTAL: ${total}`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Actualiza el texto de estado debajo del contador
    function setCoinStatus(html) {
      const el = document.getElementById('coins-status-text');
      if (el) el.outerHTML = `<span id="coins-status-text">${html}</span>`;
    }

    // Otorga 1 coin al d√≠a usando Realtime Database
    window._awardDailyCoin = async function() {
      if (!window._fbUser) return;
      const uid = window._fbUser.uid;
      const hoy = new Date().toISOString().split('T')[0]; // "YYYY-MM-DD"

      try {
        const snap = await get(ref(db, `users/${uid}`));
        const data = snap.exists() ? snap.val() : {};

        const ultimaFecha = data.lastCoinDate || null;

        if (ultimaFecha === hoy) {
          // Ya gan√≥ su coin hoy
          window._coinsUpdateDisplay(data.coins || 0);
          setCoinStatus(`<span class="waiting">Ya ganaste tu coin hoy ¬∑ Vuelve ma√±ana üïê</span>`);
          return;
        }

        // Sumar 1 coin y guardar fecha
        const nuevoTotal = (data.coins || 0) + 1;
        await update(ref(db, `users/${uid}`), {
          coins:        nuevoTotal,
          lastCoinDate: hoy
        });

        window._coinsUpdateDisplay(nuevoTotal);
        showCoinToast(nuevoTotal);
        setCoinStatus(`<span class="earned">‚úî +1 Coin ganado hoy ¬∑ ${hoy}</span>`);

      } catch (err) {
        console.warn('Coins error:', err);
      }
    };

    // Carga los coins actuales del usuario al iniciar sesi√≥n
    window._coinsLoad = async function(uid) {
      if (!uid) return;
      try {
        const snap = await get(ref(db, `users/${uid}`));
        if (snap.exists()) {
          const data = snap.val();
          const coins = data.coins || 0;
          const hoy = new Date().toISOString().split('T')[0];
          window._coinsUpdateDisplay(coins);
          if (data.lastCoinDate === hoy) {
            setCoinStatus(`<span class="waiting">Ya ganaste tu coin hoy ¬∑ Vuelve ma√±ana üïê</span>`);
          } else {
            setCoinStatus(`<span class="waiting">Guarda tus datos para ganar 1 coin ü™ô</span>`);
          }
        } else {
          window._coinsUpdateDisplay(0);
          setCoinStatus(`<span class="waiting">Guarda tus datos para ganar 1 coin ü™ô</span>`);
        }
      } catch(e) {
        console.warn('Coins load error:', e);
      }
    };
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Hook en el bot√≥n üíæ Guardar para que tambi√©n suba a Firebase
    const _origShareData = typeof shareData === 'function' ? shareData : null;
    window.shareData = async function() {
      if (_origShareData) _origShareData();
      if (!window._fbUser || !window._fbSaveAll) return;

      // Si no hay pa√≠s detectado, intentar obtenerlo ahora
      if (!window.userCountry) {
        try {
          const res  = await fetch('https://freeipapi.com/api/json');
          const data = await res.json();
          if (data.countryName && typeof normalizarPais === 'function') {
            window.userCountry = normalizarPais(data.countryName);
          }
        } catch(e) {
          try {
            const res2  = await fetch('https://ipapi.co/json/');
            const data2 = await res2.json();
            if (data2.country_name && typeof normalizarPais === 'function') {
              window.userCountry = normalizarPais(data2.country_name);
            }
          } catch(e2) {}
        }
      }

      window._fbSaveAll();
      // Intentar dar coin diario al guardar
      if (window._awardDailyCoin) window._awardDailyCoin();
    };
  </script>

  <p style="text-align:center;color:var(--text2);font-size:11px;margin-top:10px;letter-spacing:1px;">
    Tasas oficiales de Atlas Earth ‚Ä¢ Los c√°lculos son estimados ‚Ä¢ El ad boost asume 24/7
  </p>
  <p style="text-align:center;margin-top:6px;">
    <a href="https://paypal.me/Socram1331" target="_blank" style="color:var(--text2);font-size:11px;letter-spacing:1px;text-decoration:none;opacity:0.7;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
      ‚òï ¬øTe fue √∫til? Apoya con una donaci√≥n
    </a>
  </p>
</div>

<script>
  const RATES = {
    common:    0.0000000011,
    rare:      0.0000000016,
    epic:      0.0000000022,
    legendary: 0.0000000044,
  };


  function getVal(id) {
    return Math.max(0, parseInt(document.getElementById(id).value) || 0);
  }

  function change(id, delta) {
    const el = document.getElementById(id);
    const current = parseInt(el.value) || 0;
    el.value = Math.max(0, current + delta);
    calc();
  }

  function fmt(n, decimals = 6) {
    if (n >= 0.01) return '$' + n.toFixed(2);
    if (n >= 0.0001) return '$' + n.toFixed(4);
    return '$' + n.toFixed(decimals);
  }

  let explorerActive = true;

  function toggleExplorer() {
    explorerActive = !explorerActive;
    const check = document.getElementById('explorer-check');
    const desc  = document.getElementById('explorer-desc');
    const badge = document.getElementById('explorer-badge');
    if (explorerActive) {
      check.classList.add('checked');
      desc.textContent = 'Activo: diamantes √∑ 7 giros de ruleta';
      badge.style.display = 'block';
    } else {
      check.classList.remove('checked');
      desc.textContent = 'Inactivo: diamantes √∑ 5 giros de ruleta';
      badge.style.display = 'none';
    }
    // Guardar estado autom√°ticamente
    try {
      const saved = JSON.parse(localStorage.getItem(SAVE_KEY) || '{}');
      saved.explorer = explorerActive;
      localStorage.setItem(SAVE_KEY, JSON.stringify(saved));
    } catch(e) {}
    calc();
  }

  function calc() {
    const c = getVal('common');
    const r = getVal('rare');
    const e = getVal('epic');
    const l = getVal('legendary');
    const badges = getVal('badges');
    const diamonds = getVal('diamonds');
    // D√≠as de ruleta seg√∫n Club de Explorador
    const ruletaDays = Math.floor(diamonds / (explorerActive ? 7 : 5));
    document.getElementById('explorer-days').textContent = ruletaDays;
    const ab = getVal('atlasbucks');
    const total = c + r + e + l;
    document.getElementById('total-parcels').textContent = total;

    // Velocidad del donut segun total de parcelas (0 = 30s, 10000+ = 0.2s)
    let _segSpeed;
    if      (total === 0)    _segSpeed = 60;
    else if (total <= 25)    _segSpeed = 55;
    else if (total <= 50)    _segSpeed = 50;
    else if (total <= 100)   _segSpeed = 45;
    else if (total <= 200)   _segSpeed = 35;
    else if (total <= 350)   _segSpeed = 25;
    else if (total <= 500)   _segSpeed = 18;
    else if (total <= 750)   _segSpeed = 13;
    else if (total <= 1000)  _segSpeed = 10;
    else if (total <= 1500)  _segSpeed = 2.5;
    else if (total <= 2000)  _segSpeed = 2;
    else if (total <= 3000)  _segSpeed = 1.5;
    else if (total <= 5000)  _segSpeed = 1.2;
    else if (total <= 8000)  _segSpeed = 1;
    else                     _segSpeed = 0.8;
    window._donutSegSpeed = _segSpeed;

    // % per rarity
    const types = { common: c, rare: r, epic: e, legendary: l };
    for (const [key, val] of Object.entries(types)) {
      const el = document.getElementById('pct-' + key);
      if (total > 0) {
        const pct = ((val / total) * 100).toFixed(1);
        el.textContent = pct + '%';
        el.classList.toggle('active', val > 0);
      } else {
        el.textContent = '0%';
        el.classList.remove('active');
      }
    }

    // Ad Boost autom√°tico por parcelas seg√∫n pa√≠s
    let adBoost, adRange;
    const EUROPA_COUNTRIES = new Set(["Spain", "France", "Germany", "Italy", "Russia"]);
    if (EUROPA_COUNTRIES.has(userCountry)) {
      if      (total <= 70)   { adBoost = 20; adRange = "1‚Äì70 parcelas"; }
      else if (total <= 100)  { adBoost = 15; adRange = "71‚Äì100 parcelas"; }
      else if (total <= 135)  { adBoost = 10; adRange = "101‚Äì135 parcelas"; }
      else if (total <= 170)  { adBoost = 8;  adRange = "136‚Äì170 parcelas"; }
      else if (total <= 200)  { adBoost = 7;  adRange = "171‚Äì200 parcelas"; }
      else if (total <= 250)  { adBoost = 6;  adRange = "201‚Äì250 parcelas"; }
      else if (total <= 300)  { adBoost = 5;  adRange = "251‚Äì300 parcelas"; }
      else if (total <= 350)  { adBoost = 4;  adRange = "301‚Äì350 parcelas"; }
      else if (total <= 400)  { adBoost = 3;  adRange = "351‚Äì400 parcelas"; }
      else                    { adBoost = 2;  adRange = "401‚Äì1000 parcelas"; }
    } else if (userCountry === "United States") {
      if      (total <= 150)  { adBoost = 30; adRange = "1‚Äì150 parcelas"; }
      else if (total <= 220)  { adBoost = 20; adRange = "151‚Äì220 parcelas"; }
      else if (total <= 290)  { adBoost = 15; adRange = "221‚Äì290 parcelas"; }
      else if (total <= 365)  { adBoost = 12; adRange = "291‚Äì365 parcelas"; }
      else if (total <= 435)  { adBoost = 10; adRange = "366‚Äì435 parcelas"; }
      else if (total <= 545)  { adBoost = 8;  adRange = "436‚Äì545 parcelas"; }
      else if (total <= 625)  { adBoost = 7;  adRange = "546‚Äì625 parcelas"; }
      else if (total <= 730)  { adBoost = 6;  adRange = "626‚Äì730 parcelas"; }
      else if (total <= 875)  { adBoost = 5;  adRange = "731‚Äì875 parcelas"; }
      else if (total <= 1100) { adBoost = 4;  adRange = "876‚Äì1100 parcelas"; }
      else if (total <= 1500) { adBoost = 3;  adRange = "1101‚Äì1500 parcelas"; }
      else                    { adBoost = 2;  adRange = "1501‚Äì3000 parcelas"; }
    } else {
      // M√©xico y cualquier otro pa√≠s no identificado
      if      (total <= 50)  { adBoost = 20; adRange = "1‚Äì50 parcelas"; }
      else if (total <= 85)  { adBoost = 15; adRange = "51‚Äì85 parcelas"; }
      else if (total <= 100) { adBoost = 12; adRange = "86‚Äì100 parcelas"; }
      else if (total <= 140) { adBoost = 8;  adRange = "101‚Äì140 parcelas"; }
      else if (total <= 175) { adBoost = 7;  adRange = "141‚Äì175 parcelas"; }
      else if (total <= 225) { adBoost = 5;  adRange = "176‚Äì225 parcelas"; }
      else if (total <= 300) { adBoost = 4;  adRange = "226‚Äì300 parcelas"; }
      else if (total <= 400) { adBoost = 3;  adRange = "301‚Äì400 parcelas"; }
      else                   { adBoost = 2;  adRange = "401+ parcelas"; }
    }
    document.getElementById('adboost-display').textContent = adBoost + '√ó';
    document.getElementById('adboost-range').textContent = adRange;

    // Base rent per second
    const basePerSec = (c * RATES.common) + (r * RATES.rare) + (e * RATES.epic) + (l * RATES.legendary);

    // Badge boost: tiered percentage
    let badgePct = 0;
    if (badges >= 1 && badges <= 10)        badgePct = 0.05;
    else if (badges >= 11 && badges <= 30)  badgePct = 0.10;
    else if (badges >= 31 && badges <= 60)  badgePct = 0.15;
    else if (badges >= 61 && badges <= 100) badgePct = 0.20;
    else if (badges > 100)                  badgePct = 0.25;
    const badgeBoost = 1 + badgePct;

    // Parcelas comprables con Atlas Bucks (100 AB cada una)
    const parcelsBuyable = Math.floor(ab / 100);
    document.getElementById('parcels-buyable').textContent = parcelsBuyable;
    document.getElementById('ab-total-display').textContent = ab.toLocaleString() + ' AB';

    // Boosted per second
    const boostedPerSec = basePerSec * badgeBoost * adBoost;

    const perMin   = boostedPerSec * 60;
    const perHour  = boostedPerSec * 3600;
    const perDay   = boostedPerSec * 86400;
    const perWeek  = perDay * 7;
    const perMonth = perDay * 28;
    // perYear se calcula m√°s abajo incluyendo eventos SRB

    // Base per month
    const basePerMonth = basePerSec * 86400 * 28;
    const badgeExtra = basePerMonth * (badgeBoost - 1);
    const adExtra = basePerMonth * badgeBoost * (adBoost - 1);

    // Update display - table format
    // Base values (no boost)
    const basePerMin  = basePerSec * 60;
    const basePerHour = basePerSec * 3600;
    const basePerDay  = basePerSec * 86400;
    const basePerWeek = basePerDay * 7;
    const basePerMo   = basePerDay * 28;
    const basePerYear = basePerDay * 365;

    document.getElementById('r-sec-base').textContent  = '$' + basePerSec.toFixed(12);
    document.getElementById('r-min-base').textContent  = '$' + basePerMin.toFixed(10);
    document.getElementById('r-hour-base').textContent = '$' + basePerHour.toFixed(8);
    document.getElementById('r-day-base').textContent  = fmt(basePerDay);
    document.getElementById('r-week-base').textContent = fmt(basePerWeek);
    document.getElementById('r-year-base').textContent  = fmt(basePerYear);
    document.getElementById('r-month-base').textContent = fmt(basePerMo);

    // Boosted values
    document.getElementById('r-sec').textContent   = '$' + boostedPerSec.toFixed(12);
    document.getElementById('r-min').textContent   = '$' + (boostedPerSec * 60).toFixed(10);
    document.getElementById('r-hour').textContent  = '$' + (boostedPerSec * 3600).toFixed(8);
    document.getElementById('r-day').textContent   = fmt(perDay);
    document.getElementById('r-week').textContent  = fmt(perWeek);
    document.getElementById('r-year').textContent   = fmt(perDay * 365); // se actualiza abajo con SRB
    document.getElementById('r-month').textContent = fmt(perMonth);

    document.getElementById('b-base').textContent      = '$' + basePerMonth.toFixed(4) + '/mes';
    const badgePctEl = document.getElementById('b-badge-pct');
    if (badgePct === 0) {
      badgePctEl.style.display = 'none';
    } else {
      badgePctEl.style.display = '';
      badgePctEl.textContent = '+' + (badgePct * 100) + '%';
    }
    document.getElementById('b-badge').textContent     = '+$' + badgeExtra.toFixed(4) + '/mes';
    document.getElementById('b-ad-x').textContent      = adBoost + '√ó';
    document.getElementById('b-ad').textContent        = '+$' + adExtra.toFixed(4) + '/mes';
    document.getElementById('b-total').textContent     = '$' + perMonth.toFixed(4);
    // b-year se actualiza despu√©s del bloque SRB


    // ‚îÄ‚îÄ Evento quincenal: 2 √ó 32h con Ad Boost 50√ó ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const EVENT_BOOST  = 50;
    const EVENT_HOURS  = 32;
    const EVENTS_MONTH = 2;
    const MONTH_HOURS  = 28 * 24;
    const TOTAL_EVT_H  = EVENT_HOURS * EVENTS_MONTH;       // 64 h
    const NORMAL_HOURS = MONTH_HOURS - TOTAL_EVT_H;

    const boostedPerHour   = boostedPerSec * 3600;
    const eventPerHour     = basePerSec * badgeBoost * EVENT_BOOST * 3600;

    const incomeSingleEvt  = eventPerHour  * EVENT_HOURS;
    const incomeNormal     = boostedPerHour * NORMAL_HOURS;
    const incomeAllEvts    = eventPerHour  * TOTAL_EVT_H;
    const totalWithEvents  = incomeNormal  + incomeAllEvts;

    document.getElementById('r-single-event-base').textContent = fmt(basePerSec * 3600 * EVENT_HOURS);
    document.getElementById('r-single-event').textContent      = fmt(incomeSingleEvt);
    document.getElementById('r-event-base').textContent        = fmt(basePerMo);
    document.getElementById('r-event').textContent             = fmt(totalWithEvents);

    document.getElementById('b-single-event').textContent      = fmt(incomeSingleEvt);
    document.getElementById('b-event-normal-hours').textContent= NORMAL_HOURS.toFixed(1) + ' h';
    document.getElementById('b-event-normal').textContent      = fmt(incomeNormal) + '/mes';
    document.getElementById('b-event-income').textContent      = fmt(incomeAllEvts);
    document.getElementById('b-event-total').textContent       = fmt(totalWithEvents);

    // Renta anual: 12 meses, cada mes = horas normales + horas de evento
    // Total horas a√±o: 365 √ó 24 = 8,760h
    // Horas de evento al a√±o: 2 eventos √ó 32h √ó 12 meses = 768h
    // Horas normales al a√±o: 8,760 - 768 = 7,992h
    const YEAR_HOURS    = 365 * 24;                             // 8,760h
    const YEAR_EVT_H    = EVENT_HOURS * EVENTS_MONTH * 12;      // 768h
    const YEAR_NORMAL_H = YEAR_HOURS - YEAR_EVT_H;              // 7,992h
    const perYear = (boostedPerHour * YEAR_NORMAL_H) + (eventPerHour * YEAR_EVT_H);
    document.getElementById('r-year').textContent = fmt(perYear);
    document.getElementById('r-year-base').textContent = fmt(basePerYear);
    document.getElementById('b-year').textContent = '$' + perYear.toFixed(4);


    // Time to earn $1 with boost
    if (boostedPerSec > 0) {
      const secsFor1 = 1 / boostedPerSec;
      const d = Math.floor(secsFor1 / 86400);
      const h = Math.floor((secsFor1 % 86400) / 3600);
      const m = Math.floor((secsFor1 % 3600) / 60);
      const s = Math.floor(secsFor1 % 60);
      document.getElementById('t1-days').textContent  = d;
      document.getElementById('t1-hours').textContent = String(h).padStart(2,'0');
      document.getElementById('t1-mins').textContent  = String(m).padStart(2,'0');
      document.getElementById('t1-secs').textContent  = String(s).padStart(2,'0');
      // Human readable note
      let note = 'Con boost activo ¬∑ ';
      if (d > 0) note += d + 'd ' + h + 'h ' + m + 'm ' + s + 's';
      else if (h > 0) note += h + 'h ' + m + 'm ' + s + 's';
      else if (m > 0) note += m + 'm ' + s + 's';
      else note += s + ' segundos';
    } else {
      ['t1-days','t1-hours','t1-mins','t1-secs'].forEach(id => {
        document.getElementById(id).textContent = '‚Äî';
      });
    }
    autoSave();
    drawDonut(c, r, e, l, total);

    // Parcelas por d√≠a
    const startDateVal = document.getElementById('start-date').value;
    const ppdCircle = document.getElementById('ppd-circle');
    if (ppdCircle) {
      if (startDateVal && total > 0) {
        const start = new Date(startDateVal);
        const now = new Date();
        const diasJugados = Math.max(1, Math.floor((now - start) / 86400000));
        const ppd = (total / diasJugados).toFixed(1);
        ppdCircle.textContent = ppd;
      } else {
        ppdCircle.textContent = '‚Äî';
      }
    }
    const ppdCard = document.getElementById('ppd-card');
    if (ppdCard) {
      if (startDateVal && total > 0) {
        const start = new Date(startDateVal);
        const now = new Date();
        const diasJugados = Math.max(1, Math.floor((now - start) / 86400000));
        ppdCard.textContent = (total / diasJugados).toFixed(1);
      } else {
        ppdCard.textContent = '‚Äî';
      }
    }
  }

  function drawDonut(c, r, e, l, total) {
    const svg = document.getElementById('donut-svg');
    const center = document.getElementById('donut-center');
    const cx = 50, cy = 50, strokeW = 5;
    const GAP_DEG = 6;
    // Radios independientes por rareza: common, rare, epic, legendary
    // rare y legendary sobresalen m√°s
    const BASE_DONUT_R = [50, 30, 15, 5]; // para calcular radio din√°mico

    svg.querySelectorAll('.seg').forEach(el => el.remove());

    const vals = [c, r, e, l];
    const pctIds = ['donut-pct-c','donut-pct-r','donut-pct-e','donut-pct-l'];
    const colors = ['#4ade80','#60a5fa','#c084fc','#facc15'];

    if (total === 0) {
      center.textContent = '‚Äî';
      // Reset flechas a 0% con flecha abajo cuando no hay parcelas
      const donutArrowIds0 = ["donut-arrow-c","donut-arrow-r","donut-arrow-e","donut-arrow-l"];
      pctIds.forEach((id, i) => {
        const div = document.getElementById(id);
        const arrow = div.querySelector('.donut-arrow');
        if (arrow) { arrow.textContent = '‚Üì'; arrow.className = 'donut-arrow down'; }
        const tn = Array.from(div.childNodes).find(n => n.nodeType === Node.TEXT_NODE);
        if (tn) { tn.textContent = '0%'; } else { div.appendChild(document.createTextNode('0%')); }
      });
      return;
    }
    center.textContent = total;

    // Aplicar color del usuario al c√≠rculo de fondo
    const _donutBg = document.getElementById('donut-bg-circle');
    if (_donutBg && window._userThemeRgb) {
      _donutBg.setAttribute('stroke', `rgba(${window._userThemeRgb},0.15)`);
    }

    const activeCount = vals.filter(v => v > 0).length;

    // Calcular √°ngulos usando radio base com√∫n para distribuir 360¬∞
    const GAP_RAD = (GAP_DEG * Math.PI) / 180;
    const totalGap = activeCount > 1 ? GAP_RAD * activeCount : 0;
    const available = 2 * Math.PI - totalGap;

    // Helper: genera path de arco dentado (efecto engrane)
    function arcPath(cx, cy, r, startAngle, endAngle) {
      const toothHeight = 5.5;
      const toothWidth  = 0.08;
      const gapWidth    = 0.14;
      const period      = toothWidth + gapWidth;
      const arcLen      = endAngle - startAngle;
      const numTeeth    = Math.max(1, Math.floor(arcLen / period));
      const actualPeriod = arcLen / numTeeth;
      const tw = actualPeriod * 0.45;
      const rOuter = r + toothHeight;

      let d = '';
      for (let t = 0; t < numTeeth; t++) {
        const a0 = startAngle + t * actualPeriod;
        const a1 = a0 + (actualPeriod - tw);
        const a2 = a1 + tw * 0.5;
        const a3 = a0 + actualPeriod;

        const p = (angle, radius) => `${cx + radius * Math.cos(angle)} ${cy + radius * Math.sin(angle)}`;

        if (t === 0) d += `M ${p(a0, r)}`;
        else         d += ` L ${p(a0, r)}`;

        d += ` A ${r} ${r} 0 0 1 ${p(a1, r)}`;
        d += ` L ${p(a1, rOuter)}`;              // subir vertical
        d += ` L ${p(a2, rOuter)}`;              // tope plano
        d += ` L ${p(a3, r)}`;                   // bajar vertical
      }
      return d;
    }

    // 4 radios fijos por rareza: common=m√°s exterior, legendary=m√°s interior
    // Se solapan intencionalmente para que se crucen al girar
    const RADIOS = [38, 30, 22, 14]; // common, rare, epic, legendary
    // Sentido de giro alternado para que se crucen visualmente
    const SPIN_DIR = ['segSpinFwd', 'segSpinRev', 'segSpinFwd', 'segSpinRev'];

    let angleOffset = -Math.PI / 2; // empezar arriba

    vals.forEach((val, i) => {
      if (val === 0) return;
      const pct = val / total;
      const segAngle = pct * available;
      const startAngle = angleOffset;
      const endAngle = angleOffset + segAngle;
      const midAngle = (startAngle + endAngle) / 2;
      const radius = RADIOS[i];

      // Explode: desplazar el segmento hacia afuera desde el centro
      const EXPLODE = 2;
      const ex = cx + Math.cos(midAngle) * EXPLODE;
      const ey = cy + Math.sin(midAngle) * EXPLODE;

      const seg = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      seg.setAttribute('d', arcPath(ex, ey, radius, startAngle, endAngle));
      seg.setAttribute('fill', 'none');
      seg.setAttribute('stroke', colors[i]);
      seg.setAttribute('stroke-width', strokeW);
      seg.setAttribute('stroke-linecap', 'round');
      seg.setAttribute('filter', `drop-shadow(0 0 3px ${colors[i]})`);

      // Giro individual: velocidad en funci√≥n de la cantidad de parcelas de ese tipo
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('class', 'seg');
      g.style.transformOrigin = '50px 50px';
      // Velocidad basada en cantidad propia: m√°s parcelas = m√°s r√°pido
      // Rango: 60s (0 parcelas) ‚Üí 0.5s (muchas parcelas)
      const segVal = vals[i];
      let segSpeed;
      if      (segVal === 0)    segSpeed = 60;
      else if (segVal <= 10)    segSpeed = 50;
      else if (segVal <= 25)    segSpeed = 40;
      else if (segVal <= 50)    segSpeed = 30;
      else if (segVal <= 100)   segSpeed = 20;
      else if (segVal <= 200)   segSpeed = 12;
      else if (segVal <= 400)   segSpeed = 7;
      else if (segVal <= 700)   segSpeed = 4;
      else if (segVal <= 1000)  segSpeed = 2.5;
      else if (segVal <= 2000)  segSpeed = 1.5;
      else if (segVal <= 4000)  segSpeed = 1;
      else                      segSpeed = 0.5;
      g.style.animation = `${SPIN_DIR[i]} ${segSpeed.toFixed(2)}s linear infinite`;
      g.appendChild(seg);
      svg.appendChild(g);

      angleOffset = endAngle + GAP_RAD;
    });

    // Actualizar flechas ‚Äî expl√≠cito para cada rareza
    function updateArrow(divId, arrowId, parcelas, base) {
      const pct = parseFloat(((parcelas / total) * 100).toFixed(1));
      const diff = pct - base;
      const sym   = diff > 0 ? "‚Üë" : (diff < 0 ? "‚Üì" : "");
      const cls   = diff > 0 ? "donut-arrow up" : (diff < 0 ? "donut-arrow down" : "donut-arrow");
      document.getElementById(divId).innerHTML = '<span class="' + cls + '" id="' + arrowId + '">' + sym + '</span>' + pct.toFixed(1) + '%';
    }
    updateArrow('donut-pct-c', 'donut-arrow-c', c, 50);
    updateArrow('donut-pct-r', 'donut-arrow-r', r, 30);
    updateArrow('donut-pct-e', 'donut-arrow-e', e, 15);
    updateArrow('donut-pct-l', 'donut-arrow-l', l,  5);
  }


  const SAVE_KEY = 'atlas-earth-calc-data';

  function autoSave() {
    const data = {
      common:     document.getElementById('common').value,
      rare:       document.getElementById('rare').value,
      epic:       document.getElementById('epic').value,
      legendary:  document.getElementById('legendary').value,
      badges:     document.getElementById('badges').value,
      diamonds:   document.getElementById('diamonds').value,
      atlasbucks: document.getElementById('atlasbucks').value,
      explorer:   explorerActive,
      startDate:  document.getElementById('start-date').value,
    };
    localStorage.setItem('atlas-earth-calc-data', JSON.stringify(data));
  }

  function saveData() {
    const data = {
      common:     document.getElementById('common').value,
      rare:       document.getElementById('rare').value,
      epic:       document.getElementById('epic').value,
      legendary:  document.getElementById('legendary').value,
      badges:     document.getElementById('badges').value,
      diamonds:   document.getElementById('diamonds').value,
      atlasbucks: document.getElementById('atlasbucks').value,
      startDate:  document.getElementById('start-date').value,
    };
    try {
      window.storage.set(SAVE_KEY, JSON.stringify(data)).then(() => {
        showStatus();
      }).catch(() => {
        // fallback to localStorage if storage API unavailable
        localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        showStatus();
      });
    } catch(e) {
      localStorage.setItem(SAVE_KEY, JSON.stringify(data));
      showStatus();
    }
  }

  function showStatus(msg) {
    const el = document.getElementById('save-status');
    if (!el) return;
    el.textContent = msg || '‚úî Enlace copiado';
    el.classList.add('visible');
    setTimeout(() => el.classList.remove('visible'), 2500);
  }

  function shareData() {
    try {
      localStorage.setItem(SAVE_KEY, JSON.stringify({
        common:     document.getElementById('common').value,
        rare:       document.getElementById('rare').value,
        epic:       document.getElementById('epic').value,
        legendary:  document.getElementById('legendary').value,
        badges:     document.getElementById('badges').value,
        diamonds:   document.getElementById('diamonds').value,
        atlasbucks: document.getElementById('atlasbucks').value,
        explorer:   explorerActive,
        startDate:  document.getElementById('start-date').value,
      }));
    } catch(e) {}
    showStatus('‚úî Datos guardados');
  }

  async function loadData() {
    let data = null;

    // 1. Prioridad: par√°metros en la URL
    const params = new URLSearchParams(window.location.search);
    const urlKeys = ['common','rare','epic','legendary','badges','diamonds','atlasbucks','explorer'];
    if (urlKeys.some(k => params.has(k))) {
      data = {};
      urlKeys.forEach(k => {
        if (params.has(k)) data[k] = k === 'explorer' ? params.get(k) === 'true' : params.get(k);
      });
    }

    // 2. Fallback: localStorage
    if (!data) {
      const local = localStorage.getItem(SAVE_KEY);
      if (local) { try { data = JSON.parse(local); } catch(e) {} }
    }

    // 3. Fallback: storage API
    if (!data) {
      try {
        const result = await window.storage.get(SAVE_KEY);
        if (result && result.value) data = JSON.parse(result.value);
      } catch(e) {}
    }

    if (!data) return;
    ['common','rare','epic','legendary','badges','diamonds','atlasbucks'].forEach(k => {
      if (data[k] !== undefined) document.getElementById(k).value = data[k];
    });
    if (data.startDate) document.getElementById('start-date').value = data.startDate;
    if (data.explorer === false || data.explorer === 'false') {
      explorerActive = false;
      const check = document.getElementById('explorer-check');
      const desc  = document.getElementById('explorer-desc');
      const badge = document.getElementById('explorer-badge');
      check.classList.remove('checked');
      desc.textContent = 'Inactivo: diamantes √∑ 5 giros de ruleta';
      badge.style.display = 'none';
    }
    calc();
  }

  function buildShareURL() {
    const base = window.location.href.split('?')[0];
    const params = new URLSearchParams({
      common:     document.getElementById('common').value     || 0,
      rare:       document.getElementById('rare').value       || 0,
      epic:       document.getElementById('epic').value       || 0,
      legendary:  document.getElementById('legendary').value  || 0,
      badges:     document.getElementById('badges').value     || 0,
      diamonds:   document.getElementById('diamonds').value   || 0,
      atlasbucks: document.getElementById('atlasbucks').value || 0,
      explorer:   explorerActive,
    });
    return base + '?' + params.toString();
  }

  
  async function init() {
    await loadData();
    await loadProfile();
    adjustBadge();
    // Solo activar el explorer visualmente si explorerActive es true (ya lo maneja loadData)
    if (explorerActive) {
      document.getElementById('explorer-check').classList.add('checked');
      document.getElementById('explorer-badge').style.display = 'block';
    }
  }
  init();

  // ‚îÄ‚îÄ Eventos del avatar (separados para m√°xima compatibilidad m√≥vil) ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', function() {
    // Ya deber√≠a estar listo pero por si acaso
  });

  // Placeholder: abrir galer√≠a al hacer tap/click
  const avatarPlaceholder = document.getElementById('avatar-placeholder');
  const avatarEdit = document.getElementById('avatar-edit');
  const avatarInput = document.getElementById('avatar-input');
  const avatarWrapper = document.getElementById('avatar-wrapper');
  const avatarBorderColor = document.getElementById('avatar-border-color');

  function openFilePicker() {
    avatarInput.click();
  }

  function openColorPicker() {
    avatarBorderColor.click();
  }

  if (avatarPlaceholder) {
    avatarPlaceholder.addEventListener('click', function(e) {
      e.stopPropagation();
      openFilePicker();
    });
    // Touch expl√≠cito para Chrome Android
    avatarPlaceholder.addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      openFilePicker();
    });
  }

  if (avatarEdit) {
    avatarEdit.addEventListener('click', function(e) {
      e.stopPropagation();
      openFilePicker();
    });
    avatarEdit.addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      openFilePicker();
    });
  }

  // Bot√≥n color de borde
  const avatarColorBtn = document.getElementById('avatar-color-btn');
  if (avatarColorBtn) {
    avatarColorBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (isSafariIOS()) {
        toggleSafariColorPalette();
      } else {
        openColorPicker();
      }
    });
    // pointerup en lugar de touchend para mejor compatibilidad con Safari iOS
    avatarColorBtn.addEventListener('pointerup', function(e) {
      if (e.pointerType === 'touch') {
        e.stopPropagation();
        if (isSafariIOS()) {
          toggleSafariColorPalette();
        } else {
          avatarBorderColor.click();
        }
      }
    });
  }
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // Reloj en tiempo real
  function updateClock() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    document.getElementById('cl-year').textContent  = now.getFullYear();
    document.getElementById('cl-month').textContent = pad(now.getMonth() + 1);
    document.getElementById('cl-day').textContent   = pad(now.getDate());
    document.getElementById('cl-hour').textContent  = pad(now.getHours());
    document.getElementById('cl-min').textContent   = pad(now.getMinutes());
    document.getElementById('cl-sec').textContent   = pad(now.getSeconds());

    // Contador estilo NASA desde lanzamiento AEMX M√©xico (12 Jul 2024)
    const launch = new Date('2024-07-12T00:00:00');
    const diffMs = now - launch;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
    document.getElementById('aemx-sol').textContent = diffDays;
  }
  updateClock();
  setInterval(updateClock, 1000);

  function hexToRgb(hex) {
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return r+','+g+','+b;
  }

  function applyThemeColor(color) {
    const rgb = hexToRgb(color);
    const root = document.documentElement;

    // Borde del avatar
    document.querySelector('.profile-avatar-wrapper').style.setProperty('--avatar-border-color', color);

    // Actualizar c√≠rculo preview del color
    const preview = document.getElementById('color-preview');
    if (preview) preview.style.background = color;

    // Actualizar botones del avatar (‚úé y üé®)
    const avatarEditBtn = document.getElementById('avatar-edit');
    const avatarColorBtn = document.getElementById('avatar-color-btn');
    if (avatarEditBtn) {
      avatarEditBtn.style.background = color;
      avatarEditBtn.style.boxShadow = `0 0 8px rgba(${rgb},0.6)`;
    }
    if (avatarColorBtn) {
      avatarColorBtn.style.background = color;
      avatarColorBtn.style.boxShadow = `0 0 8px rgba(${rgb},0.6)`;
    }

    // Fondo oscuro seg√∫n color seleccionado
    const [_r,_g,_b] = rgb.split(",").map(Number);
    const darkBg = `rgb(${Math.round(_r*0.04)},${Math.round(_g*0.04)},${Math.round(_b*0.04)})`;
    document.body.style.background = darkBg;
    document.body.style.backgroundColor = darkBg;
    const panelBg = `rgb(${Math.round(_r*0.06)},${Math.round(_g*0.06)},${Math.round(_b*0.06)})`;
    const panel2Bg = `rgb(${Math.round(_r*0.07)},${Math.round(_g*0.07)},${Math.round(_b*0.07)})`;
    root.style.setProperty("--panel", panelBg);
    root.style.setProperty("--panel2", panel2Bg);

    // CSS variables globales
    root.style.setProperty('--glow', color);
    root.style.setProperty('--accent', color);

    // Donut center: color del usuario mezclado 50% con blanco
    const [_r2,_g2,_b2] = rgb.split(",").map(Number);
    const lightR = Math.round(_r2 + (255 - _r2) * 0.5);
    const lightG = Math.round(_g2 + (255 - _g2) * 0.5);
    const lightB = Math.round(_b2 + (255 - _b2) * 0.5);
    const donutCenter = document.getElementById('donut-center');
    if (donutCenter) donutCenter.style.color = `rgb(${lightR},${lightG},${lightB})`;

    // PPD circle: fondo 50% m√°s oscuro, texto del color del usuario
    const darkR = Math.round(_r2 * 0.5);
    const darkG = Math.round(_g2 * 0.5);
    const darkB = Math.round(_b2 * 0.5);
    const ppdEl = document.getElementById('ppd-circle');
    if (ppdEl) {
      ppdEl.style.background = `rgb(${darkR},${darkG},${darkB})`;
      ppdEl.style.color = color;
      ppdEl.style.boxShadow = `0 0 8px rgba(${rgb},0.5)`;
      ppdEl.style.textShadow = `0 0 8px rgba(${rgb},0.9), 2px 2px 0px rgba(0,0,0,0.6)`;
    }



    // counter-btn: color del texto
    document.querySelectorAll('.counter-btn').forEach(btn => {
      btn.style.color = color;
      btn.style.borderColor = `rgba(${rgb},0.5)`;
    });
    // Inputs de cantidades
    document.querySelectorAll('input[type="number"]').forEach(el => {
      el.style.background = `rgb(${Math.round(_r*0.05)},${Math.round(_g*0.05)},${Math.round(_b*0.05)})`;
      el.style.borderColor = `rgba(${rgb},0.4)`;
    });

    // T√≠tulos de secciones
    document.querySelectorAll('.card-title').forEach(el => {
      el.style.color = color;
    });
    document.querySelectorAll('.results-title, .breakdown-title').forEach(el => {
      el.style.color = color;
    });

    // Bordes de todas las secciones
    document.querySelectorAll('.card').forEach(el => {
      el.style.borderColor = `rgba(${rgb},0.5)`;
    });
    document.querySelectorAll('.header-bar, .profile-section').forEach(el => {
      el.style.borderColor = `rgba(${rgb},0.5)`;
      el.style.background = `linear-gradient(135deg, rgb(${Math.round(_r*0.07)},${Math.round(_g*0.07)},${Math.round(_b*0.07)}) 0%, rgb(${Math.round(_r*0.05)},${Math.round(_g*0.05)},${Math.round(_b*0.05)}) 100%)`;
    });
    document.querySelectorAll('.results-card').forEach(el => {
      el.style.borderColor = color;
      el.style.background = `linear-gradient(135deg, rgb(${Math.round(_r*0.07)},${Math.round(_g*0.07)},${Math.round(_b*0.07)}) 0%, rgb(${Math.round(_r*0.05)},${Math.round(_g*0.05)},${Math.round(_b*0.05)}) 100%)`;
      el.style.boxShadow = `0 0 40px rgba(${rgb},0.08), inset 0 0 40px rgba(${rgb},0.03)`;
    });
    // L√≠neas separadoras (dividers)
    document.querySelectorAll('.divider').forEach(el => {
      el.style.background = `linear-gradient(90deg, transparent, rgba(${rgb},0.4), transparent)`;
    });
    // L√≠neas separadoras en resultados de renta
    document.querySelectorAll('.breakdown-separator').forEach(el => {
      el.style.borderTopColor = `rgba(${rgb},0.35)`;
    });

    // C√≠rculo de fondo del donut con color del usuario al 15% de opacidad
    const donutBg = document.getElementById('donut-bg-circle');
    if (donutBg) donutBg.setAttribute('stroke', `rgba(${rgb},0.15)`);
    // Guardar color para cuando se redibuje el donut
    window._userThemeRgb = rgb;
  }
  // Exponer en window para que el m√≥dulo Firebase pueda accederla
  window.applyThemeColor = applyThemeColor;

  function showAvatarButtons() {
    const editBtn = document.getElementById('avatar-edit');
    const colorBtn = document.getElementById('avatar-color-btn');
    const img = document.getElementById('avatar-img');
    if (editBtn && img && img.style.display !== 'none') editBtn.style.display = 'flex';
    if (colorBtn) colorBtn.style.display = 'flex';
  }

  function hideAvatarButtons() {
    const editBtn = document.getElementById('avatar-edit');
    const colorBtn = document.getElementById('avatar-color-btn');
    if (editBtn) editBtn.style.display = 'none';
    if (colorBtn) colorBtn.style.display = 'none';
  }

  function changeAvatarBorder(color) {
    applyThemeColor(color);
    localStorage.setItem('atlas-avatar-border', color);
    try { window.storage.set('atlas-avatar-border', color); } catch(e) {}
    if (window._fbUser && window._fbSaveAll) window._fbSaveAll();
  }

  // Avatar upload
  function loadAvatar(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.getElementById('avatar-img');
      const placeholder = document.getElementById('avatar-placeholder');
      const editBtn = document.getElementById('avatar-edit');
      img.src = e.target.result;
      img.style.display = 'block';
      placeholder.style.display = 'none';
      editBtn.style.display = 'none';
      const colorBtn = document.getElementById('avatar-color-btn');
      if (colorBtn) colorBtn.style.display = 'none';
      // Save to storage
      localStorage.setItem('atlas-avatar', e.target.result);
      try { window.storage.set('atlas-avatar', e.target.result); } catch(err) {}
    };
    reader.readAsDataURL(file);
  }

  function adjustBadge() {
    // auto-resize input to fit text
    const input = document.getElementById('username');
    const tmp = document.createElement('span');
    tmp.style.font = getComputedStyle(input).font;
    tmp.style.visibility = 'hidden';
    tmp.style.position = 'absolute';
    tmp.style.whiteSpace = 'pre';
    tmp.textContent = input.value || input.placeholder;
    document.body.appendChild(tmp);
    const w = Math.min(tmp.offsetWidth + 8, 320);
    document.body.removeChild(tmp);
    input.style.width = Math.max(w, 280) + 'px';
  }

  function saveUsername() {
    const name = document.getElementById('username').value;
    localStorage.setItem('atlas-username', name);
    try { window.storage.set('atlas-username', name); } catch(err) {}
  }

  function saveStartDate() {
    const date = document.getElementById('start-date').value;
    localStorage.setItem('atlas-start-date', date);
    try { window.storage.set('atlas-start-date', date); } catch(err) {}
  }

  // Load avatar and username on startup
  async function loadProfile() {
    // Username - localStorage first
    let name = localStorage.getItem('atlas-username') || '';
    if (!name) {
      try {
        const r = await window.storage.get('atlas-username');
        if (r && r.value) name = r.value;
      } catch(e) {}
    }
    if (name) { document.getElementById('username').value = name; adjustBadge(); }

    // Avatar - localStorage first
    let avatar = localStorage.getItem('atlas-avatar') || '';
    if (!avatar) {
      try {
        const r = await window.storage.get('atlas-avatar');
        if (r && r.value) avatar = r.value;
      } catch(e) {}
    }
    if (avatar) {
      const img = document.getElementById('avatar-img');
      const placeholder = document.getElementById('avatar-placeholder');
      const editBtn = document.getElementById('avatar-edit');
      img.src = avatar;
      img.style.display = 'block';
      placeholder.style.display = 'none';
      editBtn.style.display = 'none';
      const colorBtn2 = document.getElementById('avatar-color-btn');
      if (colorBtn2) colorBtn2.style.display = 'none';
    }

    // Border color
    let borderColor = localStorage.getItem('atlas-avatar-border') || '';
    if (!borderColor) {
      try {
        const r = await window.storage.get('atlas-avatar-border');
        if (r && r.value) borderColor = r.value;
      } catch(e) {}
    }
    if (borderColor) {
      applyThemeColor(borderColor);
      document.getElementById('avatar-border-color').value = borderColor;
      const preview = document.getElementById('color-preview');
      if (preview) preview.style.background = borderColor;
    }

    // Fecha de inicio
    let startDate = localStorage.getItem('atlas-start-date') || '';
    if (!startDate) {
      try {
        const r = await window.storage.get('atlas-start-date');
        if (r && r.value) startDate = r.value;
      } catch(e) {}
    }
    if (startDate) document.getElementById('start-date').value = startDate;
  }




  function hayZoomActivo() {
    if (!window.visualViewport) return false;
    return window.visualViewport.scale > 1.05;
  }

  function captureWithZoomReset(beforeCapture, onSuccess, onError) {
    // Bloquear si hay zoom activo en m√≥vil
    if (hayZoomActivo()) {
      alert('‚ö†Ô∏è Tienes zoom activo.\nPellizca la pantalla para regresar al zoom normal e intenta de nuevo.');
      onError(new Error('zoom activo'));
      return;
    }
    // Guardar viewport original y forzar zoom=1
    const meta = document.querySelector('meta[name="viewport"]');
    const orig = meta ? meta.getAttribute('content') : '';
    if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
    window.scrollTo(0, 0);

    setTimeout(() => {
      beforeCapture();
      const container = document.querySelector('.container');
      const W = Math.round(container.getBoundingClientRect().width);
      const H = Math.round(container.getBoundingClientRect().height);
      const scale = Math.max(Math.min(window.devicePixelRatio || 2, 3), 1);

      html2canvas(container, {
        backgroundColor: '#060b14',
        scale: scale,
        width: W,
        height: H,
        windowWidth: document.documentElement.clientWidth,
        windowHeight: document.documentElement.clientHeight,
        scrollX: 0,
        scrollY: 0,
        useCORS: true,
        allowTaint: true,
        imageTimeout: 0,
        logging: false,
        onclone: (doc) => {
          doc.querySelectorAll('img').forEach(img => {
            if (!img.complete || img.naturalWidth === 0) img.style.display = 'none';
          });
          doc.querySelectorAll('svg').forEach(svg => {
            if (!svg.getAttribute('width')) svg.setAttribute('width', '180');
            if (!svg.getAttribute('height')) svg.setAttribute('height', '180');
            svg.style.animation = 'none';
            svg.style.transform = 'rotate(-90deg)';
          });
          doc.querySelectorAll('.seg').forEach(g => { g.style.animation = 'none'; });
          const styleEl = doc.createElement('style');
          styleEl.textContent = `
            .profile-avatar-wrapper { animation: none !important; background: none !important; }
            .profile-avatar-wrapper::before { display: none !important; content: none !important; }
            .profile-avatar-wrapper::after { display: none !important; content: none !important; }
            .profile-avatar { border: 20px solid #00c8ff !important; animation: none !important; }
            #visit-wrapper { display: none !important; }
            @keyframes spinBorder { 0%,100% { transform: none; } }
            @keyframes spinDonut { 0%,100% { transform: rotate(-90deg); } }
            @keyframes glowCompass { 0%,100% { filter: none; } }
          `;
          doc.head.appendChild(styleEl);
        }
      }).then(canvas => {
        if (meta && orig) meta.setAttribute('content', orig);
        onSuccess(canvas);
      }).catch(err => {
        if (meta && orig) meta.setAttribute('content', orig);
        onError(err);
      });
    }, 500);
  }



  // ‚îÄ‚îÄ Ubicaci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var userCountry = "";
  window.userCountry = "";

  // Mapa de nombres en espa√±ol/variantes ‚Üí nombre normalizado
  var COUNTRY_MAP = {
    // M√©xico
    "m√©xico": "Mexico", "mexico": "Mexico",
    // Estados Unidos
    "estados unidos": "United States", "united states": "United States",
    "us": "United States", "usa": "United States",
    // Europa
    "espa√±a": "Spain", "spain": "Spain",
    "francia": "France", "france": "France",
    "alemania": "Germany", "germany": "Germany",
    "italia": "Italy", "italy": "Italy",
    "rusia": "Russia", "russia": "Russia",
  };

  function normalizarPais(name) {
    if (!name) return "";
    var lower = name.toLowerCase().trim();
    return COUNTRY_MAP[lower] || name;
  }

  function actualizarPais(countryName) {
    var pais = normalizarPais(countryName) || "";
    if (!pais) return;
    userCountry = pais; window.userCountry = pais;
    var spanMexico = document.querySelector('.mexico');
    if (spanMexico) { spanMexico.textContent = pais.toUpperCase(); spanMexico.style.color = '#7EC8E3'; }
    if (typeof calc === 'function') calc();
    var intentos = 0;
    var retry = setInterval(function() {
      intentos++;
      if (window._fbSaveCountry) { clearInterval(retry); window._fbSaveCountry(pais); }
      else if (intentos >= 20)   { clearInterval(retry); }
    }, 500);
  }

  function actualizarCiudad(ciudad, estado) {
    if (!ciudad) return;
    var texto = ciudad + (estado ? ", " + estado : "");
    var el = document.getElementById("user-location");
    if (el) el.textContent = texto.toUpperCase();
    var intentos = 0;
    var retry = setInterval(function() {
      intentos++;
      if (window._fbSaveCity) {
        clearInterval(retry);
        window._fbSaveCity(texto);
      } else if (intentos >= 20) { clearInterval(retry); }
    }, 500);
  }

  async function ubicacionPorIP() {
    var elLoc = document.getElementById("user-location");
    if (elLoc && elLoc.textContent === "‚Äî") elLoc.textContent = "...";
    try {
      var r1 = await fetch("https://freeipapi.com/api/json");
      var d1 = await r1.json();
      if (d1.countryName) actualizarPais(d1.countryName);
      if (d1.cityName && d1.regionName) { actualizarCiudad(d1.cityName, d1.regionName); return; }
    } catch(e) {}
    try {
      var r2 = await fetch("https://ipapi.co/json/");
      var d2 = await r2.json();
      if (d2.country_name) actualizarPais(d2.country_name);
      if (d2.city && d2.region) { actualizarCiudad(d2.city, d2.region); return; }
    } catch(e) {}
    try {
      var r3 = await fetch("https://ipwho.is/");
      var d3 = await r3.json();
      if (d3.country) actualizarPais(d3.country);
      if (d3.city && d3.region) { actualizarCiudad(d3.city, d3.region); return; }
    } catch(e) {}
    if (elLoc && elLoc.textContent === "...") elLoc.textContent = "‚Äî";
  }

  // Siempre obtener pa√≠s y ciudad por IP
  setTimeout(ubicacionPorIP, 300);

  // Mejorar ciudad/estado con GPS si est√° disponible
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        var lat = pos.coords.latitude;
        var lon = pos.coords.longitude;
        fetch("https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=" + lat + "&longitude=" + lon + "&localityLanguage=es")
          .then(function(res) { return res.json(); })
          .then(function(data) {
            var ciudad = data.city || data.locality || "";
            var estado = data.principalSubdivision || "";
            if (ciudad) actualizarCiudad(ciudad, estado);
            if (data.countryName) actualizarPais(data.countryName);
          })
          .catch(function() {
            fetch("https://nominatim.openstreetmap.org/reverse?lat=" + lat + "&lon=" + lon + "&format=json&accept-language=es")
              .then(function(r) { return r.json(); })
              .then(function(d) {
                var ciudad = d.address && (d.address.city || d.address.town || d.address.village || "");
                var estado = d.address && (d.address.state || "");
                var pais   = d.address && (d.address.country || "");
                if (ciudad) actualizarCiudad(ciudad, estado);
                if (pais)   actualizarPais(pais);
              }).catch(function() {});
          });
      },
      function() {}
    );
  }
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // ‚îÄ‚îÄ Contador de visitas (counterapi.dev) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function initVisitCounter() {
    const wrapper = document.createElement('div');
    wrapper.id = 'visit-wrapper';
    wrapper.innerHTML = `
      <span style="font-size:13px;opacity:0.7;">Powered by Socram13 üëÅ üëÅ</span>
      <span id="visit-count-display" style="font-family:'Share Tech Mono',monospace;font-size:15px;color:#4a6a8a;letter-spacing:3px;background:#0b1626;border:1px solid #1a3a5c;border-radius:6px;padding:3px 10px;">00000000</span>
    `;
    Object.assign(wrapper.style, {
      position: 'fixed',
      bottom: '14px',
      right: '18px',
      zIndex: '99999',
      display: 'flex',
      alignItems: 'center',
      gap: '8px',
      opacity: '0.55',
      transition: 'opacity 0.3s',
      cursor: 'default',
    });
    wrapper.onmouseenter = () => wrapper.style.opacity = '0.85';
    wrapper.onmouseleave = () => wrapper.style.opacity = '0.55';
    document.body.appendChild(wrapper);

    try {
      const res = await fetch('https://api.counterapi.dev/v1/socram-13-gamertag/visits/up');
      const data = await res.json();
      const el = document.getElementById('visit-count-display');
      if (el && data.count !== undefined) el.textContent = String(data.count).padStart(8, '0');
    } catch(e) {}
  }
  initVisitCounter();

  // ‚îÄ‚îÄ Bloquear botones si hay zoom activo (Chrome Android) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function checkZoomButtons() {
    const scale = window.visualViewport ? window.visualViewport.scale : 1;
    const zoomActivo = scale > 1.05;
    const btnPng   = document.getElementById('btn-screenshot');
    const btnShare = document.getElementById('btn-share-data');

    [btnPng, btnShare].forEach(btn => {
      if (!btn) return;
      btn.disabled = zoomActivo;
      btn.style.setProperty('opacity', zoomActivo ? '0.35' : '1', 'important');
      btn.style.setProperty('cursor', zoomActivo ? 'not-allowed' : 'pointer', 'important');
      btn.style.setProperty('filter', zoomActivo ? 'grayscale(1)' : 'none', 'important');
    });
  }

  // Polling cada 300ms ‚Äî √∫nico m√©todo confiable en Chrome Android
  checkZoomButtons();
  setInterval(checkZoomButtons, 300);
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // ‚îÄ‚îÄ Safari iOS: detecci√≥n y paleta de colores alternativa ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function isSafariIOS() {
    return /iP(hone|od|ad)/.test(navigator.userAgent) &&
           /WebKit/.test(navigator.userAgent) &&
           !window.MSStream;
  }

  const SAFARI_PALETTE_COLORS = [
    '#00c8ff','#4ade80','#facc15','#f97316',
    '#ef4444','#a855f7','#ec4899','#ffffff',
    '#94a3b8','#1e40af','#065f46','#7f1d1d'
  ];

  function toggleSafariColorPalette() {
    let palette = document.getElementById('safari-color-palette');
    if (palette) {
      palette.remove();
      return;
    }
    palette = document.createElement('div');
    palette.id = 'safari-color-palette';
    palette.style.cssText = `
      position: fixed;
      z-index: 9999;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 14px;
      display: grid;
      grid-template-columns: repeat(6, 36px);
      gap: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    `;
    SAFARI_PALETTE_COLORS.forEach(color => {
      const swatch = document.createElement('div');
      swatch.style.cssText = `
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: ${color};
        cursor: pointer;
        border: 2px solid rgba(255,255,255,0.2);
        transition: transform 0.15s;
      `;
      swatch.addEventListener('click', function(e) {
        e.stopPropagation();
        changeAvatarBorder(color);
        document.getElementById('avatar-border-color').value = color;
        palette.remove();
      });
      palette.appendChild(swatch);
    });
    document.body.appendChild(palette);
    // Cerrar si se toca fuera
    setTimeout(() => {
      document.addEventListener('pointerdown', function closePalette(e) {
        if (!palette.contains(e.target)) {
          palette.remove();
          document.removeEventListener('pointerdown', closePalette);
        }
      });
    }, 100);
  }
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

</script>
  <!-- Toast de coin ganado -->
  <div class="coin-toast" id="coin-toast">ü™ô +1 COIN GANADO</div>

  <!-- ===== CHAT WIDGET ===== -->
  <button id="chat-fab" onclick="toggleChat()" aria-label="Abrir chat">
    <svg class="icon-chat" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>
    <svg class="icon-close" style="display:none" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
  </button>

  <div id="chat-iframe-container">
    <div id="chat-widget-bar">
      <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <span id="widget-time">--:--</span>
    </div>
    <iframe id="chat-frame" src="chat-firebase.html" title="Chat Atlas Earth M√©xico" loading="lazy" allow="clipboard-write"></iframe>
  </div>

  <script>
    let chatOpen = false;

    const chatFrame = document.getElementById('chat-frame');

    function toggleChat() {
      chatOpen = !chatOpen;
      document.getElementById('chat-iframe-container').classList.toggle('open', chatOpen);
      document.getElementById('chat-fab').classList.toggle('open', chatOpen);

      // Ocultar/mostrar contador de visitas
      const visitWrapper = document.getElementById('visit-wrapper');
      if (visitWrapper) visitWrapper.style.display = chatOpen ? 'none' : '';

      // En m√≥vil ocultar el bot√≥n cuando el chat est√° abierto
      if (window.innerWidth <= 480) {
        document.getElementById('chat-fab').style.display = chatOpen ? 'none' : 'flex';
      }

      if (chatOpen) {
        // Empujar estado para interceptar el bot√≥n atr√°s
        history.pushState({ chatOpen: true }, '');
        // Cargar iframe con username
        const username = localStorage.getItem('atlas-username') || '';
        const avatar = localStorage.getItem('atlas-avatar') || '';
        const color = localStorage.getItem('atlas-avatar-border') || '';
        sessionStorage.setItem('chat-avatar', avatar);
        document.getElementById('chat-frame').src = `chat-firebase.html?username=${encodeURIComponent(username)}&color=${encodeURIComponent(color)}`;
      }
    }

    function updateWidgetTime() {
      const now = new Date();
      document.getElementById('widget-time').textContent =
        String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
    }
    updateWidgetTime();
    setInterval(updateWidgetTime, 60000);
    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'CLOSE_CHAT') closeChatWidget();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && chatOpen) closeChatWidget(); });

    function closeChatWidget() {
      chatOpen = false;
      document.getElementById('chat-iframe-container').classList.remove('open');
      document.getElementById('chat-fab').classList.remove('open');
      const visitWrapper = document.getElementById('visit-wrapper');
      if (visitWrapper) visitWrapper.style.display = '';
      if (window.innerWidth <= 480) {
        document.getElementById('chat-fab').style.display = 'flex';
      }
    }

    // Interceptar bot√≥n "atr√°s" del m√≥vil para cerrar el chat
    window.addEventListener('popstate', () => {
      if (chatOpen) closeChatWidget();
    });
  </script>
  <!-- ===== FIN CHAT WIDGET ===== -->
</body>
</html>
