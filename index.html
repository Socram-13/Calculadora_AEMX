<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/png" href="imagen_1.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü™™ Atlas Earth AEMX - GAMERTAG V2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700;800;900&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #7bc96a;
    --panel: #fffbf0;
    --panel2: #f5ead8;
    --border: #c8a96e;
    --glow: #F5A623;
    --glow2: #4CAF50;
    --gold: #F5A623;
    --epic: #9C27B0;
    --rare: #2196F3;
    --common: #4CAF50;
    --legendary: #FF9800;
    --text: #3E2A10;
    --text2: #7a5c30;
    --accent: #F5A623;
    --sky: #87CEEB;
    --sand: #F5ECD7;
    --sand-dark: #e0d0b0;
    --green-dark: #2d7a25;
    --red-game: #E53935;
    --blue-game: #1E88E5;
    --purple-game: #8E24AA;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #7bc96a url('outdoor-bg.webp') center top / cover scroll;
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    min-height: 100vh;
  }

  body.theme-original {
    background: #060b14 url('') !important;
  }

  html {
    overflow-x: hidden;
  }

  /* fondo tomado de outdoor-bg.webp */

  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 12px 16px 40px;
  }

  header {
    padding: 12px 0 12px;
  }

  .header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    background: linear-gradient(180deg, #7dd86a 0%, #55b845 100%);
    border: 4px solid #3d9932;
    border-radius: 20px;
    padding: 10px 16px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 6px 0 #1e5c19, 0 8px 20px rgba(0,0,0,0.25);
  }

  .header-bar::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 5px;
    background: linear-gradient(90deg, #F5A623, #FFD060, #4CAF50, #29B6F6, #F5A623);
    background-size: 200% 100%;
    animation: rainbowSlide 6s linear infinite;
    border-radius: 16px 16px 0 0;
  }

  @keyframes rainbowSlide {
    0% { background-position: 0% 0; }
    100% { background-position: 200% 0; }
  }

  .header-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
  }

  .aemx-logo-img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    border-radius: 0;
    filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
  }

  .header-left-label {
    font-family: 'Fredoka One', cursive;
    font-size: 8px;
    letter-spacing: 2px;
    color: rgba(255,255,255,0.8);
    text-transform: uppercase;
  }

  .header-center {
    flex: 1;
    text-align: center;
  }

  .header-title {
    font-family: 'Fredoka One', cursive;
    font-size: clamp(18px, 4vw, 34px);
    font-weight: 400;
    line-height: 1.1;
    letter-spacing: 1px;
    text-shadow: 2px 3px 0 rgba(0,0,0,0.2);
  }

  .header-title .atlas { color: #FFD060; }
  .header-title .earth { color: #FFD060; }
  .header-title .mexico { color: #fff; }
  .header-title .mexico .i { color: #ef4444; }

  .header-subtitle {
    font-family: 'Fredoka One', cursive;
    font-size: clamp(16px, 3vw, 24px);
    font-weight: 400;
    color: #fff;
    letter-spacing: 2px;
    margin-top: 4px;
    text-shadow: 2px 3px 0 rgba(0,0,0,0.2);
  }

  .header-tagline {
    font-size: 11px;
    color: rgba(255,255,255,0.7);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 6px;
  }

  .header-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
  }

  .atlas-logo-img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
  }

  .header-right-label {
    font-family: 'Fredoka One', cursive;
    font-size: 8px;
    letter-spacing: 2px;
    color: #FFD060;
    text-transform: uppercase;
  }

  @media (max-width: 480px) {
    .container { padding: 8px 8px 100px; }
    .header-bar { padding: 10px 10px; gap: 6px; }
    .aemx-logo-img, .atlas-logo-img { width: 44px; height: 44px; }
    .header-tagline { display: none; }
    .profile-section {
      flex-direction: column;
      align-items: center;
      padding: 12px 10px;
      gap: 10px;
    }
    .profile-avatar, .profile-avatar-placeholder { width: 90px; height: 90px; }
    .profile-info { width: 100%; text-align: center; }
    .profile-name-input { min-width: 0; width: 100%; font-size: 18px; text-align: center; }
    .donut-wrap { width: 90px; height: 90px; overflow: hidden; }
    .donut-wrap svg { width: 100% !important; height: 100% !important; }
    .card { padding: 10px; }
    .card-title { font-size: 11px; letter-spacing: 2px; }
    .parcel-row { gap: 6px; }
    .parcel-pct { font-size: 13px; min-width: 38px; }
    .counter-btn { width: 28px; height: 28px; font-size: 16px; }
    .counter-val { font-size: 18px; min-width: 36px; }
    .breakdown-label, .breakdown-value { font-size: 11px; }
    .results-card { padding: 12px 8px; }
    .medals-card { margin: 10px 0; }
    .medals-grid { gap: 8px; padding: 4px 12px 16px; }
    .results-title { font-size: 11px; letter-spacing: 2px; margin-bottom: 10px; }
    .results-table { font-size: 12px; }
    .results-table th { font-size: 8px; letter-spacing: 1px; padding: 6px 6px; }
    .results-table td { font-size: 12px; padding: 8px 6px; }
    .rt-period { font-size: 9px; letter-spacing: 1px; gap: 5px; }
    .rt-period .dot { width: 5px; height: 5px; }
    .rt-base { font-size: 11px; }
    .rt-boost { font-size: 12px; }
    .rt-boost.highlight { font-size: 14px; }
    .boost-badge { font-size: 10px; padding: 3px 8px; margin-left: 4px; }
    .breakdown-row { font-size: 11px; flex-wrap: wrap; gap: 2px; }
    .tier-info { flex-wrap: wrap; gap: 6px; padding: 8px; }
    .tier-label { font-size: 11px; }
    .tier-value { font-size: 11px; }
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
  }

  @media (max-width: 600px) {
    .grid { grid-template-columns: 1fr; }
  }

  .card {
    background: var(--panel);
    border: 3px solid var(--border);
    border-radius: 18px;
    padding: 14px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s, transform 0.2s;
    box-shadow: 0 5px 0 var(--sand-dark), 0 8px 16px rgba(0,0,0,0.15);
  }

  .card:hover {
    border-color: var(--gold);
    transform: translateY(-3px);
    box-shadow: 0 8px 0 var(--sand-dark), 0 10px 20px rgba(0,0,0,0.2);
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .card:hover::before { opacity: 1; }

  .card-title {
    font-family: 'Fredoka One', cursive;
    font-size: 15px;
    font-weight: 400;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 10px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .parcel-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .parcel-icon {
    width: 36px; height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .parcel-label {
    flex: 1;
    font-size: 14px;
    font-weight: 600;
  }

  .parcel-rate {
    font-family: 'Nunito', sans-serif; font-weight: 800;
    font-size: 10px;
    color: var(--text2);
    white-space: nowrap;
  }

  input[type="number"] {
    width: 80px;
    background: #fff;
    border: 3px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    font-size: 16px;
    font-weight: 800;
    padding: 8px 10px;
    text-align: center;
    transition: border-color 0.2s, box-shadow 0.2s;
    appearance: textfield;
    -moz-appearance: textfield;
    box-shadow: 0 3px 0 var(--sand-dark);
  }

  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
  }

  input[type="number"]:focus {
    outline: none;
    border-color: var(--gold);
    box-shadow: 0 3px 0 #c8851a, 0 0 0 3px rgba(245,166,35,0.2);
  }

  .common .parcel-icon { background: rgba(148,163,184,0.1); border: 1px solid rgba(148,163,184,0.3); color: var(--common); }
  .common .parcel-label { color: var(--common); }
  .rare .parcel-icon { background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3); color: var(--rare); }
  .rare .parcel-label { color: var(--rare); }
  .epic .parcel-icon { background: rgba(192,132,252,0.1); border: 1px solid rgba(192,132,252,0.3); color: var(--epic); }
  .epic .parcel-label { color: var(--epic); }
  .legendary .parcel-icon { background: rgba(255,140,66,0.1); border: 1px solid rgba(255,140,66,0.3); color: var(--legendary); }
  .legendary .parcel-label { color: var(--legendary); }

  .booster-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .booster-icon {
    font-size: 22px;
    width: 36px;
    text-align: center;
    flex-shrink: 0;
  }

  .booster-info { flex: 1; }
  .booster-name { font-size: 14px; font-weight: 600; }
  .booster-desc { font-size: 11px; color: var(--text2); margin-top: 2px; }

  .results-card {
    background: linear-gradient(180deg, #fffbf0 0%, #f5ead8 100%);
    border: 4px solid var(--gold);
    border-radius: 20px;
    padding: 18px;
    margin-top: 16px;
    box-shadow: 0 6px 0 #c8851a, 0 10px 24px rgba(0,0,0,0.15);
    overflow-x: hidden;
    width: 100%;
    box-sizing: border-box;
  }

  .results-title {
    font-family: 'Fredoka One', cursive;
    font-size: 18px;
    font-weight: 400;
    letter-spacing: 3px;
    color: var(--text);
    text-transform: uppercase;
    text-align: center;
    margin-bottom: 14px;
  }

  .results-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 24px;
    font-family: 'Nunito', sans-serif;
    table-layout: fixed;
    word-break: break-word;
  }

  .results-table thead tr {
    border-bottom: 2px solid var(--border);
  }

  .results-table th {
    font-family: 'Fredoka One', cursive;
    font-size: 11px;
    font-weight: 400;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
    padding: 8px 14px;
    text-align: left;
  }

  .results-table th:last-child,
  .results-table td:last-child { text-align: right; }

  .results-table td {
    padding: 10px 14px;
    font-size: 14px;
    font-weight: 700;
    border-bottom: 1px solid rgba(200,169,110,0.3);
    vertical-align: middle;
    color: var(--text);
  }

  .results-table tbody tr {
    transition: background 0.15s;
  }

  .results-table tbody tr:hover {
    background: rgba(245,166,35,0.06);
  }

  .results-table tbody tr:last-child td { border-bottom: none; }

  .rt-period {
    font-family: 'Fredoka One', cursive;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .rt-period .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--gold);
    flex-shrink: 0;
    box-shadow: 0 0 4px rgba(245,166,35,0.5);
  }

  .rt-base {
    color: var(--text2);
    font-size: 13px;
    font-weight: 700;
  }

  .rt-boost {
    color: #2d7a25;
    font-size: 15px;
    font-weight: 800;
  }

  .rt-boost.highlight {
    color: #2d7a25;
    font-size: 18px;
  }

  .breakdown {
    border-top: 2px solid var(--sand-dark);
    padding-top: 12px;
    margin-top: 4px;
  }

  .breakdown-title {
    font-family: 'Fredoka One', cursive;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .breakdown-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    font-weight: 700;
  }

  .donut-arrow {
    font-size: 26px;
    font-weight: 900;
    margin-right: 3px;
    line-height: 1;
  }
  .donut-arrow.up   { color: #2d7a25; }
  .donut-arrow.down { color: #c0392b; }

  .rarity-arrow {
    font-size: 11px;
    font-weight: 900;
    margin-right: 2px;
    line-height: 1;
  }
  .rarity-arrow.up   { color: #2d7a25; }
  .rarity-arrow.down { color: #c0392b; }

  .breakdown-label { color: var(--text2); }
  .breakdown-value {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    color: var(--text);
  }

  .breakdown-value.highlight { color: var(--gold); font-weight: 900; }

  .boost-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(245,166,35,0.15);
    border: 2px solid rgba(245,166,35,0.5);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 12px;
    font-weight: 800;
    color: #c8851a;
    margin-left: 8px;
  }

  .tier-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 16px;
    padding: 12px;
    background: rgba(245,166,35,0.08);
    border-radius: 12px;
    border: 2px dashed rgba(245,166,35,0.4);
  }

  .tier-label { font-size: 12px; color: var(--text2); font-weight: 700; }
  .tier-value {
    font-family: 'Fredoka One', cursive;
    font-size: 14px;
    font-weight: 400;
    color: var(--gold);
  }

  .divider {
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--sand-dark), transparent);
    margin: 4px 0 8px;
  }

  .full-card { grid-column: 1 / -1; }

  .total-parcels {
    text-align: center;
    margin-bottom: 8px;
    padding: 8px;
    background: rgba(245,166,35,0.06);
    border-radius: 12px;
  }

  .total-parcels .num {
    font-family: 'Fredoka One', cursive;
    font-size: 28px;
    font-weight: 400;
    color: var(--text);
  }

  .total-parcels .lbl {
    font-family: 'Fredoka One', cursive;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
  }

  .counter {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .counter-btn {
    width: 32px; height: 32px;
    border-radius: 10px;
    border: 3px solid var(--border);
    background: linear-gradient(180deg, #fff 0%, #f5ead8 100%);
    color: var(--text);
    font-size: 20px;
    font-weight: 900;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s, border-color 0.15s, transform 0.1s;
    flex-shrink: 0;
    line-height: 1;
    box-shadow: 0 3px 0 var(--sand-dark);
  }

  .counter-btn:hover {
    background: linear-gradient(180deg, #FFF8E1 0%, #FFE082 100%);
    border-color: var(--gold);
    transform: translateY(-1px);
  }
  .counter-btn:active { transform: translateY(1px); box-shadow: 0 1px 0 var(--sand-dark); }

  @keyframes pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .pop { animation: pop 0.2s ease; }

  @keyframes bouncePulse {
    0%, 100% { box-shadow: 0 6px 0 #c8851a, 0 8px 16px rgba(0,0,0,0.15); }
    50% { box-shadow: 0 8px 0 #c8851a, 0 12px 24px rgba(245,166,35,0.25); }
  }

  .results-card { animation: bouncePulse 4s ease-in-out infinite; }

  .diamond-row .booster-name { color: #1565C0; }

  .info {
    font-size: 10px;
    color: var(--text2);
    background: rgba(245,166,35,0.1);
    border: 1px solid rgba(245,166,35,0.3);
    border-radius: 8px;
    padding: 2px 6px;
    margin-left: 4px;
    font-weight: 700;
  }

  .coins-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    margin-top: 28px;
    padding: 14px 20px;
    background: linear-gradient(180deg, #fff8e1 0%, #ffeaa0 100%);
    border: 3px solid #F5A623;
    border-radius: 18px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
    box-shadow: 0 5px 0 #c8851a, 0 8px 16px rgba(0,0,0,0.1);
  }

  .coins-bar::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, #FFD060, transparent);
    opacity: 0.9;
  }

  .coins-icon {
    font-size: 28px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    animation: coinFloat 3s ease-in-out infinite;
    flex-shrink: 0;
  }

  @keyframes coinFloat {
    0%, 100% { transform: translateY(0) rotate(-5deg); }
    50%       { transform: translateY(-4px) rotate(5deg); }
  }

  .coins-info { text-align: left; }

  .coins-label {
    font-family: 'Fredoka One', cursive;
    font-size: 9px;
    letter-spacing: 2px;
    color: #c8851a;
    text-transform: uppercase;
    margin-bottom: 2px;
  }

  .coins-value {
    font-family: 'Fredoka One', cursive;
    font-size: 28px;
    font-weight: 400;
    color: #7a4a0a;
    line-height: 1;
    transition: transform 0.3s;
  }

  .coins-value.pop-coin {
    animation: coinPop 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97);
  }

  @keyframes coinPop {
    0%   { transform: scale(1); }
    30%  { transform: scale(1.4); }
    60%  { transform: scale(0.9); }
    100% { transform: scale(1); }
  }

  .coins-sub {
    font-family: 'Nunito', sans-serif;
    font-size: 10px;
    font-weight: 700;
    color: #c8851a;
    margin-top: 2px;
    letter-spacing: 1px;
  }

  .coins-status {
    font-family: 'Nunito', sans-serif;
    font-size: 11px;
    font-weight: 700;
    text-align: center;
    flex: 1;
  }

  .coins-status .earned {
    color: #2d7a25;
    animation: fadeInUp 0.4s ease;
  }

  .coins-status .waiting {
    color: rgba(200,133,26,0.6);
    letter-spacing: 1px;
  }

  .btn-checkin {
    font-family: 'Fredoka One', cursive;
    font-size: 13px;
    font-weight: 400;
    letter-spacing: 1px;
    padding: 12px 22px;
    border-radius: 14px;
    border: 3px solid #c8851a;
    background: linear-gradient(180deg, #FFD060 0%, #F5A623 100%);
    color: #7a4a0a;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
    box-shadow: 0 4px 0 #c8851a;
    text-transform: uppercase;
  }
  .btn-checkin:hover:not(:disabled) {
    background: linear-gradient(180deg, #FFE090 0%, #FFD060 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 0 #c8851a;
  }
  .btn-checkin:active:not(:disabled) {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #c8851a;
  }
  .btn-checkin:disabled {
    border-color: var(--sand-dark);
    color: var(--text2);
    background: var(--sand);
    cursor: not-allowed;
    box-shadow: 0 3px 0 var(--sand-dark);
    transform: none;
  }
  .btn-checkin.done {
    border-color: #2d7a25;
    color: #1e5c19;
    background: linear-gradient(180deg, #81C784 0%, #4CAF50 100%);
    box-shadow: 0 4px 0 #2d7a25;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .coin-toast {
    position: fixed;
    top: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: linear-gradient(180deg, #fff8e1 0%, #ffeaa0 100%);
    border: 3px solid #F5A623;
    border-radius: 50px;
    padding: 10px 24px;
    font-family: 'Fredoka One', cursive;
    font-size: 16px;
    font-weight: 400;
    color: #7a4a0a;
    letter-spacing: 1px;
    box-shadow: 0 5px 0 #c8851a, 0 8px 24px rgba(0,0,0,0.2);
    z-index: 99999;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events: none;
    white-space: nowrap;
  }

  .coin-toast.show {
    transform: translateX(-50%) translateY(0);
  }

  .save-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 12px;
    position: relative;
  }

  .btn-save {
    font-family: 'Fredoka One', cursive;
    font-size: 13px;
    font-weight: 400;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: #fff;
    background: linear-gradient(180deg, #66BB6A 0%, #43A047 100%);
    border: 3px solid #2d7a25;
    border-radius: 12px;
    padding: 10px 22px;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.15s, box-shadow 0.2s;
    box-shadow: 0 4px 0 #2d7a25;
  }

  .btn-save:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 6px 0 #2d7a25;
  }

  .btn-save:active { transform: translateY(2px); box-shadow: 0 2px 0 #2d7a25; }

  .save-status {
    font-family: 'Nunito', sans-serif;
    font-size: 12px;
    font-weight: 800;
    color: #2d7a25;
    opacity: 0;
    transition: opacity 0.4s;
    display: flex;
    align-items: center;
    gap: 6px;
    position: absolute;
    bottom: -24px;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
  }

  .save-status.visible { opacity: 1; }

  .btn-copy-link {
    font-family: 'Fredoka One', cursive;
    font-size: 12px;
    font-weight: 400;
    letter-spacing: 1px;
    color: #fff;
    background: linear-gradient(180deg, #42A5F5 0%, #1E88E5 100%);
    border: 3px solid #1565C0;
    border-radius: 10px;
    padding: 9px 16px;
    cursor: pointer;
    flex-shrink: 0;
    transition: opacity 0.2s, transform 0.15s;
    box-shadow: 0 3px 0 #1565C0;
  }

  .btn-copy-link:hover { opacity: 0.9; transform: translateY(-1px); }

  .profile-section {
    display: flex;
    align-items: center;
    gap: 12px;
    background: linear-gradient(180deg, #fffbf0 0%, #f5ead8 100%);
    border: 3px solid var(--border);
    border-radius: 20px;
    padding: 10px 16px 10px 16px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
    min-width: 0;
    box-shadow: 0 5px 0 var(--sand-dark), 0 8px 16px rgba(0,0,0,0.1);
  }

  .profile-section::before {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
  }

  .ppd-circle {
    position: absolute;
    bottom: 10px;
    left: 12px;
    width: 42px;
    height: 42px;
    background: var(--gold);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Fredoka One', cursive;
    font-size: 17px;
    font-weight: 400;
    color: #7a4a0a;
    box-shadow: 0 3px 0 #c8851a;
    z-index: 4;
    line-height: 1.1;
    text-align: center;
    cursor: default;
  }

  .profile-avatar-wrapper {
    position: relative;
    flex-shrink: 0;
    cursor: pointer;
    width: 142px;
    height: 142px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .profile-avatar-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: conic-gradient(var(--avatar-border-color, #F5A623), transparent 40%, var(--avatar-border-color, #F5A623));
    animation: spinBorder 2.5s linear infinite;
    z-index: 0;
  }

  .profile-avatar-wrapper::after {
    content: '';
    position: absolute;
    inset: 20px;
    border-radius: 50%;
    background: var(--panel);
    z-index: 1;
  }

  @keyframes spinBorder {
    0%   { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .profile-avatar {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    object-fit: cover;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: block;
    background: var(--sand);
    position: relative;
    z-index: 2;
  }

  .profile-avatar-placeholder {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    border: 3px dashed var(--border);
    background: var(--sand);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    gap: 4px;
    position: relative;
    z-index: 3;
  }

  .profile-avatar-placeholder:hover {
    border-color: var(--gold);
    background: rgba(245,166,35,0.1);
  }

  .profile-avatar-placeholder .upload-icon {
    font-size: 22px;
    opacity: 0.6;
  }

  .profile-avatar-placeholder .upload-label {
    font-family: 'Fredoka One', cursive;
    font-size: 9px;
    letter-spacing: 1px;
    color: var(--text2);
    text-transform: uppercase;
    text-align: center;
    line-height: 1.3;
  }

  .profile-avatar-color {
    position: absolute;
    bottom: 2px;
    left: 2px;
    width: 32px;
    height: 32px;
    background: var(--gold);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 2px 0 #c8851a;
    z-index: 3;
  }

  .profile-avatar-edit {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 32px;
    height: 32px;
    background: var(--gold);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #7a4a0a;
    cursor: pointer;
    box-shadow: 0 2px 0 #c8851a;
    display: none;
    z-index: 3;
  }

  .profile-info {
    flex: 1;
  }

  .profile-name-label {
    font-family: 'Fredoka One', cursive;
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .profile-name-input {
    font-family: 'Fredoka One', cursive;
    font-size: clamp(16px, 3vw, 24px);
    font-weight: 400;
    color: var(--text);
    background: transparent;
    border: none;
    border-bottom: 3px solid var(--border);
    outline: none;
    width: auto;
    min-width: min(280px, 100%);
    max-width: 100%;
    padding: 4px 2px;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: border-color 0.2s;
    caret-color: var(--gold);
  }

  .profile-name-input:focus {
    border-bottom-color: var(--gold);
  }

  .profile-name-input::placeholder {
    color: var(--text2);
    opacity: 0.5;
    font-size: 14px;
    letter-spacing: 1px;
  }

  #avatar-input { display: none; }

  .explorer-badge-inline {
    font-size: 22px;
    flex-shrink: 0;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
    animation: glowCompass 2s ease-in-out infinite;
  }

  @keyframes glowCompass {
    0%, 100% { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15)); }
    50%       { filter: drop-shadow(0 0 8px rgba(245,166,35,0.7)); }
  }

  .explorer-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 8px 12px;
    background: rgba(245,166,35,0.08);
    border: 2px solid rgba(245,166,35,0.3);
    border-radius: 14px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
  }

  .explorer-row:hover {
    background: rgba(245,166,35,0.15);
    border-color: rgba(245,166,35,0.5);
  }

  .explorer-checkbox {
    width: 24px; height: 24px;
    border-radius: 8px;
    border: 3px solid rgba(245,166,35,0.5);
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.2s, border-color 0.2s;
    font-size: 14px;
    color: #7a4a0a;
  }

  .explorer-checkbox.checked {
    background: var(--gold);
    border-color: #c8851a;
    box-shadow: 0 2px 0 #c8851a;
  }

  .explorer-info { flex: 1; }
  .explorer-name {
    font-family: 'Fredoka One', cursive;
    font-size: 14px;
    font-weight: 400;
    color: #c8851a;
  }
  .explorer-desc {
    font-size: 11px;
    font-weight: 700;
    color: var(--text2);
    margin-top: 2px;
  }

  .explorer-result {
    text-align: center;
  }

  .explorer-days {
    font-family: 'Fredoka One', cursive;
    font-size: 20px;
    font-weight: 400;
    color: #c8851a;
    line-height: 1;
  }

  .explorer-days-label {
    font-family: 'Fredoka One', cursive;
    font-size: 9px;
    color: var(--text2);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .dollar-box {
    margin-top: 8px;
    background: rgba(245,166,35,0.08);
    border: 2px solid rgba(245,166,35,0.3);
    border-radius: 14px;
    padding: 10px 8px;
  }

  .dollar-box-title {
    font-family: 'Fredoka One', cursive;
    font-size: 11px;
    letter-spacing: 2px;
    color: #c8851a;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dollar-box-title::before {
    content: '‚óà';
    color: var(--gold);
  }

  .dollar-time {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 0;
    flex-wrap: wrap;
  }

  .dollar-unit {
    text-align: center;
    padding: 0 8px;
    border-right: 1px solid rgba(250,204,21,0.15);
    flex: 1;
  }

  .dollar-unit:last-child { border-right: none; }

  .dollar-num {
    font-family: 'Fredoka One', cursive;
    font-size: clamp(16px, 3vw, 24px);
    font-weight: 400;
    color: #c8851a;
    line-height: 1;
  }

  .dollar-lbl {
    font-family: 'Fredoka One', cursive;
    font-size: 10px;
    letter-spacing: 1px;
    color: var(--text2);
    text-transform: uppercase;
    margin-top: 4px;
  }

  .dollar-note {
    text-align: center;
    font-size: 11px;
    font-weight: 700;
    color: var(--text2);
    margin-top: 14px;
    letter-spacing: 1px;
  }

  .dollar-note span {
    color: #c8851a;
    font-weight: 900;
  }

  .parcel-pct {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 15px;
    color: var(--text2);
    min-width: 44px;
    text-align: left;
    flex-shrink: 0;
    transition: color 0.3s;
    opacity: 0.4;
  }
  .common .parcel-pct.active  { color: #2d7a25; opacity: 1; }
  .rare .parcel-pct.active    { color: #1565C0; opacity: 1; }
  .epic .parcel-pct.active    { color: #6A1B9A; opacity: 1; }
  .legendary .parcel-pct.active { color: #c8851a; opacity: 1; }

  .profile-chart {
    flex-shrink: 0;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
  }

  .donut-legend {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .dl-item {
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0.35;
    transition: opacity 0.3s;
  }

  .dl-item.has-data { opacity: 1; }

  .dl-dot {
    width: 7px; height: 7px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .dl-letter {
    font-family: 'Fredoka One', cursive;
    font-size: 10px;
    font-weight: 400;
    letter-spacing: 1px;
    width: 10px;
  }

  .dl-pct {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 22px;
    min-width: 48px;
  }

  .donut-wrap {
    position: relative;
    width: 130px;
    height: 130px;
    flex-shrink: 0;
    overflow: hidden;
  }

  .donut-wrap svg {
    transform: rotate(-90deg);
  }

  @keyframes segSpinFwd {
    from { transform: rotate(0deg); }
    to   { transform: rotate(-360deg); }
  }
  @keyframes segSpinRev {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }

  .donut-center {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Fredoka One', cursive;
    font-size: 22px;
    font-weight: 400;
    color: var(--text);
    text-align: center;
    line-height: 1.2;
  }

  .donut-center span, #donut-center {
    border-radius: 8px;
    padding: 2px 8px;
  }

  .donut-crel {
    display: flex;
    gap: 6px;
    font-family: 'Fredoka One', cursive;
    font-size: 16px;
    font-weight: 400;
    letter-spacing: 2px;
  }

  @media print {
    @page { margin: 0; size: auto; }
    body { background: #f5ead8 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #visit-wrapper { display: none !important; }
    .container > p { display: none !important; }
    * { animation: none !important; transition: none !important; }
  }

  #chat-fab {
    position: fixed;
    bottom: 28px;
    right: 28px;
    z-index: 9998;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(180deg, #66BB6A 0%, #2E7D32 100%);
    border: 3px solid #1b5e20;
    cursor: pointer;
    box-shadow: 0 5px 0 #1b5e20, 0 8px 20px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  #chat-fab:hover {
    transform: scale(1.1) translateY(-2px);
    box-shadow: 0 7px 0 #1b5e20, 0 10px 24px rgba(0,0,0,0.35);
  }
  #chat-fab:active { transform: scale(0.95) translateY(2px); box-shadow: 0 3px 0 #1b5e20; }
  #chat-fab svg { width: 28px; height: 28px; fill: #fff; }
  #chat-fab.open svg.icon-chat { display: none; }
  #chat-fab.open svg.icon-close { display: block !important; }
  #chat-fab::before {
    content: 'CHAT';
    position: absolute;
    right: 74px;
    background: var(--panel);
    border: 2px solid var(--border);
    color: var(--text);
    font-family: 'Fredoka One', cursive;
    font-size: 12px;
    font-weight: 400;
    letter-spacing: 1px;
    padding: 6px 12px;
    border-radius: 12px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    box-shadow: 0 3px 0 var(--sand-dark);
  }
  #chat-fab:hover::before { opacity: 1; }
  #chat-fab.open::before { content: 'CERRAR'; }

  #chat-iframe-container {
    position: fixed;
    bottom: 100px;
    right: 28px;
    z-index: 9997;
    width: 380px;
    height: min(600px, calc(100dvh - 120px));
    border-radius: 20px;
    overflow: hidden;
    border: 3px solid var(--border);
    box-shadow: 0 8px 0 var(--sand-dark), 0 16px 40px rgba(0,0,0,0.25);
    transform: scale(0.85) translateY(20px);
    transform-origin: bottom right;
    opacity: 0;
    pointer-events: none;
    transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1), opacity 0.25s ease;
  }
  #chat-iframe-container.open {
    transform: scale(1) translateY(0);
    opacity: 1;
    pointer-events: all;
  }
  #chat-iframe-container iframe { width: 100%; height: 100%; border: none; display: block; }

  #chat-widget-bar {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 36px;
    background: linear-gradient(90deg, #5aba4e, #3d9932);
    border-bottom: 2px solid #2d7a25;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
    z-index: 1;
    pointer-events: none;
  }
  #chat-widget-bar span {
    font-family: 'Fredoka One', cursive;
    font-size: 11px;
    font-weight: 400;
    color: #fff;
    letter-spacing: 1px;
  }
  #chat-widget-bar .dots { display: flex; gap: 5px; }
  #chat-widget-bar .dot { width: 8px; height: 8px; border-radius: 50%; }
  #chat-widget-bar .dot:nth-child(1) { background: #ff5f57; }
  #chat-widget-bar .dot:nth-child(2) { background: #ffbd2e; }
  #chat-widget-bar .dot:nth-child(3) { background: #28c840; }

  @media (max-width: 480px) {
    #chat-widget-bar { display: none; }
    #chat-iframe-container {
      right: 0;
      bottom: 0;
      left: 0;
      top: auto;
      width: 100%;
      height: 75dvh;
      border-radius: 20px 20px 0 0;
      transform-origin: bottom center;
      border-left: none;
      border-right: none;
      border-bottom: none;
    }
    #chat-fab { bottom: 20px; right: 20px; }
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CARD DE MEDALLAS
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .medals-card {
    background: var(--panel);
    border: 3px solid var(--border);
    border-radius: 18px;
    overflow: hidden;
    margin-top: 10px;
    margin-bottom: 10px;
    transition: border-color 0.3s, transform 0.2s;
    position: relative;
    box-shadow: 0 5px 0 var(--sand-dark), 0 8px 16px rgba(0,0,0,0.1);
  }
  .medals-card:hover { border-color: var(--gold); }
  .medals-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }
  .medals-card:hover::before { opacity: 1; }

  .medals-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: none;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    min-height: 48px; /* tap target iOS */
  }
  .medals-toggle:hover { background: rgba(245,166,35,0.06); }
  .medals-toggle-left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

  .medals-title {
    font-family: 'Fredoka One', cursive;
    font-size: 15px;
    font-weight: 400;
    letter-spacing: 2px;
    color: var(--text);
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .medals-title-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--gold);
    flex-shrink: 0;
  }
  .medals-count {
    font-family: 'Fredoka One', cursive;
    font-size: 11px;
    color: #c8851a;
    letter-spacing: 1px;
    background: rgba(245,166,35,0.15);
    border: 2px solid rgba(245,166,35,0.4);
    border-radius: 8px;
    padding: 1px 8px;
  }
  .medals-arrow {
    font-size: 10px;
    color: var(--text2);
    transition: transform 0.3s ease;
  }
  .medals-toggle.open .medals-arrow { transform: rotate(180deg); }

  .medals-body {
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.35s ease;
  }
  .medals-body.open { max-height: 2400px; }

  .medals-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 4px 18px 20px;
  }

  .medals-section-label {
    width: 100%;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 2px dashed rgba(200,169,110,0.5);
    font-family: 'Fredoka One', cursive;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
  }

  .mbadge {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    position: relative;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  .mbadge-icon {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    border: 2px solid;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 3px 0;
  }
  .mbadge-icon::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 60%);
    pointer-events: none;
  }
  .mbadge:hover .mbadge-icon { transform: translateY(-4px); filter: brightness(1.1); }
  .mbadge-name {
    font-family: 'Nunito', sans-serif;
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 0.5px;
    text-align: center;
    color: var(--text2);
    max-width: 66px;
    line-height: 1.2;
  }

  .mbadge.m-common   .mbadge-icon { background: rgba(76,175,80,0.15);  border-color: rgba(76,175,80,0.5);  box-shadow: 0 3px 0 rgba(76,175,80,0.4); }
  .mbadge.m-rare     .mbadge-icon { background: rgba(33,150,243,0.15);  border-color: rgba(33,150,243,0.5);  box-shadow: 0 3px 0 rgba(33,150,243,0.4); }
  .mbadge.m-epic     .mbadge-icon { background: rgba(156,39,176,0.15); border-color: rgba(156,39,176,0.5); box-shadow: 0 3px 0 rgba(156,39,176,0.4); }
  .mbadge.m-legendary .mbadge-icon { background: rgba(245,166,35,0.15);  border-color: rgba(245,166,35,0.5);  box-shadow: 0 3px 0 rgba(245,166,35,0.4); animation: mLegendaryGlow 2s ease-in-out infinite; }
  .mbadge.m-coins    .mbadge-icon { background: rgba(255,152,0,0.15); border-color: rgba(255,152,0,0.5); box-shadow: 0 3px 0 rgba(255,152,0,0.4); }

  @keyframes mLegendaryGlow {
    0%, 100% { box-shadow: 0 3px 0 rgba(245,166,35,0.4); }
    50%       { box-shadow: 0 5px 0 rgba(245,166,35,0.6), 0 0 20px rgba(245,166,35,0.3); }
  }

  .mbadge-tooltip {
    position: absolute;
    bottom: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 8px 12px;
    width: 170px;
    text-align: center;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 10;
    box-shadow: 0 4px 0 var(--sand-dark);
  }
  .mbadge:hover .mbadge-tooltip { opacity: 1; }
  .mbadge-tooltip-name { font-family: 'Fredoka One', cursive; font-size: 11px; letter-spacing: 1px; color: var(--text); margin-bottom: 4px; }
  .mbadge-tooltip-desc { font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 11px; color: var(--text2); line-height: 1.25; }
  .mbadge-tooltip-cost { margin-top: 6px; font-family: 'Fredoka One', cursive; font-size: 11px; color: #c8851a; }

  /* Medallas regulares bloqueadas */
  .mbadge.m-locked { display: none !important; }
  .mbadge.m-coins.m-locked { display: none !important; }

  /* ‚îÄ‚îÄ Modal de medalla ‚îÄ‚îÄ */
  .medal-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    backdrop-filter: blur(3px);
    -webkit-backdrop-filter: blur(3px);
  }
  .medal-modal-overlay.open {
    opacity: 1;
    pointer-events: auto;
  }
  .medal-modal {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%) translateY(100%);
    width: 100%;
    max-width: 480px;
    background: var(--panel);
    border: 3px solid var(--border);
    border-bottom: none;
    border-radius: 24px 24px 0 0;
    padding: 20px 24px calc(28px + env(safe-area-inset-bottom, 0px));
    z-index: 10001;
    transition: transform 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);
    box-shadow: 0 -6px 0 var(--sand-dark), 0 -12px 40px rgba(0,0,0,0.2);
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    max-height: 85vh;
    overflow-y: auto;
  }
  .medal-modal.open {
    transform: translateX(-50%) translateY(0);
  }
  .medal-modal-handle {
    width: 40px;
    height: 5px;
    background: var(--sand-dark);
    border-radius: 3px;
    margin: 0 auto 18px;
    flex-shrink: 0;
  }
  .medal-modal-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }
  .medal-modal-icon {
    width: 64px;
    height: 64px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    border: 2px solid;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 0;
  }
  .medal-modal-icon::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 60%);
  }
  .medal-modal-info { flex: 1; min-width: 0; }
  .medal-modal-name {
    font-family: 'Fredoka One', cursive;
    font-size: 15px;
    font-weight: 400;
    letter-spacing: 1px;
    color: var(--text);
    margin-bottom: 6px;
    word-break: break-word;
  }
  .medal-modal-rarity {
    font-family: 'Fredoka One', cursive;
    font-size: 10px;
    letter-spacing: 2px;
    padding: 2px 10px;
    border-radius: 8px;
    border: 2px solid;
    display: inline-block;
  }
  .medal-modal-divider {
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
    margin: 14px 0;
  }
  .medal-modal-section-label {
    font-family: 'Fredoka One', cursive;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--text2);
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .medal-modal-desc {
    font-family: 'Nunito', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.4;
    margin-bottom: 14px;
  }
  .medal-modal-status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-family: 'Fredoka One', cursive;
    font-size: 11px;
    letter-spacing: 1px;
    padding: 8px 16px;
    border-radius: 12px;
    border: 2px solid;
    box-shadow: 0 3px 0;
  }
  .medal-modal-status.earned {
    color: #2d7a25;
    border-color: rgba(45,122,37,0.5);
    background: rgba(76,175,80,0.1);
    box-shadow: 0 3px 0 rgba(45,122,37,0.3);
  }
  .medal-modal-status.locked {
    color: var(--text2);
    border-color: rgba(200,169,110,0.5);
    background: rgba(200,169,110,0.08);
    box-shadow: 0 3px 0 rgba(200,169,110,0.3);
  }
  .medal-modal-cost {
    margin-top: 10px;
    font-family: 'Fredoka One', cursive;
    font-size: 13px;
    color: #c8851a;
    letter-spacing: 1px;
  }
  .mbadge.m-coins.m-owned .mbadge-icon { border-color: rgba(45,122,37,0.7); box-shadow: 0 3px 0 rgba(45,122,37,0.4); filter: none; }
  .mbadge.m-coins.m-owned::after {
    content: '‚úî';
    position: absolute;
    top: -6px; right: -6px;
    width: 18px; height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(76,175,80,0.9);
    color: #3E2A10;
    font-family: 'Fredoka One', cursive;
    font-size: 10px;
    box-shadow: 0 0 10px rgba(74,222,128,0.35);
  }

  /* ‚îÄ‚îÄ Bot√≥n comprar ‚îÄ‚îÄ */
  .mbadge-buy-btn {
    margin-top: 2px;
    font-family: 'Fredoka One', cursive;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1px;
    color: #ffaa00;
    background: rgba(255,170,0,0.12);
    border: 1px solid rgba(255,170,0,0.45);
    border-radius: 6px;
    padding: 6px 10px;                  /* m√≠nimo 44px alto en total con el badge */
    min-height: 28px;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    white-space: nowrap;
    touch-action: manipulation;         /* evita zoom al doble-tap en iOS */
    -webkit-tap-highlight-color: transparent;
  }
  .mbadge-buy-btn:hover {
    background: rgba(255,170,0,0.28);
    transform: scale(1.05);
  }
  .mbadge-buy-btn:active { transform: scale(0.97); }
  .mbadge.m-coins.m-owned .mbadge-buy-btn {
    color: #4ade80;
    background: rgba(74,222,128,0.1);
    border-color: rgba(74,222,128,0.4);
    cursor: default;
    pointer-events: none;
  }
  /* Suprimir tooltips en m√≥vil (hover no funciona en touch) */
  @media (hover: none) {
    .mbadge-tooltip { display: none !important; }
    .mbadge:hover .mbadge-icon { transform: none; filter: none; }
    .medals-card:hover { border-color: var(--border); transform: none; }
    .medals-card:hover::before { opacity: 0; }
  }

  /* Ajustes extra para pantallas muy peque√±as (< 360px, algunos Android) */
  @media (max-width: 360px) {
    .medals-grid { gap: 8px; padding: 4px 10px 16px; }
    .mbadge-icon { width: 44px; height: 44px; font-size: 20px; border-radius: 10px; }
    .mbadge-name { font-size: 9px; max-width: 56px; }
    .mbadge-buy-btn { font-size: 7px; padding: 4px 6px; }
    .medal-modal { padding: 16px 16px calc(24px + env(safe-area-inset-bottom, 0px)); }
    .medal-modal-icon { width: 52px; height: 52px; font-size: 24px; }
    .medal-modal-name { font-size: 11px; }
  }

  /* ‚îÄ‚îÄ Preview fila de medallas (secci√≥n comprimida) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .medals-preview-row {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 0 18px 10px;
    overflow: hidden;
    flex-wrap: nowrap;
  }
  .medals-body.open .medals-preview-row { display: none; }

  .mprev {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    width: 36px;
    flex-shrink: 0;
  }
  .mprev-icon {
    width: 28px; height: 28px;
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    border: 1.5px solid transparent;
    overflow: hidden;
    flex-shrink: 0;
  }
  .mprev-icon img {
    width: 100%; height: 100%;
    object-fit: contain;
    display: block;
    border-radius: 5px;
  }
  .mprev-name {
    font-family: 'Fredoka One', cursive;
    font-size: 5px;
    font-weight: 700;
    letter-spacing: 0.5px;
    color: var(--text2);
    text-align: center;
    text-transform: uppercase;
    line-height: 1.2;
    max-width: 36px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .mprev.legendary .mprev-icon { background: rgba(255,215,0,0.12); border-color: rgba(255,215,0,0.5); animation: mLegendaryGlow 2s ease-in-out infinite; }
  .mprev.epic      .mprev-icon { background: rgba(192,132,252,0.12); border-color: rgba(192,132,252,0.5); }
  .mprev.rare      .mprev-icon { background: rgba(96,165,250,0.12); border-color: rgba(96,165,250,0.5); }
  .mprev.common    .mprev-icon { background: rgba(74,222,128,0.12); border-color: rgba(74,222,128,0.5); }
  .mprev.coins     .mprev-icon { background: rgba(255,170,0,0.12); border-color: rgba(255,170,0,0.5); }

  .mprev-more {
    width: 28px; height: 28px;
    border-radius: 7px;
    background: rgba(245,166,35,0.08);
    border: 1.5px dashed rgba(245,166,35,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Fredoka One', cursive;
    font-size: 7px;
    color: var(--text2);
    flex-shrink: 0;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TEMA ORIGINAL (CYBERPUNK/SCI-FI)
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  body.theme-original {
    --bg: #060b14;
    --panel: #0b1626;
    --panel2: #0f1e35;
    --border: #1a3a5c;
    --glow: #00c8ff;
    --glow2: #00ff9d;
    --gold: #ffd700;
    --epic: #c084fc;
    --rare: #60a5fa;
    --common: #4ade80;
    --legendary: #facc15;
    --text: #cce4ff;
    --text2: #6b8ab0;
    --accent: #00c8ff;
    --sand: #0b1626;
    --sand-dark: #1a3a5c;
    font-family: 'Orbitron', monospace !important;
  }

  body.theme-original .card,
  body.theme-original .profile-section,
  body.theme-original .results-card,
  body.theme-original .medals-card,
  body.theme-original .coins-bar,
  body.theme-original .medal-modal {
    background: var(--panel) !important;
    border-color: var(--border) !important;
    box-shadow: 0 0 20px rgba(0,200,255,0.08) !important;
  }

  body.theme-original .header-bar {
    background: linear-gradient(135deg, #0b1f3a 0%, #060f1e 100%) !important;
    border-color: var(--border) !important;
    box-shadow: none !important;
  }

  body.theme-original .results-card {
    background: linear-gradient(135deg, #0a1f38 0%, #060f1e 100%) !important;
    border-color: var(--glow) !important;
  }

  body.theme-original .btn-save {
    background: linear-gradient(135deg, #00c8ff, #4ade80) !important;
    border-color: transparent !important;
    color: #000 !important;
    box-shadow: 0 0 20px rgba(0,200,255,0.35) !important;
  }

  body.theme-original .btn-checkin {
    background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,180,0,0.1)) !important;
    border-color: #ffd700 !important;
    color: #ffd700 !important;
    box-shadow: 0 0 12px rgba(255,215,0,0.15) !important;
  }

  body.theme-original .coins-bar {
    background: linear-gradient(135deg, #1a1200 0%, #0d0b00 100%) !important;
    border-color: rgba(255,215,0,0.35) !important;
    box-shadow: none !important;
  }

  body.theme-original input[type="number"] {
    background: #060b14 !important;
    border-color: var(--border) !important;
    color: white !important;
    box-shadow: none !important;
  }

  body.theme-original .card-title,
  body.theme-original .results-title,
  body.theme-original .medals-title,
  body.theme-original .header-title .atlas,
  body.theme-original .header-title .earth {
    color: var(--glow) !important;
    font-family: 'Orbitron', monospace !important;
  }

  body.theme-original .header-bar::before {
    background: linear-gradient(90deg, #00c8ff, #4ade80, #facc15, #c084fc, #00c8ff) !important;
  }

  /* ‚ïê‚ïê Bot√≥n de cambio de tema ‚ïê‚ïê */
  #theme-toggle-btn {
    position: fixed;
    bottom: 100px;
    right: 28px;
    z-index: 9999;
    width: 54px;
    height: 54px;
    border-radius: 50%;
    border: 3px solid #c8851a;
    background: linear-gradient(180deg, #FFD060 0%, #F5A623 100%);
    box-shadow: 0 4px 0 #c8851a, 0 6px 16px rgba(0,0,0,0.25);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    transition: transform 0.2s, box-shadow 0.2s;
    title: "Cambiar tema";
  }
  #theme-toggle-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 0 #c8851a, 0 8px 20px rgba(0,0,0,0.3);
  }
  #theme-toggle-btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #c8851a;
  }
  body.theme-original #theme-toggle-btn {
    background: linear-gradient(135deg, #00c8ff, #4ade80) !important;
    border-color: #007a99 !important;
    box-shadow: 0 0 16px rgba(0,200,255,0.5) !important;
  }

  #theme-toggle-tooltip {
    position: fixed;
    bottom: 162px;
    right: 22px;
    z-index: 9999;
    background: var(--panel);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 5px 10px;
    font-family: 'Fredoka One', cursive;
    font-size: 11px;
    color: var(--text);
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    box-shadow: 0 3px 0 var(--sand-dark);
  }
  #theme-toggle-btn:hover + #theme-toggle-tooltip { opacity: 1; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- ===== FIREBASE SDK ===== -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged, browserLocalPersistence, setPersistence }
      from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getDatabase, ref, set, get, update, onValue }
      from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB-xx2PlBjvnHe0K7Bf1MspVqUlfjky0mk",
      authDomain: "aemx-chat.firebaseapp.com",
      databaseURL: "https://aemx-chat-default-rtdb.firebaseio.com",
      projectId: "aemx-chat",
      storageBucket: "aemx-chat.appspot.com",
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    const provider = new GoogleAuthProvider();

    setPersistence(auth, browserLocalPersistence).catch(console.warn);

    window._fbAuth     = auth;
    window._fbDb       = db;
    window._fbRef      = ref;
    window._fbSet      = set;
    window._fbGet      = get;
    window._fbUpdate   = update;
    window._fbOnValue  = onValue;
    window._fbSignIn   = () => signInWithPopup(auth, provider);
    window._fbSignOut  = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        window._fbUser = user;
        renderAuthUI(user);
        setTimeout(() => syncFromFirebase(user.uid), 300);
      } else {
        window._fbUser = null;
        renderAuthUI(null);
        const coinsBar = document.getElementById('coins-bar');
        if (coinsBar) coinsBar.style.display = 'none';
      }
    });

    function renderAuthUI(user) {
      const btn = document.getElementById('google-auth-btn');
      const info = document.getElementById('google-user-info');
      if (!btn) return;
      if (user) {
        btn.textContent = 'Cerrar sesi√≥n';
        btn.title = `Sesi√≥n: ${user.displayName}`;
        if (info) {
          info.innerHTML = `<img src="${user.photoURL}" style="width:22px;height:22px;border-radius:50%;vertical-align:middle;margin-right:6px;">${user.displayName.split(' ')[0]}`;
          info.style.display = 'flex';
        }
      } else {
        btn.textContent = 'üîë Iniciar con Google';
        btn.title = '';
        if (info) info.style.display = 'none';
      }
    }

    async function syncFromFirebase(uid) {
      try {
        const snap = await get(ref(db, `users/${uid}`));
        if (!snap.exists()) {
          if (window._fbSaveAll) setTimeout(window._fbSaveAll, 500);
          return;
        }
        const d = snap.val();

        if (d.username) { document.getElementById('username').value = d.username; if(window.adjustBadge) window.adjustBadge(); }
        // ‚úÖ FIX: solo cargar avatar si existe y no est√° vac√≠o
        if (d.avatar && d.avatar.length > 0) {
          const img = document.getElementById('avatar-img');
          const ph  = document.getElementById('avatar-placeholder');
          const eb  = document.getElementById('avatar-edit');
          img.src = d.avatar; img.style.display='block';
          if(ph) ph.style.display='none';
          if(eb) eb.style.display='none';
          localStorage.setItem('atlas-avatar', d.avatar);
        }
        if (d.borderColor) {
          localStorage.setItem('atlas-avatar-border', d.borderColor);
          document.getElementById('avatar-border-color').value = d.borderColor;
          const prev = document.getElementById('color-preview');
          if(prev) prev.style.background = d.borderColor;
          const applyBorder = (color) => {
            if (window.applyThemeColor) {
              window.applyThemeColor(color);
            } else {
              let tries = 0;
              const interval = setInterval(() => {
                tries++;
                if (window.applyThemeColor) {
                  window.applyThemeColor(color);
                  clearInterval(interval);
                } else if (tries > 30) {
                  clearInterval(interval);
                }
              }, 100);
            }
          };
          applyBorder(d.borderColor);
        }
        if (d.startDate) { document.getElementById('start-date').value = d.startDate; }
        if (d.country) {
          userCountry = d.country; window.userCountry = d.country;
          const spanMx = document.querySelector('.mexico');
          if (spanMx) { spanMx.textContent = d.country.toUpperCase(); spanMx.style.color = '#7EC8E3'; }
          const elLoc = document.getElementById('user-location');
          if (elLoc) elLoc.textContent = (d.city || d.country).toUpperCase();
        }

        ['common','rare','epic','legendary','badges','diamonds','atlasbucks'].forEach(k => {
          if (d[k] !== undefined) { document.getElementById(k).value = d[k]; }
        });

        if(window.calc) window.calc();
        window.clanMember = d.clanMember === true;

        const waitCoins = setInterval(() => {
          if (window._coinsLoad) {
            clearInterval(waitCoins);
            window._coinsLoad(uid, d);
          }
        }, 100);
        setTimeout(() => clearInterval(waitCoins), 5000);
      } catch(e) { console.warn('Firebase sync error:', e); }
    }

    // ‚úÖ FIX PRINCIPAL: _fbSaveAll ahora siempre incluye el avatar desde localStorage
    window._fbSaveAll = async function() {
      const user = window._fbUser;
      if (!user) return;

      // Leer el avatar directamente de localStorage en el momento de guardar
      const avatarData = localStorage.getItem('atlas-avatar') || '';

      const data = {
        username:    document.getElementById('username')?.value    || '',
        avatar:      avatarData,
        borderColor: localStorage.getItem('atlas-avatar-border')   || '',
        startDate:   document.getElementById('start-date')?.value  || '',
        common:      document.getElementById('common')?.value      || 0,
        rare:        document.getElementById('rare')?.value        || 0,
        epic:        document.getElementById('epic')?.value        || 0,
        legendary:   document.getElementById('legendary')?.value   || 0,
        badges:      document.getElementById('badges')?.value      || 0,
        diamonds:    document.getElementById('diamonds')?.value    || 0,
        atlasbucks:  document.getElementById('atlasbucks')?.value  || 0,
      };
      try {
        const snap = await get(ref(db, `users/${user.uid}`));
        if (snap.exists()) {
          const prev = snap.val();
          if (prev.country)        data.country        = prev.country;
          else if (window.userCountry) data.country    = window.userCountry;
          if (prev.city)           data.city           = prev.city;
          if (prev.countryHistory) data.countryHistory = prev.countryHistory;
          data.clanMember        = prev.clanMember        === true;
          data.bannedChat        = prev.bannedChat        === true;
          data.bannedLeaderboard = prev.bannedLeaderboard === true;
          data.role              = prev.role              || '';
          const parcelasChanged =
            String(data.common)    !== String(prev.common    || 0) ||
            String(data.rare)      !== String(prev.rare      || 0) ||
            String(data.epic)      !== String(prev.epic      || 0) ||
            String(data.legendary) !== String(prev.legendary || 0);
          data.updatedAt = parcelasChanged ? Date.now() : (prev.updatedAt || null);
        } else {
          data.updatedAt = Date.now();
          if (window.userCountry) data.country = window.userCountry;
          data.clanMember        = false;
          data.bannedChat        = false;
          data.bannedLeaderboard = false;
          data.role              = '';
        }
        await update(ref(db, `users/${user.uid}`), data);
      } catch(e) { console.warn('Firebase save error:', e); }
    };

    window._fbSaveCity = async function(cityText) {
      const user = window._fbUser;
      if (!user || !cityText) return;
      try {
        await update(ref(db, `users/${user.uid}`), { city: cityText });
      } catch(e) { console.warn('Firebase city error:', e); }
    };

    window._fbSaveCountry = async function(newCountry) {
      const user = window._fbUser;
      if (!user || !newCountry) return;
      try {
        const snap = await get(ref(db, `users/${user.uid}/country`));
        const prev = snap.exists() ? snap.val() : null;
        if (prev === newCountry) return;
        const updates = { country: newCountry };
        if (prev) {
          const histSnap = await get(ref(db, `users/${user.uid}/countryHistory`));
          const history  = histSnap.exists() ? histSnap.val() : [];
          history.push({ from: prev, to: newCountry, date: Date.now() });
          updates.countryHistory = history;
        }
        await update(ref(db, `users/${user.uid}`), updates);
      } catch(e) { console.warn('Firebase country error:', e); }
    };

    document.addEventListener('DOMContentLoaded', () => {
      ['common','rare','epic','legendary','badges','diamonds','atlasbucks','start-date','username'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', () => { if(window._fbUser) window._fbSaveAll(); });
      });
    });
  </script>
  <!-- ===== FIN FIREBASE SDK ===== -->
</head>
<body>

<!-- ‚ïê‚ïê BOT√ìN CAMBIO DE TEMA ‚ïê‚ïê -->
<button id="theme-toggle-btn" onclick="toggleTheme()" title="Cambiar tema">üé®</button>
<div id="theme-toggle-tooltip">Cambiar tema</div>

<script>
  (function() {
    const saved = localStorage.getItem('aemx-theme');
    if (saved === 'original') document.body.classList.add('theme-original');
    const btn = document.getElementById('theme-toggle-btn');
    if (btn) btn.textContent = saved === 'original' ? 'üåø' : 'üé®';
  })();
  function toggleTheme() {
    const isOriginal = document.body.classList.toggle('theme-original');
    localStorage.setItem('aemx-theme', isOriginal ? 'original' : 'atlas');
    document.getElementById('theme-toggle-btn').textContent = isOriginal ? 'üåø' : 'üé®';
  }
</script>
<div class="container">
  <header>
    <div class="header-bar">
      <div class="header-left">
        <img src="imagen_2.png" alt="AEMX" class="aemx-logo-img">
        <div class="header-left-label">Comunidad</div>
      </div>

      <div class="header-center">
        <div class="header-title">
          <span class="atlas">ATLAS </span><span class="earth">EARTH </span><span class="mexico">M√âXICO</span>
        </div>
        <div class="header-subtitle">GAMERTAG</div>
        <div class="header-tagline">Calcula tus ganancias pasivas</div>
      </div>

      <div class="header-right">
        <img src="imagen_3.png" alt="Atlas Earth M√©xico" class="atlas-logo-img">
        <div class="header-right-label">Atlas Earth AEMX</div>
      </div>
    </div>
  </header>

  <div class="profile-section">
    <label for="avatar-input" style="display:none;" id="avatar-label"></label>
    <input type="file" id="avatar-input" accept="image/*" onchange="loadAvatar(event)" style="display:none;">
    <input type="color" id="avatar-border-color" value="#00c8ff" oninput="changeAvatarBorder(this.value)" style="display:none;">
    <div class="profile-avatar-wrapper" id="avatar-wrapper" onmouseenter="showAvatarButtons()" onmouseleave="hideAvatarButtons()">
      <div class="profile-avatar-placeholder" id="avatar-placeholder">
        <span class="upload-icon">üë§</span>
        <span class="upload-label">Foto de<br>perfil</span>
      </div>
      <img id="avatar-img" class="profile-avatar" src="" alt="avatar" style="display:none;">
      <div class="profile-avatar-edit" id="avatar-edit">‚úé</div>
      <div class="profile-avatar-color" id="avatar-color-btn">üé®</div>
    </div>
    <div class="profile-info">
      <div class="profile-name-label">Nombre de usuario</div>
      <div style="display:flex;align-items:center;gap:0;flex-wrap:nowrap;">
        <input
          type="text"
          id="username"
          class="profile-name-input"
          placeholder="Tu nombre aqu√≠"
          maxlength="35"
          oninput="this.value=this.value.toUpperCase(); saveUsername(); adjustBadge();"
          style="width:auto;min-width:60px;flex:0 1 auto;text-transform:uppercase;"
        >
        <div class="explorer-badge-inline" id="explorer-badge" style="display:none;margin-left:8px;flex-shrink:0;">üß≠</div>
      </div>
      <div class="profile-hint" style="font-size:9px;">Toca el avatar para cambiar foto</div>
      <span id="color-preview" style="display:none;"></span>
      <div style="margin-top:6px;display:flex;align-items:center;justify-content:center;gap:4px;font-family:'Nunito',sans-serif;font-weight:800;font-size:11px;color:var(--text2);letter-spacing:1px;">
        <span style="opacity:0.5;">JUGANDO DESDE¬∑</span>
        <input
          type="date"
          id="start-date"
          onchange="saveStartDate()"
          style="
            font-family:'Nunito',sans-serif;font-weight:800;
            font-size:11px;
            color:var(--text2);
            letter-spacing:1px;
            background:transparent;
            border:none;
            outline:none;
            padding:0;
            cursor:pointer;
            color-scheme:dark;
            width:auto;
          "
        >
      </div>
      <div style="margin-top:8px;">
        <div style="display:inline-flex;justify-content:center;align-items:center;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;color:var(--text2);letter-spacing:1px;">
          <span id="cl-year">‚Äî</span><span>¬∑</span><span id="cl-month">‚Äî</span><span>¬∑</span><span id="cl-day">‚Äî</span><span style="margin:0 5px;opacity:0.4;">|</span><span id="cl-hour">‚Äî</span><span>:</span><span id="cl-min">‚Äî</span><span>:</span><span id="cl-sec" style="color:var(--gold);">‚Äî</span><span style="margin:0 5px;opacity:0.4;">¬∑</span><span style="font-family:'Fredoka One',cursive;font-size:11px;font-weight:700;color:var(--text2);text-shadow:none;">SOL <span id="aemx-sol">‚Äî</span> MX</span>
        </div>
      </div>
      <div style="margin-top:6px;">
        <div style="display:inline-flex;align-items:center;gap:6px;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;color:var(--text2);letter-spacing:1px;">
          <span style="color:var(--gold);font-size:11px;">üìç</span>
          <span id="user-location" style="color:#fff;font-weight:700;text-transform:uppercase;">‚Äî</span>
        </div>
      </div>
    </div>

    <div class="ppd-circle" id="ppd-circle">‚Äî</div>

    <div class="profile-chart">
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:22px;font-weight:700;color:#2d7a25;" id="donut-pct-c"><span class="donut-arrow" id="donut-arrow-c"></span>0%</div>
        <div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:22px;font-weight:700;color:#1565C0;" id="donut-pct-r"><span class="donut-arrow" id="donut-arrow-r"></span>0%</div>
        <div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:22px;font-weight:700;color:#6A1B9A;" id="donut-pct-e"><span class="donut-arrow" id="donut-arrow-e"></span>0%</div>
        <div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:22px;font-weight:700;color:#c8851a;" id="donut-pct-l"><span class="donut-arrow" id="donut-arrow-l"></span>0%</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:5px;">
        <div class="donut-wrap">
          <svg width="100%" height="100%" viewBox="-10 -10 120 120" id="donut-svg">
            <circle id="donut-bg-circle" cx="50" cy="50" r="28" fill="none" stroke="#1a3a5c" stroke-width="30"/>
          </svg>
          <div class="donut-center" id="donut-center">‚Äî</div>
        </div>
        <div class="donut-crel">
          <span style="color:#2d7a25">C.</span>
          <span style="color:#1565C0">R.</span>
          <span style="color:#6A1B9A">E.</span>
          <span style="color:#c8851a">L.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CARD DE MEDALLAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="medals-card">
    <button class="medals-toggle" id="medalsToggle" onclick="toggleMedals()">
      <div class="medals-toggle-left">
        <span class="medals-title">
          <span class="medals-title-dot"></span>
          üéñÔ∏è Medallas
        </span>
        <span class="medals-count" id="medalsCount">41 / 41</span>
      </div>
      <span class="medals-arrow">‚ñº</span>
    </button>

    <div class="medals-preview-row" id="medalsPreviewRow"></div>
    <div class="medals-body" id="medalsBody">
      <div class="medals-grid" id="medalsGrid">
        <div class="medals-section-label">üü¢ COMUNES</div>

        <div class="mbadge m-common" data-medal-id="explorador">
          <div class="mbadge-icon">üó∫Ô∏è
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">EXPLORADOR</div><div class="mbadge-tooltip-desc">Diste el primer paso: obt√©n 1 parcela.</div></div>
          </div>
          <div class="mbadge-name">Explorador</div>
        </div>

        <div class="mbadge m-common" data-medal-id="sembrador">
          <div class="mbadge-icon">üå±
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">SEMBRADOR</div><div class="mbadge-tooltip-desc">Empiezas a construir tu imperio: 25 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Sembrador</div>
        </div>

        <div class="mbadge m-common" data-medal-id="colono">
          <div class="mbadge-icon">üèòÔ∏è
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">COLONO</div><div class="mbadge-tooltip-desc">Tu territorio ya se nota: 50 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Colono</div>
        </div>

        <div class="mbadge m-common" data-medal-id="ubicado">
          <div class="mbadge-icon">üìç
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">UBICADO</div><div class="mbadge-tooltip-desc">Comparte tu ubicaci√≥n para aparecer en el mapa.</div></div>
          </div>
          <div class="mbadge-name">Ubicado</div>
        </div>

        <div class="mbadge m-common" data-medal-id="mexicano">
          <div class="mbadge-icon">üá≤üáΩ
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">MEXICANO</div><div class="mbadge-tooltip-desc">Pa√≠s configurado como M√©xico.</div></div>
          </div>
          <div class="mbadge-name">Mexicano</div>
        </div>

        <div class="mbadge m-common" data-medal-id="ahorrador">
          <div class="mbadge-icon">üí∞
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">AHORRADOR</div><div class="mbadge-tooltip-desc">Acumula 50 coins.</div></div>
          </div>
          <div class="mbadge-name">Ahorrador</div>
        </div>



        <div class="medals-section-label">üîµ RARAS</div>

        <div class="mbadge m-rare" data-medal-id="terrateniente">
          <div class="mbadge-icon">üèòÔ∏è
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">TERRATENIENTE</div><div class="mbadge-tooltip-desc">Expande tu territorio: 100 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Terrateniente</div>
        </div>

        <div class="mbadge m-rare" data-medal-id="urbanista">
          <div class="mbadge-icon">üèôÔ∏è
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">URBANISTA</div><div class="mbadge-tooltip-desc">Crecimiento serio: 250 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Urbanista</div>
        </div>

        <div class="mbadge m-rare" data-medal-id="constructor">
          <div class="mbadge-icon">üèõÔ∏è
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">CONSTRUCTOR</div><div class="mbadge-tooltip-desc">Construcci√≥n masiva: 500 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Constructor</div>
        </div>

        <div class="mbadge m-rare" data-medal-id="magnate">
          <div class="mbadge-icon">üóº
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">MAGNATE</div><div class="mbadge-tooltip-desc">Imperio en crecimiento: 750 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Magnate</div>
        </div>



        <div class="mbadge m-rare" data-medal-id="estratega">
          <div class="mbadge-icon">üéØ
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">ESTRATEGA</div><div class="mbadge-tooltip-desc">Diversifica: 10 comunes + 5 raras + 2 √©picas.</div></div>
          </div>
          <div class="mbadge-name">Estratega</div>
        </div>

        <div class="mbadge m-rare" data-medal-id="visionario">
          <div class="mbadge-icon">üîÆ
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">VISIONARIO</div><div class="mbadge-tooltip-desc">1000 parcelas totales.</div></div>
          </div>
          <div class="mbadge-name">Visionario</div>
        </div>

        <div class="medals-section-label">üü£ √âPICAS</div>

        <div class="mbadge m-epic" data-medal-id="tormenta">
          <div class="mbadge-icon">üå©Ô∏è
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">TORMENTA</div><div class="mbadge-tooltip-desc">Expansi√≥n feroz: 1500 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Tormenta</div>
        </div>

        <div class="mbadge m-epic" data-medal-id="guerrero">
          <div class="mbadge-icon">‚öîÔ∏è
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">GUERRERO</div><div class="mbadge-tooltip-desc">Conquista constante: 2000 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Guerrero</div>
        </div>

        <div class="mbadge m-epic" data-medal-id="cazador_rarezas">
          <div class="mbadge-icon">üóø
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">CAZADOR DE RAREZAS</div><div class="mbadge-tooltip-desc">Logra 100 raras o 50 √©picas.</div></div>
          </div>
          <div class="mbadge-name">Cazador de Rarezas</div>
        </div>

        <div class="mbadge m-epic" data-medal-id="imparable">
          <div class="mbadge-icon">üî•
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">IMPARABLE</div><div class="mbadge-tooltip-desc">Nada te detiene: 2500 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Imparable</div>
        </div>

        <div class="medals-section-label">üü° LEGENDARIAS</div>

        <div class="mbadge m-legendary" data-medal-id="fundador">
          <div class="mbadge-icon"><img src="oldaemx.png" alt="Fundador" style="width:100%;height:100%;object-fit:cover;border-radius:11px;display:block;">
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">FUNDADOR</div><div class="mbadge-tooltip-desc">Cuenta iniciada el 26-sep-2024 o antes.</div></div>
          </div>
          <div class="mbadge-name">Fundador</div>
        </div>

        <div class="mbadge m-legendary" data-medal-id="clan_aemx">
          <div class="mbadge-icon" style="overflow:hidden;padding:0;">
            <img src="imagen_2.png" alt="AEMX" style="width:100%;height:100%;object-fit:contain;display:block;border-radius:8px;">
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">MIEMBRO AEMX</div><div class="mbadge-tooltip-desc">Formas parte del clan oficial Atlas Earth M√©xico.</div></div>
          </div>
          <div class="mbadge-name">AEMX</div>
        </div>

        <div class="mbadge m-legendary" data-medal-id="titan">
          <div class="mbadge-icon">üåå
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">TIT√ÅN</div><div class="mbadge-tooltip-desc">Nivel √©lite: 3000 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Tit√°n</div>
        </div>

        <div class="mbadge m-legendary" data-medal-id="leyenda">
          <div class="mbadge-icon">üèÖ
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">LEYENDA</div><div class="mbadge-tooltip-desc">Entre los mejores: 4000 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Leyenda</div>
        </div>

        <div class="mbadge m-legendary" data-medal-id="emperador_supremo">
          <div class="mbadge-icon">üëë
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">EMPERADOR SUPREMO</div><div class="mbadge-tooltip-desc">Imperio supremo: 5000 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Emperador Supremo</div>
        </div>

        <div class="mbadge m-legendary" data-medal-id="conquistador">
          <div class="mbadge-icon">üí†
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">CONQUISTADOR</div><div class="mbadge-tooltip-desc">Conquista absoluta: 6000 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Conquistador</div>
        </div>

        <div class="mbadge m-legendary" data-medal-id="dominio_absoluto">
          <div class="mbadge-icon">‚≠ê
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">DOMINIO ABSOLUTO</div><div class="mbadge-tooltip-desc">Dominas el mapa: 7000 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Dominio Absoluto</div>
        </div>

        <div class="mbadge m-legendary" data-medal-id="dios_atlas">
          <div class="mbadge-icon">üî±
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">DIOS DEL ATLAS</div><div class="mbadge-tooltip-desc">Nivel presidente: 8000 parcelas.</div></div>
          </div>
          <div class="mbadge-name">Dios del Atlas</div>
        </div>

        <div class="mbadge m-legendary" data-medal-id="coleccionista_leg">
          <div class="mbadge-icon">üü°
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">COLECCIONISTA LEGENDARIO</div><div class="mbadge-tooltip-desc">Ten 100 parcelas legendarias.</div></div>
          </div>
          <div class="mbadge-name">Coleccionista Legendario</div>
        </div>

        <div class="mbadge m-legendary" data-medal-id="portfolio_perfecto">
          <div class="mbadge-icon">üßÆ
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">CREL PERFECTO</div><div class="mbadge-tooltip-desc">Diversificaci√≥n legendaria: 100C + 75R + 50E + 25L.</div></div>
          </div>
          <div class="mbadge-name">Portfolio Perfecto</div>
        </div>

        <div class="medals-section-label" id="medalShopSection">üí∞ SHOP (COINS)</div>

        <div class="mbadge m-coins" data-medal-id="orgullo_mx" data-price="50">
          <div class="mbadge-icon">üèüÔ∏è
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">ORGULLO MX</div><div class="mbadge-tooltip-desc">Medalla patri√≥tica mexicana.</div><div class="mbadge-tooltip-cost">ü™ô 50 coins</div></div>
          </div>
          <div class="mbadge-name">Orgullo MX</div>
          <button class="mbadge-buy-btn" onclick="buyMedal(event, this)">ü™ô 50</button>
        </div>

        <div class="mbadge m-coins" data-medal-id="on_fire" data-price="100">
          <div class="mbadge-icon">üî•
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">ON FIRE</div><div class="mbadge-tooltip-desc">Racha ardiente.</div><div class="mbadge-tooltip-cost">ü™ô 100 coins</div></div>
          </div>
          <div class="mbadge-name">On Fire</div>
          <button class="mbadge-buy-btn" onclick="buyMedal(event, this)">ü™ô 100</button>
        </div>

        <div class="mbadge m-coins" data-medal-id="artista" data-price="150">
          <div class="mbadge-icon">üé®
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">ARTISTA</div><div class="mbadge-tooltip-desc">Para creadores de contenido.</div><div class="mbadge-tooltip-cost">ü™ô 150 coins</div></div>
          </div>
          <div class="mbadge-name">Artista</div>
          <button class="mbadge-buy-btn" onclick="buyMedal(event, this)">ü™ô 150</button>
        </div>

        <div class="mbadge m-coins" data-medal-id="gamer_pro" data-price="200">
          <div class="mbadge-icon">üéÆ
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">GAMER PRO</div><div class="mbadge-tooltip-desc">Para los verdaderos gamers.</div><div class="mbadge-tooltip-cost">ü™ô 200 coins</div></div>
          </div>
          <div class="mbadge-name">Gamer Pro</div>
          <button class="mbadge-buy-btn" onclick="buyMedal(event, this)">ü™ô 200</button>
        </div>

        <div class="mbadge m-coins" data-medal-id="rainbow" data-price="250">
          <div class="mbadge-icon">üåà
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">RAINBOW</div><div class="mbadge-tooltip-desc">Edici√≥n limitada colorida.</div><div class="mbadge-tooltip-cost">ü™ô 250 coins</div></div>
          </div>
          <div class="mbadge-name">Rainbow</div>
          <button class="mbadge-buy-btn" onclick="buyMedal(event, this)">ü™ô 250</button>
        </div>

        <div class="mbadge m-coins" data-medal-id="thunderbolt" data-price="300">
          <div class="mbadge-icon">‚ö°
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">THUNDERBOLT</div><div class="mbadge-tooltip-desc">Poder extremo.</div><div class="mbadge-tooltip-cost">ü™ô 300 coins</div></div>
          </div>
          <div class="mbadge-name">Thunderbolt</div>
          <button class="mbadge-buy-btn" onclick="buyMedal(event, this)">ü™ô 300</button>
        </div>

        <div class="mbadge m-coins" data-medal-id="phantom" data-price="400">
          <div class="mbadge-icon">üëª
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">PHANTOM</div><div class="mbadge-tooltip-desc">Medalla oscura misteriosa.</div><div class="mbadge-tooltip-cost">ü™ô 400 coins</div></div>
          </div>
          <div class="mbadge-name">Phantom</div>
          <button class="mbadge-buy-btn" onclick="buyMedal(event, this)">ü™ô 400</button>
        </div>

        <div class="mbadge m-coins" data-medal-id="diamante" data-price="500">
          <div class="mbadge-icon">üíé
            <div class="mbadge-tooltip"><div class="mbadge-tooltip-name">DIAMANTE</div><div class="mbadge-tooltip-desc">Medalla premium exclusiva.</div><div class="mbadge-tooltip-cost">ü™ô 500 coins</div></div>
          </div>
          <div class="mbadge-name">Diamante</div>
          <button class="mbadge-buy-btn" onclick="buyMedal(event, this)">ü™ô 500</button>
        </div>

      </div>
    </div>
  </div>
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIN CARD MEDALLAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <div class="grid">
    <div class="card">
      <div class="card-title">
        <span class="dot" style="background:#94a3b8;box-shadow:0 0 6px #94a3b8"></span>
        Parcelas
      </div>

      <div class="parcel-row common">
        <div class="parcel-pct" id="pct-common">0%</div>
        <div class="parcel-icon"><span style="display:inline-block;width:18px;height:18px;background:#4ade80;border-radius:3px;box-shadow:0 0 8px rgba(74,222,128,0.6);"></span></div>
        <div style="flex:1">
          <div class="parcel-label">Comunes</div>
          <div class="parcel-rate">$0.0000000011/seg</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('common',-1)">‚àí</button>
          <input type="number" id="common" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('common',1)">+</button>
        </div>
        <div class="parcel-pct" id="pct-common"></div>
      </div>

      <div class="parcel-row rare">
        <div class="parcel-pct" id="pct-rare">0%</div>
        <div class="parcel-icon"><span style="display:inline-block;width:18px;height:18px;background:#60a5fa;border-radius:3px;box-shadow:0 0 8px rgba(96,165,250,0.6);"></span></div>
        <div style="flex:1">
          <div class="parcel-label">Raras</div>
          <div class="parcel-rate">$0.0000000016/seg</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('rare',-1)">‚àí</button>
          <input type="number" id="rare" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('rare',1)">+</button>
        </div>
        <div class="parcel-pct" id="pct-rare"></div>
      </div>

      <div class="parcel-row epic">
        <div class="parcel-pct" id="pct-epic">0%</div>
        <div class="parcel-icon"><span style="display:inline-block;width:18px;height:18px;background:#c084fc;border-radius:3px;box-shadow:0 0 8px rgba(192,132,252,0.6);"></span></div>
        <div style="flex:1">
          <div class="parcel-label">√âpicas</div>
          <div class="parcel-rate">$0.0000000022/seg</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('epic',-1)">‚àí</button>
          <input type="number" id="epic" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('epic',1)">+</button>
        </div>
        <div class="parcel-pct" id="pct-epic"></div>
      </div>

      <div class="parcel-row legendary">
        <div class="parcel-pct" id="pct-legendary">0%</div>
        <div class="parcel-icon"><span style="display:inline-block;width:18px;height:18px;background:#facc15;border-radius:3px;box-shadow:0 0 8px rgba(250,204,21,0.6);"></span></div>
        <div style="flex:1">
          <div class="parcel-label">Legendarias</div>
          <div class="parcel-rate">$0.0000000044/seg</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('legendary',-1)">‚àí</button>
          <input type="number" id="legendary" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('legendary',1)">+</button>
        </div>
        <div class="parcel-pct" id="pct-legendary"></div>
      </div>

      <div class="total-parcels">
        <div class="num" id="total-parcels">0</div>
        <div class="lbl">Parcelas totales</div>
      </div>

      <div class="dollar-box">
        <div class="dollar-box-title">Tiempo para ganar $1.00 USD</div>
        <div class="dollar-time">
          <div class="dollar-unit">
            <div class="dollar-num" id="t1-days">‚Äî</div>
            <div class="dollar-lbl">D√≠as</div>
          </div>
          <div class="dollar-unit">
            <div class="dollar-num" id="t1-hours">‚Äî</div>
            <div class="dollar-lbl">Horas</div>
          </div>
          <div class="dollar-unit">
            <div class="dollar-num" id="t1-mins">‚Äî</div>
            <div class="dollar-lbl">Min</div>
          </div>
          <div class="dollar-unit">
            <div class="dollar-num" id="t1-secs">‚Äî</div>
            <div class="dollar-lbl">Seg</div>
          </div>
        </div>
      </div>

      <div style="margin-top:14px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border-radius:10px;padding:10px 16px;">
        <div style="font-family:'Fredoka One',cursive;font-size:10px;letter-spacing:2px;color:var(--text2);text-transform:uppercase;">Parcelas por d√≠a</div>
        <div style="display:flex;align-items:baseline;gap:5px;">
          <span id="ppd-card" style="font-family:'Nunito',sans-serif;font-weight:800;font-size:22px;font-weight:700;color:var(--text2);">‚Äî</span>
          <span style="font-size:10px;color:var(--text2);">parc/d√≠a</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <span class="dot" style="background:#ffd700;box-shadow:0 0 6px #ffd700"></span>
        Potenciadores
      </div>

      <div class="booster-row">
        <div class="booster-icon">üèÖ</div>
        <div class="booster-info">
          <div class="booster-name">Insignias <span id="b-badge-pct" class="boost-badge" style="display:none;">+0%</span></div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('badges',-1)">‚àí</button>
          <input type="number" id="badges" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('badges',1)">+</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="booster-row">
        <div class="booster-icon">üíé</div>
        <div class="booster-info">
          <div class="booster-name" style="color:#a5f3fc">Diamantes</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('diamonds',-1)">‚àí</button>
          <input type="number" id="diamonds" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('diamonds',1)">+</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="booster-row">
        <div class="booster-icon">üíµ</div>
        <div class="booster-info">
          <div class="booster-name" style="color:#86efac">Atlas Bucks (AB)</div>
        </div>
        <div class="counter">
          <button class="counter-btn" onclick="change('atlasbucks',-100)">‚àí</button>
          <input type="number" id="atlasbucks" value="0" min="0" oninput="calc()">
          <button class="counter-btn" onclick="change('atlasbucks',100)">+</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="explorer-row" onclick="toggleExplorer()">
        <div class="explorer-checkbox" id="explorer-check">‚úì</div>
        <div class="explorer-info">
          <div class="explorer-name">üß≠ Club de Explorador</div>
          <div class="explorer-desc" id="explorer-desc">Activo: diamantes √∑ 7 giros de ruleta</div>
        </div>
        <div class="explorer-result">
          <div class="explorer-days" id="explorer-days">0</div>
          <div class="explorer-days-label">d√≠as ruleta</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="booster-row">
        <div class="booster-icon">üì∫</div>
        <div class="booster-info">
          <div class="booster-name"> Boost (M√©xico)</div>
          <div class="booster-desc">Calculado autom√°ticamente por parcelas</div>
        </div>
        <div style="text-align:center;">
          <div id="adboost-display" style="font-family:'Fredoka One',cursive;font-size:22px;font-weight:900;color:var(--gold);text-shadow:none;line-height:1;">20√ó</div>
          <div id="adboost-range" style="font-size:10px;color:var(--text2);letter-spacing:1px;margin-top:2px;">1‚Äì50 parcelas</div>
        </div>
      </div>

      <div class="tier-info" id="tier-info" style="flex-direction:column;gap:6px;text-align:center;">
        <div style="font-family:'Fredoka One',cursive;font-size:9px;letter-spacing:3px;color:var(--text2);text-transform:uppercase;">Parcelas que puedes comprar</div>
        <div style="display:flex;align-items:baseline;justify-content:center;gap:8px;">
          <span id="parcels-buyable" style="font-family:'Fredoka One',cursive;font-size:30px;font-weight:900;color:#2d7a25;text-shadow:none;">0</span>
          <span style="font-size:12px;color:var(--text2);">parcelas</span>
        </div>
        <div style="font-size:11px;color:var(--text2);">con tus <span id="ab-total-display" style="color:var(--gold);">0 AB</span> ¬∑ 100 AB por parcela</div>
      </div>
    </div>
  </div>

  <div class="results-card">
    <div class="results-title">‚óà Resultados de Renta ‚óà</div>

    <table class="results-table">
      <thead>
        <tr>
          <th>Per√≠odo</th>
          <th>Sin Boost</th>
          <th>Con Boost</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por Segundo</div></td>
          <td class="rt-base" id="r-sec-base">$0.000000000000</td>
          <td class="rt-boost" id="r-sec">$0.000000000000</td>
        </tr>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por Minuto</div></td>
          <td class="rt-base" id="r-min-base">$0.0000000000</td>
          <td class="rt-boost" id="r-min">$0.0000000000</td>
        </tr>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por Hora</div></td>
          <td class="rt-base" id="r-hour-base">$0.00000000</td>
          <td class="rt-boost" id="r-hour">$0.00000000</td>
        </tr>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por D√≠a</div></td>
          <td class="rt-base" id="r-day-base">$0.000000</td>
          <td class="rt-boost" id="r-day">$0.000000</td>
        </tr>
        <tr>
          <td><div class="rt-period"><span class="dot"></span>Por Semana</div></td>
          <td class="rt-base" id="r-week-base">$0.0000</td>
          <td class="rt-boost" id="r-week">$0.0000</td>
        </tr>
        <tr style="background:rgba(0,255,157,0.03);">
          <td><div class="rt-period" style="color:#2d7a25"><span class="dot" style="background:var(--glow2);box-shadow:0 0 4px var(--glow2)"></span>Renta Mensual</div></td>
          <td class="rt-base" id="r-month-base">$0.0000</td>
          <td class="rt-boost highlight" id="r-month">$0.0000</td>
        </tr>
        <tr style="background:rgba(251,191,36,0.04);border-top:1px solid rgba(251,191,36,0.15);">
          <td>
            <div class="rt-period" style="color:#c8851a"><span class="dot" style="background:#fbbf24;box-shadow:0 0 4px #fbbf24"></span>SRB 50√ó</div>
            <div style="font-size:10px;color:#92400e;font-family:'Nunito',sans-serif;font-weight:800;margin-top:3px;padding-left:14px;">32h ¬∑ 50√ó boost</div>
          </td>
          <td class="rt-base" id="r-single-event-base">$0.0000</td>
          <td class="rt-boost" id="r-single-event" style="color:#c8851a;text-shadow:0 0 16px rgba(251,191,36,0.5);">$0.0000</td>
        </tr>
        <tr style="background:rgba(251,191,36,0.07);border-top:1px solid rgba(251,191,36,0.2);">
          <td>
            <div class="rt-period" style="color:#c8851a"><span class="dot" style="background:#fbbf24;box-shadow:0 0 6px #fbbf24"></span>Renta Total Mes</div>
            <div style="font-size:10px;color:#92400e;font-family:'Nunito',sans-serif;font-weight:800;margin-top:3px;padding-left:14px;">2√ó SRB ¬∑ 32h ¬∑ 50√ó boost</div>
          </td>
          <td class="rt-base" id="r-event-base">$0.0000</td>
          <td class="rt-boost" id="r-event" style="color:#c8851a;text-shadow:0 0 20px rgba(251,191,36,0.6);font-size:18px;">$0.0000</td>
        </tr>
        <tr style="background:rgba(0,200,255,0.03);">
          <td><div class="rt-period" style="color:var(--gold)"><span class="dot" style="background:var(--glow);box-shadow:0 0 4px var(--glow)"></span>Por A√±o</div></td>
          <td class="rt-base" id="r-year-base">$0.00</td>
          <td class="rt-boost highlight" id="r-year" style="color:#00ff9d;text-shadow:0 0 20px rgba(0,255,157,0.6);font-size:16px;font-weight:900;letter-spacing:1px;">$0.00</td>
        </tr>
      </tbody>
    </table>

    <div class="breakdown">
      <div class="breakdown-title">‚óà Desglose Detallado</div>

      <div class="breakdown-row">
        <span class="breakdown-label">Renta base (sin boosts)</span>
        <span class="breakdown-value" id="b-base">$0.00/mes</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-label">Boost de insignias </span>
        <span class="breakdown-value" id="b-badge">+$0.00/mes</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-label">Boost de anuncios ‚Äî <span id="b-ad-x">20√ó</span> (M√©xico)</span>
        <span class="breakdown-value" id="b-ad">+$0.00/mes</span>
      </div>
      <div class="breakdown-row breakdown-separator" style="border-top:1px solid var(--border);padding-top:10px;margin-top:6px">
        <span class="breakdown-label" style="font-weight:700;color:var(--text)">Total mensual estimado</span>
        <span class="breakdown-value highlight" id="b-total">$0.00</span>
      </div>
      <div class="breakdown-row" style="margin-top:4px;">
        <span class="breakdown-label" style="font-weight:700;color:var(--gold)">üí´ Total anual estimado</span>
        <span class="breakdown-value" style="color:var(--gold);font-size:15px;font-weight:700;text-shadow:none;" id="b-year">$0.00</span>
      </div>

      <div style="margin-top:16px;padding:14px;background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.25);border-radius:10px;">
        <div style="font-family:'Fredoka One',cursive;font-size:9px;letter-spacing:3px;color:#c8851a;text-transform:uppercase;margin-bottom:12px;">üöÄ SRB 50√ó</div>
        <div class="breakdown-row" style="margin-bottom:6px;">
          <span class="breakdown-label">Renta 1 evento (32h ¬∑ 50√ó)</span>
          <span class="breakdown-value" id="b-single-event" style="color:#c8851a;">$0.0000</span>
        </div>
        <div class="breakdown-row" style="margin-bottom:6px;">
          <span class="breakdown-label">Horas normales del mes <span style="font-size:10px;color:var(--text2)">(‚âà720h ‚àí 64h evento)</span></span>
          <span class="breakdown-value" id="b-event-normal-hours">656 h</span>
        </div>
        <div class="breakdown-row" style="margin-bottom:6px;">
          <span class="breakdown-label">Renta en horas normales</span>
          <span class="breakdown-value" id="b-event-normal">$0.0000</span>
        </div>
        <div class="breakdown-row" style="margin-bottom:6px;">
          <span class="breakdown-label">Renta en 2 eventos (64h ¬∑ 50√ó)</span>
          <span class="breakdown-value" id="b-event-income" style="color:#c8851a;">$0.0000</span>
        </div>
        <div class="breakdown-row breakdown-separator" style="border-top:1px solid rgba(251,191,36,0.2);padding-top:10px;margin-top:4px;">
          <span class="breakdown-label" style="font-weight:700;color:#fef3c7;">Renta Total Mes</span>
          <span class="breakdown-value" style="color:#c8851a;font-size:16px;font-weight:700;text-shadow:0 0 12px rgba(251,191,36,0.4);" id="b-event-total">$0.0000</span>
        </div>
      </div>
    </div>
  </div>

  <!-- COINS COUNTER -->
  <div class="coins-bar" id="coins-bar" style="margin-top:16px;margin-bottom:0;display:none;">
    <div class="coins-icon">ü™ô</div>
    <div class="coins-info">
      <div class="coins-label">AEMX Coins</div>
      <div class="coins-value" id="coins-display">‚Äî</div>
      <div class="coins-sub">Total acumulado</div>
    </div>
    <div class="coins-status" id="coins-status">
      <span class="waiting" id="coins-status-text">Inicia sesi√≥n para ganar coins</span>
    </div>
    <button class="btn-checkin" id="btn-checkin" onclick="doCheckIn()" disabled>
      üèÅ CHECK IN
    </button>
  </div>

  <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-top:12px;flex-wrap:wrap;">
    <button class="btn-save" onclick="shareData()" id="btn-share-data">üíæ &nbsp;Guardar</button>
    <div id="google-auth-bar" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <span id="google-user-info" style="display:none;align-items:center;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;color:var(--gold);letter-spacing:1px;"></span>
      <button id="google-auth-btn" onclick="handleGoogleAuth()"
        style="font-family:'Nunito',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;padding:7px 16px;border-radius:8px;cursor:pointer;background:linear-gradient(135deg,#1a3a5c,#0b1626);border:1px solid var(--glow);color:var(--gold);transition:all 0.2s;white-space:nowrap;"
        onmouseover="this.style.background='var(--glow)';this.style.color='#060b14'"
        onmouseout="this.style.background='linear-gradient(135deg,#1a3a5c,#0b1626)';this.style.color='var(--glow)'">
        üîë Iniciar con Google
      </button>
    </div>
    <div class="save-status" id="save-status">‚úî Datos guardados</div>
  </div>
</div>

  <script>
    function handleGoogleAuth() {
      const s    = document.getElementById('save-status');
      const btn  = document.getElementById('google-auth-btn');
      const info = document.getElementById('google-user-info');
      if (!window._fbSignOut || !window._fbSignIn) return;
      if (window._fbUser) {
        if (btn) { btn.disabled = true; btn.textContent = 'Cerrando...'; }
        window._fbSignOut()
          .then(() => {
            window._fbUser = null;
            if (btn) { btn.disabled = false; btn.textContent = 'üîë Iniciar con Google'; btn.title = ''; }
            if (info) info.style.display = 'none';
            if (s) { s.textContent = 'üëã Sesi√≥n cerrada'; s.classList.add('visible'); setTimeout(() => s.classList.remove('visible'), 2500); }
          })
          .catch(err => { console.warn(err); if (btn) { btn.disabled = false; btn.textContent = 'Cerrar sesi√≥n'; } });
      } else {
        window._fbSignIn()
          .then(() => {
            if (s) { s.textContent = '‚úî Sesi√≥n iniciada'; s.classList.add('visible'); setTimeout(() => s.classList.remove('visible'), 2500); }
            if (window._fbUser && window._coinsLoad) window._coinsLoad(window._fbUser.uid);
          })
          .catch(err => console.warn('Sign-in error:', err));
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      ['common','rare','epic','legendary','badges','diamonds','atlasbucks'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => { if(window._fbUser && window._fbSaveAll) setTimeout(window._fbSaveAll, 800); });
      });
    });

    // ‚îÄ‚îÄ Sistema de Coins ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window._coinsUpdateDisplay = function(coins) {
      const el = document.getElementById('coins-display');
      if (el) {
        el.textContent = coins !== undefined && coins !== null ? coins : '0';
        el.classList.remove('pop-coin');
        void el.offsetWidth;
        el.classList.add('pop-coin');
        setTimeout(() => el.classList.remove('pop-coin'), 500);
      }
    };

    async function fechaCDMX() {
      try {
        const res  = await fetch('https://worldtimeapi.org/api/timezone/America/Mexico_City');
        const data = await res.json();
        return data.datetime.split('T')[0];
      } catch(e) {
        return new Intl.DateTimeFormat('en-CA', {
          timeZone: 'America/Mexico_City',
          year: 'numeric', month: '2-digit', day: '2-digit'
        }).format(new Date());
      }
    }

    function updateCheckInBtn(yaHizo) {
      const btn = document.getElementById('btn-checkin');
      if (!btn) return;
      if (yaHizo) {
        btn.disabled = true;
        btn.classList.add('done');
        btn.textContent = '‚úî CHECK IN HECHO';
      } else {
        btn.disabled = false;
        btn.classList.remove('done');
        btn.textContent = 'üèÅ CHECK IN';
      }
    }

    window.doCheckIn = async function() {
      const btn = document.getElementById('btn-checkin');
      if (!btn || btn.disabled) return;
      btn.disabled = true;
      btn.textContent = '‚è≥ ...';
      await window._awardDailyCoin();
    };

    function playCoinSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const notes = [523.25, 659.25, 783.99, 1046.50];
        notes.forEach((freq, i) => {
          const osc  = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.09);
          gain.gain.setValueAtTime(0.35, ctx.currentTime + i * 0.09);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.09 + 0.18);
          osc.start(ctx.currentTime + i * 0.09);
          osc.stop(ctx.currentTime + i * 0.09 + 0.18);
        });
      } catch(e) {}
    }

    function showCoinToast(total) {
      const toast = document.getElementById('coin-toast');
      if (!toast) return;
      toast.textContent = `ü™ô +1 COIN GANADO ¬∑ TOTAL: ${total}`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function setCoinStatus(html) {
      const el = document.getElementById('coins-status-text');
      if (el) el.outerHTML = `<span id="coins-status-text">${html}</span>`;
    }

    window._awardDailyCoin = async function() {
      if (!window._fbUser) return;
      const uid = window._fbUser.uid;
      const hoy = await fechaCDMX();
      const _db  = window._fbDb;
      const _ref = window._fbRef;
      const _get = window._fbGet;
      const _upd = window._fbUpdate;
      if (!_db || !_ref || !_get || !_upd) return;

      try {
        const configSnap = await _get(_ref(_db, 'config/coinsActivo'));
        const coinsActivo = configSnap.exists() ? configSnap.val() : true;
        const pais = (window.userCountry || '').toLowerCase();
        const esMexico = pais.includes('mexico') || pais.includes('m√©xico');

        if (!coinsActivo || !esMexico) return;

        const snap = await _get(_ref(_db, `users/${uid}`));
        const data = snap.exists() ? snap.val() : {};
        const ultimaFecha = data.lastCoinDate || null;

        if (ultimaFecha === hoy) {
          window._coinsUpdateDisplay(data.coins || 0);
          setCoinStatus(`<span class="waiting">Vuelve ma√±ana a guardar tus datos para ganar otro coin üïê</span>`);
          updateCheckInBtn(true);
          return;
        }

        const nuevoTotal = (data.coins || 0) + 1;
        await _upd(_ref(_db, `users/${uid}`), {
          coins:        nuevoTotal,
          lastCoinDate: hoy
        });

        window._coinsUpdateDisplay(nuevoTotal);
        playCoinSound();
        showCoinToast(nuevoTotal);
        setCoinStatus(`<span class="earned">‚úî +1 Coin ganado hoy ¬∑ ${hoy}</span>`);
        updateCheckInBtn(true);

      } catch (err) {
        console.warn('Coins error:', err);
      }
    };

    window._coinsLoad = async function(uid, serverDataPrefetch) {
      if (!uid) return;
      const _db  = window._fbDb;
      const _ref = window._fbRef;
      const _get = window._fbGet;
      if (!_db || !_ref || !_get) return;

      try {
        const configSnap = await _get(_ref(_db, 'config/coinsActivo'));
        const coinsActivo = configSnap.exists() ? configSnap.val() : true;
        const coinsBar = document.getElementById('coins-bar');

        if (!coinsActivo) {
          if (coinsBar) coinsBar.style.display = 'none';
          return;
        }

        let serverData;
        if (serverDataPrefetch) {
          serverData = serverDataPrefetch;
        } else {
          const snap = await _get(_ref(_db, `users/${uid}`));
          serverData = snap.exists() ? snap.val() : {};
        }

        const pais = (serverData.country || window.userCountry || '').toLowerCase();
        const esMexico = pais.includes('mexico') || pais.includes('m√©xico');

        if (!esMexico) {
          if (coinsBar) coinsBar.style.display = 'none';
          return;
        }

        if (coinsBar) coinsBar.style.display = '';

        const coins = serverData.coins || 0;
        const hoy   = await fechaCDMX();

        window._coinsUpdateDisplay(coins);

        if (serverData.lastCoinDate === hoy) {
          setCoinStatus(`<span class="waiting">Vuelve ma√±ana para ganar otro coin üïê</span>`);
          updateCheckInBtn(true);
        } else {
          setCoinStatus(`<span class="waiting">Haz Check In para ganar 1 coin ü™ô</span>`);
          updateCheckInBtn(false);
        }

      } catch(e) {
        console.warn('Coins load error:', e);
      }
    };

    const _origShareData = typeof shareData === 'function' ? shareData : null;
    window.shareData = async function() {
      if (_origShareData) _origShareData();
      if (!window._fbUser || !window._fbSaveAll) return;

      if (!window.userCountry) {
        try {
          const res  = await fetch('https://get.geojs.io/v1/ip/geo.json');
          const data = await res.json();
          if (data.country && typeof normalizarPais === 'function') {
            window.userCountry = normalizarPais(data.country);
          }
        } catch(e) {
          try {
            const res2  = await fetch('https://api.ip.sb/geoip');
            const data2 = await res2.json();
            if (data2.country && typeof normalizarPais === 'function') {
              window.userCountry = normalizarPais(data2.country);
            }
          } catch(e2) {}
        }
      }

      window._fbSaveAll();
    };
  </script>

  <p style="text-align:center;color:var(--text2);font-size:11px;margin-top:4px;letter-spacing:1px;">
    Tasas oficiales de Atlas Earth ‚Ä¢ Los c√°lculos son estimados ‚Ä¢ El ad boost asume 24/7
  </p>
  <p style="text-align:center;margin-top:4px;padding-bottom:60px;">
    <a href="https://buymeacoffee.com/socram13" target="_blank" style="color:var(--text2);font-size:11px;letter-spacing:1px;text-decoration:none;opacity:0.7;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
      ‚òï ¬øTe fue √∫til? Apoya con una donaci√≥n
    </a>
  </p>
</div>

<script>
  const RATES = {
    common:    0.0000000011,
    rare:      0.0000000016,
    epic:      0.0000000022,
    legendary: 0.0000000044,
  };

  function getVal(id) {
    return Math.max(0, parseInt(document.getElementById(id).value) || 0);
  }

  function change(id, delta) {
    const el = document.getElementById(id);
    const current = parseInt(el.value) || 0;
    el.value = Math.max(0, current + delta);
    calc();
  }

  function fmt(n, decimals = 6) {
    if (n >= 0.01) return '$' + n.toFixed(2);
    if (n >= 0.0001) return '$' + n.toFixed(4);
    return '$' + n.toFixed(decimals);
  }

  let explorerActive = true;

  function toggleExplorer() {
    explorerActive = !explorerActive;
    const check = document.getElementById('explorer-check');
    const desc  = document.getElementById('explorer-desc');
    const badge = document.getElementById('explorer-badge');
    if (explorerActive) {
      check.classList.add('checked');
      desc.textContent = 'Activo: diamantes √∑ 7 giros de ruleta';
      badge.style.display = 'block';
    } else {
      check.classList.remove('checked');
      desc.textContent = 'Inactivo: diamantes √∑ 5 giros de ruleta';
      badge.style.display = 'none';
    }
    try {
      const saved = JSON.parse(localStorage.getItem(SAVE_KEY) || '{}');
      saved.explorer = explorerActive;
      localStorage.setItem(SAVE_KEY, JSON.stringify(saved));
    } catch(e) {}
    calc();
  }

  function calc() {
    const c = getVal('common');
    const r = getVal('rare');
    const e = getVal('epic');
    const l = getVal('legendary');
    const badges = getVal('badges');
    const diamonds = getVal('diamonds');
    const ruletaDays = Math.floor(diamonds / (explorerActive ? 7 : 5));
    document.getElementById('explorer-days').textContent = ruletaDays;
    const ab = getVal('atlasbucks');
    const total = c + r + e + l;
    document.getElementById('total-parcels').textContent = total;

    let _segSpeed;
    if      (total === 0)    _segSpeed = 60;
    else if (total <= 25)    _segSpeed = 55;
    else if (total <= 50)    _segSpeed = 50;
    else if (total <= 100)   _segSpeed = 45;
    else if (total <= 200)   _segSpeed = 35;
    else if (total <= 350)   _segSpeed = 25;
    else if (total <= 500)   _segSpeed = 18;
    else if (total <= 750)   _segSpeed = 13;
    else if (total <= 1000)  _segSpeed = 10;
    else if (total <= 1500)  _segSpeed = 2.5;
    else if (total <= 2000)  _segSpeed = 2;
    else if (total <= 3000)  _segSpeed = 1.5;
    else if (total <= 5000)  _segSpeed = 1.2;
    else if (total <= 8000)  _segSpeed = 1;
    else                     _segSpeed = 0.8;
    window._donutSegSpeed = _segSpeed;

    const types = { common: c, rare: r, epic: e, legendary: l };
    for (const [key, val] of Object.entries(types)) {
      const el = document.getElementById('pct-' + key);
      if (total > 0) {
        const pct = ((val / total) * 100).toFixed(1);
        el.textContent = pct + '%';
        el.classList.toggle('active', val > 0);
      } else {
        el.textContent = '0%';
        el.classList.remove('active');
      }
    }

    let adBoost, adRange;
    const EUROPA_COUNTRIES = new Set(["Spain", "France", "Germany", "Italy", "Russia"]);
    if (EUROPA_COUNTRIES.has(userCountry)) {
      if      (total <= 70)   { adBoost = 20; adRange = "1‚Äì70 parcelas"; }
      else if (total <= 100)  { adBoost = 15; adRange = "71‚Äì100 parcelas"; }
      else if (total <= 135)  { adBoost = 10; adRange = "101‚Äì135 parcelas"; }
      else if (total <= 170)  { adBoost = 8;  adRange = "136‚Äì170 parcelas"; }
      else if (total <= 200)  { adBoost = 7;  adRange = "171‚Äì200 parcelas"; }
      else if (total <= 250)  { adBoost = 6;  adRange = "201‚Äì250 parcelas"; }
      else if (total <= 300)  { adBoost = 5;  adRange = "251‚Äì300 parcelas"; }
      else if (total <= 350)  { adBoost = 4;  adRange = "301‚Äì350 parcelas"; }
      else if (total <= 400)  { adBoost = 3;  adRange = "351‚Äì400 parcelas"; }
      else                    { adBoost = 2;  adRange = "401‚Äì1000 parcelas"; }
    } else if (userCountry === "United States") {
      if      (total <= 150)  { adBoost = 30; adRange = "1‚Äì150 parcelas"; }
      else if (total <= 220)  { adBoost = 20; adRange = "151‚Äì220 parcelas"; }
      else if (total <= 290)  { adBoost = 15; adRange = "221‚Äì290 parcelas"; }
      else if (total <= 365)  { adBoost = 12; adRange = "291‚Äì365 parcelas"; }
      else if (total <= 435)  { adBoost = 10; adRange = "366‚Äì435 parcelas"; }
      else if (total <= 545)  { adBoost = 8;  adRange = "436‚Äì545 parcelas"; }
      else if (total <= 625)  { adBoost = 7;  adRange = "546‚Äì625 parcelas"; }
      else if (total <= 730)  { adBoost = 6;  adRange = "626‚Äì730 parcelas"; }
      else if (total <= 875)  { adBoost = 5;  adRange = "731‚Äì875 parcelas"; }
      else if (total <= 1100) { adBoost = 4;  adRange = "876‚Äì1100 parcelas"; }
      else if (total <= 1500) { adBoost = 3;  adRange = "1101‚Äì1500 parcelas"; }
      else                    { adBoost = 2;  adRange = "1501‚Äì3000 parcelas"; }
    } else {
      if      (total <= 50)  { adBoost = 20; adRange = "1‚Äì50 parcelas"; }
      else if (total <= 85)  { adBoost = 15; adRange = "51‚Äì85 parcelas"; }
      else if (total <= 100) { adBoost = 12; adRange = "86‚Äì100 parcelas"; }
      else if (total <= 140) { adBoost = 8;  adRange = "101‚Äì140 parcelas"; }
      else if (total <= 175) { adBoost = 7;  adRange = "141‚Äì175 parcelas"; }
      else if (total <= 225) { adBoost = 5;  adRange = "176‚Äì225 parcelas"; }
      else if (total <= 300) { adBoost = 4;  adRange = "226‚Äì300 parcelas"; }
      else if (total <= 400) { adBoost = 3;  adRange = "301‚Äì400 parcelas"; }
      else                   { adBoost = 2;  adRange = "401+ parcelas"; }
    }
    document.getElementById('adboost-display').textContent = adBoost + '√ó';
    document.getElementById('adboost-range').textContent = adRange;

    const basePerSec = (c * RATES.common) + (r * RATES.rare) + (e * RATES.epic) + (l * RATES.legendary);

    let badgePct = 0;
    if (badges >= 1 && badges <= 10)        badgePct = 0.05;
    else if (badges >= 11 && badges <= 30)  badgePct = 0.10;
    else if (badges >= 31 && badges <= 60)  badgePct = 0.15;
    else if (badges >= 61 && badges <= 100) badgePct = 0.20;
    else if (badges > 100)                  badgePct = 0.25;
    const badgeBoost = 1 + badgePct;

    const parcelsBuyable = Math.floor(ab / 100);
    document.getElementById('parcels-buyable').textContent = parcelsBuyable;
    document.getElementById('ab-total-display').textContent = ab.toLocaleString() + ' AB';

    const boostedPerSec = basePerSec * badgeBoost * adBoost;

    const perMin   = boostedPerSec * 60;
    const perHour  = boostedPerSec * 3600;
    const perDay   = boostedPerSec * 86400;
    const perWeek  = perDay * 7;
    const perMonth = perDay * 30;

    const basePerMonth = basePerSec * 86400 * 30;
    const badgeExtra = basePerMonth * (badgeBoost - 1);
    const adExtra = basePerMonth * badgeBoost * (adBoost - 1);

    const basePerMin  = basePerSec * 60;
    const basePerHour = basePerSec * 3600;
    const basePerDay  = basePerSec * 86400;
    const basePerWeek = basePerDay * 7;
    const basePerMo   = basePerDay * 30;
    const basePerYear = basePerDay * 365;

    document.getElementById('r-sec-base').textContent  = '$' + basePerSec.toFixed(12);
    document.getElementById('r-min-base').textContent  = '$' + basePerMin.toFixed(10);
    document.getElementById('r-hour-base').textContent = '$' + basePerHour.toFixed(8);
    document.getElementById('r-day-base').textContent  = fmt(basePerDay);
    document.getElementById('r-week-base').textContent = fmt(basePerWeek);
    document.getElementById('r-year-base').textContent  = fmt(basePerYear);
    document.getElementById('r-month-base').textContent = fmt(basePerMo);

    document.getElementById('r-sec').textContent   = '$' + boostedPerSec.toFixed(12);
    document.getElementById('r-min').textContent   = '$' + (boostedPerSec * 60).toFixed(10);
    document.getElementById('r-hour').textContent  = '$' + (boostedPerSec * 3600).toFixed(8);
    document.getElementById('r-day').textContent   = fmt(perDay);
    document.getElementById('r-week').textContent  = fmt(perWeek);
    document.getElementById('r-year').textContent   = fmt(perDay * 365);
    document.getElementById('r-month').textContent = fmt(perMonth);

    document.getElementById('b-base').textContent      = '$' + basePerMonth.toFixed(4) + '/mes';
    const badgePctEl = document.getElementById('b-badge-pct');
    if (badgePct === 0) {
      badgePctEl.style.display = 'none';
    } else {
      badgePctEl.style.display = '';
      badgePctEl.textContent = '+' + (badgePct * 100) + '%';
    }
    document.getElementById('b-badge').textContent     = '+$' + badgeExtra.toFixed(4) + '/mes';
    document.getElementById('b-ad-x').textContent      = adBoost + '√ó';
    document.getElementById('b-ad').textContent        = '+$' + adExtra.toFixed(4) + '/mes';
    document.getElementById('b-total').textContent     = '$' + perMonth.toFixed(4);

    const EVENT_BOOST  = 50;
    const EVENT_HOURS  = 32;
    const EVENTS_MONTH = 2;
    const MONTH_HOURS  = 30 * 24;
    const TOTAL_EVT_H  = EVENT_HOURS * EVENTS_MONTH;
    const NORMAL_HOURS = MONTH_HOURS - TOTAL_EVT_H;

    const boostedPerHour   = boostedPerSec * 3600;
    const eventPerHour     = basePerSec * badgeBoost * EVENT_BOOST * 3600;

    const incomeSingleEvt  = eventPerHour  * EVENT_HOURS;
    const incomeNormal     = boostedPerHour * NORMAL_HOURS;
    const incomeAllEvts    = eventPerHour  * TOTAL_EVT_H;
    const totalWithEvents  = incomeNormal  + incomeAllEvts;

    document.getElementById('r-single-event-base').textContent = fmt(basePerSec * 3600 * EVENT_HOURS);
    document.getElementById('r-single-event').textContent      = fmt(incomeSingleEvt);
    document.getElementById('r-event-base').textContent        = fmt(basePerMo);
    document.getElementById('r-event').textContent             = fmt(totalWithEvents);

    document.getElementById('b-single-event').textContent      = fmt(incomeSingleEvt);
    document.getElementById('b-event-normal-hours').textContent= NORMAL_HOURS.toFixed(1) + ' h';
    document.getElementById('b-event-normal').textContent      = fmt(incomeNormal) + '/mes';
    document.getElementById('b-event-income').textContent      = fmt(incomeAllEvts);
    document.getElementById('b-event-total').textContent       = fmt(totalWithEvents);

    const YEAR_HOURS    = 365 * 24;
    const YEAR_EVT_H    = EVENT_HOURS * EVENTS_MONTH * 12;
    const YEAR_NORMAL_H = YEAR_HOURS - YEAR_EVT_H;
    const perYear = (boostedPerHour * YEAR_NORMAL_H) + (eventPerHour * YEAR_EVT_H);
    document.getElementById('r-year').textContent = fmt(perYear);
    document.getElementById('r-year-base').textContent = fmt(basePerYear);
    document.getElementById('b-year').textContent = '$' + perYear.toFixed(4);

    if (boostedPerSec > 0) {
      const secsFor1 = 1 / boostedPerSec;
      const d = Math.floor(secsFor1 / 86400);
      const h = Math.floor((secsFor1 % 86400) / 3600);
      const m = Math.floor((secsFor1 % 3600) / 60);
      const s = Math.floor(secsFor1 % 60);
      document.getElementById('t1-days').textContent  = d;
      document.getElementById('t1-hours').textContent = String(h).padStart(2,'0');
      document.getElementById('t1-mins').textContent  = String(m).padStart(2,'0');
      document.getElementById('t1-secs').textContent  = String(s).padStart(2,'0');
    } else {
      ['t1-days','t1-hours','t1-mins','t1-secs'].forEach(id => {
        document.getElementById(id).textContent = '‚Äî';
      });
    }
    autoSave();
    drawDonut(c, r, e, l, total);

    const startDateVal = document.getElementById('start-date').value;
    const ppdCircle = document.getElementById('ppd-circle');
    if (ppdCircle) {
      if (startDateVal && total > 0) {
        const start = new Date(startDateVal);
        const now = new Date();
        const diasJugados = Math.max(1, Math.floor((now - start) / 86400000));
        const ppd = (total / diasJugados).toFixed(1);
        ppdCircle.textContent = ppd;
      } else {
        ppdCircle.textContent = '‚Äî';
      }
    }
    const ppdCard = document.getElementById('ppd-card');
    if (ppdCard) {
      if (startDateVal && total > 0) {
        const start = new Date(startDateVal);
        const now = new Date();
        const diasJugados = Math.max(1, Math.floor((now - start) / 86400000));
        ppdCard.textContent = (total / diasJugados).toFixed(1);
      } else {
        ppdCard.textContent = '‚Äî';
      }
    }
  }

  function drawDonut(c, r, e, l, total) {
    const svg = document.getElementById('donut-svg');
    const center = document.getElementById('donut-center');
    const cx = 50, cy = 50, strokeW = 5;
    const GAP_DEG = 6;

    svg.querySelectorAll('.seg').forEach(el => el.remove());

    const vals = [c, r, e, l];
    const pctIds = ['donut-pct-c','donut-pct-r','donut-pct-e','donut-pct-l'];
    const colors = ['#4ade80','#60a5fa','#c084fc','#facc15'];

    if (total === 0) {
      center.textContent = '‚Äî';
      pctIds.forEach((id, i) => {
        const div = document.getElementById(id);
        const arrow = div.querySelector('.donut-arrow');
        if (arrow) { arrow.textContent = '‚Üì'; arrow.className = 'donut-arrow down'; }
        const tn = Array.from(div.childNodes).find(n => n.nodeType === Node.TEXT_NODE);
        if (tn) { tn.textContent = '0%'; } else { div.appendChild(document.createTextNode('0%')); }
      });
      return;
    }
    center.textContent = total;

    const _donutBg = document.getElementById('donut-bg-circle');
    if (_donutBg && window._userThemeRgb) {
      _donutBg.setAttribute('stroke', `rgba(${window._userThemeRgb},0.15)`);
    }

    const activeCount = vals.filter(v => v > 0).length;
    const GAP_RAD = (GAP_DEG * Math.PI) / 180;
    const totalGap = activeCount > 1 ? GAP_RAD * activeCount : 0;
    const available = 2 * Math.PI - totalGap;

    function arcPath(cx, cy, r, startAngle, endAngle) {
      const toothHeight = 5.5;
      const toothWidth  = 0.08;
      const gapWidth    = 0.14;
      const period      = toothWidth + gapWidth;
      const arcLen      = endAngle - startAngle;
      const numTeeth    = Math.max(1, Math.floor(arcLen / period));
      const actualPeriod = arcLen / numTeeth;
      const tw = actualPeriod * 0.45;
      const rOuter = r + toothHeight;

      let d = '';
      for (let t = 0; t < numTeeth; t++) {
        const a0 = startAngle + t * actualPeriod;
        const a1 = a0 + (actualPeriod - tw);
        const a2 = a1 + tw * 0.5;
        const a3 = a0 + actualPeriod;

        const p = (angle, radius) => `${cx + radius * Math.cos(angle)} ${cy + radius * Math.sin(angle)}`;

        if (t === 0) d += `M ${p(a0, r)}`;
        else         d += ` L ${p(a0, r)}`;

        d += ` A ${r} ${r} 0 0 1 ${p(a1, r)}`;
        d += ` L ${p(a1, rOuter)}`;
        d += ` L ${p(a2, rOuter)}`;
        d += ` L ${p(a3, r)}`;
      }
      return d;
    }

    const RADIOS = [38, 30, 22, 14];
    const SPIN_DIR = ['segSpinFwd', 'segSpinRev', 'segSpinFwd', 'segSpinRev'];

    let angleOffset = -Math.PI / 2;

    vals.forEach((val, i) => {
      if (val === 0) return;
      const pct = val / total;
      const segAngle = pct * available;
      const startAngle = angleOffset;
      const endAngle = angleOffset + segAngle;
      const midAngle = (startAngle + endAngle) / 2;
      const radius = RADIOS[i];

      const EXPLODE = 2;
      const ex = cx + Math.cos(midAngle) * EXPLODE;
      const ey = cy + Math.sin(midAngle) * EXPLODE;

      const seg = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      seg.setAttribute('d', arcPath(ex, ey, radius, startAngle, endAngle));
      seg.setAttribute('fill', 'none');
      seg.setAttribute('stroke', colors[i]);
      seg.setAttribute('stroke-width', strokeW);
      seg.setAttribute('stroke-linecap', 'round');
      seg.setAttribute('filter', `drop-shadow(0 0 3px ${colors[i]})`);

      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('class', 'seg');
      g.style.transformOrigin = '50px 50px';
      const segVal = vals[i];
      let segSpeed;
      if      (segVal === 0)    segSpeed = 60;
      else if (segVal <= 10)    segSpeed = 50;
      else if (segVal <= 25)    segSpeed = 40;
      else if (segVal <= 50)    segSpeed = 30;
      else if (segVal <= 100)   segSpeed = 20;
      else if (segVal <= 200)   segSpeed = 12;
      else if (segVal <= 400)   segSpeed = 7;
      else if (segVal <= 700)   segSpeed = 4;
      else if (segVal <= 1000)  segSpeed = 2.5;
      else if (segVal <= 2000)  segSpeed = 1.5;
      else if (segVal <= 4000)  segSpeed = 1;
      else                      segSpeed = 0.5;
      g.style.animation = `${SPIN_DIR[i]} ${segSpeed.toFixed(2)}s linear infinite`;
      g.appendChild(seg);
      svg.appendChild(g);

      angleOffset = endAngle + GAP_RAD;
    });

    function updateArrow(divId, arrowId, parcelas, base) {
      const pct = parseFloat(((parcelas / total) * 100).toFixed(1));
      const diff = pct - base;
      const sym   = diff > 0 ? "‚Üë" : (diff < 0 ? "‚Üì" : "");
      const cls   = diff > 0 ? "donut-arrow up" : (diff < 0 ? "donut-arrow down" : "donut-arrow");
      document.getElementById(divId).innerHTML = '<span class="' + cls + '" id="' + arrowId + '">' + sym + '</span>' + pct.toFixed(1) + '%';
    }
    updateArrow('donut-pct-c', 'donut-arrow-c', c, 50);
    updateArrow('donut-pct-r', 'donut-arrow-r', r, 30);
    updateArrow('donut-pct-e', 'donut-arrow-e', e, 15);
    updateArrow('donut-pct-l', 'donut-arrow-l', l,  5);
  }

  const SAVE_KEY = 'atlas-earth-calc-data';

  function autoSave() {
    const data = {
      common:     document.getElementById('common').value,
      rare:       document.getElementById('rare').value,
      epic:       document.getElementById('epic').value,
      legendary:  document.getElementById('legendary').value,
      badges:     document.getElementById('badges').value,
      diamonds:   document.getElementById('diamonds').value,
      atlasbucks: document.getElementById('atlasbucks').value,
      explorer:   explorerActive,
      startDate:  document.getElementById('start-date').value,
    };
    localStorage.setItem('atlas-earth-calc-data', JSON.stringify(data));
  }

  function showStatus(msg) {
    const el = document.getElementById('save-status');
    if (!el) return;
    el.textContent = msg || '‚úî Enlace copiado';
    el.classList.add('visible');
    setTimeout(() => el.classList.remove('visible'), 2500);
  }

  function shareData() {
    try {
      localStorage.setItem(SAVE_KEY, JSON.stringify({
        common:     document.getElementById('common').value,
        rare:       document.getElementById('rare').value,
        epic:       document.getElementById('epic').value,
        legendary:  document.getElementById('legendary').value,
        badges:     document.getElementById('badges').value,
        diamonds:   document.getElementById('diamonds').value,
        atlasbucks: document.getElementById('atlasbucks').value,
        explorer:   explorerActive,
        startDate:  document.getElementById('start-date').value,
      }));
    } catch(e) {}
    showStatus('‚úî Datos guardados');
    if(window._fbSaveAll) window._fbSaveAll();
  }

  async function loadData() {
    let data = null;
    const params = new URLSearchParams(window.location.search);
    const urlKeys = ['common','rare','epic','legendary','badges','diamonds','atlasbucks','explorer'];
    if (urlKeys.some(k => params.has(k))) {
      data = {};
      urlKeys.forEach(k => {
        if (params.has(k)) data[k] = k === 'explorer' ? params.get(k) === 'true' : params.get(k);
      });
    }
    if (!data) {
      const local = localStorage.getItem(SAVE_KEY);
      if (local) { try { data = JSON.parse(local); } catch(e) {} }
    }
    if (!data) return;
    ['common','rare','epic','legendary','badges','diamonds','atlasbucks'].forEach(k => {
      if (data[k] !== undefined) document.getElementById(k).value = data[k];
    });
    if (data.startDate) document.getElementById('start-date').value = data.startDate;
    if (data.explorer === false || data.explorer === 'false') {
      explorerActive = false;
      const check = document.getElementById('explorer-check');
      const desc  = document.getElementById('explorer-desc');
      const badge = document.getElementById('explorer-badge');
      check.classList.remove('checked');
      desc.textContent = 'Inactivo: diamantes √∑ 5 giros de ruleta';
      badge.style.display = 'none';
    }
    calc();
  }

  async function init() {
    await loadData();
    await loadProfile();
    adjustBadge();
    if (explorerActive) {
      document.getElementById('explorer-check').classList.add('checked');
      document.getElementById('explorer-badge').style.display = 'block';
    }
  }
  init();

  const avatarPlaceholder = document.getElementById('avatar-placeholder');
  const avatarEdit = document.getElementById('avatar-edit');
  const avatarInput = document.getElementById('avatar-input');
  const avatarWrapper = document.getElementById('avatar-wrapper');
  const avatarBorderColor = document.getElementById('avatar-border-color');

  function openFilePicker() { avatarInput.click(); }
  function openColorPicker() { avatarBorderColor.click(); }

  if (avatarPlaceholder) {
    avatarPlaceholder.addEventListener('click', function(e) { e.stopPropagation(); openFilePicker(); });
    avatarPlaceholder.addEventListener('touchend', function(e) { e.preventDefault(); e.stopPropagation(); openFilePicker(); });
  }

  if (avatarEdit) {
    avatarEdit.addEventListener('click', function(e) { e.stopPropagation(); openFilePicker(); });
    avatarEdit.addEventListener('touchend', function(e) { e.preventDefault(); e.stopPropagation(); openFilePicker(); });
  }

  const avatarColorBtn = document.getElementById('avatar-color-btn');
  if (avatarColorBtn) {
    avatarColorBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (isSafariIOS()) { toggleSafariColorPalette(); } else { openColorPicker(); }
    });
    avatarColorBtn.addEventListener('pointerup', function(e) {
      if (e.pointerType === 'touch') {
        e.stopPropagation();
        if (isSafariIOS()) { toggleSafariColorPalette(); } else { avatarBorderColor.click(); }
      }
    });
  }

  function updateClock() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    document.getElementById('cl-year').textContent  = now.getFullYear();
    document.getElementById('cl-month').textContent = pad(now.getMonth() + 1);
    document.getElementById('cl-day').textContent   = pad(now.getDate());
    document.getElementById('cl-hour').textContent  = pad(now.getHours());
    document.getElementById('cl-min').textContent   = pad(now.getMinutes());
    document.getElementById('cl-sec').textContent   = pad(now.getSeconds());
    const launch = new Date('2024-07-12T00:00:00');
    const diffMs = now - launch;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
    document.getElementById('aemx-sol').textContent = diffDays;
  }
  updateClock();
  setInterval(updateClock, 1000);

  function hexToRgb(hex) {
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return r+','+g+','+b;
  }

  function applyThemeColor(color) {
    const rgb = hexToRgb(color);
    const root = document.documentElement;
    document.querySelector('.profile-avatar-wrapper').style.setProperty('--avatar-border-color', color);
    const preview = document.getElementById('color-preview');
    if (preview) preview.style.background = color;
    const avatarEditBtn = document.getElementById('avatar-edit');
    const avatarColorBtn2 = document.getElementById('avatar-color-btn');
    if (avatarEditBtn) { avatarEditBtn.style.background = color; avatarEditBtn.style.boxShadow = `0 0 8px rgba(${rgb},0.6)`; }
    if (avatarColorBtn2) { avatarColorBtn2.style.background = color; avatarColorBtn2.style.boxShadow = `0 0 8px rgba(${rgb},0.6)`; }
    const [_r,_g,_b] = rgb.split(",").map(Number);
    const darkBg = `rgb(${Math.round(_r*0.04)},${Math.round(_g*0.04)},${Math.round(_b*0.04)})`;
    document.body.style.background = darkBg;
    document.body.style.backgroundColor = darkBg;
    const panelBg = `rgb(${Math.round(_r*0.06)},${Math.round(_g*0.06)},${Math.round(_b*0.06)})`;
    const panel2Bg = `rgb(${Math.round(_r*0.07)},${Math.round(_g*0.07)},${Math.round(_b*0.07)})`;
    root.style.setProperty("--panel", panelBg);
    root.style.setProperty("--panel2", panel2Bg);
    root.style.setProperty('--glow', color);
    root.style.setProperty('--accent', color);
    const [_r2,_g2,_b2] = rgb.split(",").map(Number);
    const lightR = Math.round(_r2 + (255 - _r2) * 0.5);
    const lightG = Math.round(_g2 + (255 - _g2) * 0.5);
    const lightB = Math.round(_b2 + (255 - _b2) * 0.5);
    const donutCenter = document.getElementById('donut-center');
    if (donutCenter) donutCenter.style.color = `rgb(${lightR},${lightG},${lightB})`;
    const darkR = Math.round(_r2 * 0.5);
    const darkG = Math.round(_g2 * 0.5);
    const darkB = Math.round(_b2 * 0.5);
    const ppdEl = document.getElementById('ppd-circle');
    if (ppdEl) {
      ppdEl.style.background = `rgb(${darkR},${darkG},${darkB})`;
      ppdEl.style.color = color;
      ppdEl.style.boxShadow = `0 0 8px rgba(${rgb},0.5)`;
      ppdEl.style.textShadow = `0 0 8px rgba(${rgb},0.9), 2px 2px 0px rgba(0,0,0,0.6)`;
    }
    document.querySelectorAll('.counter-btn').forEach(btn => {
      btn.style.color = color;
      btn.style.borderColor = `rgba(${rgb},0.5)`;
    });
    document.querySelectorAll('input[type="number"]').forEach(el => {
      el.style.background = `rgb(${Math.round(_r*0.05)},${Math.round(_g*0.05)},${Math.round(_b*0.05)})`;
      el.style.borderColor = `rgba(${rgb},0.4)`;
    });
    document.querySelectorAll('.card-title').forEach(el => { el.style.color = color; });
    document.querySelectorAll('.results-title, .breakdown-title').forEach(el => { el.style.color = color; });
    document.querySelectorAll('.card, .medals-card').forEach(el => { el.style.borderColor = `rgba(${rgb},0.5)`; });
    document.querySelectorAll('.header-bar, .profile-section').forEach(el => {
      el.style.borderColor = `rgba(${rgb},0.5)`;
      el.style.background = `linear-gradient(135deg, rgb(${Math.round(_r*0.07)},${Math.round(_g*0.07)},${Math.round(_b*0.07)}) 0%, rgb(${Math.round(_r*0.05)},${Math.round(_g*0.05)},${Math.round(_b*0.05)}) 100%)`;
    });
    document.querySelectorAll('.results-card').forEach(el => {
      el.style.borderColor = color;
      el.style.background = `linear-gradient(135deg, rgb(${Math.round(_r*0.07)},${Math.round(_g*0.07)},${Math.round(_b*0.07)}) 0%, rgb(${Math.round(_r*0.05)},${Math.round(_g*0.05)},${Math.round(_b*0.05)}) 100%)`;
      el.style.boxShadow = `0 0 40px rgba(${rgb},0.08), inset 0 0 40px rgba(${rgb},0.03)`;
    });
    document.querySelectorAll('.divider').forEach(el => {
      el.style.background = `linear-gradient(90deg, transparent, rgba(${rgb},0.4), transparent)`;
    });
    document.querySelectorAll('.breakdown-separator').forEach(el => {
      el.style.borderTopColor = `rgba(${rgb},0.35)`;
    });
    const donutBg = document.getElementById('donut-bg-circle');
    if (donutBg) donutBg.setAttribute('stroke', `rgba(${rgb},0.15)`);
    window._userThemeRgb = rgb;
  }
  window.applyThemeColor = applyThemeColor;

  function showAvatarButtons() {
    const editBtn = document.getElementById('avatar-edit');
    const colorBtn = document.getElementById('avatar-color-btn');
    const img = document.getElementById('avatar-img');
    if (editBtn && img && img.style.display !== 'none') editBtn.style.display = 'flex';
    if (colorBtn) colorBtn.style.display = 'flex';
  }

  function hideAvatarButtons() {
    const editBtn = document.getElementById('avatar-edit');
    const colorBtn = document.getElementById('avatar-color-btn');
    if (editBtn) editBtn.style.display = 'none';
    if (colorBtn) colorBtn.style.display = 'none';
  }

  function changeAvatarBorder(color) {
    applyThemeColor(color);
    localStorage.setItem('atlas-avatar-border', color);
    if (window._fbUser && window._fbSaveAll) window._fbSaveAll();
  }

  // ‚úÖ FIX PRINCIPAL: loadAvatar ahora comprime la imagen Y sube a Firebase
  function loadAvatar(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      // Comprimir imagen a 200x200 JPEG 75% para no exceder l√≠mites de Firebase
      const tempImg = new Image();
      tempImg.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = 200;
        canvas.height = 200;
        const ctx = canvas.getContext('2d');

        // Recorte centrado (crop cuadrado)
        const size = Math.min(tempImg.width, tempImg.height);
        const offsetX = (tempImg.width - size) / 2;
        const offsetY = (tempImg.height - size) / 2;
        ctx.drawImage(tempImg, offsetX, offsetY, size, size, 0, 0, 200, 200);

        const compressed = canvas.toDataURL('image/jpeg', 0.75);

        // Actualizar UI
        const img = document.getElementById('avatar-img');
        const placeholder = document.getElementById('avatar-placeholder');
        const editBtn = document.getElementById('avatar-edit');
        const colorBtn = document.getElementById('avatar-color-btn');
        img.src = compressed;
        img.style.display = 'block';
        if (placeholder) placeholder.style.display = 'none';
        if (editBtn) editBtn.style.display = 'none';
        if (colorBtn) colorBtn.style.display = 'none';

        // Guardar en localStorage
        localStorage.setItem('atlas-avatar', compressed);

        // ‚úÖ FIX: Subir a Firebase inmediatamente despu√©s de guardar en localStorage
        if (window._fbUser && window._fbSaveAll) {
          setTimeout(window._fbSaveAll, 300);
        }
      };
      tempImg.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function adjustBadge() {
    const input = document.getElementById('username');
    const tmp = document.createElement('span');
    tmp.style.font = getComputedStyle(input).font;
    tmp.style.visibility = 'hidden';
    tmp.style.position = 'absolute';
    tmp.style.whiteSpace = 'pre';
    tmp.textContent = input.value || input.placeholder;
    document.body.appendChild(tmp);
    const w = Math.min(tmp.offsetWidth + 8, 320);
    document.body.removeChild(tmp);
    input.style.width = Math.max(w, 280) + 'px';
  }

  function saveUsername() {
    const name = document.getElementById('username').value;
    localStorage.setItem('atlas-username', name);
  }

  function saveStartDate() {
    const date = document.getElementById('start-date').value;
    localStorage.setItem('atlas-start-date', date);
  }

  async function loadProfile() {
    let name = localStorage.getItem('atlas-username') || '';
    if (name) { document.getElementById('username').value = name; adjustBadge(); }

    let avatar = localStorage.getItem('atlas-avatar') || '';
    if (avatar) {
      const img = document.getElementById('avatar-img');
      const placeholder = document.getElementById('avatar-placeholder');
      const editBtn = document.getElementById('avatar-edit');
      img.src = avatar;
      img.style.display = 'block';
      placeholder.style.display = 'none';
      editBtn.style.display = 'none';
      const colorBtn2 = document.getElementById('avatar-color-btn');
      if (colorBtn2) colorBtn2.style.display = 'none';
    }

    let borderColor = localStorage.getItem('atlas-avatar-border') || '';
    if (borderColor) {
      applyThemeColor(borderColor);
      document.getElementById('avatar-border-color').value = borderColor;
    }

    let startDate = localStorage.getItem('atlas-start-date') || '';
    if (startDate) document.getElementById('start-date').value = startDate;
  }

  function hayZoomActivo() {
    if (!window.visualViewport) return false;
    return window.visualViewport.scale > 1.05;
  }

  var userCountry = "";
  window.userCountry = "";

  var COUNTRY_MAP = {
    "m√©xico": "Mexico", "mexico": "Mexico",
    "estados unidos": "United States", "united states": "United States",
    "us": "United States", "usa": "United States",
    "espa√±a": "Spain", "spain": "Spain",
    "francia": "France", "france": "France",
    "alemania": "Germany", "germany": "Germany",
    "italia": "Italy", "italy": "Italy",
    "rusia": "Russia", "russia": "Russia",
  };

  function normalizarPais(name) {
    if (!name) return "";
    var lower = name.toLowerCase().trim();
    return COUNTRY_MAP[lower] || name;
  }

  function actualizarPais(countryName) {
    var pais = normalizarPais(countryName) || "";
    if (!pais) return;
    userCountry = pais; window.userCountry = pais;
    var spanMexico = document.querySelector('.mexico');
    if (spanMexico) { spanMexico.textContent = pais.toUpperCase(); spanMexico.style.color = '#7EC8E3'; }
    if (typeof calc === 'function') calc();
    if (typeof updateMedals === 'function') updateMedals();
    var intentos = 0;
    var retry = setInterval(function() {
      intentos++;
      if (window._fbSaveCountry) { clearInterval(retry); window._fbSaveCountry(pais); }
      else if (intentos >= 20)   { clearInterval(retry); }
    }, 500);
  }

  function actualizarCiudad(ciudad, estado) {
    if (!ciudad) return;
    var texto = ciudad + (estado ? ", " + estado : "");
    var el = document.getElementById("user-location");
    if (el) el.textContent = texto.toUpperCase();
    var intentos = 0;
    var retry = setInterval(function() {
      intentos++;
      if (window._fbSaveCity) { clearInterval(retry); window._fbSaveCity(texto); }
      else if (intentos >= 20) { clearInterval(retry); }
    }, 500);
  }

  async function ubicacionPorIP() {
    var elLoc = document.getElementById("user-location");
    if (elLoc && elLoc.textContent === "‚Äî") elLoc.textContent = "...";
    // APIs con soporte CORS compatible con GitHub Pages
    try {
      var r1 = await fetch("https://get.geojs.io/v1/ip/geo.json");
      var d1 = await r1.json();
      if (d1.country) actualizarPais(d1.country);
      if (d1.city && d1.region) { actualizarCiudad(d1.city, d1.region); return; }
    } catch(e) {}
    try {
      var r2 = await fetch("https://api.ip.sb/geoip");
      var d2 = await r2.json();
      if (d2.country) actualizarPais(d2.country);
      if (d2.city && d2.region) { actualizarCiudad(d2.city, d2.region); return; }
    } catch(e) {}
    try {
      var r3 = await fetch("https://ipapi.co/json/", { headers: { "Accept": "application/json" } });
      var d3 = await r3.json();
      if (d3.country_name) actualizarPais(d3.country_name);
      if (d3.city && d3.region) { actualizarCiudad(d3.city, d3.region); return; }
    } catch(e) {}
    if (elLoc && elLoc.textContent === "...") elLoc.textContent = "‚Äî";
  }

  setTimeout(ubicacionPorIP, 300);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        var lat = pos.coords.latitude;
        var lon = pos.coords.longitude;
        fetch("https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=" + lat + "&longitude=" + lon + "&localityLanguage=es")
          .then(function(res) { return res.json(); })
          .then(function(data) {
            var ciudad = data.city || data.locality || "";
            var estado = data.principalSubdivision || "";
            if (ciudad) actualizarCiudad(ciudad, estado);
            if (data.countryName) actualizarPais(data.countryName);
          })
          .catch(function() {
            fetch("https://nominatim.openstreetmap.org/reverse?lat=" + lat + "&lon=" + lon + "&format=json&accept-language=es")
              .then(function(r) { return r.json(); })
              .then(function(d) {
                var ciudad = d.address && (d.address.city || d.address.town || d.address.village || "");
                var estado = d.address && (d.address.state || "");
                var pais   = d.address && (d.address.country || "");
                if (ciudad) actualizarCiudad(ciudad, estado);
                if (pais)   actualizarPais(pais);
              }).catch(function() {});
          });
      },
      function() {}
    );
  }

  async function initVisitCounter() {
    const wrapper = document.createElement('div');
    wrapper.id = 'visit-wrapper';
    wrapper.innerHTML = `
      <span style="font-size:13px;opacity:0.7;">Powered by Socram13 üëÅ üëÅ</span>
      <span id="visit-count-display" style="font-family:'Nunito',sans-serif;font-weight:800;font-size:15px;color:var(--text2);letter-spacing:3px;background:var(--panel);border:2px solid var(--border);border-radius:10px;padding:3px 10px;">00000000</span>
    `;
    Object.assign(wrapper.style, {
      position: 'fixed', bottom: '14px', right: '18px', zIndex: '99999',
      display: 'flex', alignItems: 'center', gap: '8px',
      opacity: '0.55', transition: 'opacity 0.3s', cursor: 'default',
    });
    wrapper.onmouseenter = () => wrapper.style.opacity = '0.85';
    wrapper.onmouseleave = () => wrapper.style.opacity = '0.55';
    document.body.appendChild(wrapper);
    // Esperar a que Firebase est√© listo (m√°x 3s)
    await new Promise(resolve => {
      let tries = 0;
      const wait = setInterval(() => {
        tries++;
        if (window._fbDb && window._fbRef || tries > 30) { clearInterval(wait); resolve(); }
      }, 100);
    });
    try {
      const db  = window._fbDb;
      const ref = window._fbRef;
      const get = window._fbGet;
      if (!db || !ref || !get) throw new Error('Firebase no disponible');
      const visitsRef = ref(db, 'visits/total');
      const snap = await get(visitsRef);
      const current = snap.exists() ? (snap.val() || 0) : 0;
      const newCount = current + 1;
      // Usar set directo (tr√°fico m√≠nimo: 1 lectura + 1 escritura por visita)
      await window._fbSet(visitsRef, newCount);
      const el = document.getElementById('visit-count-display');
      if (el) el.textContent = String(newCount).padStart(8, '0');
    } catch(e) {
      const el = document.getElementById('visit-count-display');
      if (el) el.textContent = '--------';
    }
  }
  initVisitCounter();

  function checkZoomButtons() {
    const scale = window.visualViewport ? window.visualViewport.scale : 1;
    const zoomActivo = scale > 1.05;
    const btnShare = document.getElementById('btn-share-data');
    [btnShare].forEach(btn => {
      if (!btn) return;
      btn.disabled = zoomActivo;
      btn.style.setProperty('opacity', zoomActivo ? '0.35' : '1', 'important');
      btn.style.setProperty('cursor', zoomActivo ? 'not-allowed' : 'pointer', 'important');
      btn.style.setProperty('filter', zoomActivo ? 'grayscale(1)' : 'none', 'important');
    });
  }
  checkZoomButtons();
  setInterval(checkZoomButtons, 300);

  function isSafariIOS() {
    return /iP(hone|od|ad)/.test(navigator.userAgent) &&
           /WebKit/.test(navigator.userAgent) &&
           !window.MSStream;
  }

  const SAFARI_PALETTE_COLORS = [
    '#00c8ff','#4ade80','#facc15','#f97316',
    '#ef4444','#a855f7','#ec4899','#ffffff',
    '#94a3b8','#1e40af','#065f46','#7f1d1d'
  ];

  function toggleSafariColorPalette() {
    let palette = document.getElementById('safari-color-palette');
    if (palette) { palette.remove(); return; }
    palette = document.createElement('div');
    palette.id = 'safari-color-palette';
    palette.style.cssText = `
      position: fixed; z-index: 9999; bottom: 80px; left: 50%;
      transform: translateX(-50%); background: #1a1a2e;
      border: 1px solid rgba(255,255,255,0.15); border-radius: 16px;
      padding: 14px; display: grid; grid-template-columns: repeat(6, 36px);
      gap: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    `;
    SAFARI_PALETTE_COLORS.forEach(color => {
      const swatch = document.createElement('div');
      swatch.style.cssText = `width:36px;height:36px;border-radius:50%;background:${color};cursor:pointer;border:2px solid rgba(255,255,255,0.2);transition:transform 0.15s;`;
      swatch.addEventListener('click', function(e) {
        e.stopPropagation();
        changeAvatarBorder(color);
        document.getElementById('avatar-border-color').value = color;
        palette.remove();
      });
      palette.appendChild(swatch);
    });
    document.body.appendChild(palette);
    setTimeout(() => {
      document.addEventListener('pointerdown', function closePalette(e) {
        if (!palette.contains(e.target)) { palette.remove(); document.removeEventListener('pointerdown', closePalette); }
      });
    }, 100);
  }

</script>

  <div class="coin-toast" id="coin-toast">ü™ô +1 COIN GANADO</div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL MEDALLA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="medal-modal-overlay" id="medalModalOverlay" onclick="closeMedalModal()"></div>
  <div class="medal-modal" id="medalModal">
    <div class="medal-modal-handle"></div>
    <div class="medal-modal-header">
      <div class="medal-modal-icon" id="mmIcon"></div>
      <div class="medal-modal-info">
        <div class="medal-modal-name" id="mmName"></div>
        <div class="medal-modal-rarity" id="mmRarity"></div>
      </div>
    </div>
    <div class="medal-modal-divider"></div>
    <div class="medal-modal-section-label">¬øC√≥mo obtenerla?</div>
    <div class="medal-modal-desc" id="mmDesc"></div>
    <div id="mmCost" class="medal-modal-cost" style="display:none;"></div>
    <div class="medal-modal-status" id="mmStatus"></div>
  </div>
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIN MODAL MEDALLA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JS MEDALLAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <script>
    function toggleMedals() {
      const btn  = document.getElementById('medalsToggle');
      const body = document.getElementById('medalsBody');
      if (!btn || !body) return;
      btn.classList.toggle('open');
      body.classList.toggle('open');
    }

    /* ‚îÄ‚îÄ Fila de preview medallas (comprimida) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const RARITY_ORDER = ['legendary','epic','rare','common','coins'];

    function buildPreviewRow() {
      const row = document.getElementById('medalsPreviewRow');
      if (!row) return;

      const esMx = _esMexico();
      const earned = [];

      document.querySelectorAll('.mbadge[data-medal-id]').forEach(b => {
        const isShop   = b.classList.contains('m-coins');
        if (isShop && !esMx) return;
        const id       = b.dataset.medalId;
        const unlocked = isShop ? !!_ownedMedals[id] : isMedalEarned(id);
        if (!unlocked) return;

        let rarity = 'common';
        if (b.classList.contains('m-legendary')) rarity = 'legendary';
        else if (b.classList.contains('m-epic'))  rarity = 'epic';
        else if (b.classList.contains('m-rare'))  rarity = 'rare';
        else if (b.classList.contains('m-coins')) rarity = 'coins';

        // Obtener icono: imagen o emoji
        const iconEl = b.querySelector('.mbadge-icon');
        const img    = iconEl ? iconEl.querySelector('img') : null;
        const iconHTML = img
          ? `<img src="${img.src}" alt="" style="width:100%;height:100%;object-fit:contain;display:block;border-radius:5px;">`
          : (iconEl ? (iconEl.childNodes[0]?.textContent?.trim() || 'üèÖ') : 'üèÖ');

        const nameEl = b.querySelector('.mbadge-name');
        const name   = nameEl ? nameEl.textContent.trim() : '';

        earned.push({ rarity, iconHTML, name, isImg: !!img });
      });

      // Ordenar por rareza
      earned.sort((a, b) => RARITY_ORDER.indexOf(a.rarity) - RARITY_ORDER.indexOf(b.rarity));

      const MAX = 8;
      const shown = earned.slice(0, MAX);
      const extra = earned.length - MAX;

      row.innerHTML = shown.map(m => `
        <div class="mprev ${m.rarity}">
          <div class="mprev-icon">${m.iconHTML}</div>
          <div class="mprev-name">${m.name}</div>
        </div>`).join('') +
        (extra > 0 ? `<div class="mprev"><div class="mprev-more">+${extra}</div></div>` : '') +
        (earned.length === 0 ? '<span style="font-size:11px;color:var(--text2);letter-spacing:1px;font-family:Rajdhani,sans-serif;">Sin medallas a√∫n</span>' : '');
    }

    const _ownedMedals = {};

    /* ‚îÄ‚îÄ Leer valores actuales del gamertag ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function _getParcelas() {
      return {
        c: Number(document.getElementById('common')?.value)   || 0,
        r: Number(document.getElementById('rare')?.value)     || 0,
        e: Number(document.getElementById('epic')?.value)     || 0,
        l: Number(document.getElementById('legendary')?.value)|| 0,
      };
    }
    function _getCoins() {
      const txt = document.getElementById('coins-display')?.textContent || '0';
      return Number(txt.replace(/[^\d]/g, '')) || 0;
    }
    function _getLocation() {
      return (document.getElementById('user-location')?.textContent || '‚Äî').trim();
    }
    function _getStartDate() {
      return document.getElementById('start-date')?.value || '';
    }

    /* ‚îÄ‚îÄ Condiciones de cada medalla (por data-medal-id) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function isMedalEarned(id) {
      const p = _getParcelas();
      const total = p.c + p.r + p.e + p.l;
      const coins = _getCoins();
      const loc   = _getLocation();
      const sd    = _getStartDate();

      switch(id) {
        /* COMUNES */
        case 'explorador':       return total >= 1;
        case 'sembrador':        return total >= 25;
        case 'colono':           return total >= 50;
        case 'ubicado':          return loc !== '‚Äî' && loc !== '' && loc !== '...';
        case 'mexicano':         return (window.userCountry || '').toLowerCase().includes('mexico');
        case 'ahorrador':        return coins >= 50;
        case 'disciplinado':     return coins >= 100;
        case 'fundador':         return window.clanMember === true && sd !== '' && sd <= '2024-09-26';
        /* RARAS */
        case 'terrateniente':    return total >= 100;
        case 'urbanista':        return total >= 250;
        case 'constructor':      return total >= 500;
        case 'magnate':          return total >= 750;
        case 'globalizado':      return false; // requiere verificaci√≥n manual
        case 'campeon_local':    return false; // requiere verificaci√≥n manual
        case 'estratega':        return p.c >= 10 && p.r >= 5 && p.e >= 2;
        case 'visionario':       return total >= 1000;
        /* √âPICAS */
        case 'tormenta':         return total >= 1500;
        case 'guerrero':         return total >= 2000;
        case 'cazador_rarezas':  return p.r >= 100 || p.e >= 50;
        case 'imparable':        return total >= 2500;
        /* LEGENDARIAS */
        case 'titan':            return total >= 3000;
        case 'leyenda':          return total >= 4000;
        case 'emperador_supremo':return total >= 5000;
        case 'conquistador':     return total >= 6000;
        case 'dominio_absoluto': return total >= 7000;
        case 'dios_atlas':       return total >= 8000;
        case 'coleccionista_leg':return p.l >= 100;
        case 'portfolio_perfecto':return p.c >= 100 && p.r >= 75 && p.e >= 50 && p.l >= 25;
        case 'clan_aemx':         return window.clanMember === true;
        /* SHOP */
        default: return !!_ownedMedals[id];
      }
    }

    /* ‚îÄ‚îÄ Actualizar todos los estados y el contador ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function _esMexico() {
      const pais = (window.userCountry || _getLocation()).toLowerCase();
      return pais.includes('mexico') || pais.includes('m√©xico') || pais.includes('mx');
    }

    function updateMedals() {
      // ‚îÄ‚îÄ Visibilidad del SHOP seg√∫n pa√≠s ‚îÄ‚îÄ
      const shopSection = document.getElementById('medalShopSection');
      const shopBadges  = document.querySelectorAll('.mbadge.m-coins');
      const esMx = _esMexico();
      if (shopSection) shopSection.style.display = esMx ? '' : 'none';
      shopBadges.forEach(b => { b.style.display = esMx ? '' : 'none'; });

      const badges = document.querySelectorAll('.mbadge[data-medal-id]');
      let earned = 0;
      let total  = 0;

      badges.forEach(b => {
        // No contar medallas de shop si no es M√©xico
        if (b.classList.contains('m-coins') && !esMx) return;
        total++;

        const id       = b.dataset.medalId;
        const isShop   = b.classList.contains('m-coins');
        const unlocked = isShop ? !!_ownedMedals[id] : isMedalEarned(id);

        if (isShop) {
          const price = Number(b.dataset.price || 0);
          const coins = _getCoins();
          const owned = !!_ownedMedals[id];
          b.classList.toggle('m-owned',  owned);
          b.classList.toggle('m-locked', !owned && coins < price);
          const btn = b.querySelector('.mbadge-buy-btn');
          if (btn) btn.textContent = owned ? '‚úî TUYA' : `ü™ô ${price}`;
        } else {
          b.classList.toggle('m-locked', !unlocked);
        }

        if (unlocked) earned++;
      });

      const counter = document.getElementById('medalsCount');
      if (counter) counter.textContent = `${earned} / ${total}`;
      buildPreviewRow();
    }

    /* ‚îÄ‚îÄ Compra de medallas shop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function buyMedal(e, btn) {
      e.stopPropagation(); // no abrir modal al clickear el bot√≥n
      const badge = btn.closest('.mbadge.m-coins[data-medal-id]');
      if (!badge) return;
      const id    = badge.dataset.medalId;
      const price = Number(badge.dataset.price || 0);
      if (_ownedMedals[id]) { return; }
      const coins = _getCoins();
      if (coins < price) { alert(`‚ùå Coins insuficientes. Te faltan ${price - coins}.`); return; }
      if (!confirm(`¬øComprar esta medalla por ${price} coins?`)) return;
      _ownedMedals[id] = true;
      updateMedals();
    }

    document.addEventListener('click', (e) => {
      const badge = e.target.closest('.mbadge.m-coins[data-medal-id]');
      if (!badge) return;
      const id    = badge.dataset.medalId;
      const price = Number(badge.dataset.price || 0);
      if (_ownedMedals[id]) return;
      const coins = _getCoins();
      if (coins < price) return;
      if (!confirm(`¬øComprar esta medalla por ${price} coins?`)) return;
      _ownedMedals[id] = true;
      updateMedals();
    });

    /* ‚îÄ‚îÄ Observar cambios en coins, location, parcelas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const _coinsEl = document.getElementById('coins-display');
    if (_coinsEl) new MutationObserver(updateMedals).observe(_coinsEl, { childList: true, subtree: true, characterData: true });

    const _locEl = document.getElementById('user-location');
    if (_locEl) new MutationObserver(updateMedals).observe(_locEl, { childList: true, subtree: true, characterData: true });

    // Hook a los inputs de parcelas (se llama desde calc() que ya existe)
    ['common','rare','epic','legendary'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', updateMedals);
    });

    // Hook al input de fecha
    const _sdEl = document.getElementById('start-date');
    if (_sdEl) _sdEl.addEventListener('change', updateMedals);

    window.addEventListener('DOMContentLoaded', updateMedals);
    // Tambi√©n actualizar tras carga completa por si Firebase ya llen√≥ datos
    setTimeout(updateMedals, 1200);

    /* ‚îÄ‚îÄ Modal de detalle de medalla ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const RARITY_CONFIG = {
      'common':    { label: 'COM√öN',      color: '#4ade80',  bg: 'rgba(74,222,128,0.12)',  border: 'rgba(74,222,128,0.45)'  },
      'rare':      { label: 'RARA',       color: '#60a5fa',  bg: 'rgba(96,165,250,0.12)',  border: 'rgba(96,165,250,0.45)'  },
      'epic':      { label: '√âPICA',      color: '#c084fc',  bg: 'rgba(192,132,252,0.12)', border: 'rgba(192,132,252,0.45)' },
      'legendary': { label: 'LEGENDARIA', color: '#ffd700',  bg: 'rgba(255,215,0,0.12)',   border: 'rgba(255,215,0,0.45)'   },
      'coins':     { label: 'SHOP',       color: '#ffaa00',  bg: 'rgba(255,170,0,0.12)',   border: 'rgba(255,170,0,0.45)'   },
    };

    function getRarity(badge) {
      if (badge.classList.contains('m-common'))   return 'common';
      if (badge.classList.contains('m-rare'))     return 'rare';
      if (badge.classList.contains('m-epic'))     return 'epic';
      if (badge.classList.contains('m-legendary'))return 'legendary';
      if (badge.classList.contains('m-coins'))    return 'coins';
      return 'common';
    }

    function openMedalModal(badge) {
      const name  = badge.querySelector('.mbadge-tooltip-name')?.textContent || '';
      const desc  = badge.querySelector('.mbadge-tooltip-desc')?.textContent || '';
      const cost  = badge.querySelector('.mbadge-tooltip-cost')?.textContent || '';
      const rarity = getRarity(badge);
      const cfg   = RARITY_CONFIG[rarity];
      const mid   = badge.dataset.medalId;
      const isShop = rarity === 'coins';
      const earned = isShop ? !!_ownedMedals[mid] : (mid ? isMedalEarned(mid) : false);

      // √çcono
      const mmIcon = document.getElementById('mmIcon');
      const imgEl = badge.querySelector('.mbadge-icon img');
      if (imgEl) {
        mmIcon.innerHTML = `<img src="${imgEl.src}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:11px;display:block;">`;
      } else {
        const icon = badge.querySelector('.mbadge-icon')?.childNodes[0]?.textContent?.trim() || 'üèÖ';
        mmIcon.textContent = icon;
      }
      mmIcon.style.background = cfg.bg;
      mmIcon.style.borderColor = cfg.border;
      mmIcon.style.boxShadow   = `0 0 20px ${cfg.bg}`;

      // Nombre y rareza
      document.getElementById('mmName').textContent = name;
      const mmRarity = document.getElementById('mmRarity');
      mmRarity.textContent = cfg.label;
      mmRarity.style.color       = cfg.color;
      mmRarity.style.borderColor = cfg.border;
      mmRarity.style.background  = cfg.bg;

      // Descripci√≥n
      document.getElementById('mmDesc').textContent = desc;

      // Costo (solo shop)
      const mmCost = document.getElementById('mmCost');
      if (cost) { mmCost.textContent = cost; mmCost.style.display = 'block'; }
      else       { mmCost.style.display = 'none'; }

      // Estado
      const mmStatus = document.getElementById('mmStatus');
      if (earned) {
        mmStatus.textContent  = '‚úî MEDALLA OBTENIDA';
        mmStatus.className    = 'medal-modal-status earned';
      } else {
        mmStatus.textContent  = 'üîí A√öN NO DESBLOQUEADA';
        mmStatus.className    = 'medal-modal-status locked';
      }

      // Aplicar color del borde del modal al accent actual
      const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--glow').trim() || '#00c8ff';
      document.getElementById('medalModal').style.borderColor = `rgba(${hexToRgb(accentColor)},0.4)`;

      document.getElementById('medalModalOverlay').classList.add('open');
      document.getElementById('medalModal').classList.add('open');
    }

    function closeMedalModal() {
      document.getElementById('medalModalOverlay').classList.remove('open');
      document.getElementById('medalModal').classList.remove('open');
    }

    function hexToRgb(hex) {
      hex = hex.replace('#','');
      if (hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
      const n = parseInt(hex,16);
      return `${(n>>16)&255},${(n>>8)&255},${n&255}`;
    }

    // Tap/click en cualquier badge abre el modal
    document.addEventListener('click', (e) => {
      // Si es shop, no interceptar ‚Äî ya est√° manejado arriba para la compra
      const badge = e.target.closest('.mbadge[data-medal-id]');
      if (!badge) return;
      // Evitar abrir modal si es shop y se va a comprar
      if (badge.classList.contains('m-coins')) {
        // Si no es owned ni locked, dejamos que siga la compra ‚Äî pero igual mostramos el modal
        // Solo bloqueamos si ya la tiene (para que no duplique la alerta)
      }
      openMedalModal(badge);
    });

    // Cerrar con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeMedalModal();
    });

    // Swipe down para cerrar en m√≥vil
    (function() {
      let startY = 0;
      const modal = document.getElementById('medalModal');
      modal.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; }, { passive: true });
      modal.addEventListener('touchend', (e) => {
        const dy = e.changedTouches[0].clientY - startY;
        if (dy > 60) closeMedalModal(); // swipe abajo > 60px cierra
      }, { passive: true });
    })();
  </script>
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIN JS MEDALLAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <!-- CHAT WIDGET -->
  <button id="chat-fab" onclick="toggleChat()" aria-label="Abrir chat">
    <svg class="icon-chat" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>
    <svg class="icon-close" style="display:none" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
  </button>

  <div id="chat-iframe-container">
    <div id="chat-widget-bar">
      <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <span id="widget-time">--:--</span>
    </div>
    <iframe id="chat-frame" src="about:blank" title="Chat Atlas Earth M√©xico" allow="clipboard-write" allowfullscreen></iframe>
  </div>

  <script>
    let chatOpen = false;
    const chatFrame = document.getElementById('chat-frame');

    function toggleChat() {
      chatOpen = !chatOpen;
      document.getElementById('chat-iframe-container').classList.toggle('open', chatOpen);
      document.getElementById('chat-fab').classList.toggle('open', chatOpen);
      const visitWrapper = document.getElementById('visit-wrapper');
      if (visitWrapper) visitWrapper.style.display = chatOpen ? 'none' : '';
      if (window.innerWidth <= 480) {
        document.getElementById('chat-fab').style.display = chatOpen ? 'none' : 'flex';
      }
      if (chatOpen) {
        history.pushState({ chatOpen: true }, '');
        // ‚úÖ Solo carga el iframe la PRIMERA vez ‚Äî evita reinicios de Firebase
        const frame = document.getElementById('chat-frame');
        if (!frame.getAttribute('data-loaded')) {
          const username = localStorage.getItem('atlas-username') || '';
          const color = localStorage.getItem('atlas-avatar-border') || '';
          frame.src = `chat-firebase.html?username=${encodeURIComponent(username)}&color=${encodeURIComponent(color)}`;
          frame.setAttribute('data-loaded', '1');
        }
      }
    }

    function updateWidgetTime() {
      const now = new Date();
      document.getElementById('widget-time').textContent =
        String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
    }
    updateWidgetTime();
    setInterval(updateWidgetTime, 60000);
    window.addEventListener('message', (e) => { if (e.data && e.data.type === 'CLOSE_CHAT') closeChatWidget(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && chatOpen) closeChatWidget(); });

    function closeChatWidget() {
      chatOpen = false;
      document.getElementById('chat-iframe-container').classList.remove('open');
      document.getElementById('chat-fab').classList.remove('open');
      const visitWrapper = document.getElementById('visit-wrapper');
      if (visitWrapper) visitWrapper.style.display = '';
      if (window.innerWidth <= 480) document.getElementById('chat-fab').style.display = 'flex';
    }

    window.addEventListener('popstate', () => { if (chatOpen) closeChatWidget(); });
  </script>
</body>
</html>
