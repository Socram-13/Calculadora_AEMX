<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>AEMX · Editor de Marco</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#060b14; --panel:#0b1626; --border:#1a3a5c;
  --glow:#00c8ff; --glow2:#00ff9d; --text:#cce4ff; --text2:#6b8ab0;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  background:var(--bg); color:var(--text);
  font-family:'Rajdhani',sans-serif;
  min-height:100vh; display:flex; flex-direction:column;
  align-items:center; padding:24px 16px 48px; gap:20px;
}
body::before{
  content:''; position:fixed; top:0; right:0; bottom:0; left:0;
  background-image:
    linear-gradient(rgba(0,200,255,0.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,200,255,0.03) 1px,transparent 1px);
  background-size:40px 40px; pointer-events:none; z-index:0;
}
h1{
  font-family:'Orbitron',monospace; font-size:clamp(14px,3vw,20px);
  font-weight:900; letter-spacing:4px; color:var(--glow);
  text-shadow:0 0 20px rgba(0,200,255,0.5); position:relative; z-index:1;
}
h1 span{color:#facc15;}

/* ── Controls ── */
.controls{
  display:flex; gap:14px; flex-wrap:wrap; justify-content:center;
  background:var(--panel); border:1px solid var(--border);
  border-radius:14px; padding:16px 20px; position:relative; z-index:1;
  max-width:620px; width:100%;
}
.ctrl-block{
  display:flex; flex-direction:column; align-items:center; gap:8px;
  padding:10px 14px; border-radius:10px;
  border:1px solid var(--border); background:rgba(0,200,255,0.03);
  min-width:130px;
}
.ctrl-title{
  font-family:'Orbitron',monospace; font-size:8px;
  letter-spacing:2px; color:var(--glow); text-transform:uppercase;
}
.ctrl-row{display:flex; align-items:center; gap:10px;}
.ctrl-label{font-size:9px; color:var(--text2); letter-spacing:1px; font-family:'Orbitron',monospace;}
input[type="color"]{
  width:38px; height:38px; border-radius:8px;
  border:2px solid var(--border); background:none; cursor:pointer; padding:2px;
}
input[type="color"]:hover{border-color:var(--glow);}
input[type="range"]{width:90px; accent-color:var(--glow);}
.range-val{font-size:10px; color:var(--text2); font-family:monospace; min-width:24px; text-align:right;}
.divider{width:1px; height:80px; background:var(--border); align-self:center;}

/* ── Buttons ── */
.btn-row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; position:relative; z-index:1;}
.btn{
  font-family:'Orbitron',monospace; font-size:9px; font-weight:700;
  letter-spacing:2px; padding:9px 18px; border-radius:8px;
  border:1px solid var(--glow); background:rgba(0,200,255,0.08);
  color:var(--glow); cursor:pointer; transition:all 0.2s; white-space:nowrap;
}
.btn:hover{background:var(--glow); color:#060b14; box-shadow:0 0 20px rgba(0,200,255,0.4);}
.btn.upload{border-color:#facc15; color:#facc15; background:rgba(250,204,21,0.08);}
.btn.upload:hover{background:#facc15; color:#060b14;}
.btn.download{border-color:var(--glow2); color:var(--glow2); background:rgba(0,255,157,0.08);}
.btn.download:hover{background:var(--glow2); color:#060b14;}

/* ── Canvas editor ── */
.editor-outer{
  position:relative; width:min(500px,92vw); height:min(500px,92vw);
  z-index:1; flex-shrink:0;
}
.corner{
  position:absolute; width:18px; height:18px;
  border-color:var(--glow); border-style:solid;
  opacity:0.5; pointer-events:none; z-index:10;
  transition:opacity 0.2s;
}
.editor-outer:hover .corner{ opacity:1; }
.corner.tl{ top:-6px;    left:-6px;  border-width:2px 0 0 2px; border-radius:3px 0 0 0;}
.corner.tr{ top:-6px;    right:-6px; border-width:2px 2px 0 0; border-radius:0 3px 0 0;}
.corner.bl{ bottom:-6px; left:-6px;  border-width:0 0 2px 2px; border-radius:0 0 0 3px;}
.corner.br{ bottom:-6px; right:-6px; border-width:0 2px 2px 0; border-radius:0 0 3px 0;}
.editor-wrap{
  position:relative; width:100%; height:100%;
  border-radius:50%; overflow:hidden;
  box-shadow:0 0 60px rgba(0,200,255,0.15), 0 20px 60px rgba(0,0,0,0.8);
  cursor:pointer;
  touch-action:none; /* iOS: previene scroll/zoom del sistema durante pan/pinch */
  -webkit-user-select:none; user-select:none;
}
.editor-wrap.dragover{outline:2px dashed var(--glow); outline-offset:4px;}
.layer{position:absolute; top:0; right:0; bottom:0; left:0; width:100%; height:100%;}
#photo-layer{
  background:#0d0d0d;
  display:flex; align-items:center; justify-content:center;
}
#photo-layer img{
  position:absolute; width:100%; height:100%; object-fit:cover;
  transform-origin:center center;
  cursor:grab; -webkit-user-select:none; user-select:none; -webkit-user-drag:none;
}
#photo-layer img:active{ cursor:grabbing; }
.upload-hint{
  display:flex; flex-direction:column; align-items:center; gap:8px;
  pointer-events:none; opacity:0.35; z-index:1;
}
.upload-hint svg{width:40px; height:40px; opacity:.6;}
.upload-hint p{
  font-family:'Orbitron',monospace; font-size:9px;
  letter-spacing:2px; color:var(--text2); text-align:center;
}
/* frame layers — canvas tint */
#layer1-canvas, #layer2-canvas{
  position:absolute; top:0; right:0; bottom:0; left:0; width:100%; height:100%;
  pointer-events:none;
}
#layer1-canvas{z-index:2;}
#layer2-canvas{z-index:3;}
/* logo layer — top, no tint */
#logo-layer{
  position:absolute; top:0; right:0; bottom:0; left:0; width:100%; height:100%;
  pointer-events:none; z-index:4;
  display:flex; align-items:flex-start; justify-content:center;
  padding-top:0;
}
#logo-layer img{
  width:100%; height:100%;
  object-fit:cover; pointer-events:none;
}

.hint{font-size:11px; color:var(--text2); letter-spacing:1px; position:relative; z-index:1; text-align:center;}

/* ── Zoom controls ── */
.zoom-bar{
  display:none; align-items:center; gap:12px;
  background:var(--panel); border:1px solid var(--border);
  border-radius:10px; padding:10px 16px;
  position:relative; z-index:1;
}
.zoom-bar .ctrl-label{ font-size:9px; color:var(--text2); letter-spacing:1px; font-family:'Orbitron',monospace; }
.zoom-bar input[type=range]{ width:120px; accent-color:var(--glow); }
.zoom-bar .range-val{ font-size:10px; color:var(--text2); font-family:monospace; min-width:36px; }
.zoom-bar .btn{ font-size:8px; padding:5px 10px; }

/* ── Access overlay ── */
#accessOverlay{
  display:none; position:fixed; top:0; right:0; bottom:0; left:0; z-index:99999;
  background:rgba(6,11,20,0.97);
  align-items:center; justify-content:center; flex-direction:column; gap:24px;
  -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px);
}
.access-box{
  background:var(--panel); border:1px solid var(--border);
  border-radius:18px; padding:36px 32px; max-width:360px; width:90%;
  display:flex; flex-direction:column; align-items:center; gap:20px;
  box-shadow:0 0 60px rgba(0,200,255,0.12);
}
.access-logo{
  font-family:'Orbitron',monospace; font-size:22px; font-weight:900;
  color:var(--glow); text-shadow:0 0 20px rgba(0,200,255,0.5);
  letter-spacing:4px;
}
.access-logo span{color:#facc15;}
.access-msg{
  font-family:'Rajdhani',sans-serif; font-size:14px; letter-spacing:1px;
  color:var(--text2); text-align:center; line-height:1.6;
}
#btnLoginGoogle{
  display:none; align-items:center; gap:10px;
  font-family:'Orbitron',monospace; font-size:10px; font-weight:700;
  letter-spacing:2px; padding:12px 22px; border-radius:10px;
  border:1px solid var(--glow); background:rgba(0,200,255,0.08);
  color:var(--glow); cursor:pointer; transition:all 0.2s;
}
#btnLoginGoogle:hover{background:var(--glow); color:#060b14; box-shadow:0 0 20px rgba(0,200,255,0.4);}
#btnLoginGoogle svg{width:18px; height:18px; flex-shrink:0;}
.btn-back{
  position:fixed; top:12px; right:12px; z-index:99998;
  background:#111; color:#fff; border:none;
  padding:10px 14px; border-radius:10px;
  font-size:14px; line-height:1; cursor:pointer; opacity:.92;
}
.btn-back:active{transform:scale(.97);}
</style>

<!-- Firebase Auth -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyB-xx2PlBjvnHe0K7Bf1MspVqUlfjky0mk",
    authDomain: "aemx-chat.firebaseapp.com",
    databaseURL: "https://aemx-chat-default-rtdb.firebaseio.com",
    projectId: "aemx-chat",
    storageBucket: "aemx-chat.firebasestorage.app",
    messagingSenderId: "267113002594",
    appId: "1:267113002594:web:4099e7537d950f5753433b"
  };

  const app      = initializeApp(firebaseConfig);
  const auth     = getAuth(app);
  const database = getDatabase(app);

  const overlay  = document.getElementById('accessOverlay');
  const msgEl    = document.getElementById('accessMsg');
  const btnLogin = document.getElementById('btnLoginGoogle');

  overlay.style.display = 'flex';

  async function verificar(user) {
    if (!user) {
      msgEl.textContent = 'Debes iniciar sesión para acceder al editor de marco.';
      btnLogin.style.display = 'flex';
      return;
    }
    try {
      const snap = await get(ref(database, 'users/' + user.uid));
      const data = snap.exists() ? snap.val() : {};
      const esMiembro = data.clanMember === true || data.role === 'admin' || data.role === 'moderator';
      if (esMiembro) {
        overlay.style.display = 'none';
      } else {
        btnLogin.style.display = 'none';
        msgEl.textContent = '⛔ Solo los miembros del clan AEMX pueden acceder a esta página.';
      }
    } catch(e) {
      msgEl.textContent = '⛔ Error al verificar acceso. Intenta de nuevo.';
    }
  }

  onAuthStateChanged(auth, verificar);

  window._googleLogin = async function() {
    try {
      await signInWithPopup(auth, new GoogleAuthProvider());
    } catch(e) {
      msgEl.textContent = 'Error al iniciar sesión. Intenta de nuevo.';
    }
  };
</script>

</head>
<body>

<!-- Access Overlay -->
<div id="accessOverlay">
  <div class="access-box">
    <div class="access-logo">AEMX · <span>EDITOR</span></div>
    <p class="access-msg" id="accessMsg">Verificando acceso...</p>
    <button id="btnLoginGoogle" onclick="window._googleLogin()">
      <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.7 32.7 29.2 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.8 1.1 7.9 2.9l5.7-5.7C34.5 7.1 29.5 5 24 5 13 5 4 14 4 25s9 20 20 20 20-9 20-20c0-1.3-.1-2.6-.4-3.8z"/><path fill="#FF3D00" d="M6.3 15.2l6.6 4.8C14.5 17 19 14 24 14c3.1 0 5.8 1.1 7.9 2.9l5.7-5.7C34.5 7.1 29.5 5 24 5 16.3 5 9.7 9.1 6.3 15.2z"/><path fill="#4CAF50" d="M24 45c5.2 0 9.9-1.9 13.5-5.1l-6.2-5.2C29.4 36.6 26.8 38 24 38c-5.2 0-9.6-3.3-11.3-7.9l-6.5 5C9.6 41.1 16.3 45 24 45z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-.8 2.3-2.3 4.2-4.3 5.6l6.2 5.2C43.1 36.1 44 31 44 25c0-1.5-.1-3-.4-4.5z"/></svg>
      INICIAR CON GOOGLE
    </button>
  </div>
</div>

<!-- Back button -->
<button class="btn-back" onclick="window.history.length>1?window.history.back():window.location.href='index.html'">✕</button>

<h1>AEMX · <span>EDITOR DE MARCO</span></h1>

<!-- Controls -->
<div class="controls">

  <!-- Capa 1: anillo oscuro -->
  <div class="ctrl-block">
    <div class="ctrl-title">⬤ Anillo oscuro</div>
    <div class="ctrl-row">
      <span class="ctrl-label">COLOR</span>
      <input type="color" id="color1" value="#00c8ff"/>
    </div>
    <div class="ctrl-row">
      <span class="ctrl-label">INTENSIDAD</span>
      <input type="range" id="int1" min="0" max="100" value="60"/>
      <span class="range-val" id="int1-val">60</span>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Capa 2: anillo metálico -->
  <div class="ctrl-block">
    <div class="ctrl-title">◯ Anillo metálico</div>
    <div class="ctrl-row">
      <span class="ctrl-label">COLOR</span>
      <input type="color" id="color2" value="#ffffff"/>
    </div>
    <div class="ctrl-row">
      <span class="ctrl-label">INTENSIDAD</span>
      <input type="range" id="int2" min="0" max="100" value="50"/>
      <span class="range-val" id="int2-val">50</span>
    </div>
  </div>

</div>

<!-- Buttons -->
<div class="btn-row">
  <label class="btn upload" style="cursor:pointer;">
    ↑ SUBIR FOTO
    <input type="file" id="photo-input" accept="image/*" style="display:none;"/>
  </label>
  <button class="btn download" onclick="descargar()">↓ DESCARGAR</button>
</div>

<!-- Editor -->
<div class="editor-outer">
  <div class="corner tl"></div>
  <div class="corner tr"></div>
  <div class="corner bl"></div>
  <div class="corner br"></div>
  <div class="editor-wrap" id="editor-wrap">
  <!-- Capa 0: foto usuario -->
  <div class="layer" id="photo-layer">
    <div class="upload-hint" id="upload-hint">
      <svg viewBox="0 0 24 24" fill="none" stroke="#6b8ab0" stroke-width="1.5">
        <path d="M12 16V8m0 0-3 3m3-3 3 3"/><rect x="3" y="3" width="18" height="18" rx="3"/>
      </svg>
      <p>TOCA PARA<br/>SUBIR FOTO</p>
    </div>
  </div>
  <!-- Capa 1: anillo oscuro -->
  <canvas id="layer1-canvas"></canvas>
  <!-- Capa 2: anillo metálico -->
  <canvas id="layer2-canvas"></canvas>
  <!-- Capa 3: logo fijo -->
  <div class="layer" id="logo-layer">
    <img id="logo-img" src="" alt="AEMX Logo" crossorigin="anonymous"/>
  </div>
  </div>
</div>

<!-- Zoom controls (visible solo con foto) -->
<div class="zoom-bar" id="zoom-bar">
  <span class="ctrl-label">↔ ZOOM</span>
  <input type="range" id="zoom-slider" min="100" max="300" value="100" step="1"/>
  <span class="range-val" id="zoom-val">100%</span>
  <button class="btn" id="zoom-reset">↺ RESET</button>
</div>

<p class="hint" id="main-hint">Toca el círculo para subir tu foto · Arrastra también funciona</p>

<script>
// ── URLs de GitHub ────────────────────────────────────────────────────────────
const LAYER1_SRC = 'https://raw.githubusercontent.com/socram-13/GamerTag_AEMX/main/marco_oscuro.png';
const LAYER2_SRC = 'https://raw.githubusercontent.com/socram-13/GamerTag_AEMX/main/marco_metalico.png';
const LAYER3_SRC = 'https://raw.githubusercontent.com/socram-13/GamerTag_AEMX/main/marco_logo.png';

document.getElementById('logo-img').src = LAYER3_SRC;

// ── Sistema de colorización por multiplicación de píxeles ────────────────────
// Guarda la ImageData original de cada capa para no perderla al re-renderizar
const layerData = { 1: null, 2: null };
const layerImg  = { 1: new Image(), 2: new Image() };
layerImg[1].crossOrigin = 'anonymous';
layerImg[2].crossOrigin = 'anonymous';

// Convierte hex "#rrggbb" a {r,g,b} 0-255
function hexToRgb(hex) {
  return {
    r: parseInt(hex.slice(1,3), 16),
    g: parseInt(hex.slice(3,5), 16),
    b: parseInt(hex.slice(5,7), 16)
  };
}

// Samplea el color dominante del PNG original (píxeles saturados)
function sampleDominantColor(imgEl) {
  const c = document.createElement('canvas');
  c.width = c.height = 128;
  const ctx = c.getContext('2d');
  ctx.drawImage(imgEl, 0, 0, 128, 128);
  const data = ctx.getImageData(0, 0, 128, 128).data;
  let r = 0, g = 0, b = 0, count = 0;
  for (let i = 0; i < data.length; i += 4) {
    if (data[i+3] < 128) continue;
    const ri = data[i], gi = data[i+1], bi = data[i+2];
    const max = Math.max(ri,gi,bi), min = Math.min(ri,gi,bi);
    const sat = max === 0 ? 0 : (max - min) / max;
    const lum = (ri + gi + bi) / 3;
    if (sat > 0.30 && lum > 30 && lum < 240) {
      r += ri*sat; g += gi*sat; b += bi*sat; count += sat;
    }
  }
  if (!count) return '#888888';
  return '#' + [r,g,b].map(v => Math.round(v/count).toString(16).padStart(2,'0')).join('');
}

// Aplica colorización por píxel al canvas de la capa
// Técnica: luminancia del pixel original × color elegido (colorize real)
// intensity 0-100: mezcla entre original y colorizado
function applyTint(layerNum, hexColor, intensity) {
  const canvas = document.getElementById('layer' + layerNum + '-canvas');
  const orig   = layerData[layerNum];
  if (!orig) return;

  const w = orig.width, h = orig.height;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');

  const tint  = hexToRgb(hexColor);
  const mix   = intensity / 100; // 0.0 → original, 1.0 → colorizado

  // Copia mutable de la data original
  const src = orig.data;
  const out = ctx.createImageData(w, h);
  const dst = out.data;

  for (let i = 0; i < src.length; i += 4) {
    const ro = src[i], go = src[i+1], bo = src[i+2], ao = src[i+3];
    // Luminancia perceptual del pixel original (0-255)
    const lum = 0.299*ro + 0.587*go + 0.114*bo;
    const l   = lum / 255;
    // Pixel colorizado = luminancia × color del picker
    const cr = l * tint.r;
    const cg = l * tint.g;
    const cb = l * tint.b;
    // Mezcla lineal entre original y colorizado
    dst[i]   = Math.round(ro + (cr - ro) * mix);
    dst[i+1] = Math.round(go + (cg - go) * mix);
    dst[i+2] = Math.round(bo + (cb - bo) * mix);
    dst[i+3] = ao; // preservar alpha original
  }
  ctx.putImageData(out, 0, 0);
}

function render1() {
  const color = document.getElementById('color1').value;
  const int   = parseInt(document.getElementById('int1').value);
  applyTint(1, color, int);
}

function render2() {
  const color = document.getElementById('color2').value;
  const int   = parseInt(document.getElementById('int2').value);
  applyTint(2, color, int);
}

// Cargar PNG → guardar ImageData original → init picker → render
function loadLayer(num, src) {
  const img = layerImg[num];
  img.onload = () => {
    // Capturar ImageData original a resolución completa
    const c = document.createElement('canvas');
    c.width = img.naturalWidth; c.height = img.naturalHeight;
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0);
    layerData[num] = ctx.getImageData(0, 0, c.width, c.height);
    // Sincronizar picker con color real del PNG
    document.getElementById('color' + num).value = sampleDominantColor(img);
    // Primer render
    num === 1 ? render1() : render2();
  };
  img.src = src;
}

loadLayer(1, LAYER1_SRC);
loadLayer(2, LAYER2_SRC);

// ── Events ───────────────────────────────────────────────────────────────────
document.getElementById('color1').addEventListener('input', render1);
document.getElementById('color2').addEventListener('input', render2);

['int1','int2'].forEach(id => {
  document.getElementById(id).addEventListener('input', () => {
    document.getElementById(id+'-val').textContent = document.getElementById(id).value;
    id === 'int1' ? render1() : render2();
  });
});

// ── Photo upload + Zoom/Pan ───────────────────────────────────────────────────
let photoState = { zoom: 1, x: 0, y: 0 };

function applyPhotoTransform() {
  const img = document.querySelector('#photo-layer img');
  if (!img) return;
  img.style.transform = `translate(${photoState.x}px, ${photoState.y}px) scale(${photoState.zoom})`;
  document.getElementById('zoom-slider').value = Math.round(photoState.zoom * 100);
  document.getElementById('zoom-val').textContent = Math.round(photoState.zoom * 100) + '%';
}

function loadPhoto(file) {
  if (!file || !file.type.startsWith('image/')) return;
  const url = URL.createObjectURL(file);
  const img = document.createElement('img');
  img.src = url;
  const layer = document.getElementById('photo-layer');
  layer.querySelectorAll('img').forEach(el => el.remove());
  document.getElementById('upload-hint').style.display = 'none';
  layer.appendChild(img);
  // Resetear estado y mostrar controles
  photoState = { zoom: 1, x: 0, y: 0 };
  applyPhotoTransform();
  document.getElementById('zoom-bar').style.display = 'flex';
  document.getElementById('main-hint').textContent = 'Arrastra para mover · Scroll o slider para zoom';
}

// ── Zoom slider ───────────────────────────────────────────────────────────────
document.getElementById('zoom-slider').addEventListener('input', e => {
  photoState.zoom = parseInt(e.target.value) / 100;
  document.getElementById('zoom-val').textContent = e.target.value + '%';
  applyPhotoTransform();
});
document.getElementById('zoom-reset').addEventListener('click', () => {
  photoState = { zoom: 1, x: 0, y: 0 };
  applyPhotoTransform();
});

// ── Drag para mover (mouse) ───────────────────────────────────────────────────
let drag = { active: false, startX: 0, startY: 0, originX: 0, originY: 0, moved: false };

const wrap = document.getElementById('editor-wrap');

wrap.addEventListener('mousedown', e => {
  if (!document.querySelector('#photo-layer img')) return;
  drag = { active: true, startX: e.clientX, startY: e.clientY,
           originX: photoState.x, originY: photoState.y, moved: false };
  e.preventDefault();
});
window.addEventListener('mousemove', e => {
  if (!drag.active) return;
  const dx = e.clientX - drag.startX, dy = e.clientY - drag.startY;
  if (Math.abs(dx) > 3 || Math.abs(dy) > 3) drag.moved = true;
  photoState.x = drag.originX + dx;
  photoState.y = drag.originY + dy;
  applyPhotoTransform();
});
window.addEventListener('mouseup', e => {
  if (!drag.active) return;
  const wasMoved = drag.moved;
  drag.active = false;
  // Si no hubo movimiento real → abrir file picker (click normal)
  if (!wasMoved && !document.querySelector('#photo-layer img')) {
    document.getElementById('photo-input').click();
  }
});

// ── Scroll para zoom ──────────────────────────────────────────────────────────
wrap.addEventListener('wheel', e => {
  if (!document.querySelector('#photo-layer img')) return;
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.05 : 0.05;
  photoState.zoom = Math.min(3, Math.max(1, photoState.zoom + delta));
  applyPhotoTransform();
}, { passive: false });

// ── Touch: pan + pinch zoom ───────────────────────────────────────────────────
let touch = { last: null, lastDist: null };

wrap.addEventListener('touchstart', e => {
  if (!document.querySelector('#photo-layer img')) return;
  if (e.touches.length === 1) {
    touch.last = { x: e.touches[0].clientX, y: e.touches[0].clientY,
                   ox: photoState.x, oy: photoState.y };
    touch.lastDist = null;
  } else if (e.touches.length === 2) {
    touch.lastDist = Math.hypot(
      e.touches[1].clientX - e.touches[0].clientX,
      e.touches[1].clientY - e.touches[0].clientY
    );
    touch.lastZoom = photoState.zoom;
  }
}, { passive: true });

wrap.addEventListener('touchmove', e => {
  if (!document.querySelector('#photo-layer img')) return;
  e.preventDefault();
  if (e.touches.length === 1 && touch.last) {
    photoState.x = touch.last.ox + (e.touches[0].clientX - touch.last.x);
    photoState.y = touch.last.oy + (e.touches[0].clientY - touch.last.y);
    applyPhotoTransform();
  } else if (e.touches.length === 2 && touch.lastDist) {
    const dist = Math.hypot(
      e.touches[1].clientX - e.touches[0].clientX,
      e.touches[1].clientY - e.touches[0].clientY
    );
    photoState.zoom = Math.min(3, Math.max(1, touch.lastZoom * (dist / touch.lastDist)));
    applyPhotoTransform();
  }
}, { passive: false });

wrap.addEventListener('touchend',   () => { touch.last = null; touch.lastDist = null; touch.lastZoom = null; });
wrap.addEventListener('touchcancel', () => { touch.last = null; touch.lastDist = null; touch.lastZoom = null; });

// ── Click para subir (solo si no hay foto y no hubo drag) ─────────────────────
wrap.addEventListener('click', e => {
  if (drag.moved) return; // fue un pan, no un click
  if (document.querySelector('#photo-layer img')) return; // ya hay foto
  if (e.target.closest('#logo-layer')) return;
  document.getElementById('photo-input').click();
});

document.getElementById('photo-input').addEventListener('change', e => loadPhoto(e.target.files[0]));
wrap.addEventListener('dragover', e => { e.preventDefault(); wrap.classList.add('dragover'); });
wrap.addEventListener('dragleave', () => wrap.classList.remove('dragover'));
wrap.addEventListener('drop', e => { e.preventDefault(); wrap.classList.remove('dragover'); loadPhoto(e.dataTransfer.files[0]); });

// ── Download: composite all layers ──────────────────────────────────────────
// Las capas 1 y 2 ya son canvas con la colorización aplicada —
// se dibujan directamente sin filtros adicionales.
function descargar() {
  const size = 1024;
  const tmp  = document.createElement('canvas');
  tmp.width = tmp.height = size;
  const tCtx = tmp.getContext('2d');
  tCtx.clearRect(0, 0, size, size);

  // Layer 0: foto del usuario con zoom/pan
  const photoImg = document.querySelector('#photo-layer img');
  if (photoImg) {
    const nw = photoImg.naturalWidth, nh = photoImg.naturalHeight;
    const baseScale = Math.max(size / nw, size / nh);
    const bw = nw * baseScale, bh = nh * baseScale;
    const previewSize = document.getElementById('editor-wrap').offsetWidth;
    const ratio = size / previewSize;
    const fw = bw * photoState.zoom, fh = bh * photoState.zoom;
    const fx = (size - fw) / 2 + photoState.x * ratio;
    const fy = (size - fh) / 2 + photoState.y * ratio;
    tCtx.drawImage(photoImg, fx, fy, fw, fh);
  }

  // Layer 1 y 2: canvas ya colorizados, escalar a 1024x1024
  ['layer1-canvas', 'layer2-canvas'].forEach(id => {
    const c = document.getElementById(id);
    if (c && c.width) tCtx.drawImage(c, 0, 0, size, size);
  });

  // Layer 3: logo fijo
  const logoImg = document.getElementById('logo-img');
  if (logoImg.complete && logoImg.naturalWidth) {
    tCtx.drawImage(logoImg, 0, 0, size, size);
  }

  const dataUrl = tmp.toDataURL('image/png');
  // iOS Safari: <a download> no funciona — abre en nueva pestaña para guardar
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  if (isIOS) {
    window.open(dataUrl, '_blank');
  } else {
    const link = document.createElement('a');
    link.download = 'AEMX_marco.png';
    link.href = dataUrl;
    link.click();
  }
}
</script>

</body>
</html>