<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>AEMX · Editor de Marco</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#060b14; --panel:#0b1626; --border:#1a3a5c;
  --glow:#00c8ff; --glow2:#00ff9d; --text:#cce4ff; --text2:#6b8ab0;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  background:var(--bg); color:var(--text);
  font-family:'Rajdhani',sans-serif;
  min-height:100vh; display:flex; flex-direction:column;
  align-items:center; padding:24px 16px 48px; gap:20px;
}
body::before{
  content:''; position:fixed; inset:0;
  background-image:
    linear-gradient(rgba(0,200,255,0.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,200,255,0.03) 1px,transparent 1px);
  background-size:40px 40px; pointer-events:none; z-index:0;
}
h1{
  font-family:'Orbitron',monospace; font-size:clamp(14px,3vw,20px);
  font-weight:900; letter-spacing:4px; color:var(--glow);
  text-shadow:0 0 20px rgba(0,200,255,0.5); position:relative; z-index:1;
}
h1 span{color:#facc15;}

/* ── Controls ── */
.controls{
  display:flex; gap:14px; flex-wrap:wrap; justify-content:center;
  background:var(--panel); border:1px solid var(--border);
  border-radius:14px; padding:16px 20px; position:relative; z-index:1;
  max-width:620px; width:100%;
}
.ctrl-block{
  display:flex; flex-direction:column; align-items:center; gap:8px;
  padding:10px 14px; border-radius:10px;
  border:1px solid var(--border); background:rgba(0,200,255,0.03);
  min-width:130px;
}
.ctrl-title{
  font-family:'Orbitron',monospace; font-size:8px;
  letter-spacing:2px; color:var(--glow); text-transform:uppercase;
}
.ctrl-row{display:flex; align-items:center; gap:10px;}
.ctrl-label{font-size:9px; color:var(--text2); letter-spacing:1px; font-family:'Orbitron',monospace;}
input[type="color"]{
  width:38px; height:38px; border-radius:8px;
  border:2px solid var(--border); background:none; cursor:pointer; padding:2px;
}
input[type="color"]:hover{border-color:var(--glow);}
input[type="range"]{width:90px; accent-color:var(--glow);}
.range-val{font-size:10px; color:var(--text2); font-family:monospace; min-width:24px; text-align:right;}
.divider{width:1px; height:80px; background:var(--border); align-self:center;}

/* ── Buttons ── */
.btn-row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; position:relative; z-index:1;}
.btn{
  font-family:'Orbitron',monospace; font-size:9px; font-weight:700;
  letter-spacing:2px; padding:9px 18px; border-radius:8px;
  border:1px solid var(--glow); background:rgba(0,200,255,0.08);
  color:var(--glow); cursor:pointer; transition:all 0.2s; white-space:nowrap;
}
.btn:hover{background:var(--glow); color:#060b14; box-shadow:0 0 20px rgba(0,200,255,0.4);}
.btn.upload{border-color:#facc15; color:#facc15; background:rgba(250,204,21,0.08);}
.btn.upload:hover{background:#facc15; color:#060b14;}
.btn.download{border-color:var(--glow2); color:var(--glow2); background:rgba(0,255,157,0.08);}
.btn.download:hover{background:var(--glow2); color:#060b14;}

/* ── Canvas editor ── */
.editor-outer{
  position:relative; width:min(500px,92vw); height:min(500px,92vw);
  z-index:1; flex-shrink:0;
}
.corner{
  position:absolute; width:18px; height:18px;
  border-color:var(--glow); border-style:solid;
  opacity:0.5; pointer-events:none; z-index:10;
  transition:opacity 0.2s;
}
.editor-outer:hover .corner{ opacity:1; }
.corner.tl{ top:-6px;    left:-6px;  border-width:2px 0 0 2px; border-radius:3px 0 0 0;}
.corner.tr{ top:-6px;    right:-6px; border-width:2px 2px 0 0; border-radius:0 3px 0 0;}
.corner.bl{ bottom:-6px; left:-6px;  border-width:0 0 2px 2px; border-radius:0 0 0 3px;}
.corner.br{ bottom:-6px; right:-6px; border-width:0 2px 2px 0; border-radius:0 0 3px 0;}
.editor-wrap{
  position:relative; width:100%; height:100%;
  border-radius:50%; overflow:hidden;
  box-shadow:0 0 60px rgba(0,200,255,0.15), 0 20px 60px rgba(0,0,0,0.8);
  cursor:pointer;
}
.editor-wrap.dragover{outline:2px dashed var(--glow); outline-offset:4px;}
.layer{position:absolute; inset:0; width:100%; height:100%;}
#photo-layer{
  background:#0d0d0d;
  display:flex; align-items:center; justify-content:center;
}
#photo-layer img{
  position:absolute; width:100%; height:100%; object-fit:cover;
  transform-origin:center center;
  cursor:grab; user-select:none; -webkit-user-drag:none;
}
#photo-layer img:active{ cursor:grabbing; }
.upload-hint{
  display:flex; flex-direction:column; align-items:center; gap:8px;
  pointer-events:none; opacity:0.35; z-index:1;
}
.upload-hint svg{width:40px; height:40px; opacity:.6;}
.upload-hint p{
  font-family:'Orbitron',monospace; font-size:9px;
  letter-spacing:2px; color:var(--text2); text-align:center;
}
/* frame layers via CSS filter */
#layer1-img, #layer2-img{
  position:absolute; inset:0; width:100%; height:100%;
  pointer-events:none; object-fit:cover;
}
#layer1-img{z-index:2;}
#layer2-img{z-index:3;}
/* logo layer — top, no tint */
#logo-layer{
  position:absolute; inset:0; width:100%; height:100%;
  pointer-events:none; z-index:4;
  display:flex; align-items:flex-start; justify-content:center;
  padding-top:0;
}
#logo-layer img{
  width:100%; height:100%;
  object-fit:cover; pointer-events:none;
}

.hint{font-size:11px; color:var(--text2); letter-spacing:1px; position:relative; z-index:1; text-align:center;}

/* ── Zoom controls ── */
.zoom-bar{
  display:none; align-items:center; gap:12px;
  background:var(--panel); border:1px solid var(--border);
  border-radius:10px; padding:10px 16px;
  position:relative; z-index:1;
}
.zoom-bar .ctrl-label{ font-size:9px; color:var(--text2); letter-spacing:1px; font-family:'Orbitron',monospace; }
.zoom-bar input[type=range]{ width:120px; accent-color:var(--glow); }
.zoom-bar .range-val{ font-size:10px; color:var(--text2); font-family:monospace; min-width:36px; }
.zoom-bar .btn{ font-size:8px; padding:5px 10px; }

/* ── Access overlay ── */
#accessOverlay{
  display:none; position:fixed; inset:0; z-index:99999;
  background:rgba(6,11,20,0.97);
  align-items:center; justify-content:center; flex-direction:column; gap:24px;
  backdrop-filter:blur(6px);
}
.access-box{
  background:var(--panel); border:1px solid var(--border);
  border-radius:18px; padding:36px 32px; max-width:360px; width:90%;
  display:flex; flex-direction:column; align-items:center; gap:20px;
  box-shadow:0 0 60px rgba(0,200,255,0.12);
}
.access-logo{
  font-family:'Orbitron',monospace; font-size:22px; font-weight:900;
  color:var(--glow); text-shadow:0 0 20px rgba(0,200,255,0.5);
  letter-spacing:4px;
}
.access-logo span{color:#facc15;}
.access-msg{
  font-family:'Rajdhani',sans-serif; font-size:14px; letter-spacing:1px;
  color:var(--text2); text-align:center; line-height:1.6;
}
#btnLoginGoogle{
  display:none; align-items:center; gap:10px;
  font-family:'Orbitron',monospace; font-size:10px; font-weight:700;
  letter-spacing:2px; padding:12px 22px; border-radius:10px;
  border:1px solid var(--glow); background:rgba(0,200,255,0.08);
  color:var(--glow); cursor:pointer; transition:all 0.2s;
}
#btnLoginGoogle:hover{background:var(--glow); color:#060b14; box-shadow:0 0 20px rgba(0,200,255,0.4);}
#btnLoginGoogle svg{width:18px; height:18px; flex-shrink:0;}
.btn-back{
  position:fixed; top:12px; right:12px; z-index:99998;
  background:#111; color:#fff; border:none;
  padding:10px 14px; border-radius:10px;
  font-size:14px; line-height:1; cursor:pointer; opacity:.92;
}
.btn-back:active{transform:scale(.97);}
</style>

<!-- Firebase Auth -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyB-xx2PlBjvnHe0K7Bf1MspVqUlfjky0mk",
    authDomain: "aemx-chat.firebaseapp.com",
    databaseURL: "https://aemx-chat-default-rtdb.firebaseio.com",
    projectId: "aemx-chat",
    storageBucket: "aemx-chat.firebasestorage.app",
    messagingSenderId: "267113002594",
    appId: "1:267113002594:web:4099e7537d950f5753433b"
  };

  const app      = initializeApp(firebaseConfig);
  const auth     = getAuth(app);
  const database = getDatabase(app);

  const overlay  = document.getElementById('accessOverlay');
  const msgEl    = document.getElementById('accessMsg');
  const btnLogin = document.getElementById('btnLoginGoogle');

  overlay.style.display = 'flex';

  async function verificar(user) {
    if (!user) {
      msgEl.textContent = 'Debes iniciar sesión para acceder al editor de marco.';
      btnLogin.style.display = 'flex';
      return;
    }
    try {
      const snap = await get(ref(database, 'users/' + user.uid));
      const data = snap.exists() ? snap.val() : {};
      const esMiembro = data.clanMember === true || data.role === 'admin' || data.role === 'moderator';
      if (esMiembro) {
        overlay.style.display = 'none';
      } else {
        btnLogin.style.display = 'none';
        msgEl.textContent = '⛔ Solo los miembros del clan AEMX pueden acceder a esta página.';
      }
    } catch(e) {
      msgEl.textContent = '⛔ Error al verificar acceso. Intenta de nuevo.';
    }
  }

  onAuthStateChanged(auth, verificar);

  window._googleLogin = async function() {
    try {
      await signInWithPopup(auth, new GoogleAuthProvider());
    } catch(e) {
      msgEl.textContent = 'Error al iniciar sesión. Intenta de nuevo.';
    }
  };
</script>

</head>
<body>

<!-- Access Overlay -->
<div id="accessOverlay">
  <div class="access-box">
    <div class="access-logo">AEMX · <span>EDITOR</span></div>
    <p class="access-msg" id="accessMsg">Verificando acceso...</p>
    <button id="btnLoginGoogle" onclick="window._googleLogin()">
      <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.7 32.7 29.2 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.8 1.1 7.9 2.9l5.7-5.7C34.5 7.1 29.5 5 24 5 13 5 4 14 4 25s9 20 20 20 20-9 20-20c0-1.3-.1-2.6-.4-3.8z"/><path fill="#FF3D00" d="M6.3 15.2l6.6 4.8C14.5 17 19 14 24 14c3.1 0 5.8 1.1 7.9 2.9l5.7-5.7C34.5 7.1 29.5 5 24 5 16.3 5 9.7 9.1 6.3 15.2z"/><path fill="#4CAF50" d="M24 45c5.2 0 9.9-1.9 13.5-5.1l-6.2-5.2C29.4 36.6 26.8 38 24 38c-5.2 0-9.6-3.3-11.3-7.9l-6.5 5C9.6 41.1 16.3 45 24 45z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-.8 2.3-2.3 4.2-4.3 5.6l6.2 5.2C43.1 36.1 44 31 44 25c0-1.5-.1-3-.4-4.5z"/></svg>
      INICIAR CON GOOGLE
    </button>
  </div>
</div>

<!-- Back button -->
<button class="btn-back" onclick="window.history.length>1?window.history.back():window.location.href='index.html'">✕</button>

<h1>AEMX · <span>EDITOR DE MARCO</span></h1>

<!-- Controls -->
<div class="controls">

  <!-- Capa 1: anillo oscuro -->
  <div class="ctrl-block">
    <div class="ctrl-title">⬤ Anillo oscuro</div>
    <div class="ctrl-row">
      <span class="ctrl-label">COLOR</span>
      <input type="color" id="color1" value="#00c8ff"/>
    </div>
    <div class="ctrl-row">
      <span class="ctrl-label">INTENSIDAD</span>
      <input type="range" id="int1" min="0" max="100" value="60"/>
      <span class="range-val" id="int1-val">60</span>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Capa 2: anillo metálico -->
  <div class="ctrl-block">
    <div class="ctrl-title">◯ Anillo metálico</div>
    <div class="ctrl-row">
      <span class="ctrl-label">COLOR</span>
      <input type="color" id="color2" value="#ffffff"/>
    </div>
    <div class="ctrl-row">
      <span class="ctrl-label">INTENSIDAD</span>
      <input type="range" id="int2" min="0" max="100" value="50"/>
      <span class="range-val" id="int2-val">50</span>
    </div>
  </div>

</div>

<!-- Buttons -->
<div class="btn-row">
  <label class="btn upload" style="cursor:pointer;">
    ↑ SUBIR FOTO
    <input type="file" id="photo-input" accept="image/*" style="display:none;"/>
  </label>
  <button class="btn download" onclick="descargar()">↓ DESCARGAR</button>
</div>

<!-- Editor -->
<div class="editor-outer">
  <div class="corner tl"></div>
  <div class="corner tr"></div>
  <div class="corner bl"></div>
  <div class="corner br"></div>
  <div class="editor-wrap" id="editor-wrap">
  <!-- Capa 0: foto usuario -->
  <div class="layer" id="photo-layer">
    <div class="upload-hint" id="upload-hint">
      <svg viewBox="0 0 24 24" fill="none" stroke="#6b8ab0" stroke-width="1.5">
        <path d="M12 16V8m0 0-3 3m3-3 3 3"/><rect x="3" y="3" width="18" height="18" rx="3"/>
      </svg>
      <p>TOCA PARA<br/>SUBIR FOTO</p>
    </div>
  </div>
  <!-- Capa 1: anillo oscuro -->
  <img id="layer1-img" src="" alt="" crossorigin="anonymous"/>
  <!-- Capa 2: anillo metálico -->
  <img id="layer2-img" src="" alt="" crossorigin="anonymous"/>
  <!-- Capa 3: logo fijo -->
  <div class="layer" id="logo-layer">
    <img id="logo-img" src="" alt="AEMX Logo"/>
  </div>
  </div>
</div>

<!-- Zoom controls (visible solo con foto) -->
<div class="zoom-bar" id="zoom-bar">
  <span class="ctrl-label">↔ ZOOM</span>
  <input type="range" id="zoom-slider" min="100" max="300" value="100" step="1"/>
  <span class="range-val" id="zoom-val">100%</span>
  <button class="btn" id="zoom-reset">↺ RESET</button>
</div>

<p class="hint" id="main-hint">Toca el círculo para subir tu foto · Arrastra también funciona</p>

<script>
// ── URLs de GitHub ────────────────────────────────────────────────────────────
const LAYER1_SRC = 'https://raw.githubusercontent.com/socram-13/GamerTag_AEMX/main/marco_oscuro.png';
const LAYER2_SRC = 'https://raw.githubusercontent.com/socram-13/GamerTag_AEMX/main/marco_metalico.png';
const LAYER3_SRC = 'https://raw.githubusercontent.com/socram-13/GamerTag_AEMX/main/marco_logo.png';

const layer1 = document.getElementById('layer1-img');
const layer2 = document.getElementById('layer2-img');

layer1.src = LAYER1_SRC;
layer2.src = LAYER2_SRC;
document.getElementById('logo-img').src = LAYER3_SRC;

// ── Convierte hex a HSL ───────────────────────────────────────────────────────
function hexToHsl(hex) {
  let r = parseInt(hex.slice(1,3),16)/255;
  let g = parseInt(hex.slice(3,5),16)/255;
  let b = parseInt(hex.slice(5,7),16)/255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  let h, s, l = (max+min)/2;
  if (max === min) { h = s = 0; }
  else {
    const d = max - min;
    s = l > 0.5 ? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h = ((g-b)/d + (g<b?6:0))/6; break;
      case g: h = ((b-r)/d + 2)/6; break;
      case b: h = ((r-g)/d + 4)/6; break;
    }
  }
  return { h: Math.round(h*360), s: Math.round(s*100), l: Math.round(l*100) };
}

// ── Aplica CSS filter: hue-rotate + saturate + brightness ────────────────────
// El PNG de cada capa tiene sus propios colores base.
// Usamos hue-rotate para cambiar el matiz y saturate para la saturación.
// intensity (0-100): qué tan saturado se ve el color aplicado.
function applyFilter(el, hexColor, intensity) {
  if (intensity === 0) {
    el.style.filter = 'saturate(0) brightness(0.9)';
    return;
  }
  const hsl = hexToHsl(hexColor);
  // hue-rotate: giramos desde el matiz original de la imagen
  // El marco_oscuro tiene tonos cyan (~190°), el metálico blanco/gris (~0°)
  // Calculamos cuánto rotar para llegar al color elegido
  const hueRotate = hsl.h; // rotamos al matiz del color elegido
  const saturate  = 0.2 + (intensity / 100) * 3.5; // 0.2 a 3.7
  const brightness = 0.7 + (hsl.l / 100) * 0.8;    // ajuste por luminosidad del color elegido
  el.style.filter = `hue-rotate(${hueRotate}deg) saturate(${saturate.toFixed(2)}) brightness(${brightness.toFixed(2)})`;
}

function render1() {
  const color = document.getElementById('color1').value;
  const int   = parseInt(document.getElementById('int1').value);
  applyFilter(layer1, color, int);
}

function render2() {
  const color = document.getElementById('color2').value;
  const int   = parseInt(document.getElementById('int2').value);
  applyFilter(layer2, color, int);
}

// ── Samplea el color dominante de un PNG (solo píxeles opacos) ───────────────
function sampleDominantColor(imgEl) {
  const c = document.createElement('canvas');
  c.width = c.height = 64;
  const ctx = c.getContext('2d');
  ctx.drawImage(imgEl, 0, 0, 64, 64);
  const data = ctx.getImageData(0, 0, 64, 64).data;
  let r = 0, g = 0, b = 0, count = 0;
  for (let i = 0; i < data.length; i += 4) {
    if (data[i + 3] > 128) {
      r += data[i]; g += data[i + 1]; b += data[i + 2]; count++;
    }
  }
  if (!count) return '#ffffff';
  r = Math.round(r / count); g = Math.round(g / count); b = Math.round(b / count);
  return '#' + [r, g, b].map(v => v.toString(16).padStart(2, '0')).join('');
}

// Al cargar cada capa: detectar color real del PNG y sincronizar el picker
layer1.onload = () => {
  document.getElementById('color1').value = sampleDominantColor(layer1);
  render1();
};
layer2.onload = () => {
  document.getElementById('color2').value = sampleDominantColor(layer2);
  render2();
};

// ── Events ───────────────────────────────────────────────────────────────────
document.getElementById('color1').addEventListener('input', render1);
document.getElementById('color2').addEventListener('input', render2);

['int1','int2'].forEach(id => {
  document.getElementById(id).addEventListener('input', () => {
    document.getElementById(id+'-val').textContent = document.getElementById(id).value;
    id === 'int1' ? render1() : render2();
  });
});

// ── Photo upload + Zoom/Pan ───────────────────────────────────────────────────
let photoState = { zoom: 1, x: 0, y: 0 };

function applyPhotoTransform() {
  const img = document.querySelector('#photo-layer img');
  if (!img) return;
  img.style.transform = `translate(${photoState.x}px, ${photoState.y}px) scale(${photoState.zoom})`;
  document.getElementById('zoom-slider').value = Math.round(photoState.zoom * 100);
  document.getElementById('zoom-val').textContent = Math.round(photoState.zoom * 100) + '%';
}

function loadPhoto(file) {
  if (!file || !file.type.startsWith('image/')) return;
  const url = URL.createObjectURL(file);
  const img = document.createElement('img');
  img.src = url;
  const layer = document.getElementById('photo-layer');
  layer.querySelectorAll('img').forEach(el => el.remove());
  document.getElementById('upload-hint').style.display = 'none';
  layer.appendChild(img);
  // Resetear estado y mostrar controles
  photoState = { zoom: 1, x: 0, y: 0 };
  applyPhotoTransform();
  document.getElementById('zoom-bar').style.display = 'flex';
  document.getElementById('main-hint').textContent = 'Arrastra para mover · Scroll o slider para zoom';
}

// ── Zoom slider ───────────────────────────────────────────────────────────────
document.getElementById('zoom-slider').addEventListener('input', e => {
  photoState.zoom = parseInt(e.target.value) / 100;
  document.getElementById('zoom-val').textContent = e.target.value + '%';
  applyPhotoTransform();
});
document.getElementById('zoom-reset').addEventListener('click', () => {
  photoState = { zoom: 1, x: 0, y: 0 };
  applyPhotoTransform();
});

// ── Drag para mover (mouse) ───────────────────────────────────────────────────
let drag = { active: false, startX: 0, startY: 0, originX: 0, originY: 0, moved: false };

const wrap = document.getElementById('editor-wrap');

wrap.addEventListener('mousedown', e => {
  if (!document.querySelector('#photo-layer img')) return;
  drag = { active: true, startX: e.clientX, startY: e.clientY,
           originX: photoState.x, originY: photoState.y, moved: false };
  e.preventDefault();
});
window.addEventListener('mousemove', e => {
  if (!drag.active) return;
  const dx = e.clientX - drag.startX, dy = e.clientY - drag.startY;
  if (Math.abs(dx) > 3 || Math.abs(dy) > 3) drag.moved = true;
  photoState.x = drag.originX + dx;
  photoState.y = drag.originY + dy;
  applyPhotoTransform();
});
window.addEventListener('mouseup', e => {
  if (!drag.active) return;
  const wasMoved = drag.moved;
  drag.active = false;
  // Si no hubo movimiento real → abrir file picker (click normal)
  if (!wasMoved && !document.querySelector('#photo-layer img')) {
    document.getElementById('photo-input').click();
  }
});

// ── Scroll para zoom ──────────────────────────────────────────────────────────
wrap.addEventListener('wheel', e => {
  if (!document.querySelector('#photo-layer img')) return;
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.05 : 0.05;
  photoState.zoom = Math.min(3, Math.max(1, photoState.zoom + delta));
  applyPhotoTransform();
}, { passive: false });

// ── Touch: pan + pinch zoom ───────────────────────────────────────────────────
let touch = { last: null, lastDist: null };

wrap.addEventListener('touchstart', e => {
  if (!document.querySelector('#photo-layer img')) return;
  if (e.touches.length === 1) {
    touch.last = { x: e.touches[0].clientX, y: e.touches[0].clientY,
                   ox: photoState.x, oy: photoState.y };
    touch.lastDist = null;
  } else if (e.touches.length === 2) {
    touch.lastDist = Math.hypot(
      e.touches[1].clientX - e.touches[0].clientX,
      e.touches[1].clientY - e.touches[0].clientY
    );
    touch.lastZoom = photoState.zoom;
  }
}, { passive: true });

wrap.addEventListener('touchmove', e => {
  if (!document.querySelector('#photo-layer img')) return;
  e.preventDefault();
  if (e.touches.length === 1 && touch.last) {
    photoState.x = touch.last.ox + (e.touches[0].clientX - touch.last.x);
    photoState.y = touch.last.oy + (e.touches[0].clientY - touch.last.y);
    applyPhotoTransform();
  } else if (e.touches.length === 2 && touch.lastDist) {
    const dist = Math.hypot(
      e.touches[1].clientX - e.touches[0].clientX,
      e.touches[1].clientY - e.touches[0].clientY
    );
    photoState.zoom = Math.min(3, Math.max(1, touch.lastZoom * (dist / touch.lastDist)));
    applyPhotoTransform();
  }
}, { passive: false });

wrap.addEventListener('touchend', () => { touch.last = null; touch.lastDist = null; });

// ── Click para subir (solo si no hay foto y no hubo drag) ─────────────────────
wrap.addEventListener('click', e => {
  if (drag.moved) return; // fue un pan, no un click
  if (document.querySelector('#photo-layer img')) return; // ya hay foto
  if (e.target.closest('#logo-layer')) return;
  document.getElementById('photo-input').click();
});

document.getElementById('photo-input').addEventListener('change', e => loadPhoto(e.target.files[0]));
wrap.addEventListener('dragover', e => { e.preventDefault(); wrap.classList.add('dragover'); });
wrap.addEventListener('dragleave', () => wrap.classList.remove('dragover'));
wrap.addEventListener('drop', e => { e.preventDefault(); wrap.classList.remove('dragover'); loadPhoto(e.dataTransfer.files[0]); });

// ── Dibuja una imagen con CSS filter preservando transparencia ───────────────
// El problema: ctx.filter trabaja con alpha premultiplicado. Al aplicar
// hue-rotate/saturate, los píxeles semitransparentes de los bordes del PNG
// quedan con RGB contaminado de negro. No hay forma de corregirlo después
// porque el daño ocurre durante la multiplicación interna del canvas.
//
// Solución: aplicar el filtro en un canvas B, luego usar destination-in con
// el alpha original limpio (canvas A) para "recortar" exactamente los bordes.
// destination-in conserva solo los píxeles donde A tiene alpha > 0, eliminando
// cualquier borde negro que haya generado el filtro.
function drawFiltered(ctx, imgEl, size) {
  const filterStr = imgEl.style.filter || '';

  // Canvas A — imagen original sin filtro (alpha limpio)
  const canvasA = document.createElement('canvas');
  canvasA.width = canvasA.height = size;
  const ctxA = canvasA.getContext('2d');
  ctxA.drawImage(imgEl, 0, 0, size, size);

  if (!filterStr || filterStr === 'none') {
    ctx.drawImage(canvasA, 0, 0);
    return;
  }

  // Canvas B — imagen con filtro aplicado (puede tener bordes negros)
  const canvasB = document.createElement('canvas');
  canvasB.width = canvasB.height = size;
  const ctxB = canvasB.getContext('2d');
  ctxB.filter = filterStr;
  ctxB.drawImage(imgEl, 0, 0, size, size);
  ctxB.filter = 'none';

  // Canvas C — aplicamos destination-in: los colores de B quedan enmascarados
  // por el alpha de A. Resultado: colores filtrados + alpha original limpio.
  const canvasC = document.createElement('canvas');
  canvasC.width = canvasC.height = size;
  const ctxC = canvasC.getContext('2d');
  ctxC.drawImage(canvasB, 0, 0);                    // paso 1: dibujar imagen filtrada
  ctxC.globalCompositeOperation = 'destination-in'; // paso 2: recortar con alpha original
  ctxC.drawImage(canvasA, 0, 0);
  ctxC.globalCompositeOperation = 'source-over';    // restaurar modo por defecto

  // Composite final sobre el canvas principal
  ctx.drawImage(canvasC, 0, 0);
}

// ── Download: composite all layers preservando transparencia ─────────────────
function descargar() {
  const size = 1024;
  const tmp  = document.createElement('canvas');
  tmp.width = tmp.height = size;
  const tCtx = tmp.getContext('2d');

  // Fondo transparente explícito (sin relleno negro)
  tCtx.clearRect(0, 0, size, size);

  // Layer 0: foto del usuario aplicando el mismo zoom/pan que en preview
  const photoImg = document.querySelector('#photo-layer img');
  if (photoImg) {
    const nw = photoImg.naturalWidth, nh = photoImg.naturalHeight;
    // Escala base (object-fit:cover) para cubrir 1024x1024
    const baseScale = Math.max(size / nw, size / nh);
    const bw = nw * baseScale, bh = nh * baseScale;
    // Ratio px-preview → px-canvas para traducir el offset del usuario
    const previewSize = document.getElementById('editor-wrap').offsetWidth;
    const ratio = size / previewSize;
    // Aplicar zoom centrado + offset de pan
    const fw = bw * photoState.zoom, fh = bh * photoState.zoom;
    const fx = (size - fw) / 2 + photoState.x * ratio;
    const fy = (size - fh) / 2 + photoState.y * ratio;
    tCtx.drawImage(photoImg, fx, fy, fw, fh);
  }
  // Sin foto → fondo transparente

  // Layer 1 (anillo oscuro) y Layer 2 (anillo metálico)
  // Usamos drawFiltered para no perder el canal alpha del PNG
  [layer1, layer2].forEach(imgEl => drawFiltered(tCtx, imgEl, size));

  // Layer 3: logo fijo — tamaño completo 1024x1024
  const logoImg = document.getElementById('logo-img');
  if (logoImg.complete && logoImg.naturalWidth) {
    tCtx.drawImage(logoImg, 0, 0, size, size);
  }

  const link = document.createElement('a');
  link.download = 'AEMX_marco.png';
  link.href = tmp.toDataURL('image/png');
  link.click();
}
</script>

</body>
</html>