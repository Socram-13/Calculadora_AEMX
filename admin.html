<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADMIN ¬∑ ATLAS EARTH AEMX</title>
  <link rel="icon" type="image/png" href="imagen_1.png">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <style>
    :root {
      --bg:        #060b14;
      --panel:     #0b1626;
      --panel2:    #0f1e35;
      --border:    #1a3a5c;
      --glow:      #00c8ff;
      --glow2:     #00ff9d;
      --danger:    #ff4466;
      --warning:   #ffaa00;
      --success:   #00ff9d;
      --text:      #cce4ff;
      --text2:     #6b8ab0;
      --banned-bg: rgba(255,68,102,0.08);
      --banned-border: rgba(255,68,102,0.3);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0,200,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,200,255,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: 0;
      animation: gridMove 20s linear infinite;
      pointer-events: none;
    }

    @keyframes gridMove {
      0%   { transform: translateY(0); }
      100% { transform: translateY(40px); }
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 20% 10%, rgba(255,68,102,0.05) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 90%, rgba(0,200,255,0.04) 0%, transparent 50%);
      z-index: 0;
      pointer-events: none;
    }

    /* ‚îÄ‚îÄ Auth overlay ‚îÄ‚îÄ */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(6,11,20,0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
    }
    .auth-overlay.hidden { display: none; }

    .auth-box {
      background: var(--panel);
      border: 1px solid var(--danger);
      border-radius: 16px;
      padding: 48px 40px;
      max-width: 380px;
      width: 90%;
      text-align: center;
      box-shadow: 0 0 60px rgba(255,68,102,0.15);
      animation: fadeUp 0.4s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .auth-box .lock-icon {
      font-size: 40px;
      margin-bottom: 16px;
      display: block;
    }

    .auth-box h2 {
      font-family: 'Orbitron', monospace;
      font-size: 13px;
      color: var(--danger);
      letter-spacing: 4px;
      margin-bottom: 8px;
    }

    .auth-box p {
      color: var(--text2);
      font-size: 13px;
      margin-bottom: 28px;
      letter-spacing: 1px;
    }

    .auth-btn-google {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 13px 20px;
      background: linear-gradient(135deg, #1a1a2e, #0b1626);
      border: 1px solid var(--danger);
      border-radius: 10px;
      color: var(--danger);
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .auth-btn-google:hover {
      background: var(--danger);
      color: #fff;
      box-shadow: 0 0 24px rgba(255,68,102,0.4);
    }

    .auth-error {
      margin-top: 14px;
      font-size: 12px;
      color: var(--danger);
      letter-spacing: 1px;
      min-height: 18px;
    }

    /* ‚îÄ‚îÄ Access denied ‚îÄ‚îÄ */
    .access-denied {
      position: fixed;
      inset: 0;
      background: rgba(6,11,20,0.98);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1999;
      flex-direction: column;
      gap: 16px;
      text-align: center;
      padding: 20px;
    }
    .access-denied.visible { display: flex; }
    .access-denied .icon { font-size: 56px; }
    .access-denied h2 {
      font-family: 'Orbitron', monospace;
      font-size: 16px;
      color: var(--danger);
      letter-spacing: 4px;
    }
    .access-denied p {
      color: var(--text2);
      font-size: 13px;
      letter-spacing: 1px;
    }
    .btn-signout-denied {
      margin-top: 8px;
      background: none;
      border: 1px solid var(--danger);
      border-radius: 8px;
      color: var(--danger);
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      letter-spacing: 2px;
      padding: 8px 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-signout-denied:hover { background: var(--danger); color: #fff; }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 16px 60px;
    }

    /* ‚îÄ‚îÄ Two-column layout ‚îÄ‚îÄ */
    .admin-body {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 16px;
      align-items: start;
    }

    /* ‚îÄ‚îÄ Left column: mapa compacto ‚îÄ‚îÄ */
    .map-col {
      position: sticky;
      top: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .map-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--glow), var(--glow2));
      z-index: 10;
    }

    .map-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--panel2);
    }

    .map-card-title {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 3px;
      color: var(--glow);
    }

    .map-live-dot {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--glow2);
      letter-spacing: 1px;
    }

    .map-live-dot::before {
      content: '';
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--glow2);
      box-shadow: 0 0 6px var(--glow2);
      animation: pulse 1.5s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50%       { opacity: 0.4; transform: scale(0.7); }
    }

    #mini-map {
      height: 400px;
      width: 100%;
      background: #060b14;
    }

    .map-mini-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--border);
    }

    .map-mini-stat {
      background: var(--panel2);
      padding: 8px 12px;
      text-align: center;
    }

    .map-mini-stat .num {
      font-family: 'Orbitron', monospace;
      font-size: 16px;
      font-weight: 700;
      color: var(--glow);
    }

    .map-mini-stat .lbl {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--text2);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-top: 2px;
    }

    /* ‚îÄ‚îÄ Right column ‚îÄ‚îÄ */
    .table-col { min-width: 0; }

    @media (max-width: 900px) {
      .admin-body { grid-template-columns: 1fr; }
      .map-col { position: static; }
      #mini-map { height: 260px; }
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 12px;
    }

    .header-left h1 {
      font-family: 'Orbitron', monospace;
      font-size: clamp(16px, 3.5vw, 22px);
      font-weight: 900;
      letter-spacing: 4px;
      color: var(--danger);
      text-shadow: 0 0 20px rgba(255,68,102,0.4);
    }

    .header-left .subtitle {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      letter-spacing: 2px;
      margin-top: 4px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      color: var(--text2);
    }

    .admin-badge {
      background: rgba(255,68,102,0.15);
      border: 1px solid var(--danger);
      border-radius: 6px;
      padding: 3px 10px;
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      color: var(--danger);
      letter-spacing: 2px;
    }

    .btn-signout {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text2);
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      letter-spacing: 1px;
      padding: 4px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-signout:hover { border-color: var(--danger); color: var(--danger); }

    .btn-mapa {
      background: none;
      border: 1px solid var(--glow);
      border-radius: 6px;
      color: var(--glow);
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      letter-spacing: 1px;
      padding: 4px 10px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .btn-mapa:hover { background: rgba(0,200,255,0.1); box-shadow: 0 0 10px rgba(0,200,255,0.3); }

    /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
    }
    .stat-card.total::before   { background: linear-gradient(90deg, var(--glow), var(--glow2)); }
    .stat-card.banned-c::before { background: var(--danger); }
    .stat-card.active-c::before { background: var(--success); }

    .stat-value {
      font-family: 'Orbitron', monospace;
      font-size: 24px;
      font-weight: 700;
    }
    .stat-card.total .stat-value   { color: var(--glow); }
    .stat-card.banned-c .stat-value { color: var(--danger); }
    .stat-card.active-c .stat-value { color: var(--success); }

    .stat-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      letter-spacing: 2px;
      margin-top: 4px;
    }

    /* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text2);
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      letter-spacing: 1px;
      padding: 6px 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn:hover { border-color: var(--glow); color: var(--glow); }
    .filter-btn.active { border-color: var(--glow); color: var(--glow); background: rgba(0,200,255,0.08); }
    .filter-btn.active-banned { border-color: var(--danger); color: var(--danger); background: rgba(255,68,102,0.08); }

    /* ‚îÄ‚îÄ User table ‚îÄ‚îÄ */
    .table-wrap {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 8px;
    }

    .table-title {
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      color: var(--glow);
      letter-spacing: 3px;
    }

    .search-input {
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      padding: 6px 12px;
      outline: none;
      width: 200px;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--glow); }
    .search-input::placeholder { color: var(--text2); }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--text2);
      text-align: left;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--panel2);
    }

    tbody tr {
      border-bottom: 1px solid rgba(26,58,92,0.5);
      transition: background 0.15s;
      animation: fadeIn 0.3s ease both;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-6px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(0,200,255,0.03); }
    tbody tr.banned-row { background: var(--banned-bg); border-left: 2px solid var(--danger); }
    tbody tr.banned-row:hover { background: rgba(255,68,102,0.1); }

    tbody td { padding: 12px 20px; vertical-align: middle; }

    .player-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 36px; height: 36px;
      border-radius: 50%;
      border-width: 2px;
      border-style: solid;
      border-color: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron', monospace;
      font-size: 13px;
      font-weight: 700;
      color: #060b14;
      flex-shrink: 0;
      overflow: hidden;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

    .player-name {
      font-family: 'Rajdhani', sans-serif;
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 1px;
    }

    .player-email {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      margin-top: 2px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      padding: 3px 10px;
      border-radius: 20px;
      letter-spacing: 1px;
      white-space: nowrap;
    }
    .status-badge.active  { color: var(--success); background: rgba(0,255,157,0.1); border: 1px solid rgba(0,255,157,0.3); }
    .status-badge.banned  { color: var(--danger);  background: rgba(255,68,102,0.1); border: 1px solid rgba(255,68,102,0.3); }
    .status-badge::before {
      content: '';
      width: 5px; height: 5px;
      border-radius: 50%;
    }
    .status-badge.active::before { background: var(--success); box-shadow: 0 0 6px var(--success); }
    .status-badge.banned::before { background: var(--danger); }

    .parcelas-cell {
      font-family: 'Orbitron', monospace;
      font-size: 13px;
      font-weight: 700;
      color: var(--glow);
    }

    .country-cell {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--text2);
    }

    /* ‚îÄ‚îÄ Action buttons ‚îÄ‚îÄ */
    .actions-cell { display: flex; gap: 8px; flex-wrap: wrap; }

    .btn-action {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 5px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid;
      white-space: nowrap;
    }

    .btn-ban {
      color: var(--danger);
      border-color: rgba(255,68,102,0.5);
      background: rgba(255,68,102,0.08);
    }
    .btn-ban:hover { background: var(--danger); color: #fff; box-shadow: 0 0 14px rgba(255,68,102,0.4); }

    /* Country change badge */
    .country-changed {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--warning);
      background: rgba(255,170,0,0.1);
      border: 1px solid rgba(255,170,0,0.4);
      border-radius: 6px;
      padding: 2px 7px;
      cursor: pointer;
      position: relative;
    }

    .country-history-tooltip {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      background: var(--panel2);
      border: 1px solid var(--warning);
      border-radius: 8px;
      padding: 10px 14px;
      min-width: 220px;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }

    .country-changed:hover .country-history-tooltip { display: block; }

    .history-entry {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
      line-height: 1.6;
    }
    .history-entry:last-child { border-bottom: none; }
    .history-entry .from { color: var(--danger); }
    .history-entry .to   { color: var(--success); }
    .history-entry .date { color: var(--text2); font-size: 9px; }

    .btn-unban {
      color: var(--success);
      border-color: rgba(0,255,157,0.5);
      background: rgba(0,255,157,0.08);
    }
    .btn-unban:hover { background: var(--success); color: #060b14; box-shadow: 0 0 14px rgba(0,255,157,0.4); }

    .btn-ban-chat {
      color: var(--warning);
      border-color: rgba(255,170,0,0.5);
      background: rgba(255,170,0,0.08);
    }
    .btn-ban-chat:hover { background: var(--warning); color: #060b14; }

    .btn-edit-country {
      color: #a78bfa;
      border-color: rgba(167,139,250,0.5);
      background: rgba(167,139,250,0.08);
    }
    .btn-edit-country:hover { background: #a78bfa; color: #fff; box-shadow: 0 0 14px rgba(167,139,250,0.4); }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--panel);
      border: 1px solid var(--glow);
      border-radius: 10px;
      padding: 10px 24px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      color: var(--glow);
      letter-spacing: 1px;
      z-index: 3000;
      transition: transform 0.3s ease, opacity 0.3s ease;
      opacity: 0;
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { border-color: var(--danger); color: var(--danger); }

    /* ‚îÄ‚îÄ Empty / loading ‚îÄ‚îÄ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text2);
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      letter-spacing: 2px;
    }

    .spinner {
      width: 28px; height: 28px;
      border: 2px solid var(--border);
      border-top-color: var(--danger);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 14px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Confirm modal ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(6,11,20,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.visible { display: flex; }

    .modal-box {
      background: var(--panel);
      border: 1px solid var(--danger);
      border-radius: 14px;
      padding: 32px 28px;
      max-width: 340px;
      width: 90%;
      text-align: center;
      box-shadow: 0 0 40px rgba(255,68,102,0.2);
      animation: fadeUp 0.3s ease;
    }
    .modal-box h3 {
      font-family: 'Orbitron', monospace;
      font-size: 13px;
      color: var(--danger);
      letter-spacing: 3px;
      margin-bottom: 10px;
    }
    .modal-box p {
      color: var(--text2);
      font-size: 13px;
      margin-bottom: 24px;
      letter-spacing: 0.5px;
      line-height: 1.5;
    }
    .modal-box strong { color: var(--text); }
    .modal-actions { display: flex; gap: 10px; justify-content: center; }
    .btn-confirm {
      background: var(--danger);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 9px 20px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-confirm:hover { opacity: 0.85; }
    .btn-cancel {
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text2);
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      letter-spacing: 1px;
      padding: 9px 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-cancel:hover { border-color: var(--text2); color: var(--text); }

    @media (max-width: 640px) {
      .actions-cell { flex-direction: column; }
      .search-input { width: 100%; }
      tbody td { padding: 10px 12px; }
      thead th { padding: 8px 12px; }
      .player-email { display: none; }
    }

    /* ===== CHAT WIDGET ===== */
    #chat-fab {
      position: fixed;
      bottom: 28px;
      right: 28px;
      z-index: 9998;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00ff88, #00ffff);
      border: none;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0,255,136,0.6), 0 4px 15px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    #chat-fab:hover { transform: scale(1.1); box-shadow: 0 0 35px rgba(0,255,136,0.9), 0 6px 20px rgba(0,0,0,0.5); }
    #chat-fab:active { transform: scale(0.95); }
    #chat-fab svg { width: 28px; height: 28px; fill: #0a0e1a; }
    #chat-fab.open svg.icon-chat { display: none; }
    #chat-fab.open svg.icon-close { display: block !important; }
    #chat-fab::before {
      content: 'CHAT';
      position: absolute;
      right: 70px;
      background: #0f1419;
      border: 1px solid #00ff88;
      color: #00ff88;
      font-family: 'Orbitron', sans-serif;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 6px 10px;
      border-radius: 4px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      box-shadow: 0 0 10px rgba(0,255,136,0.3);
    }
    #chat-fab:hover::before { opacity: 1; }
    #chat-fab.open::before { content: 'CERRAR'; }

    #chat-iframe-container {
      position: fixed;
      bottom: 100px;
      right: 28px;
      z-index: 9997;
      width: 380px;
      height: min(600px, calc(100dvh - 120px));
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #00ff88;
      box-shadow: 0 0 40px rgba(0,255,136,0.4), 0 20px 60px rgba(0,0,0,0.6);
      transform: scale(0.85) translateY(20px);
      transform-origin: bottom right;
      opacity: 0;
      pointer-events: none;
      transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1), opacity 0.25s ease;
    }
    #chat-iframe-container.open { transform: scale(1) translateY(0); opacity: 1; pointer-events: all; }
    #chat-iframe-container iframe { width: 100%; height: 100%; border: none; display: block; }

    #chat-widget-bar {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 36px;
      background: linear-gradient(90deg, rgba(0,255,136,0.15), rgba(0,255,255,0.1));
      border-bottom: 1px solid rgba(0,255,136,0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      z-index: 1;
      pointer-events: none;
    }
    #chat-widget-bar span { font-family: 'Orbitron', sans-serif; font-size: 9px; font-weight: 700; color: #00ff88; letter-spacing: 2px; text-shadow: 0 0 8px #00ff88; }
    #chat-widget-bar .dots { display: flex; gap: 5px; }
    #chat-widget-bar .dot { width: 8px; height: 8px; border-radius: 50%; }
    #chat-widget-bar .dot:nth-child(1) { background: #ff5f57; }
    #chat-widget-bar .dot:nth-child(2) { background: #ffbd2e; }
    #chat-widget-bar .dot:nth-child(3) { background: #00ff88; box-shadow: 0 0 6px #00ff88; }

    @media (max-width: 480px) {
      #chat-widget-bar { display: none; }
      #chat-iframe-container {
        right: 0; bottom: 0; left: 0; top: auto;
        width: 100%; height: 75dvh;
        border-radius: 20px 20px 0 0;
        transform-origin: bottom center;
        border-left: none; border-right: none; border-bottom: none;
      }
      #chat-fab { bottom: 20px; right: 20px; }
    }
    /* ===== FIN CHAT WIDGET ===== */

    /* ‚îÄ‚îÄ Leaflet mini-map overrides ‚îÄ‚îÄ */
    #mini-map .leaflet-control-zoom {
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
      overflow: hidden;
    }
    #mini-map .leaflet-control-zoom a {
      background: var(--panel2) !important;
      color: var(--glow) !important;
      border-color: var(--border) !important;
      font-weight: 700;
      width: 24px !important;
      height: 24px !important;
      line-height: 24px !important;
      font-size: 14px !important;
    }
    #mini-map .leaflet-control-zoom a:hover {
      background: var(--panel) !important;
      color: #fff !important;
    }
    #mini-map .leaflet-control-attribution { display: none; }
    #mini-map { background: #060b14 !important; }
    .leaflet-container { background: #060b14 !important; font-family: 'Rajdhani', sans-serif; }
    .leaflet-tooltip {
      background: var(--panel) !important;
      border: 1px solid var(--border) !important;
      color: var(--text2) !important;
      font-family: 'Orbitron', monospace !important;
      font-size: 9px !important;
      letter-spacing: 1px !important;
      border-radius: 6px !important;
    }
  </style>
</head>
<body>

  <!-- Auth Overlay -->
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-box">
      <span class="lock-icon">üîê</span>
      <h2>PANEL DE ADMINISTRACI√ìN</h2>
      <p>Acceso restringido ‚Äî solo administradores</p>
      <button class="auth-btn-google" onclick="authWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 48 48">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
        </svg>
        INICIAR CON GOOGLE
      </button>
      <div class="auth-error" id="authError"></div>
    </div>
  </div>

  <!-- Access Denied -->
  <div class="access-denied" id="accessDenied">
    <span class="icon">üö´</span>
    <h2>ACCESO DENEGADO</h2>
    <p>No tienes permisos de administrador.</p>
    <button class="btn-signout-denied" onclick="signOutUser()">CERRAR SESI√ìN</button>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
      <h3 id="modalTitle">CONFIRMAR</h3>
      <p id="modalBody"></p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal()">CANCELAR</button>
        <button class="btn-confirm" id="modalConfirmBtn">CONFIRMAR</button>
      </div>
    </div>
  </div>

  <!-- Edit Country Modal -->
  <div class="modal-overlay" id="countryModal">
    <div class="modal-box">
      <h3>‚úé EDITAR PA√çS</h3>
      <p id="countryModalUser" style="margin-bottom:14px;"></p>
      <input
        id="countryInput"
        type="text"
        placeholder="Ej: Mexico, United States..."
        style="width:100%;background:var(--panel2);border:1px solid #a78bfa;border-radius:8px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:13px;padding:9px 14px;outline:none;margin-bottom:18px;letter-spacing:1px;"
      >
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeCountryModal()">CANCELAR</button>
        <button class="btn-confirm" style="background:#a78bfa;" onclick="saveCountry()">GUARDAR</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <div class="container">
    <header>
      <div class="header-left">
        <h1>‚öôÔ∏è ADMIN PANEL</h1>
        <div class="subtitle">ATLAS EARTH AEMX ¬∑ GESTI√ìN DE USUARIOS</div>
      </div>
      <div class="header-right" id="headerRight" style="display:none">
        <span class="admin-badge">ADMIN</span>
        <span id="adminEmail"></span>
        <a href="mapa.html" class="btn-mapa">üó∫Ô∏è MAPA</a>
        <button class="btn-signout" onclick="signOutUser()">SALIR</button>
      </div>
    </header>

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-card total">
        <div class="stat-value" id="statTotal">‚Äî</div>
        <div class="stat-label">USUARIOS TOTALES</div>
      </div>
      <div class="stat-card active-c">
        <div class="stat-value" id="statActive">‚Äî</div>
        <div class="stat-label">ACTIVOS</div>
      </div>
      <div class="stat-card banned-c">
        <div class="stat-value" id="statBanned">‚Äî</div>
        <div class="stat-label">BLOQUEADOS</div>
      </div>
    </div>

    <!-- Two-column body -->
    <div class="admin-body">

      <!-- LEFT: Mapa compacto -->
      <div class="map-col">
        <div class="map-card">
          <div class="map-card-header">
            <span class="map-card-title">üó∫Ô∏è MAPA EN VIVO</span>
            <span class="map-live-dot">EN VIVO</span>
          </div>
          <div id="mini-map"></div>
          <div class="map-mini-stats">
            <div class="map-mini-stat">
              <div class="num" id="miniStatJugadores">‚Äî</div>
              <div class="lbl">Jugadores</div>
            </div>
            <div class="map-mini-stat">
              <div class="num" id="miniStatEstados">‚Äî</div>
              <div class="lbl">Estados</div>
            </div>
            <div class="map-mini-stat">
              <div class="num" id="miniStatCiudades">‚Äî</div>
              <div class="lbl">Ciudades</div>
            </div>
            <div class="map-mini-stat">
              <div class="num" id="miniStatAemx" style="color:var(--glow2)">‚Äî</div>
              <div class="lbl">Miembros AEMX</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Tabla usuarios -->
      <div class="table-col">
        <!-- Filters + search -->
        <div class="filters">
          <button class="filter-btn active" id="filterAll" onclick="setFilter('all')">TODOS</button>
          <button class="filter-btn" id="filterActive" onclick="setFilter('active')">ACTIVOS</button>
          <button class="filter-btn" id="filterBanned" onclick="setFilter('banned')">BLOQUEADOS</button>
        </div>

        <!-- Table -->
        <div class="table-wrap">
          <div class="table-header">
            <span class="table-title">USUARIOS REGISTRADOS</span>
            <input class="search-input" type="text" placeholder="Buscar usuario..." oninput="filterSearch(this.value)" id="searchInput">
          </div>
          <table>
            <thead>
              <tr>
                <th>JUGADOR</th>
                <th>PA√çS</th>
                <th>PARCELAS</th>
                <th>ESTADO</th>
                <th>ACCIONES</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr>
                <td colspan="5">
                  <div class="empty-state">
                    <div class="spinner"></div>
                    CARGANDO USUARIOS...
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div><!-- /admin-body -->
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script>
    // ‚îÄ‚îÄ Mini mapa Leaflet ‚îÄ‚îÄ
    const miniMap = L.map('mini-map', {
      center: [23.6345, -102.5528],
      zoom: 4,
      zoomControl: true,
      attributionControl: false,
      dragging: true,
      scrollWheelZoom: 'center',
      doubleClickZoom: true,
      touchZoom: true,
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd', maxZoom: 19,
    }).addTo(miniMap);

    // Coordenadas de estados
    const ESTADO_COORDS_MINI = {
      'Aguascalientes':[21.8853,-102.2916],'Baja California':[30.8406,-115.2838],
      'Baja California Sur':[26.0444,-111.6661],'Campeche':[19.8301,-90.5349],
      'Chiapas':[16.7569,-93.1292],'Chihuahua':[28.6353,-106.0889],
      'Ciudad de M√©xico':[19.4326,-99.1332],'Coahuila':[27.0587,-101.7068],
      'Colima':[19.2452,-103.7241],'Durango':[24.0277,-104.6532],
      'Estado de M√©xico':[19.2826,-99.6557],'Guanajuato':[21.0190,-101.2574],
      'Guerrero':[17.4392,-100.0000],'Hidalgo':[20.0911,-98.7624],
      'Jalisco':[20.6597,-103.3496],'Michoac√°n':[19.7008,-101.1844],
      'Morelos':[18.6813,-99.1013],'Nayarit':[21.7514,-104.8455],
      'Nuevo Le√≥n':[25.5922,-99.9962],'Oaxaca':[17.0732,-96.7266],
      'Puebla':[19.0414,-98.2063],'Quer√©taro':[20.5888,-100.3899],
      'Quintana Roo':[19.1817,-88.4791],'San Luis Potos√≠':[22.1565,-100.9855],
      'Sinaloa':[25.1721,-107.4795],'Sonora':[29.0729,-110.9559],
      'Tabasco':[17.8409,-92.6189],'Tamaulipas':[24.2669,-98.8363],
      'Tlaxcala':[19.3182,-98.2375],'Veracruz':[19.1738,-96.1342],
      'Yucat√°n':[20.9674,-89.5926],'Zacatecas':[22.7709,-102.5832],
    };

    const CIUDAD_ESTADO_MINI = {
      'ciudad de m√©xico':'Ciudad de M√©xico','cdmx':'Ciudad de M√©xico',
      'guadalajara':'Jalisco','monterrey':'Nuevo Le√≥n','puebla':'Puebla',
      'tijuana':'Baja California','mexicali':'Baja California',
      'toluca':'Estado de M√©xico','ecatepec':'Estado de M√©xico',
      'le√≥n':'Guanajuato','chihuahua':'Chihuahua','ciudad ju√°rez':'Chihuahua',
      'm√©rida':'Yucat√°n','hermosillo':'Sonora','culiac√°n':'Sinaloa',
      'canc√∫n':'Quintana Roo','veracruz':'Veracruz','morelia':'Michoac√°n',
      'aguascalientes':'Aguascalientes','san luis potos√≠':'San Luis Potos√≠',
      'saltillo':'Coahuila','torre√≥n':'Coahuila','durango':'Durango',
      'quer√©taro':'Quer√©taro','cuernavaca':'Morelos','tampico':'Tamaulipas',
      'reynosa':'Tamaulipas','la paz':'Baja California Sur',
      'villahermosa':'Tabasco','tuxtla guti√©rrez':'Chiapas',
      'oaxaca':'Oaxaca','acapulco':'Guerrero','zacatecas':'Zacatecas',
      'pachuca':'Hidalgo','tepic':'Nayarit','colima':'Colima',
      'campeche':'Campeche','tlaxcala':'Tlaxcala',
    };

    function extractEstadoMini(city) {
      if (!city) return null;
      const parts = city.split(',');
      if (parts.length >= 2) return parts[parts.length - 1].trim();
      return CIUDAD_ESTADO_MINI[city.toLowerCase().trim()] || null;
    }

    let miniMarkers = [];
    let miniCircles = [];

    function renderMiniMap(players) {
      miniMarkers.forEach(m => miniMap.removeLayer(m));
      miniCircles.forEach(c => miniMap.removeLayer(c));
      miniMarkers = []; miniCircles = [];

      // Agrupar por estado
      const porEstado = {};
      players.forEach(p => {
        const estado = extractEstadoMini(p.city || '');
        if (!estado) return;
        if (!porEstado[estado]) porEstado[estado] = [];
        porEstado[estado].push(p);
      });

      // C√≠rculos por estado
      Object.entries(porEstado).forEach(([estado, jugs]) => {
        const coords = ESTADO_COORDS_MINI[estado];
        if (!coords) return;
        const n = jugs.length;
        const tieneAEMX = jugs.some(p => (p.username||'').toUpperCase().includes('AEMX'));
        const color = tieneAEMX ? '#00ff9d' : (n >= 5 ? '#00c8ff' : n >= 2 ? '#1a6a9c' : '#1a3a5c');
        const fill  = tieneAEMX ? 'rgba(0,255,157,0.55)' : (n >= 5 ? 'rgba(0,200,255,0.45)' : n >= 2 ? 'rgba(0,200,255,0.25)' : 'rgba(0,200,255,0.12)');

        const c = L.circle(coords, {
          radius: 60000 + n * 12000,
          color, fillColor: fill, fillOpacity: 1, weight: 1.5, opacity: 0.9,
          interactive: true,
        }).addTo(miniMap);

        c.bindTooltip(`${estado} ¬∑ ${n} jugador${n>1?'es':''}`, { permanent: false, direction: 'top' });
        miniCircles.push(c);
      });

      // Marcadores simples (puntos)
      players.forEach(p => {
        const estado = extractEstadoMini(p.city || '');
        let coords = null;
        if (estado && ESTADO_COORDS_MINI[estado]) {
          coords = [
            ESTADO_COORDS_MINI[estado][0] + (Math.random()-0.5)*0.8,
            ESTADO_COORDS_MINI[estado][1] + (Math.random()-0.5)*0.8,
          ];
        } else if (p.country === 'Mexico' || !p.city) {
          // Sin ciudad: posici√≥n aleatoria sobre M√©xico
          coords = [
            23.6345 + (Math.random()-0.5)*6,
            -102.5528 + (Math.random()-0.5)*6,
          ];
        }
        if (!coords) return;

        const letter = (p.username||'?').charAt(0).toUpperCase();
        const colors = ['#00c8ff','#00ff9d','#c084fc','#60a5fa','#facc15','#4ade80','#f472b6'];
        const bg = p.borderColor || colors[letter.charCodeAt(0) % colors.length];

        const icon = L.divIcon({
          html: `<div style="width:10px;height:10px;border-radius:50%;background:${bg};border:1.5px solid #fff;box-shadow:0 0 6px ${bg};"></div>`,
          className: '', iconSize: [10,10], iconAnchor: [5,5],
        });
        const m = L.marker(coords, { icon, interactive: true }).addTo(miniMap);
        m.bindTooltip(`${p.username} ¬∑ ${p.total.toLocaleString()} parcelas`, { direction: 'top' });
        miniMarkers.push(m);
      });

      // Stats del mapa
      const estados  = Object.keys(porEstado).length;
      const ciudades = new Set(players.map(p => p.city).filter(Boolean)).size;
      const aemx     = players.filter(p => (p.username||'').toUpperCase().includes('AEMX')).length;
      document.getElementById('miniStatJugadores').textContent = players.length;
      document.getElementById('miniStatEstados').textContent   = estados;
      document.getElementById('miniStatCiudades').textContent  = ciudades;
      document.getElementById('miniStatAemx').textContent      = aemx;
    }

    window.renderMiniMap = renderMiniMap;
  </script>

  <script type="module">
    import { initializeApp }   from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut }
                               from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, onValue, update }
                               from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const ADMIN_EMAIL = 'ingmarcosrodriguez31@gmail.com';

    const firebaseConfig = {
      apiKey:        'AIzaSyB-xx2PlBjvnHe0K7Bf1MspVqUlfjky0mk',
      authDomain:    'aemx-chat.firebaseapp.com',
      databaseURL:   'https://aemx-chat-default-rtdb.firebaseio.com',
      projectId:     'aemx-chat',
      storageBucket: 'aemx-chat.appspot.com',
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
    window.authWithGoogle = async function() {
      document.getElementById('authError').textContent = '';
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch(e) {
        document.getElementById('authError').textContent = 'Error al iniciar sesi√≥n.';
      }
    };

    window.signOutUser = async function() { await signOut(auth); };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('authOverlay').classList.add('hidden');
        if (user.email !== ADMIN_EMAIL) {
          document.getElementById('accessDenied').classList.add('visible');
          return;
        }
        // Admin autorizado
        document.getElementById('accessDenied').classList.remove('visible');
        document.getElementById('headerRight').style.display = 'flex';
        document.getElementById('adminEmail').textContent = user.displayName || user.email;
        loadUsers();
      } else {
        document.getElementById('authOverlay').classList.remove('hidden');
        document.getElementById('accessDenied').classList.remove('visible');
        document.getElementById('headerRight').style.display = 'none';
      }
    });

    // ‚îÄ‚îÄ Data ‚îÄ‚îÄ
    let allUsers   = [];
    let currentFilter = 'all';
    let searchQuery   = '';
    let pendingAction = null;

    function loadUsers() {
      onValue(ref(db, 'users'), (snapshot) => {
        allUsers = [];
        snapshot.forEach((child) => {
          const d = child.val();
          if (!d.username) return;
          const common    = parseInt(d.common)    || 0;
          const rare      = parseInt(d.rare)      || 0;
          const epic      = parseInt(d.epic)      || 0;
          const legendary = parseInt(d.legendary) || 0;
          allUsers.push({
            uid:        child.key,
            username:   d.username,
            avatar:     d.avatar      || '',
            borderColor:d.borderColor || '',
            country:    d.country     || '',
            city:       d.city        || '',
            total:      common + rare + epic + legendary,
            bannedChat:        !!d.bannedChat,
            bannedLeaderboard: !!d.bannedLeaderboard,
            countryHistory:    Array.isArray(d.countryHistory) ? d.countryHistory : [],
          });
        });
        allUsers.sort((a, b) => b.total - a.total);
        updateStats();
        renderTable();
        if (window.renderMiniMap) window.renderMiniMap(allUsers);
      });
    }

    function updateStats() {
      const bannedAny = allUsers.filter(u => u.bannedChat || u.bannedLeaderboard).length;
      document.getElementById('statTotal').textContent  = allUsers.length;
      document.getElementById('statActive').textContent = allUsers.length - bannedAny;
      document.getElementById('statBanned').textContent = bannedAny;
    }

    function getFiltered() {
      return allUsers.filter(u => {
        const matchFilter =
          currentFilter === 'all'    ? true :
          currentFilter === 'banned' ? (u.bannedChat || u.bannedLeaderboard) :
          currentFilter === 'active' ? (!u.bannedChat && !u.bannedLeaderboard) : true;
        const matchSearch = !searchQuery ||
          u.username.toLowerCase().includes(searchQuery.toLowerCase());
        return matchFilter && matchSearch;
      });
    }

    function avatarHTML(u) {
      const letter = (u.username || '?').charAt(0).toUpperCase();
      const colors = ['#00c8ff','#00ff9d','#c084fc','#60a5fa','#facc15','#4ade80','#f472b6'];
      const bg = colors[letter.charCodeAt(0) % colors.length];
      if (u.avatar && u.avatar.startsWith('data:image')) {
        return `<div class="avatar" style="border-color:${u.borderColor||'var(--border)'}"><img src="${u.avatar}" alt="${letter}"></div>`;
      }
      return `<div class="avatar" style="background:${bg};border-color:${u.borderColor||bg}">${letter}</div>`;
    }

    function renderTable() {
      const tbody  = document.getElementById('usersBody');
      const users  = getFiltered();

      if (users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">SIN USUARIOS</div></td></tr>`;
        return;
      }

      tbody.innerHTML = users.map((u, i) => {
        const isBannedChat  = u.bannedChat;
        const isBannedLb    = u.bannedLeaderboard;
        const anyBanned     = isBannedChat || isBannedLb;
        const rowClass      = anyBanned ? 'banned-row' : '';
        const delay         = Math.min(i * 0.03, 0.5);

        const statusBadges = [];
        if (isBannedChat) statusBadges.push(`<span class="status-badge banned">üí¨ CHAT</span>`);
        if (isBannedLb)   statusBadges.push(`<span class="status-badge banned">üèÜ RANKING</span>`);
        if (!anyBanned)   statusBadges.push(`<span class="status-badge active">ACTIVO</span>`);

        const actionBtns = [];
        actionBtns.push(`<button class="btn-action btn-edit-country" onclick="editCountry('${u.uid}','${u.username}','${u.country}')">‚úé PA√çS</button>`);
        if (isBannedChat) {
          actionBtns.push(`<button class="btn-action btn-unban" onclick="confirmAction('unbanChat','${u.uid}','${u.username}')">‚úì CHAT</button>`);
        } else {
          actionBtns.push(`<button class="btn-action btn-ban btn-ban-chat" onclick="confirmAction('banChat','${u.uid}','${u.username}')">‚úï CHAT</button>`);
        }
        if (isBannedLb) {
          actionBtns.push(`<button class="btn-action btn-unban" onclick="confirmAction('unbanLb','${u.uid}','${u.username}')">‚úì RANKING</button>`);
        } else {
          actionBtns.push(`<button class="btn-action btn-ban" onclick="confirmAction('banLb','${u.uid}','${u.username}')">‚úï RANKING</button>`);
        }

        return `
          <tr class="${rowClass}" style="animation-delay:${delay}s">
            <td>
              <div class="player-cell">
                ${avatarHTML(u)}
                <div>
                  <div class="player-name">${u.username}</div>
                </div>
              </div>
            </td>
            <td class="country-cell">
              ${u.country || '‚Äî'}
              ${u.countryHistory.length > 0 ? `
                <div class="country-changed">
                  ‚ö†Ô∏è ${u.countryHistory.length} cambio${u.countryHistory.length > 1 ? 's' : ''}
                  <div class="country-history-tooltip">
                    ${u.countryHistory.map(h => `
                      <div class="history-entry">
                        <span class="from">${h.from}</span> ‚Üí <span class="to">${h.to}</span><br>
                        <span class="date">${new Date(h.date).toLocaleString('es-MX')}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </td>
            <td class="parcelas-cell">${u.total.toLocaleString()}</td>
            <td>${statusBadges.join(' ')}</td>
            <td><div class="actions-cell">${actionBtns.join('')}</div></td>
          </tr>
        `;
      }).join('');
    }

    // ‚îÄ‚îÄ Filters ‚îÄ‚îÄ
    window.setFilter = function(f) {
      currentFilter = f;
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('active', 'active-banned');
      });
      const btn = document.getElementById(f === 'all' ? 'filterAll' : f === 'active' ? 'filterActive' : 'filterBanned');
      btn.classList.add(f === 'banned' ? 'active-banned' : 'active');
      renderTable();
    };

    window.filterSearch = function(q) {
      searchQuery = q;
      renderTable();
    };

    // ‚îÄ‚îÄ Confirm modal ‚îÄ‚îÄ
    window.confirmAction = function(action, uid, username) {
      const messages = {
        banChat:  `¬øBloquear a <strong>${username}</strong> del chat?`,
        unbanChat:`¬øDesbloquear a <strong>${username}</strong> del chat?`,
        banLb:    `¬øBloquear a <strong>${username}</strong> del leaderboard?`,
        unbanLb:  `¬øDesbloquear a <strong>${username}</strong> del leaderboard?`,
      };
      const titles = {
        banChat:  'BLOQUEAR CHAT',
        unbanChat:'DESBLOQUEAR CHAT',
        banLb:    'BLOQUEAR RANKING',
        unbanLb:  'DESBLOQUEAR RANKING',
      };
      document.getElementById('modalTitle').textContent = titles[action];
      document.getElementById('modalBody').innerHTML    = messages[action];
      document.getElementById('modalConfirmBtn').onclick = () => executeAction(action, uid, username);
      document.getElementById('confirmModal').classList.add('visible');
    };

    window.closeModal = function() {
      document.getElementById('confirmModal').classList.remove('visible');
    };

    async function executeAction(action, uid, username) {
      closeModal();
      const updates = {};
      if (action === 'banChat')   updates.bannedChat = true;
      if (action === 'unbanChat') updates.bannedChat = false;
      if (action === 'banLb')     updates.bannedLeaderboard = true;
      if (action === 'unbanLb')   updates.bannedLeaderboard = false;

      try {
        await update(ref(db, `users/${uid}`), updates);
        const msgs = {
          banChat:  `${username} bloqueado del chat`,
          unbanChat:`${username} desbloqueado del chat`,
          banLb:    `${username} bloqueado del ranking`,
          unbanLb:  `${username} desbloqueado del ranking`,
        };
        showToast(msgs[action]);
      } catch(e) {
        showToast('Error al actualizar', true);
      }
    }

    // ‚îÄ‚îÄ Edit Country ‚îÄ‚îÄ
    let editingUid = null;

    window.editCountry = function(uid, username, currentCountry) {
      editingUid = uid;
      document.getElementById('countryModalUser').innerHTML = `Usuario: <strong>${username}</strong> ¬∑ Pa√≠s actual: <strong>${currentCountry || '‚Äî'}</strong>`;
      document.getElementById('countryInput').value = currentCountry || '';
      document.getElementById('countryModal').classList.add('visible');
      setTimeout(() => document.getElementById('countryInput').focus(), 100);
    };

    window.closeCountryModal = function() {
      document.getElementById('countryModal').classList.remove('visible');
      editingUid = null;
    };

    window.saveCountry = async function() {
      if (!editingUid) return;
      const newCountry = document.getElementById('countryInput').value.trim();
      try {
        await update(ref(db, `users/${editingUid}`), { country: newCountry });
        closeCountryModal();
        showToast(`Pa√≠s actualizado a "${newCountry}"`);
      } catch(e) {
        showToast('Error al actualizar pa√≠s', true);
      }
    };

    // Enter key in country input
    document.getElementById('countryInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') window.saveCountry();
      if (e.key === 'Escape') window.closeCountryModal();
    });

    // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
    let toastTimer;
    function showToast(msg, isError = false) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.toggle('error', isError);
      el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
    }
  </script>
  <!-- ===== CHAT WIDGET ===== -->
  <button id="chat-fab" onclick="toggleChat()" aria-label="Abrir chat">
    <svg class="icon-chat" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>
    <svg class="icon-close" style="display:none" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
  </button>

  <div id="chat-iframe-container">
    <div id="chat-widget-bar">
      <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <span id="widget-time">--:--</span>
    </div>
    <iframe id="chat-frame" src="about:blank" title="Chat Atlas Earth M√©xico" loading="lazy" allow="clipboard-write"></iframe>
  </div>

  <script>
    let chatOpen = false;

    function toggleChat() {
      chatOpen = !chatOpen;
      document.getElementById('chat-iframe-container').classList.toggle('open', chatOpen);
      document.getElementById('chat-fab').classList.toggle('open', chatOpen);

      if (window.innerWidth <= 480) {
        document.getElementById('chat-fab').style.display = chatOpen ? 'none' : 'flex';
      }

      if (chatOpen) {
        history.pushState({ chatOpen: true }, '');
        // Admin no tiene username/avatar en localStorage del mismo modo,
        // pero si los tiene los pasa igual
        const username = localStorage.getItem('atlas-username') || 'ADMIN';
        const color    = localStorage.getItem('atlas-avatar-border') || '#ff4466';
        document.getElementById('chat-frame').src =
          `chat-firebase.html?username=${encodeURIComponent(username)}&color=${encodeURIComponent(color)}`;
      }
    }

    function updateWidgetTime() {
      const now = new Date();
      document.getElementById('widget-time').textContent =
        String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
    }
    updateWidgetTime();
    setInterval(updateWidgetTime, 60000);

    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'CLOSE_CHAT') closeChatWidget();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && chatOpen) closeChatWidget(); });

    function closeChatWidget() {
      chatOpen = false;
      document.getElementById('chat-iframe-container').classList.remove('open');
      document.getElementById('chat-fab').classList.remove('open');
      if (window.innerWidth <= 480) {
        document.getElementById('chat-fab').style.display = 'flex';
      }
    }

    window.addEventListener('popstate', () => { if (chatOpen) closeChatWidget(); });
  </script>
  <!-- ===== FIN CHAT WIDGET ===== -->
</body>
</html>
