<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADMIN ¬∑ ATLAS EARTH AEMX</title>
  <link rel="icon" type="image/png" href="imagen_1.png">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <style>
    :root {
      --bg:        #060b14;
      --panel:     #0b1626;
      --panel2:    #0f1e35;
      --border:    #1a3a5c;
      --glow:      #00c8ff;
      --glow2:     #00ff9d;
      --danger:    #ff4466;
      --warning:   #ffaa00;
      --success:   #00ff9d;
      --text:      #cce4ff;
      --text2:     #6b8ab0;
      --banned-bg: rgba(255,68,102,0.08);
      --banned-border: rgba(255,68,102,0.3);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0,200,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,200,255,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: 0;
      animation: gridMove 20s linear infinite;
      pointer-events: none;
    }

    @keyframes gridMove {
      0%   { transform: translateY(0); }
      100% { transform: translateY(40px); }
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 20% 10%, rgba(255,68,102,0.05) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 90%, rgba(0,200,255,0.04) 0%, transparent 50%);
      z-index: 0;
      pointer-events: none;
    }

    /* ‚îÄ‚îÄ Auth overlay ‚îÄ‚îÄ */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(6,11,20,0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
    }
    .auth-overlay.hidden { display: none; }

    .auth-box {
      background: var(--panel);
      border: 1px solid var(--danger);
      border-radius: 16px;
      padding: 48px 40px;
      max-width: 380px;
      width: 90%;
      text-align: center;
      box-shadow: 0 0 60px rgba(255,68,102,0.15);
      animation: fadeUp 0.4s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .auth-box .lock-icon {
      font-size: 40px;
      margin-bottom: 16px;
      display: block;
    }

    .auth-box h2 {
      font-family: 'Orbitron', monospace;
      font-size: 13px;
      color: var(--danger);
      letter-spacing: 4px;
      margin-bottom: 8px;
    }

    .auth-box p {
      color: var(--text2);
      font-size: 13px;
      margin-bottom: 28px;
      letter-spacing: 1px;
    }

    .auth-btn-google {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 13px 20px;
      background: linear-gradient(135deg, #1a1a2e, #0b1626);
      border: 1px solid var(--danger);
      border-radius: 10px;
      color: var(--danger);
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .auth-btn-google:hover {
      background: var(--danger);
      color: #fff;
      box-shadow: 0 0 24px rgba(255,68,102,0.4);
    }

    .auth-error {
      margin-top: 14px;
      font-size: 12px;
      color: var(--danger);
      letter-spacing: 1px;
      min-height: 18px;
    }

    /* ‚îÄ‚îÄ Access denied ‚îÄ‚îÄ */
    .access-denied {
      position: fixed;
      inset: 0;
      background: rgba(6,11,20,0.98);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1999;
      flex-direction: column;
      gap: 16px;
      text-align: center;
      padding: 20px;
    }
    .access-denied.visible { display: flex; }
    .access-denied .icon { font-size: 56px; }
    .access-denied h2 {
      font-family: 'Orbitron', monospace;
      font-size: 16px;
      color: var(--danger);
      letter-spacing: 4px;
    }
    .access-denied p {
      color: var(--text2);
      font-size: 13px;
      letter-spacing: 1px;
    }
    .btn-signout-denied {
      margin-top: 8px;
      background: none;
      border: 1px solid var(--danger);
      border-radius: 8px;
      color: var(--danger);
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      letter-spacing: 2px;
      padding: 8px 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-signout-denied:hover { background: var(--danger); color: #fff; }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .container {
      position: relative;
      z-index: 1;
      max-width: 1600px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    /* ‚îÄ‚îÄ Aviso panel ‚îÄ‚îÄ */
    .aviso-card {
      background: var(--panel);
      border: 1px solid rgba(255,170,0,0.4);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .aviso-card::before {
      content: '';
      display: block;
      height: 2px;
      background: linear-gradient(90deg, #ffaa00, #ffdd00, #ffaa00);
      background-size: 200% 100%;
      animation: rainbowSlide 3s linear infinite;
    }
    @keyframes rainbowSlide { 0%{background-position:0%} 100%{background-position:200%} }
    .aviso-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: rgba(255,170,0,0.06);
      border-bottom: 1px solid rgba(255,170,0,0.2);
    }
    .aviso-title {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 3px;
      color: #ffaa00;
    }
    .aviso-live {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: #ffaa00;
      opacity: 0.6;
    }
    .aviso-body {
      display: flex;
      gap: 8px;
      padding: 12px 14px;
      align-items: center;
    }
    .aviso-input:focus { border-color: #ffaa00; box-shadow: 0 0 8px rgba(255,170,0,0.3); }
    .aviso-input::placeholder { color: rgba(255,170,0,0.35); font-size: 11px; letter-spacing: 1px; }
    .aviso-btn {
      background: rgba(255,170,0,0.15);
      border: 1px solid #ffaa00;
      border-radius: 8px;
      color: #ffaa00;
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 8px 14px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .aviso-btn:hover { background: #ffaa00; color: #060b14; }
    .aviso-btn.clear { border-color: var(--text2); color: var(--text2); background: none; }
    .aviso-btn.clear:hover { background: var(--text2); color: #060b14; }
    .admin-body {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 12px;
      align-items: start;
    }

    /* ‚îÄ‚îÄ Left column: mapa compacto ‚îÄ‚îÄ */
    .map-col {
      position: sticky;
      top: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .map-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--glow), var(--glow2));
      z-index: 10;
    }

    .map-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--panel2);
    }

    .map-card-title {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 3px;
      color: var(--glow);
    }

    .map-live-dot {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--glow2);
      letter-spacing: 1px;
    }

    .map-live-dot::before {
      content: '';
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--glow2);
      box-shadow: 0 0 6px var(--glow2);
      animation: pulse 1.5s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50%       { opacity: 0.4; transform: scale(0.7); }
    }

    #mini-map {
      height: 320px;
      width: 100%;
      background: #060b14;
    }

    .map-mini-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--border);
    }

    .map-mini-stat {
      background: var(--panel2);
      padding: 8px 12px;
      text-align: center;
    }

    .map-mini-stat .num {
      font-family: 'Orbitron', monospace;
      font-size: 16px;
      font-weight: 700;
      color: var(--glow);
    }

    .map-mini-stat .lbl {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--text2);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-top: 2px;
    }

    /* ‚îÄ‚îÄ Right column ‚îÄ‚îÄ */
    .table-col { min-width: 0; }

    @media (max-width: 900px) {
      .admin-body { grid-template-columns: 1fr; }
      .map-col { position: static; }
      #mini-map { height: 260px; }
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 12px;
    }

    .header-left h1 {
      font-family: 'Orbitron', monospace;
      font-size: clamp(16px, 3.5vw, 22px);
      font-weight: 900;
      letter-spacing: 4px;
      color: var(--danger);
      text-shadow: 0 0 20px rgba(255,68,102,0.4);
    }

    .header-left .subtitle {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      letter-spacing: 2px;
      margin-top: 4px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      color: var(--text2);
    }

    .admin-badge {
      background: rgba(255,68,102,0.15);
      border: 1px solid var(--danger);
      border-radius: 6px;
      padding: 3px 10px;
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      color: var(--danger);
      letter-spacing: 2px;
    }

    .btn-signout {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text2);
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      letter-spacing: 1px;
      padding: 4px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-signout:hover { border-color: var(--danger); color: var(--danger); }

    .btn-mapa {
      background: none;
      border: 1px solid var(--glow);
      border-radius: 6px;
      color: var(--glow);
      font-family: 'Rajdhani', sans-serif;
      font-size: 11px;
      letter-spacing: 1px;
      padding: 4px 10px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .btn-mapa:hover { background: rgba(0,200,255,0.1); box-shadow: 0 0 10px rgba(0,200,255,0.3); }

    /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; bottom: 0;
      width: 3px;
    }
    .stat-card.total::before    { background: linear-gradient(180deg, var(--glow), var(--glow2)); }
    .stat-card.banned-c::before { background: var(--danger); }
    .stat-card.active-c::before { background: var(--success); }
    .stat-card.clan-c::before   { background: var(--glow2); }
    .stat-card.coins-c::before  { background: #ffd700; }
    .stat-card[style*="--accent:#ffaa00"]::before { background: #ffaa00; }
    .stat-card[style*="--accent:#ffffff"]::before { background: linear-gradient(180deg, #fff, #a0cfff); }

    .stat-icon {
      font-size: 18px;
      flex-shrink: 0;
      opacity: 0.8;
    }

    .stat-info { display: flex; flex-direction: column; min-width: 0; }

    .stat-value {
      font-family: 'Orbitron', monospace;
      font-size: 20px;
      font-weight: 700;
      line-height: 1;
    }
    .stat-card.total .stat-value    { color: var(--glow); }
    .stat-card.banned-c .stat-value { color: var(--danger); }
    .stat-card.active-c .stat-value { color: var(--success); }
    .stat-card.clan-c .stat-value   { color: var(--glow2); }
    .stat-card.coins-c .stat-value  { color: #ffd700; }

    .stat-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--text2);
      letter-spacing: 1px;
      margin-top: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 1200px) {
      .stats-bar { grid-template-columns: repeat(4, 1fr); }
    }
    @media (max-width: 900px) {
      .stats-bar { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 600px) {
      .stats-bar { grid-template-columns: repeat(2, 1fr); }
    }

    /* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text2);
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      letter-spacing: 1px;
      padding: 6px 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn:hover { border-color: var(--glow); color: var(--glow); }
    .filter-btn.active { border-color: var(--glow); color: var(--glow); background: rgba(0,200,255,0.08); }
    .filter-btn.active-banned { border-color: var(--danger); color: var(--danger); background: rgba(255,68,102,0.08); }

    /* ‚îÄ‚îÄ User table ‚îÄ‚îÄ */
    .table-wrap {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 8px;
    }

    .table-title {
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      color: var(--glow);
      letter-spacing: 3px;
    }

    .search-input {
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      padding: 6px 12px;
      outline: none;
      width: 200px;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--glow); }
    .search-input::placeholder { color: var(--text2); }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--text2);
      text-align: left;
      padding: 8px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--panel2);
    }

    tbody tr {
      border-bottom: 1px solid rgba(26,58,92,0.5);
      transition: background 0.15s;
      animation: fadeIn 0.3s ease both;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-6px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(0,200,255,0.03); }
    tbody tr.banned-row { background: var(--banned-bg); border-left: 2px solid var(--danger); }
    tbody tr.banned-row:hover { background: rgba(255,68,102,0.1); }

    tbody td { padding: 8px 14px; vertical-align: middle; }

    .player-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 30px; height: 30px;
      border-radius: 50%;
      border-width: 2px;
      border-style: solid;
      border-color: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      font-weight: 700;
      color: #060b14;
      flex-shrink: 0;
      overflow: hidden;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

    .player-name {
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 1px;
    }

    .player-email {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      margin-top: 2px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      padding: 3px 10px;
      border-radius: 20px;
      letter-spacing: 1px;
      white-space: nowrap;
    }
    .status-badge.active  { color: var(--success); background: rgba(0,255,157,0.1); border: 1px solid rgba(0,255,157,0.3); }
    .status-badge.banned  { color: var(--danger);  background: rgba(255,68,102,0.1); border: 1px solid rgba(255,68,102,0.3); }
    .status-badge::before {
      content: '';
      width: 5px; height: 5px;
      border-radius: 50%;
    }
    .status-badge.active::before { background: var(--success); box-shadow: 0 0 6px var(--success); }
    .status-badge.banned::before { background: var(--danger); }

    .parcelas-cell {
      font-family: 'Orbitron', monospace;
      font-size: 12px;
      font-weight: 700;
      color: var(--glow);
    }

    .country-cell {
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      color: var(--text2);
    }

    /* ‚îÄ‚îÄ Action buttons ‚îÄ‚îÄ */
    .actions-cell { display: flex; gap: 8px; flex-wrap: wrap; }

    .btn-action {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 5px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid;
      white-space: nowrap;
    }

    .btn-ban {
      color: var(--danger);
      border-color: rgba(255,68,102,0.5);
      background: rgba(255,68,102,0.08);
    }
    .btn-ban:hover { background: var(--danger); color: #fff; box-shadow: 0 0 14px rgba(255,68,102,0.4); }

    /* Country change badge */
    .country-changed {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--warning);
      background: rgba(255,170,0,0.1);
      border: 1px solid rgba(255,170,0,0.4);
      border-radius: 6px;
      padding: 2px 7px;
      cursor: pointer;
      position: relative;
    }

    .country-history-tooltip {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      background: var(--panel2);
      border: 1px solid var(--warning);
      border-radius: 8px;
      padding: 10px 14px;
      min-width: 220px;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }

    .country-changed:hover .country-history-tooltip { display: block; }

    .history-entry {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
      line-height: 1.6;
    }
    .history-entry:last-child { border-bottom: none; }
    .history-entry .from { color: var(--danger); }
    .history-entry .to   { color: var(--success); }
    .history-entry .date { color: var(--text2); font-size: 9px; }

    .btn-unban {
      color: var(--success);
      border-color: rgba(0,255,157,0.5);
      background: rgba(0,255,157,0.08);
    }
    .btn-unban:hover { background: var(--success); color: #060b14; box-shadow: 0 0 14px rgba(0,255,157,0.4); }

    .btn-clan {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text2);
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-clan:hover { border-color: var(--glow2); color: var(--glow2); }
    .btn-clan.is-member {
      background: rgba(0,255,157,0.15);
      border-color: var(--glow2);
      color: var(--glow2);
      box-shadow: 0 0 8px rgba(0,255,157,0.3);
    }
    .clan-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      color: var(--glow2);
      text-shadow: 0 0 6px var(--glow2);
    }
    .btn-ban-chat {
      color: var(--warning);
      border-color: rgba(255,170,0,0.5);
      background: rgba(255,170,0,0.08);
    }
    .btn-ban-chat:hover { background: var(--warning); color: #060b14; }

    .btn-edit-country {
      color: #a78bfa;
      border-color: rgba(167,139,250,0.5);
      background: rgba(167,139,250,0.08);
    }
    .btn-edit-country:hover { background: #a78bfa; color: #fff; box-shadow: 0 0 14px rgba(167,139,250,0.4); }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--panel);
      border: 1px solid var(--glow);
      border-radius: 10px;
      padding: 10px 24px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      color: var(--glow);
      letter-spacing: 1px;
      z-index: 3000;
      transition: transform 0.3s ease, opacity 0.3s ease;
      opacity: 0;
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { border-color: var(--danger); color: var(--danger); }

    /* ‚îÄ‚îÄ Empty / loading ‚îÄ‚îÄ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text2);
      font-family: 'Share Tech Mono', monospace;
      font-size: 12px;
      letter-spacing: 2px;
    }

    .spinner {
      width: 28px; height: 28px;
      border: 2px solid var(--border);
      border-top-color: var(--danger);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 14px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Confirm modal ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(6,11,20,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.visible { display: flex; }

    .modal-box {
      background: var(--panel);
      border: 1px solid var(--danger);
      border-radius: 14px;
      padding: 32px 28px;
      max-width: 340px;
      width: 90%;
      text-align: center;
      box-shadow: 0 0 40px rgba(255,68,102,0.2);
      animation: fadeUp 0.3s ease;
    }
    .modal-box h3 {
      font-family: 'Orbitron', monospace;
      font-size: 13px;
      color: var(--danger);
      letter-spacing: 3px;
      margin-bottom: 10px;
    }
    .modal-box p {
      color: var(--text2);
      font-size: 13px;
      margin-bottom: 24px;
      letter-spacing: 0.5px;
      line-height: 1.5;
    }
    .modal-box strong { color: var(--text); }
    .modal-actions { display: flex; gap: 10px; justify-content: center; }
    .btn-confirm {
      background: var(--danger);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 9px 20px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-confirm:hover { opacity: 0.85; }
    .btn-cancel {
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text2);
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      letter-spacing: 1px;
      padding: 9px 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-cancel:hover { border-color: var(--text2); color: var(--text); }

    @media (max-width: 640px) {
      .actions-cell { flex-direction: column; }
      .search-input { width: 100%; }
      tbody td { padding: 10px 12px; }
      thead th { padding: 8px 12px; }
      .player-email { display: none; }
    }

    /* ===== CHAT WIDGET ===== */
    #chat-fab {
      position: fixed;
      bottom: 28px;
      right: 28px;
      z-index: 9998;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00ff88, #00ffff);
      border: none;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0,255,136,0.6), 0 4px 15px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    #chat-fab:hover { transform: scale(1.1); box-shadow: 0 0 35px rgba(0,255,136,0.9), 0 6px 20px rgba(0,0,0,0.5); }
    #chat-fab:active { transform: scale(0.95); }
    #chat-fab svg { width: 28px; height: 28px; fill: #0a0e1a; }
    #chat-fab.open svg.icon-chat { display: none; }
    #chat-fab.open svg.icon-close { display: block !important; }
    #chat-fab::before {
      content: 'CHAT';
      position: absolute;
      right: 70px;
      background: #0f1419;
      border: 1px solid #00ff88;
      color: #00ff88;
      font-family: 'Orbitron', sans-serif;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 6px 10px;
      border-radius: 4px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      box-shadow: 0 0 10px rgba(0,255,136,0.3);
    }
    #chat-fab:hover::before { opacity: 1; }
    #chat-fab.open::before { content: 'CERRAR'; }

    #chat-iframe-container {
      position: fixed;
      bottom: 100px;
      right: 28px;
      z-index: 9997;
      width: 380px;
      height: min(600px, calc(100dvh - 120px));
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #00ff88;
      box-shadow: 0 0 40px rgba(0,255,136,0.4), 0 20px 60px rgba(0,0,0,0.6);
      transform: scale(0.85) translateY(20px);
      transform-origin: bottom right;
      opacity: 0;
      pointer-events: none;
      transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1), opacity 0.25s ease;
    }
    #chat-iframe-container.open { transform: scale(1) translateY(0); opacity: 1; pointer-events: all; }
    #chat-iframe-container iframe { width: 100%; height: 100%; border: none; display: block; }
  


    @media (max-width: 480px) {
      #chat-iframe-container {
        right: 0; bottom: 0; left: 0; top: auto;
        width: 100%; height: 75dvh;
        border-radius: 20px 20px 0 0;
        transform-origin: bottom center;
        border-left: none; border-right: none; border-bottom: none;
      }
      #chat-fab { bottom: 20px; right: 20px; }
    }
    /* ‚îÄ‚îÄ Card de aviso ‚îÄ‚îÄ */
    .aviso-card {
      background: var(--panel);
      border: 1px solid rgba(255,170,0,0.4);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .aviso-label {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--warning);
      white-space: nowrap;
      flex-shrink: 0;
    }
    .aviso-input:focus { border-color: var(--warning); }
    .aviso-input::placeholder { color: var(--text2); font-size: 12px; }
    .aviso-btn {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1px;
      padding: 7px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.15s;
      flex-shrink: 0;
    }
    .aviso-btn:hover { opacity: 0.85; transform: translateY(-1px); }
    .aviso-btn-pub  { background: var(--warning); color: #000; }
    .aviso-btn-clear { background: rgba(255,68,102,0.15); border: 1px solid var(--danger); color: var(--danger); }
    .aviso-status {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--success);
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
    }
    .aviso-status.visible { opacity: 1; }

    /* ===== FIN CHAT WIDGET ===== */

    /* ‚îÄ‚îÄ Aviso panel ‚îÄ‚îÄ */
    .aviso-card {
      background: var(--panel);
      border: 1px solid rgba(255,170,0,0.4);
      border-radius: 12px;
      overflow: hidden;
      border-top: 2px solid #ffaa00;
    }
    .aviso-card::before { display: none; }
    .aviso-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255,170,0,0.2);
      background: rgba(255,170,0,0.06);
    }
    .aviso-title {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 3px;
      color: #ffaa00;
    }
    .aviso-body { padding: 12px 14px; display: flex; flex-direction: row; align-items: flex-start; gap: 10px; }
    .aviso-input {
      flex: 1 1 auto;
      min-width: 200px;
      background: var(--panel2);
      border: 1px solid rgba(255,170,0,0.3);
      border-radius: 8px;
      color: #ffe066;
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      padding: 9px 12px;
      outline: none;
      resize: none;
      transition: border-color 0.2s;
    }
    .aviso-input:focus { border-color: #ffaa00; box-shadow: 0 0 8px rgba(255,170,0,0.2); }
    .aviso-input::placeholder { color: var(--text2); }
    .aviso-actions { display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
    .aviso-preview {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: rgba(255,220,100,0.5);
      letter-spacing: 1px;
      font-style: italic;
      display: none;
    }
    .btn-aviso-publish {
      flex: 1;
      background: linear-gradient(135deg, rgba(255,170,0,0.25), rgba(255,220,0,0.15));
      border: 1px solid #ffaa00;
      border-radius: 7px;
      color: #ffaa00;
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-aviso-publish:hover { background: rgba(255,170,0,0.3); box-shadow: 0 0 12px rgba(255,170,0,0.3); }
    .btn-aviso-clear {
      background: none;
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text2);
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      padding: 8px 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
    }
    .btn-aviso-clear:hover { border-color: var(--danger); color: var(--danger); }
    .aviso-preview {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: rgba(255,220,100,0.5);
      letter-spacing: 1px;
      font-style: italic;
      min-height: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ‚îÄ‚îÄ Toggle Coins ‚îÄ‚îÄ */
    .coins-toggle-wrap {
      background: var(--panel);
      border: 1px solid rgba(255,215,0,0.35);
      border-top: 2px solid #ffd700;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 16px;
      flex-shrink: 0;
    }
    .coins-toggle-label {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 3px;
      color: #ffd700;
      white-space: nowrap;
    }
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
      flex-shrink: 0;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--border);
      border-radius: 26px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 18px; height: 18px;
      left: 3px; top: 3px;
      background: var(--text2);
      border-radius: 50%;
      transition: all 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider {
      background: rgba(255,215,0,0.2);
      border-color: #ffd700;
      box-shadow: 0 0 10px rgba(255,215,0,0.4);
    }
    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(22px);
      background: #ffd700;
    }
    .coins-toggle-status {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      white-space: nowrap;
    }
    .coins-toggle-status.on  { color: #ffd700; }
    .coins-toggle-status.off { color: var(--text2); }

    /* Toggle transacciones (cyan) */
    #transToggle:checked + .toggle-slider {
      background: rgba(0,200,255,0.2) !important;
      border-color: var(--glow) !important;
      box-shadow: 0 0 10px rgba(0,200,255,0.4) !important;
    }
    #transToggle:checked + .toggle-slider::before {
      background: var(--glow) !important;
    }
    .trans-status-on  { color: var(--glow) !important; }
    .trans-status-off { color: var(--text2); }

    /* ‚îÄ‚îÄ AEMX Coins ‚îÄ‚îÄ */
    .coins-cell {
      font-family: 'Orbitron', monospace;
      font-size: 13px;
      font-weight: 700;
      color: #ffd700;
      text-shadow: 0 0 8px rgba(255,215,0,0.4);
      white-space: nowrap;
    }
    .coins-cell .coin-icon { margin-right: 4px; font-size: 14px; }
    .coins-cell .coin-zero { color: var(--border); font-size: 12px; text-shadow: none; }

    .btn-edit-coins {
      color: #ffd700;
      border-color: rgba(255,215,0,0.4);
      background: rgba(255,215,0,0.07);
      font-size: 9px;
      margin-left: 6px;
      padding: 2px 7px;
      border-radius: 4px;
      border: 1px solid;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      vertical-align: middle;
    }
    .btn-edit-coins:hover {
      background: #ffd700;
      color: #060b14;
      box-shadow: 0 0 10px rgba(255,215,0,0.4);
    }

    /* Modal coins */
    #coinsModal .modal-box { border-color: #ffd700; box-shadow: 0 0 40px rgba(255,215,0,0.15); }
    #coinsModal .modal-box h3 { color: #ffd700; }
    #coinsModal .btn-confirm-coins {
      background: #ffd700;
      color: #060b14;
      border: none;
      border-radius: 8px;
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 9px 20px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    #coinsModal .btn-confirm-coins:hover { opacity: 0.85; }
    #coinsModal input[type="number"] {
      width: 100%;
      background: var(--panel2);
      border: 1px solid rgba(255,215,0,0.4);
      border-radius: 8px;
      color: #ffd700;
      font-family: 'Orbitron', monospace;
      font-size: 22px;
      font-weight: 700;
      padding: 10px 14px;
      outline: none;
      text-align: center;
      margin-bottom: 18px;
      letter-spacing: 2px;
    }
    #coinsModal input[type="number"]:focus { border-color: #ffd700; box-shadow: 0 0 8px rgba(255,215,0,0.2); }
    #coinsModal input[type="number"]::-webkit-inner-spin-button,
    #coinsModal input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }

    /* ‚îÄ‚îÄ Leaflet mini-map overrides ‚îÄ‚îÄ */
    #mini-map .leaflet-control-zoom {
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
      overflow: hidden;
    }
    #mini-map .leaflet-control-zoom a {
      background: var(--panel2) !important;
      color: var(--glow) !important;
      border-color: var(--border) !important;
      font-weight: 700;
      width: 24px !important;
      height: 24px !important;
      line-height: 24px !important;
      font-size: 14px !important;
    }
    #mini-map .leaflet-control-zoom a:hover {
      background: var(--panel) !important;
      color: #fff !important;
    }
    #mini-map .leaflet-control-attribution { display: none; }
    #mini-map { background: #060b14 !important; }
    .leaflet-container { background: #060b14 !important; font-family: 'Rajdhani', sans-serif; }
    .leaflet-tooltip {
      background: var(--panel) !important;
      border: 1px solid var(--border) !important;
      color: var(--text2) !important;
      font-family: 'Orbitron', monospace !important;
      font-size: 9px !important;
      letter-spacing: 1px !important;
      border-radius: 6px !important;
    }

    /* ‚îÄ‚îÄ C√≥digos activos (admin) ‚îÄ‚îÄ */
    .active-codes-section {
      margin-top: 16px;
    }
    .active-codes-card {
      background: var(--panel);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 12px;
      overflow: hidden;
    }
    .active-codes-card::before {
      content: '';
      display: block;
      height: 2px;
      background: linear-gradient(90deg, #ffd700, #ffaa00, #00ff9d, #ffd700);
      background-size: 200% 100%;
      animation: shimmerGold 3s linear infinite;
    }
    @keyframes shimmerGold { 0%{background-position:0%} 100%{background-position:200%} }
    .active-codes-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,215,0,0.04);
      flex-wrap: wrap;
      gap: 8px;
    }
    .active-codes-title {
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 3px;
      color: #ffd700;
    }
    .active-codes-meta {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .active-codes-badge {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--text2);
      letter-spacing: 1px;
    }
    .active-codes-badge span {
      color: #ffd700;
      font-weight: 700;
    }
    .active-codes-table {
      width: 100%;
      border-collapse: collapse;
    }
    .active-codes-table th {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--text2);
      text-align: left;
      padding: 8px 18px;
      border-bottom: 1px solid var(--border);
      background: var(--panel2);
    }
    .active-codes-table td {
      padding: 10px 18px;
      border-bottom: 1px solid rgba(26,58,92,0.4);
      vertical-align: middle;
    }
    .active-codes-table tr:last-child td { border-bottom: none; }
    .active-codes-table tr { animation: fadeIn 0.3s ease both; }
    .ac-user {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .ac-avatar {
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 700;
      color: #060b14;
      flex-shrink: 0;
      overflow: hidden;
    }
    .ac-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .ac-username {
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 1px;
    }
    .ac-coins {
      font-family: 'Orbitron', monospace;
      font-size: 14px;
      font-weight: 700;
      color: #ffd700;
      text-shadow: 0 0 8px rgba(255,215,0,0.4);
    }
    .ac-time {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--text2);
      letter-spacing: 1px;
    }
    .ac-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text2);
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      letter-spacing: 2px;
    }
  </style>
</head>
<body>

  <!-- Auth Overlay -->
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-box">
      <span class="lock-icon">üîê</span>
      <h2>PANEL DE ADMINISTRACI√ìN</h2>
      <p>Acceso restringido ‚Äî solo administradores</p>
      <button class="auth-btn-google" onclick="authWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 48 48">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
        </svg>
        INICIAR CON GOOGLE
      </button>
      <div class="auth-error" id="authError"></div>
    </div>
  </div>

  <!-- Access Denied -->
  <div class="access-denied" id="accessDenied">
    <span class="icon">üö´</span>
    <h2>ACCESO DENEGADO</h2>
    <p>No tienes permisos de administrador.</p>
    <button class="btn-signout-denied" onclick="signOutUser()">CERRAR SESI√ìN</button>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
      <h3 id="modalTitle">CONFIRMAR</h3>
      <p id="modalBody"></p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal()">CANCELAR</button>
        <button class="btn-confirm" id="modalConfirmBtn">CONFIRMAR</button>
      </div>
    </div>
  </div>

  <!-- Edit Country Modal -->
  <div class="modal-overlay" id="countryModal">
    <div class="modal-box">
      <h3>‚úé EDITAR PA√çS</h3>
      <p id="countryModalUser" style="margin-bottom:14px;"></p>
      <input
        id="countryInput"
        type="text"
        placeholder="Ej: Mexico, United States..."
        style="width:100%;background:var(--panel2);border:1px solid #a78bfa;border-radius:8px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:13px;padding:9px 14px;outline:none;margin-bottom:18px;letter-spacing:1px;"
      >
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeCountryModal()">CANCELAR</button>
        <button class="btn-confirm" style="background:#a78bfa;" onclick="saveCountry()">GUARDAR</button>
      </div>
    </div>
  </div>

  <!-- Edit Coins Modal -->
  <div class="modal-overlay" id="coinsModal">
    <div class="modal-box">
      <h3>ü™ô EDITAR AEMX COINS</h3>
      <p id="coinsModalUser" style="margin-bottom:14px;"></p>
      <input
        id="coinsInput"
        type="number"
        min="0"
        placeholder="0"
      >
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeCoinsModal()">CANCELAR</button>
        <button class="btn-confirm-coins" onclick="saveCoins()">GUARDAR</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Panel de avisos FULL WIDTH -->
  <div class="container" style="padding-bottom:0;">
    <header>
      <div class="header-left">
        <h1>‚öôÔ∏è ADMIN PANEL</h1>
        <div class="subtitle">ATLAS EARTH AEMX ¬∑ GESTI√ìN DE USUARIOS</div>
      </div>
      <div class="header-right" id="headerRight" style="display:none">
        <span class="admin-badge">ADMIN</span>
        <span id="adminEmail"></span>
        <!-- Network bars -->
        <div id="netWidget" style="display:flex;align-items:center;gap:5px;padding:0 6px;">
          <div style="display:flex;align-items:flex-end;gap:2px;height:22px;">
            <div class="net-bar" id="nb1" style="width:4px;background:var(--glow);border-radius:2px 2px 0 0;opacity:0.3;transition:height 0.3s ease,opacity 0.3s;"></div>
            <div class="net-bar" id="nb2" style="width:4px;background:var(--glow);border-radius:2px 2px 0 0;opacity:0.3;transition:height 0.3s ease,opacity 0.3s;"></div>
            <div class="net-bar" id="nb3" style="width:4px;background:var(--glow);border-radius:2px 2px 0 0;opacity:0.3;transition:height 0.3s ease,opacity 0.3s;"></div>
            <div class="net-bar" id="nb4" style="width:4px;background:var(--glow);border-radius:2px 2px 0 0;opacity:0.3;transition:height 0.3s ease,opacity 0.3s;"></div>
            <div class="net-bar" id="nb5" style="width:4px;background:var(--glow);border-radius:2px 2px 0 0;opacity:0.3;transition:height 0.3s ease,opacity 0.3s;"></div>
          </div>
          <span id="netLabel" style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--glow);letter-spacing:1px;white-space:nowrap;">-- ms</span>
        </div>
        <a href="mapa.html" class="btn-mapa">üó∫Ô∏è MAPA</a>
        <button class="btn-signout" onclick="signOutUser()">SALIR</button>
      </div>
    </header>
  </div>

  <!-- Controles: Aviso + TTL + Coins -->
  <div style="position:relative;z-index:1;padding:0 16px 12px;display:flex;flex-direction:column;gap:10px;">

    <!-- Aviso del chat (fila completa) -->
    <div style="background:var(--panel);border:1px solid rgba(255,170,0,0.4);border-top:2px solid #ffaa00;border-radius:12px;display:flex;align-items:center;gap:12px;padding:10px 16px;">
      <span style="font-family:'Orbitron',monospace;font-size:9px;font-weight:700;letter-spacing:3px;color:#ffaa00;white-space:nowrap;flex-shrink:0;">üì¢ AVISO DEL CHAT</span>
      <textarea
        id="avisoInput"
        rows="1"
        placeholder="Escribe un aviso para mostrar en el chat..."
        onkeydown="if(event.ctrlKey&&event.key==='Enter')saveAviso()"
        style="flex:1;min-width:0;height:38px;background:var(--panel2);border:1px solid rgba(255,170,0,0.3);border-radius:8px;color:#ffe066;font-family:'Rajdhani',sans-serif;font-size:13px;padding:9px 12px;outline:none;resize:none;transition:border-color 0.2s;line-height:1.4;"
      ></textarea>
      <div id="avisoPreview" style="display:none;"></div>
      <button onclick="saveAviso()" style="flex-shrink:0;background:linear-gradient(135deg,rgba(255,170,0,0.25),rgba(255,220,0,0.15));border:1px solid #ffaa00;border-radius:7px;color:#ffaa00;font-family:'Orbitron',monospace;font-size:9px;font-weight:700;letter-spacing:2px;padding:9px 18px;cursor:pointer;white-space:nowrap;">‚ö° PUBLICAR</button>
      <button id="avisoClear" onclick="clearAviso()" style="display:none;flex-shrink:0;background:none;border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;padding:9px 14px;cursor:pointer;white-space:nowrap;">‚úï BORRAR</button>
    </div>

    <!-- Autoborrado + Coins (misma fila) -->
    <div style="display:flex;gap:10px;flex-wrap:wrap;">

      <!-- TTL control -->
      <div style="background:var(--panel);border:1px solid rgba(0,200,255,0.3);border-top:2px solid var(--glow);border-radius:12px;display:flex;align-items:center;gap:12px;padding:10px 16px;flex-shrink:0;">
        <span style="font-family:'Orbitron',monospace;font-size:9px;font-weight:700;letter-spacing:3px;color:var(--glow);white-space:nowrap;">üóëÔ∏è AUTOBORRADO</span>
        <input
          id="ttlInput"
          type="number"
          min="1"
          max="720"
          placeholder="Horas"
          style="width:80px;background:var(--panel2);border:1px solid rgba(0,200,255,0.3);border-radius:8px;color:var(--glow);font-family:'Rajdhani',sans-serif;font-size:14px;padding:8px 10px;outline:none;text-align:center;"
        >
        <span style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text2);white-space:nowrap;">horas</span>
        <button onclick="saveTTL()" style="flex-shrink:0;background:linear-gradient(135deg,rgba(0,200,255,0.15),rgba(0,200,255,0.05));border:1px solid var(--glow);border-radius:7px;color:var(--glow);font-family:'Orbitron',monospace;font-size:9px;font-weight:700;letter-spacing:2px;padding:9px 16px;cursor:pointer;white-space:nowrap;">‚úî GUARDAR</button>
        <button onclick="disableTTL()" id="ttlDisableBtn" style="flex-shrink:0;background:none;border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:'Orbitron',monospace;font-size:9px;letter-spacing:1px;padding:9px 14px;cursor:pointer;white-space:nowrap;">‚èπ APAGAR</button>
        <span id="ttlStatus" style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text2);white-space:nowrap;"></span>
      </div>

      <!-- Coins toggle -->
      <div class="coins-toggle-wrap">
        <span class="coins-toggle-label">ü™ô AEMX COINS</span>
        <label class="toggle-switch">
          <input type="checkbox" id="coinsToggle" onchange="toggleCoins(this.checked)">
          <span class="toggle-slider"></span>
        </label>
        <span class="coins-toggle-status off" id="coinsToggleStatus">APAGADO</span>
      </div>

      <!-- Transacciones toggle -->
      <div class="coins-toggle-wrap" style="border-color:rgba(0,200,255,0.35);border-top-color:var(--glow);">
        <span class="coins-toggle-label" style="color:var(--glow);">üîÑ TRANSACCIONES</span>
        <label class="toggle-switch">
          <input type="checkbox" id="transToggle" onchange="toggleTransacciones(this.checked)">
          <span class="toggle-slider" style=""></span>
        </label>
        <span class="coins-toggle-status off" id="transToggleStatus">APAGADO</span>
      </div>

      <!-- Bot√≥n transacciones en chat -->
      <div class="coins-toggle-wrap" style="border-color:rgba(255,215,0,0.35);border-top-color:#ffd700;">
        <span class="coins-toggle-label" style="color:#ffd700;font-size:8px;">ü™ô BTN COINS EN CHAT</span>
        <label class="toggle-switch">
          <input type="checkbox" id="btnTransToggle" onchange="toggleBtnTransacciones(this.checked)">
          <span class="toggle-slider"></span>
        </label>
        <span class="coins-toggle-status off" id="btnTransToggleStatus">OCULTO</span>
      </div>

    </div>
  </div>

  <div class="container" style="padding-top:0;">

    <div class="stats-bar">
      <div class="stat-card total">
        <span class="stat-icon">üë•</span>
        <div class="stat-info">
          <div class="stat-value" id="statTotal">‚Äî</div>
          <div class="stat-label">USUARIOS TOTALES</div>
        </div>
      </div>
      <div class="stat-card active-c">
        <span class="stat-icon">‚úÖ</span>
        <div class="stat-info">
          <div class="stat-value" id="statActive">‚Äî</div>
          <div class="stat-label">ACTIVOS</div>
        </div>
      </div>
      <div class="stat-card banned-c">
        <span class="stat-icon">üö´</span>
        <div class="stat-info">
          <div class="stat-value" id="statBanned">‚Äî</div>
          <div class="stat-label">BLOQUEADOS</div>
        </div>
      </div>
      <div class="stat-card clan-c">
        <span class="stat-icon">‚öîÔ∏è</span>
        <div class="stat-info">
          <div class="stat-value" id="statClan">‚Äî</div>
          <div class="stat-label">MIEMBROS CLAN</div>
        </div>
      </div>
      <div class="stat-card coins-c">
        <span class="stat-icon">ü™ô</span>
        <div class="stat-info">
          <div class="stat-value" id="statCoins">‚Äî</div>
          <div class="stat-label">EN WALLETS</div>
        </div>
      </div>
      <div class="stat-card" style="--accent:#ffaa00;">
        <span class="stat-icon">üîÑ</span>
        <div class="stat-info">
          <div class="stat-value" id="statTransit" style="color:#ffaa00;">‚Äî</div>
          <div class="stat-label">EN TR√ÅNSITO</div>
        </div>
      </div>
      <div class="stat-card" style="--accent:#ffffff;">
        <span class="stat-icon">‚àë</span>
        <div class="stat-info">
          <div class="stat-value" id="statGrandTotal" style="color:#ffffff;text-shadow:0 0 12px rgba(255,255,255,0.3);">‚Äî</div>
          <div class="stat-label">TOTAL EXISTENTE</div>
        </div>
      </div>
    </div>

    <!-- Two-column body -->
    <div class="admin-body">

      <!-- LEFT: Mapa compacto -->
      <div class="map-col">
        <div class="map-card">
          <div class="map-card-header">
            <span class="map-card-title">üó∫Ô∏è MAPA EN VIVO</span>
            <span class="map-live-dot">EN VIVO</span>
          </div>
          <div id="mini-map"></div>
          <div class="map-mini-stats">
            <div class="map-mini-stat">
              <div class="num" id="miniStatJugadores">‚Äî</div>
              <div class="lbl">Jugadores</div>
            </div>
            <div class="map-mini-stat">
              <div class="num" id="miniStatEstados">‚Äî</div>
              <div class="lbl">Estados</div>
            </div>
            <div class="map-mini-stat">
              <div class="num" id="miniStatCiudades">‚Äî</div>
              <div class="lbl">Ciudades</div>
            </div>
            <div class="map-mini-stat">
              <div class="num" id="miniStatAemx" style="color:var(--glow2)">‚Äî</div>
              <div class="lbl">Miembros AEMX</div>
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT: Tabla usuarios -->
      <div class="table-col">

        <!-- Filters + search -->
        <div class="filters">
          <button class="filter-btn active" id="filterAll" onclick="setFilter('all')">TODOS</button>
          <button class="filter-btn" id="filterActive" onclick="setFilter('active')">ACTIVOS</button>
          <button class="filter-btn" id="filterBanned" onclick="setFilter('banned')">BLOQUEADOS</button>
        </div>

        <!-- Table -->
        <div class="table-wrap">
          <div class="table-header">
            <span class="table-title">USUARIOS REGISTRADOS</span>
            <input class="search-input" type="text" placeholder="Buscar usuario..." oninput="filterSearch(this.value)" id="searchInput">
          </div>
          <table>
            <thead>
              <tr>
                <th>JUGADOR</th>
                <th>PA√çS</th>
                <th>PARCELAS</th>
                <th>AEMX COINS</th>
                <th>ACTUALIZADO</th>
                <th>CLAN</th>
                <th>ESTADO</th>
                <th>ACCIONES</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr>
                <td colspan="8">
                  <div class="empty-state">
                    <div class="spinner"></div>
                    CARGANDO USUARIOS...
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div><!-- /admin-body -->

    <!-- C√≥digos activos en tr√°nsito -->
    <div class="active-codes-section">
      <div class="active-codes-card">
        <div class="active-codes-header">
          <span class="active-codes-title">ü™ô C√ìDIGOS EN TR√ÅNSITO</span>
          <div class="active-codes-meta">
            <span class="active-codes-badge">C√≥digos activos: <span id="acCount">‚Äî</span></span>
            <span class="active-codes-badge">Coins en tr√°nsito: <span id="acTotal">‚Äî</span></span>
          </div>
        </div>
        <table class="active-codes-table">
          <thead>
            <tr>
              <th>USUARIO</th>
              <th>COINS</th>
              <th>CREADO HACE</th>
            </tr>
          </thead>
          <tbody id="activeCodesBody">
            <tr><td colspan="3"><div class="ac-empty">Cargando...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script>
    // ‚îÄ‚îÄ Mini mapa Leaflet ‚îÄ‚îÄ
    const miniMap = L.map('mini-map', {
      center: [23.6345, -102.5528],
      zoom: 4,
      zoomControl: true,
      attributionControl: false,
      dragging: true,
      scrollWheelZoom: 'center',
      doubleClickZoom: true,
      touchZoom: true,
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd', maxZoom: 19,
    }).addTo(miniMap);

    // Coordenadas de estados
    const ESTADO_COORDS_MINI = {
      'Aguascalientes':[21.8853,-102.2916],'Baja California':[30.8406,-115.2838],
      'Baja California Sur':[26.0444,-111.6661],'Campeche':[19.8301,-90.5349],
      'Chiapas':[16.7569,-93.1292],'Chihuahua':[28.6353,-106.0889],
      'Ciudad de M√©xico':[19.4326,-99.1332],'Coahuila':[27.0587,-101.7068],
      'Colima':[19.2452,-103.7241],'Durango':[24.0277,-104.6532],
      'Estado de M√©xico':[19.2826,-99.6557],'Guanajuato':[21.0190,-101.2574],
      'Guerrero':[17.4392,-100.0000],'Hidalgo':[20.0911,-98.7624],
      'Jalisco':[20.6597,-103.3496],'Michoac√°n':[19.7008,-101.1844],
      'Morelos':[18.6813,-99.1013],'Nayarit':[21.7514,-104.8455],
      'Nuevo Le√≥n':[25.5922,-99.9962],'Oaxaca':[17.0732,-96.7266],
      'Puebla':[19.0414,-98.2063],'Quer√©taro':[20.5888,-100.3899],
      'Quintana Roo':[19.1817,-88.4791],'San Luis Potos√≠':[22.1565,-100.9855],
      'Sinaloa':[25.1721,-107.4795],'Sonora':[29.0729,-110.9559],
      'Tabasco':[17.8409,-92.6189],'Tamaulipas':[24.2669,-98.8363],
      'Tlaxcala':[19.3182,-98.2375],'Veracruz':[19.1738,-96.1342],
      'Yucat√°n':[20.9674,-89.5926],'Zacatecas':[22.7709,-102.5832],
    };

    const CIUDAD_ESTADO_MINI = {
      'ciudad de m√©xico':'Ciudad de M√©xico','cdmx':'Ciudad de M√©xico',
      'guadalajara':'Jalisco','monterrey':'Nuevo Le√≥n','puebla':'Puebla',
      'tijuana':'Baja California','mexicali':'Baja California',
      'toluca':'Estado de M√©xico','ecatepec':'Estado de M√©xico',
      'le√≥n':'Guanajuato','chihuahua':'Chihuahua','ciudad ju√°rez':'Chihuahua',
      'm√©rida':'Yucat√°n','hermosillo':'Sonora','culiac√°n':'Sinaloa',
      'canc√∫n':'Quintana Roo','veracruz':'Veracruz','morelia':'Michoac√°n',
      'aguascalientes':'Aguascalientes','san luis potos√≠':'San Luis Potos√≠',
      'saltillo':'Coahuila','torre√≥n':'Coahuila','durango':'Durango',
      'quer√©taro':'Quer√©taro','cuernavaca':'Morelos','tampico':'Tamaulipas',
      'reynosa':'Tamaulipas','la paz':'Baja California Sur',
      'villahermosa':'Tabasco','tuxtla guti√©rrez':'Chiapas',
      'oaxaca':'Oaxaca','acapulco':'Guerrero','zacatecas':'Zacatecas',
      'pachuca':'Hidalgo','tepic':'Nayarit','colima':'Colima',
      'campeche':'Campeche','tlaxcala':'Tlaxcala',
    };

    function extractEstadoMini(city) {
      if (!city) return null;
      const parts = city.split(',');
      if (parts.length >= 2) return parts[parts.length - 1].trim();
      return CIUDAD_ESTADO_MINI[city.toLowerCase().trim()] || null;
    }

    let miniMarkers = [];
    let miniCircles = [];

    function renderMiniMap(players) {
      miniMarkers.forEach(m => miniMap.removeLayer(m));
      miniCircles.forEach(c => miniMap.removeLayer(c));
      miniMarkers = []; miniCircles = [];

      // Agrupar por estado
      const porEstado = {};
      players.forEach(p => {
        const estado = extractEstadoMini(p.city || '');
        if (!estado) return;
        if (!porEstado[estado]) porEstado[estado] = [];
        porEstado[estado].push(p);
      });

      // C√≠rculos por estado
      Object.entries(porEstado).forEach(([estado, jugs]) => {
        const coords = ESTADO_COORDS_MINI[estado];
        if (!coords) return;
        const n = jugs.length;
        const tieneAEMX = jugs.some(p => (p.username||'').toUpperCase().includes('AEMX'));
        const color = tieneAEMX ? '#00ff9d' : (n >= 5 ? '#00c8ff' : n >= 2 ? '#1a6a9c' : '#1a3a5c');
        const fill  = tieneAEMX ? 'rgba(0,255,157,0.55)' : (n >= 5 ? 'rgba(0,200,255,0.45)' : n >= 2 ? 'rgba(0,200,255,0.25)' : 'rgba(0,200,255,0.12)');

        const c = L.circle(coords, {
          radius: 60000 + n * 12000,
          color, fillColor: fill, fillOpacity: 1, weight: 1.5, opacity: 0.9,
          interactive: true,
        }).addTo(miniMap);

        c.bindTooltip(`${estado} ¬∑ ${n} jugador${n>1?'es':''}`, { permanent: false, direction: 'top' });
        miniCircles.push(c);
      });

      // Marcadores simples (puntos)
      players.forEach(p => {
        const estado = extractEstadoMini(p.city || '');
        let coords = null;
        if (estado && ESTADO_COORDS_MINI[estado]) {
          coords = [
            ESTADO_COORDS_MINI[estado][0] + (Math.random()-0.5)*0.8,
            ESTADO_COORDS_MINI[estado][1] + (Math.random()-0.5)*0.8,
          ];
        } else if (p.country === 'Mexico' || !p.city) {
          // Sin ciudad: posici√≥n aleatoria sobre M√©xico
          coords = [
            23.6345 + (Math.random()-0.5)*6,
            -102.5528 + (Math.random()-0.5)*6,
          ];
        }
        if (!coords) return;

        const letter = (p.username||'?').charAt(0).toUpperCase();
        const colors = ['#00c8ff','#00ff9d','#c084fc','#60a5fa','#facc15','#4ade80','#f472b6'];
        const bg = p.borderColor || colors[letter.charCodeAt(0) % colors.length];

        const icon = L.divIcon({
          html: `<div style="width:10px;height:10px;border-radius:50%;background:${bg};border:1.5px solid #fff;box-shadow:0 0 6px ${bg};"></div>`,
          className: '', iconSize: [10,10], iconAnchor: [5,5],
        });
        const m = L.marker(coords, { icon, interactive: true }).addTo(miniMap);
        m.bindTooltip(`${p.username} ¬∑ ${p.total.toLocaleString()} parcelas`, { direction: 'top' });
        miniMarkers.push(m);
      });

      // Stats del mapa
      const estados  = Object.keys(porEstado).length;
      const ciudades = new Set(players.map(p => p.city).filter(Boolean)).size;
      const aemx     = players.filter(p => (p.username||'').toUpperCase().includes('AEMX')).length;
      document.getElementById('miniStatJugadores').textContent = players.length;
      document.getElementById('miniStatEstados').textContent   = estados;
      document.getElementById('miniStatCiudades').textContent  = ciudades;
      document.getElementById('miniStatAemx').textContent      = aemx;
    }

    window.renderMiniMap = renderMiniMap;
  </script>

  <script type="module">
    import { initializeApp }   from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut }
                               from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, onValue, update, set, get, query, limitToLast }
                               from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const ADMIN_EMAIL = 'ingmarcosrodriguez31@gmail.com';

    const firebaseConfig = {
      apiKey:        'AIzaSyB-xx2PlBjvnHe0K7Bf1MspVqUlfjky0mk',
      authDomain:    'aemx-chat.firebaseapp.com',
      databaseURL:   'https://aemx-chat-default-rtdb.firebaseio.com',
      projectId:     'aemx-chat',
      storageBucket: 'aemx-chat.appspot.com',
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
    window.authWithGoogle = async function() {
      document.getElementById('authError').textContent = '';
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch(e) {
        document.getElementById('authError').textContent = 'Error al iniciar sesi√≥n.';
      }
    };

    window.signOutUser = async function() { await signOut(auth); };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('authOverlay').classList.add('hidden');
        if (user.email !== ADMIN_EMAIL) {
          document.getElementById('accessDenied').classList.add('visible');
          return;
        }
        // Admin autorizado
        document.getElementById('accessDenied').classList.remove('visible');
        document.getElementById('headerRight').style.display = 'flex';
        document.getElementById('adminEmail').textContent = user.displayName || user.email;
        loadUsers();
        // Cargar aviso actual
        onValue(ref(db, 'config/aviso'), (snap) => {
          const txt = snap.exists() ? snap.val() : '';
          document.getElementById('avisoInput').value = txt;
          document.getElementById('avisoPreview').textContent = txt || '(sin aviso activo)';
          document.getElementById('avisoClear').style.display = txt ? 'inline-flex' : 'none';
        });
        // Cargar TTL actual
        onValue(ref(db, 'config/chatTTL'), (snap) => {
          const val = snap.exists() ? snap.val() : null;
          const input  = document.getElementById('ttlInput');
          const status = document.getElementById('ttlStatus');
          const disBtn = document.getElementById('ttlDisableBtn');
          if (val === 0 || val === null) {
            input.value = '';
            status.textContent = '‚èπ Apagado';
            status.style.color = 'var(--danger)';
            disBtn.style.opacity = '0.4';
          } else {
            input.value = val;
            status.textContent = `‚úî Activo ¬∑ ${val}h`;
            status.style.color = 'var(--glow2)';
            disBtn.style.opacity = '1';
          }
        });
        // Cargar estado de coins
        onValue(ref(db, 'config/coinsActivo'), (snap) => {
          const activo = snap.exists() ? snap.val() : true;
          const checkbox = document.getElementById('coinsToggle');
          const status   = document.getElementById('coinsToggleStatus');
          if (checkbox) checkbox.checked = activo;
          if (status) {
            status.textContent = activo ? 'ENCENDIDO' : 'APAGADO';
            status.className = `coins-toggle-status ${activo ? 'on' : 'off'}`;
          }
        });
        // Cargar estado de transacciones
        onValue(ref(db, 'config/transaccionesActivo'), (snap) => {
          const activo = snap.exists() ? snap.val() : true;
          const checkbox = document.getElementById('transToggle');
          const status   = document.getElementById('transToggleStatus');
          if (checkbox) checkbox.checked = activo;
          if (status) {
            status.textContent = activo ? 'ENCENDIDO' : 'APAGADO';
            status.className = `coins-toggle-status ${activo ? 'trans-status-on' : 'trans-status-off'}`;
          }
        });
        // Cargar estado del bot√≥n de transacciones en chat
        onValue(ref(db, 'config/btnTransaccionesActivo'), (snap) => {
          const activo = snap.exists() ? snap.val() : false;
          const checkbox = document.getElementById('btnTransToggle');
          const status   = document.getElementById('btnTransToggleStatus');
          if (checkbox) checkbox.checked = activo;
          if (status) {
            status.textContent = activo ? 'VISIBLE' : 'OCULTO';
            status.className = `coins-toggle-status ${activo ? 'on' : 'off'}`;
          }
        });
      } else {
      }
    });

    // ‚îÄ‚îÄ Avisos ‚îÄ‚îÄ
    window.saveAviso = async function() {
      const texto = document.getElementById('avisoInput').value.trim();
      try {
        await set(ref(db, 'config/aviso'), texto);
        showToast(texto ? 'üì¢ Aviso publicado' : 'üóëÔ∏è Aviso eliminado');
      } catch(e) { showToast('Error al guardar aviso', true); }
    };

    window.clearAviso = async function() {
      document.getElementById('avisoInput').value = '';
      await window.saveAviso();
    };

    // ‚îÄ‚îÄ TTL autoborrado ‚îÄ‚îÄ
    window.saveTTL = async function() {
      const horas = parseInt(document.getElementById('ttlInput').value);
      if (!horas || horas < 1) { showToast('Ingresa un n√∫mero de horas v√°lido', true); return; }
      try {
        await set(ref(db, 'config/chatTTL'), horas);
        showToast(`üóëÔ∏è Autoborrado cada ${horas}h`);
      } catch(e) { showToast('Error al guardar TTL', true); }
    };

    window.disableTTL = async function() {
      try {
        await set(ref(db, 'config/chatTTL'), 0);
        document.getElementById('ttlInput').value = '';
        showToast('‚èπ Autoborrado apagado');
      } catch(e) { showToast('Error al apagar TTL', true); }
    };

    // ‚îÄ‚îÄ Data ‚îÄ‚îÄ
    let allUsers   = [];
    let currentFilter = 'all';
    let searchQuery   = '';
    let pendingAction = null;

    async function loadUsers() {
  const snapshot = await get(ref(db, 'users'));
  allUsers = [];

  if (snapshot.exists()) {
    snapshot.forEach((child) => {
      const d = child.val() || {};
      if (!d.username) return;

      const common    = parseInt(d.common)    || 0;
      const rare      = parseInt(d.rare)      || 0;
      const epic      = parseInt(d.epic)      || 0;
      const legendary = parseInt(d.legendary) || 0;

      allUsers.push({
        uid:              child.key,
        username:         d.username,
        avatar:           d.avatar || '',
        borderColor:      d.borderColor || '',
        country:          d.country || '',
        city:             d.city || '',
        total:            common + rare + epic + legendary,
        coins:            parseInt(d.coins) || 0,
        updatedAt:        d.updatedAt || null,
        bannedChat:       !!d.bannedChat,
        bannedLeaderboard:!!d.bannedLeaderboard,
        clanMember:       !!d.clanMember,
        countryHistory:   Array.isArray(d.countryHistory) ? d.countryHistory : []
      });
    });
  }

  allUsers.sort((a, b) => b.total - a.total);
  updateStats();
  renderTable();
  if (window.renderMiniMap) window.renderMiniMap(allUsers);

  // Construir mapa uid ‚Üí user y cargar c√≥digos activos (limitado)
  const usersMap = {};
  allUsers.forEach(u => { usersMap[u.uid] = u; });
  loadActiveCodes(usersMap);
}

function updateStats() {
      const bannedAny   = allUsers.filter(u => u.bannedChat || u.bannedLeaderboard).length;
      const clanMembers = allUsers.filter(u => u.clanMember).length;
      const totalCoins  = allUsers.reduce((sum, u) => sum + (u.coins || 0), 0);
      document.getElementById('statTotal').textContent  = allUsers.length;
      document.getElementById('statActive').textContent = allUsers.length - bannedAny;
      document.getElementById('statBanned').textContent = bannedAny;
      document.getElementById('statClan').textContent   = clanMembers;
      document.getElementById('statCoins').textContent  = totalCoins.toLocaleString();
      // Guardar coins en wallets para el gran total
      window._coinsInWallets = totalCoins;
      updateGrandTotal();
    }

    function updateGrandTotal() {
      const wallets  = window._coinsInWallets  || 0;
      const transit  = window._coinsInTransit  || 0;
      document.getElementById('statTransit').textContent   = transit.toLocaleString();
      document.getElementById('statGrandTotal').textContent = (wallets + transit).toLocaleString();
    }

    function getFiltered() {
      return allUsers.filter(u => {
        const matchFilter =
          currentFilter === 'all'    ? true :
          currentFilter === 'banned' ? (u.bannedChat || u.bannedLeaderboard) :
          currentFilter === 'active' ? (!u.bannedChat && !u.bannedLeaderboard) : true;
        const matchSearch = !searchQuery ||
          u.username.toLowerCase().includes(searchQuery.toLowerCase());
        return matchFilter && matchSearch;
      });
    }

    function avatarHTML(u) {
      const letter = (u.username || '?').charAt(0).toUpperCase();
      const colors = ['#00c8ff','#00ff9d','#c084fc','#60a5fa','#facc15','#4ade80','#f472b6'];
      const bg = colors[letter.charCodeAt(0) % colors.length];
      if (u.avatar && u.avatar.startsWith('data:image')) {
        return `<div class="avatar" style="border-color:${u.borderColor||'var(--border)'}"><img src="${u.avatar}" alt="${letter}"></div>`;
      }
      return `<div class="avatar" style="background:${bg};border-color:${u.borderColor||bg}">${letter}</div>`;
    }

    function renderTable() {
      const tbody  = document.getElementById('usersBody');
      const users  = getFiltered();

      if (users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state">SIN USUARIOS</div></td></tr>`;
        return;
      }

      tbody.innerHTML = users.map((u, i) => {
        const isClanMember  = u.clanMember === true;
        const isBannedChat  = u.bannedChat;
        const isBannedLb    = u.bannedLeaderboard;
        const anyBanned     = isBannedChat || isBannedLb;
        const rowClass      = anyBanned ? 'banned-row' : '';
        const delay         = Math.min(i * 0.03, 0.5);

        const statusBadges = [];
        if (isBannedChat) statusBadges.push(`<span class="status-badge banned">üí¨ CHAT</span>`);
        if (isBannedLb)   statusBadges.push(`<span class="status-badge banned">üèÜ RANKING</span>`);
        if (!anyBanned)   statusBadges.push(`<span class="status-badge active">ACTIVO</span>`);

        const actionBtns = [];
        actionBtns.push(`<button class="btn-action btn-edit-country" onclick="editCountry('${u.uid}','${u.username}','${u.country}')">‚úé PA√çS</button>`);
        if (isBannedChat) {
          actionBtns.push(`<button class="btn-action btn-unban" onclick="confirmAction('unbanChat','${u.uid}','${u.username}')">‚úì CHAT</button>`);
        } else {
          actionBtns.push(`<button class="btn-action btn-ban btn-ban-chat" onclick="confirmAction('banChat','${u.uid}','${u.username}')">‚úï CHAT</button>`);
        }
        if (isBannedLb) {
          actionBtns.push(`<button class="btn-action btn-unban" onclick="confirmAction('unbanLb','${u.uid}','${u.username}')">‚úì RANKING</button>`);
        } else {
          actionBtns.push(`<button class="btn-action btn-ban" onclick="confirmAction('banLb','${u.uid}','${u.username}')">‚úï RANKING</button>`);
        }

        return `
          <tr class="${rowClass}" style="animation-delay:${delay}s">
            <td>
              <div class="player-cell">
                ${avatarHTML(u)}
                <div>
                  <div class="player-name">${u.username}</div>
                </div>
              </div>
            </td>
            <td class="country-cell">
              ${u.country || '‚Äî'}
              ${u.countryHistory.length > 0 ? `
                <div class="country-changed">
                  ‚ö†Ô∏è ${u.countryHistory.length} cambio${u.countryHistory.length > 1 ? 's' : ''}
                  <div class="country-history-tooltip">
                    ${u.countryHistory.map(h => `
                      <div class="history-entry">
                        <span class="from">${h.from}</span> ‚Üí <span class="to">${h.to}</span><br>
                        <span class="date">${new Date(h.date).toLocaleString('es-MX')}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </td>
            <td class="parcelas-cell">${u.total.toLocaleString()}</td>
            <td class="coins-cell">
              ${u.coins > 0
                ? `<span class="coin-icon">ü™ô</span>${u.coins}`
                : `<span class="coin-zero">‚Äî</span>`
              }
              <button class="btn-edit-coins" onclick="editCoins('${u.uid}','${u.username}',${u.coins})">‚úé</button>
            </td>
            <td style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text2);white-space:nowrap;">${
              u.updatedAt
                ? (() => {
                    const d = new Date(u.updatedAt);
                    const diff = Date.now() - u.updatedAt;
                    const mins = Math.floor(diff / 60000);
                    const hrs  = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);
                    const rel  = days > 0 ? `hace ${days}d` : hrs > 0 ? `hace ${hrs}h` : mins > 0 ? `hace ${mins}m` : 'ahora';
                    return `<span title="${d.toLocaleString('es-MX')}" style="cursor:default;">${rel}</span>`;
                  })()
                : '<span style="color:var(--border);">‚Äî</span>'
            }</td>
            <td>
              <button class="btn-clan ${isClanMember ? 'is-member' : ''}"
                onclick="toggleClan('${u.uid}','${u.username}',${isClanMember})">
                ${isClanMember ? '‚öîÔ∏è MIEMBRO' : '‚Äî CLAN'}
              </button>
            </td>
            <td>${statusBadges.join(' ')}</td>
            <td><div class="actions-cell">${actionBtns.join('')}</div></td>
          </tr>
        `;
      }).join('');
    }

    // ‚îÄ‚îÄ Filters ‚îÄ‚îÄ
    window.setFilter = function(f) {
      currentFilter = f;
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('active', 'active-banned');
      });
      const btn = document.getElementById(f === 'all' ? 'filterAll' : f === 'active' ? 'filterActive' : 'filterBanned');
      btn.classList.add(f === 'banned' ? 'active-banned' : 'active');
      renderTable();
    };

    window.filterSearch = function(q) {
      searchQuery = q;
      renderTable();
    };

    // ‚îÄ‚îÄ Confirm modal ‚îÄ‚îÄ
    window.toggleClan = async function(uid, username, isMember) {
      const newVal = !isMember;
      try {
        await update(ref(db, `users/${uid}`), { clanMember: newVal });
        showToast(newVal ? `‚öîÔ∏è ${username} agregado al clan` : `${username} removido del clan`);
      } catch(e) {
        showToast('Error al actualizar clan', true);
      }
    };

    window.confirmAction = function(action, uid, username) {
      const messages = {
        banChat:  `¬øBloquear a <strong>${username}</strong> del chat?`,
        unbanChat:`¬øDesbloquear a <strong>${username}</strong> del chat?`,
        banLb:    `¬øBloquear a <strong>${username}</strong> del leaderboard?`,
        unbanLb:  `¬øDesbloquear a <strong>${username}</strong> del leaderboard?`,
      };
      const titles = {
        banChat:  'BLOQUEAR CHAT',
        unbanChat:'DESBLOQUEAR CHAT',
        banLb:    'BLOQUEAR RANKING',
        unbanLb:  'DESBLOQUEAR RANKING',
      };
      document.getElementById('modalTitle').textContent = titles[action];
      document.getElementById('modalBody').innerHTML    = messages[action];
      document.getElementById('modalConfirmBtn').onclick = () => executeAction(action, uid, username);
      document.getElementById('confirmModal').classList.add('visible');
    };

    window.closeModal = function() {
      document.getElementById('confirmModal').classList.remove('visible');
    };

    async function executeAction(action, uid, username) {
      closeModal();
      const updates = {};
      if (action === 'banChat')   updates.bannedChat = true;
      if (action === 'unbanChat') updates.bannedChat = false;
      if (action === 'banLb')     updates.bannedLeaderboard = true;
      if (action === 'unbanLb')   updates.bannedLeaderboard = false;

      try {
        await update(ref(db, `users/${uid}`), updates);
        const msgs = {
          banChat:  `${username} bloqueado del chat`,
          unbanChat:`${username} desbloqueado del chat`,
          banLb:    `${username} bloqueado del ranking`,
          unbanLb:  `${username} desbloqueado del ranking`,
        };
        showToast(msgs[action]);
      } catch(e) {
        showToast('Error al actualizar', true);
      }
    }

    // ‚îÄ‚îÄ C√≥digos activos en tr√°nsito ‚îÄ‚îÄ
    async function loadActiveCodes(usersMap) {
      const snap = await get(query(ref(db, 'codes'), limitToLast(250)));
      
        const tbody = document.getElementById('activeCodesBody');
        const acCount = document.getElementById('acCount');
        const acTotal = document.getElementById('acTotal');

        if (!snap.exists()) {
          tbody.innerHTML = `<tr><td colspan="3"><div class="ac-empty">ü™ô Sin c√≥digos activos</div></td></tr>`;
          acCount.textContent = '0';
          acTotal.textContent = '0';
          window._coinsInTransit = 0;
          updateGrandTotal();
          return;
        }

        const codes = [];
        snap.forEach(child => {
          codes.push({ ...child.val() });
        });

        // Ordenar del m√°s reciente al m√°s antiguo
        codes.sort((a, b) => b.createdAt - a.createdAt);

        const total = codes.reduce((s, c) => s + (c.value || 0), 0);
        acCount.textContent = codes.length;
        acTotal.textContent = `ü™ô ${total}`;

        // Actualizar stat global
        window._coinsInTransit = total;
        updateGrandTotal();

        tbody.innerHTML = codes.map((c, i) => {
          const user = usersMap[c.createdBy] || {};
          const username = c.username || user.username || 'Desconocido';
          const photo    = user.photoURL || '';
          const letter   = username.charAt(0).toUpperCase();
          const colors   = ['#00c8ff','#00ff9d','#c084fc','#60a5fa','#facc15','#f472b6'];
          const bg       = user.borderColor || colors[letter.charCodeAt(0) % colors.length];

          const avatarHTML = photo
            ? `<div class="ac-avatar"><img src="${photo}" alt=""></div>`
            : `<div class="ac-avatar" style="background:${bg};">${letter}</div>`;

          const diff = Date.now() - c.createdAt;
          const mins = Math.floor(diff / 60000);
          const hrs  = Math.floor(diff / 3600000);
          const days = Math.floor(diff / 86400000);
          const rel  = days > 0 ? `${days}d` : hrs > 0 ? `${hrs}h` : mins > 0 ? `${mins}m` : 'ahora';

          return `
            <tr style="animation-delay:${i * 0.04}s">
              <td>
                <div class="ac-user">
                  ${avatarHTML}
                  <span class="ac-username">${username}</span>
                </div>
              </td>
              <td><span class="ac-coins">ü™ô ${c.value}</span></td>
              <td><span class="ac-time">hace ${rel}</span></td>
            </tr>
          `;
        }).join('');
    }

    // ‚îÄ‚îÄ Toggle Coins ‚îÄ‚îÄ
    window.toggleCoins = async function(activo) {
      try {
        await set(ref(db, 'config/coinsActivo'), activo);
        showToast(activo ? 'ü™ô Sistema de coins ENCENDIDO' : 'ü™ô Sistema de coins APAGADO');
      } catch(e) {
        showToast('Error al actualizar coins', true);
      }
    };

    // ‚îÄ‚îÄ Toggle Transacciones ‚îÄ‚îÄ
    window.toggleTransacciones = async function(activo) {
      try {
        await set(ref(db, 'config/transaccionesActivo'), activo);
        showToast(activo ? 'üîÑ Transacciones ENCENDIDAS' : 'üîÑ Transacciones APAGADAS');
      } catch(e) {
        showToast('Error al actualizar transacciones', true);
      }
    };

    // ‚îÄ‚îÄ Toggle Bot√≥n Transacciones en chat ‚îÄ‚îÄ
    window.toggleBtnTransacciones = async function(activo) {
      try {
        await set(ref(db, 'config/btnTransaccionesActivo'), activo);
        showToast(activo ? 'ü™ô Bot√≥n COINS visible en chat' : 'ü™ô Bot√≥n COINS oculto en chat');
      } catch(e) {
        showToast('Error al actualizar', true);
      }
    };

    // ‚îÄ‚îÄ Edit Coins ‚îÄ‚îÄ
    let editingCoinsUid = null;

    window.editCoins = function(uid, username, currentCoins) {
      editingCoinsUid = uid;
      document.getElementById('coinsModalUser').innerHTML =
        `Usuario: <strong>${username}</strong> ¬∑ Coins actuales: <strong>ü™ô ${currentCoins}</strong>`;
      document.getElementById('coinsInput').value = currentCoins;
      document.getElementById('coinsModal').classList.add('visible');
      setTimeout(() => document.getElementById('coinsInput').focus(), 100);
    };

    window.closeCoinsModal = function() {
      document.getElementById('coinsModal').classList.remove('visible');
      editingCoinsUid = null;
    };

    window.saveCoins = async function() {
      if (!editingCoinsUid) return;
      const newCoins = parseInt(document.getElementById('coinsInput').value);
      if (isNaN(newCoins) || newCoins < 0) {
        showToast('Ingresa un valor v√°lido (0 o m√°s)', true);
        return;
      }
      try {
        await update(ref(db, `users/${editingCoinsUid}`), { coins: newCoins });
        closeCoinsModal();
        showToast(`ü™ô Coins actualizados a ${newCoins}`);
      } catch(e) {
        showToast('Error al actualizar coins', true);
      }
    };

    document.getElementById('coinsInput').addEventListener('keydown', e => {
      if (e.key === 'Enter')  window.saveCoins();
      if (e.key === 'Escape') window.closeCoinsModal();
    });

    // ‚îÄ‚îÄ Edit Country ‚îÄ‚îÄ
    let editingUid = null;

    window.editCountry = function(uid, username, currentCountry) {
      editingUid = uid;
      document.getElementById('countryModalUser').innerHTML = `Usuario: <strong>${username}</strong> ¬∑ Pa√≠s actual: <strong>${currentCountry || '‚Äî'}</strong>`;
      document.getElementById('countryInput').value = currentCountry || '';
      document.getElementById('countryModal').classList.add('visible');
      setTimeout(() => document.getElementById('countryInput').focus(), 100);
    };

    window.closeCountryModal = function() {
      document.getElementById('countryModal').classList.remove('visible');
      editingUid = null;
    };

    window.saveCountry = async function() {
      if (!editingUid) return;
      const newCountry = document.getElementById('countryInput').value.trim();
      try {
        await update(ref(db, `users/${editingUid}`), { country: newCountry });
        closeCountryModal();
        showToast(`Pa√≠s actualizado a "${newCountry}"`);
      } catch(e) {
        showToast('Error al actualizar pa√≠s', true);
      }
    };

    // Enter key in country input
    document.getElementById('countryInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') window.saveCountry();
      if (e.key === 'Escape') window.closeCountryModal();
    });

    // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
    let toastTimer;
    function showToast(msg, isError = false) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.toggle('error', isError);
      el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
    }
  </script>
  <!-- ===== CHAT WIDGET ===== -->
  <button id="chat-fab" onclick="toggleChat()" aria-label="Abrir chat">
    <svg class="icon-chat" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>
    <svg class="icon-close" style="display:none" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
  </button>

  <div id="chat-iframe-container">
    <iframe id="chat-frame" src="about:blank" title="Chat Atlas Earth M√©xico" loading="lazy" allow="clipboard-write" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation"></iframe>
  </div>

  <script>
    let chatOpen = false;

    function toggleChat() {
      chatOpen = !chatOpen;
      document.getElementById('chat-iframe-container').classList.toggle('open', chatOpen);
      document.getElementById('chat-fab').classList.toggle('open', chatOpen);

      if (window.innerWidth <= 480) {
        document.getElementById('chat-fab').style.display = chatOpen ? 'none' : 'flex';
      }

      if (chatOpen) {
        history.pushState({ chatOpen: true }, '');
        // Admin no tiene username/avatar en localStorage del mismo modo,
        // pero si los tiene los pasa igual
        const username = localStorage.getItem('atlas-username') || 'ADMIN';
        const color    = localStorage.getItem('atlas-avatar-border') || '#ff4466';
        document.getElementById('chat-frame').src =
          `chat-firebase.html?username=${encodeURIComponent(username)}&color=${encodeURIComponent(color)}`;
      }
    }

    function updateWidgetTime() {
      const now = new Date();
        String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
    }
    updateWidgetTime();
    setInterval(updateWidgetTime, 60000);

    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'CLOSE_CHAT') closeChatWidget();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && chatOpen) closeChatWidget(); });

    function closeChatWidget() {
      chatOpen = false;
      document.getElementById('chat-iframe-container').classList.remove('open');
      document.getElementById('chat-fab').classList.remove('open');
      if (window.innerWidth <= 480) {
        document.getElementById('chat-fab').style.display = 'flex';
      }
    }

    window.addEventListener('popstate', () => { if (chatOpen) closeChatWidget(); });
  </script>
  <!-- ===== FIN CHAT WIDGET ===== -->
  <script>
    // ‚îÄ‚îÄ Network bars widget ‚îÄ‚îÄ
    const bars   = [1,2,3,4,5].map(i => document.getElementById('nb' + i));
    const netLbl = document.getElementById('netLabel');
    const maxH   = 22; // px altura m√°xima

    async function measurePing() {
      const t0 = performance.now();
      try {
        await fetch('https://www.gstatic.com/generate_204', { cache: 'no-store', mode: 'no-cors' });
      } catch(e) {}
      return Math.round(performance.now() - t0);
    }

    async function updateNetBars() {
      const ping = await measurePing();

      // Calidad: <60ms excelente, <120 bueno, <200 regular, <400 malo, ‚â•400 p√©simo
      let nivel, color;
      if      (ping < 60)  { nivel = 5; color = '#00ff9d'; }
      else if (ping < 120) { nivel = 4; color = '#00c8ff'; }
      else if (ping < 200) { nivel = 3; color = '#ffaa00'; }
      else if (ping < 400) { nivel = 2; color = '#ff6644'; }
      else                 { nivel = 1; color = '#ff4466'; }

      bars.forEach((bar, i) => {
        const active = i < nivel;
        const h = Math.round(maxH * (i + 1) / 5);
        bar.style.height  = h + 'px';
        bar.style.background = color;
        bar.style.opacity = active ? '1' : '0.15';
        bar.style.boxShadow = active ? `0 0 6px ${color}` : 'none';
      });

      netLbl.style.color = color;
      netLbl.textContent = ping + ' ms';
    }

    // Arrancar solo cuando el header sea visible
    const headerObs = new MutationObserver(() => {
      const hr = document.getElementById('headerRight');
      if (hr && hr.style.display !== 'none') {
        headerObs.disconnect();
        updateNetBars();
        setInterval(updateNetBars, 3000);
      }
    });
    headerObs.observe(document.getElementById('headerRight'), { attributes: true, attributeFilter: ['style'] });
  </script>

</body>
</html>